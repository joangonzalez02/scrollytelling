<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cancún: Entre el Destino Global y la Ciudad Justa</title>
    
        <!-- Meta descripción (SEO) -->
        <meta name="description" content="Scrollytelling interactivo sobre Cancún: crecimiento urbano, movilidad y densidad poblacional. Mapas, gráficos y datos para entender la evolución de la ciudad.">
        <meta name="robots" content="index, follow">
        <meta name="author" content="joangonzalez02">

        <!-- Canonical -->
        <link rel="canonical" href="https://joangonzalez02.github.io/SCROLLAMA/">

        <!-- Open Graph (Social) -->
        <meta property="og:type" content="website">
        <meta property="og:locale" content="es_ES">
        <meta property="og:title" content="Cancún: Entre el Destino Global y la Ciudad Justa">
        <meta property="og:description" content="Scrollytelling interactivo con mapas y gráficos sobre la evolución urbana de Cancún: población, movilidad y retos de una ciudad en transformación.">
        <meta property="og:url" content="https://joangonzalez02.github.io/SCROLLAMA/">
        <meta property="og:image" content="https://joangonzalez02.github.io/SCROLLAMA/assets/1.png">

        <!-- Twitter Cards -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Cancún: Entre el Destino Global y la Ciudad Justa">
        <meta name="twitter:description" content="Mapas y datos para entender el crecimiento urbano de Cancún. Explora la historia y los retos de la ciudad con visualizaciones interactivas.">
        <meta name="twitter:image" content="https://joangonzalez02.github.io/SCROLLAMA/assets/1.png">

        <!-- JSON-LD (Schema.org) para WebPage -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "Cancún: Entre el Destino Global y la Ciudad Justa",
            "url": "https://joangonzalez02.github.io/SCROLLAMA/",
            "inLanguage": "es",
            "description": "Scrollytelling interactivo con mapas y gráficos sobre la evolución urbana de Cancún: población, movilidad y densidad.",
            "isPartOf": {
                "@type": "WebSite",
                "name": "SCROLLAMA",
                "url": "https://joangonzalez02.github.io/SCROLLAMA/"
            }
        }
        </script>
    <!-- Preconnect to third-party origins to reduce DNS/TLS latency -->
    <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
    <link rel="preconnect" href="https://d3js.org" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    
    <!-- Defer Mapbox CSS using preload to avoid render-blocking; noscript fallback -->
    <link rel="preload" as="style" href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css"></noscript>
    <!-- Mapbox GL JS library - DEBE cargarse ANTES de mapbox-integration -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <!-- Proyecciones para convertir GeoJSON en EPSG:32616 a WGS84 (lon/lat) en el navegador -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js" defer></script>
    <script src="https://unpkg.com/scrollama" defer></script>
    <script src="https://d3js.org/d3.v7.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" defer></script>
    <script src="dist/population-chart.min.js" defer></script>
    <script src="dist/vehicle-chart.min.js" defer></script>
    <script src="dist/urban-evolution.min.js" defer></script>
    <!-- Mapbox integration DEBE esperar a que mapboxgl esté disponible -->
    <script>
        // Asegurar que mapboxgl esté disponible antes de cargar mapbox-integration
        if (typeof mapboxgl === 'undefined') {
            console.error('❌ Mapbox GL JS no está cargado');
        } else {
            console.log('✅ Mapbox GL JS cargado y disponible, versión:', mapboxgl.version);
        }
    </script>
    <script src="dist/mapbox-integration.min.js" defer></script>
    <script src="dist/main.min.js" defer></script>
    <style>
        * { box-sizing: border-box; }

        #map {
            z-index: 1000 !important; 
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Estilo específico para step 1 con video */
        section[data-step="1"] {
            background: none !important;
        }
        
        section[data-step="1"]::before,
        section[data-step="1"]::after {
            display: none !important;
        }
        
        /* Configuración del mapa base*/
        #map { 
            position: fixed; 
            top: 0; 
            left: 0;
            bottom: 0; 
            width: 100%; 
            height: 100vh;
            z-index: 1000; /* Aumentado para estar por encima de todo */
            /* Transiciones suaves */
            transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;
            transform-origin: top center;
            /* Estado inicial: oculto */
            opacity: 0;
            visibility: hidden;
            display: none; /* Añadido para garantizar que no se muestre inicialmente */
            /* Permitir que los eventos de scroll pasen al documento */
            pointer-events: none;
            /* Sin background-color para que el mapa base de Mapbox sea visible */
        }
        
        /* Estado activo del mapa */
        #map.active {
            opacity: 1;
            visibility: visible;
            display: block;
            /* Activar eventos del mapa solo cuando está activo */
            pointer-events: auto;
        }
        
        /* Asegurar que el canvas del mapa tenga opacidad completa */
        #map .mapboxgl-canvas {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Leyenda del mapa */
        #map-legend { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map-legend .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; line-height: 1.3; }
        #map-legend .legend-swatch { width: 18px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.2); flex: 0 0 18px; }
        #map-legend .legend-label { flex: 1 1 auto; color: #222; }
        @media (max-width: 640px) {
            #map-legend { right: 10px; bottom: 10px; min-width: 180px; }
        }
        
        /* Asegurar que las capas del mapa se muestren con colores nítidos */
        #map .mapboxgl-canvas-container {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Forzar que el control container sea visible */
        #map .mapboxgl-control-container {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Zona de scroll en los bordes del mapa */
        #map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Crear zonas de scroll en los bordes */
        .map-scroll-zone {
            position: absolute;
            background: transparent;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .map-scroll-zone.top {
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
        }
        
        .map-scroll-zone.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
        }
        
        /* Estilo para el botón de cierre de mapa */
        .map-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #FB8500; 
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer !important;
            z-index: 99999 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            transition: all 0.2s ease !important;
            pointer-events: auto !important; /* Asegurarse de que siempre capture clics */
        }

        
        /* Asegurarse de que los steps con mapa permitan el scroll */
        .step.has-map {
            z-index: 3; /* Por encima del mapa para permitir scroll */
        }
        
        /* Estilos para el scrollytelling */
        #scroller {
            position: relative;
            z-index: 1;
            background: transparent;
        }
        
        .step {
            margin: 0;
            padding: 100px 50px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* Estilos especiales para los steps de años urbanos */
        .step.urban-year-image {
            padding: 0 !important;
            margin: 0 !important;
            background: transparent !important;
            z-index: 2;
            color: transparent !important;
        }
        
        .step.has-map {
            /* Steps con mapas/visualizaciones - fondo transparente, sin texto */
            background: transparent;
        }
        
        .step.has-map .step-content {
            /* Ocultar completamente el contenido de texto en steps de mapa */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* Estilos diferenciados para steps de texto vs mapa/visualizaciones */
        .step:not(.has-map):not(.urban-year-image) {
            /* Steps de texto - fondo blanco uniforme */
            background: #FFFFFF;
            color: #000000;
        }
        
        /* Estilo del contenido de texto*/
        .step-content {
    font-size: 24px;
    font-weight: normal;
    text-shadow: none;
    line-height: 1.6;
    max-width: 1200px;
    margin: 0 auto;
}
        
        /* Excepción para que la sombra no se aplique al contenido del gráfico */
        .chart-container text,
        .chart-container .data-selector,
        .chart-container .data-selector label {
            text-shadow: none;
        }
        
        .step-content h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: none;
            color: #000000;
            text-align: center;
        }
        
        .step-content h2 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: none;
            color: #000000;
            text-align: center;
        }
        
        .step-content p {
            margin-bottom: 20px;
            font-size: 20px;
            color: #000000;
        }
        
        .step-content strong {
            font-weight: 700;
            text-shadow: none;
            color: #000000;
        }
        
        /* Estilos para el gráfico interactivo con D3 */
        .chart-container {
            width: 100%;
            height: 550px;
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            overflow: visible;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #populationGrowthChart,
        #vehicleGrowthChart {
            width: 100%;
            height: 100%;
            min-height: 480px;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container .axis path,
        .chart-container .axis line {
            stroke: rgba(120, 120, 120, 0.2);
            shape-rendering: crispEdges;
        }
        
        .chart-container .axis text {
            fill: #000000;
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container .bar {
            fill: url(#bar-gradient);
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 1px;
            transition: all 0.3s;
        }
        
        .chart-container .bar:hover {
            filter: brightness(1.05);
            cursor: pointer;
        }
        
        .chart-container .value-label {
            font-size: 14px;
            font-weight: bold;
            fill: #000000;
            text-anchor: middle;
            filter: none;
            text-shadow: none;
        }
        
        .chart-container .title {
            font-size: 18px;
            font-weight: bold;
            fill: #000000;
            text-anchor: middle;
        }
        
        .chart-container .grid line {
            stroke: rgba(200, 200, 200, 0.2);
        }
        
        /* Estilos para el tooltip */
        .chart-container .tooltip {
            position: absolute;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            border-left: 4px solid #FB8500;
            min-width: 180px;
            transform: translateY(0);
        }
        
        .chart-container .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.97) transparent transparent transparent;
        }
        
        .chart-container .tooltip p {
            margin: 5px 0;
        }
        
        .chart-container .tooltip .value {
            color: #FB8500;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Transición de imágenes para la evolución urbana */
        .urban-evolution-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
        }
        
        .urban-evolution-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            background-size: cover;
            background-position: center;
        }
        
        .urban-evolution-image.active {
            opacity: 1;
        }

        /* Estilos específicos para las imágenes de evolución urbana */
        .urban-year-image {
            position: relative;
            width: 100%;
            height: 100vh;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        
        /* Contenedor de fondo para evolución urbana */
        #urban-evolution-background {
            pointer-events: none;
            background-color: #FFFFFF; /* Fondo blanco uniforme detrás de evolución urbana */
        }
        
        .urban-bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .urban-bg-image.active {
            opacity: 1;
        }
        

        
        /* Footer */
        .footer {
            background-color: #023047;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }
        
        .footer img {
            max-height: 60px;
            margin: 10px;
        }

        /* Crédito de foto en steps con imagen de fondo */
        .photo-credit {
            position: absolute;
            bottom: 14px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
            z-index: 5;
            pointer-events: auto;
        }
        .photo-credit a {
            color: #fff;
            text-decoration: underline;
        }
        .photo-credit a:hover {
            text-decoration: none;
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        
        /* Media queries para responsividad */
        @media (max-width: 768px) {
            .step {
                padding: 60px 20px;
            }
            
            .step-content h1 {
                font-size: 2em;
            }
            
            .step-content h2 {
                font-size: 1.5em;
            }
            
            .chart-container {
                height: 450px;
            }
            
            #populationGrowthChart,
            #vehicleGrowthChart {
                min-height: 380px;
            }
            
            /* Cuando está integrado en un step */
            .step .lizmap-scrolly-container {
                height: 400px !important;
                margin: 20px 0 !important;
            }
            
            /* Cuando está como overlay */
            .lizmap-scrolly-container.overlay {
                height: 100vh !important;
            }

            /* Último step: colocar la imagen debajo del texto en móvil */
            section[data-step="32"] > div {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            section[data-step="32"] .step-content {
                width: 100%;
                max-width: 700px;
            }
            section[data-step="32"] > div > div:last-child {
                width: 100%;
                display: flex;
                justify-content: center;
            }
            section[data-step="32"] > div > div:last-child img {
                width: 100%;
                height: auto;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa base de Mapbox -->
    <div id="map"></div>
    <!-- Leyenda de mapa (se rellena dinámicamente) -->
    <div id="map-legend" aria-live="polite" style="display:none; position: fixed; right: 14px; bottom: 14px; z-index: 2000; background: rgba(255,255,255,0.96); color: #222; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.18); padding: 10px 12px; min-width: 220px; pointer-events: none;">
        <div class="legend-title" style="font-weight: 700; font-size: 13px; margin-bottom: 8px;">Leyenda</div>
        <div class="legend-items" style="display: flex; flex-direction: column; gap: 6px;"></div>
    </div>
    
    <!-- Únicamente se usa el contenedor #map -->
    
    <!-- Botón X independiente que siempre estará por encima de todo -->
    <button id="emergency-close-btn" style="position:fixed; top:20px; left:20px; z-index:999999; width:60px; height:60px; font-size:36px; background:#FB8500; color:white; border:3px solid white; border-radius:50%; cursor:pointer; display:none; box-shadow:0 6px 16px rgba(0,0,0,0.7); align-items:center; justify-content:center; pointer-events:auto;" onclick="cerrarMapaAhora()">×</button>

    <script>
        // Función específica para cerrar el mapa directamente desde el botón X
        function cerrarMapaAhora() {
            console.log("¡BOTÓN X PRESIONADO! - Cerrando mapa ahora");
            
            // Cerrar el mapa usando la función de Mapbox
            if (window.mapboxHelper && typeof window.mapboxHelper.hideMapOverlay === 'function') {
                console.log("Cerrando mapa usando mapboxHelper");
                window.mapboxHelper.hideMapOverlay();
            }
            
            // Restaurar scroll y estados del body
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            document.body.classList.remove('showing-map');
            
            // Ocultar el botón X
            document.getElementById('emergency-close-btn').style.display = 'none';
            
            // Intentar método programático general
            if (typeof window.hideMapVisuals === 'function') {
                console.log("Usando hideMapVisuals");
                try {
                    window.hideMapVisuals();
                } catch(e) {
                    console.error("Error en hideMapVisuals:", e);
                }
            }
            
            console.log("Proceso de cierre de mapa completado");
            
            // Para evitar propagación de eventos
            return false;
        }
        
        // Mostrar botón X solo cuando el mapa esté visible y estemos en un paso con mapa
        setInterval(function() {
            const mapContainer = document.getElementById('map');
            let mapVisible = false;
            let currentStepHasMap = false;
            
            // Verificar si el paso actual tiene un mapa
            const currentStepElement = document.querySelector('.step.is-active');
            if (currentStepElement && currentStepElement.getAttribute('data-map') === 'true') {
                currentStepHasMap = true;
            }
            
            if (mapContainer) {
                mapVisible = window.getComputedStyle(mapContainer).display !== 'none' && 
                             window.getComputedStyle(mapContainer).visibility !== 'hidden' &&
                             window.getComputedStyle(mapContainer).opacity !== '0';
            }
            
            // Mostrar botón X solo si el mapa está visible Y estamos en un paso con mapa
            const emergencyButton = document.getElementById('emergency-close-btn');
            if (emergencyButton) {
                emergencyButton.style.display = (mapVisible && currentStepHasMap) ? 'flex' : 'none';
                console.log("Estado botón X:", (mapVisible && currentStepHasMap) ? "VISIBLE" : "oculto", 
                           "Paso con mapa:", currentStepHasMap ? "SÍ" : "NO",
                           mapContainer ? (mapContainer.classList.contains('overlay') ? "(overlay)" : "(integrado)") : "(sin contenedor)");
            }
        }, 1000);
        
        // Función de emergencia global para cerrar el mapa con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                console.log('¡Escape presionado! Intentando cerrar mapa...');
                cerrarMapaAhora();
            }
        });
    </script>
    
    <!-- Contenedor para imágenes de fondo -->
    <div id="image-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden;">
        <img src="" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    
    <!-- Contenedor para evolución urbana -->
    <div id="urban-evolution-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; display: none; visibility: hidden; opacity: 0; transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;">
        <!-- Las imágenes de años se insertarán aquí dinámicamente -->
    </div>
    
    <!-- Contenedor principal para el scrollytelling -->
    <main id="scroller">
        <!-- Step 1: Portada / Hook -->
        <section class="step" data-step="1" style="position: relative; overflow: hidden; background: none !important;">
            <!-- Video de fondo con mejor implementación -->
            <video autoplay muted loop playsinline preload="metadata" poster="assets/1.png" id="background-video" style="position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: -2;">
                <source src="assets/1.mp4" type="video/mp4">
                Tu navegador no soporta video HTML5.
            </video>
            
            <!-- Capa de color con transparencia mayor -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(2, 48, 71, 0.4); z-index: -1;"></div>
            
            <!-- Contenido sin estilo de las tarjetas normales -->
            <div style="position: relative; z-index: 5; max-width: 800px; margin: 0 auto; padding: 40px 20px; text-align: center;">
                <h1 style="font-size: 48px; font-weight: bold; margin-bottom: 30px; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: white;">Cancún: Entre el Destino Global y la Ciudad Justa</h1>

            </div>
        </section>

        <!-- Step 2: Imagen cuadernobancodemex.jpg -->
        <section class="step" data-step="2" style="min-height: 100vh; background-color: #023047; display: flex; align-items: flex-start; justify-content: center; position: relative; z-index: 2; padding-top: 15vh;">
            <div style="max-width: 320px; width: 90%; position: relative; z-index: 3;">
                <img src="assets/cuadernobancodemex.jpg" alt="Cuaderno Banco de México" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: block;">
            </div>
            <div class="photo-credit" style="position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.5); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; line-height: 1.3; z-index: 4;">
                Fuente: <a href="https://cgc.qroo.gob.mx/cjg/wp-content/uploads/2019/11/Cap-09-OK-Mayo-7.pdf" target="_blank" rel="noopener" title="Capítulo 9 - cgc.qroo.gob.mx">cgc.qroo.gob.mx</a>
        </section>


        <!-- Step 3: Digging in (Introducción al caso) -->
        <section class="step" data-step="3">
            <div class="step-content">
                <h2>De Proyecto Planificado a Ciudad Viva</h2>
                <p>Cancún no fue solo un destino turístico, sino un proyecto político y tecnocrático. Nació en 1969, en un momento en que el gobierno mexicano buscaba redefinir su imagen internacional tras Tlatelolco, proponiendo un <strong>"paraíso de alta tecnología, ordenado y apolítico"</strong>.</p>
                <p>Impulsado por tecnócratas del Banco de México, que buscaban una <strong>"industria sin chimeneas"</strong> para captar divisas, su ubicación fue seleccionada por algoritmos computacionales en un <strong>"lienzo en blanco"</strong>.</p>
                <p>El Plan Maestro original codificó intencionalmente la tensión que vemos hoy: una <strong>"dualidad urbana"</strong> que separaba funcional y físicamente la isla de 19 km para el <strong>"turismo de clase mundial"</strong> de la zona continental, diseñada como el <strong>"centro de apoyo logístico y residencial"</strong> para la fuerza laboral.</p>
            </div>
        </section>
        
        <!-- Step 4: Mapa histórico de la franja hotelera y supermanzanas iniciales -->
        <section class="step has-map" data-step="4" data-map="true" data-map-layer="desarrollo_historico" data-map-view="hotelera">
            <div class="step-content">
                <h2>Mapa histórico de la franja hotelera y supermanzanas iniciales</h2>
                <p>Visualización del desarrollo histórico de Cancún, mostrando el contraste entre la franja hotelera turística y las supermanzanas residenciales diseñadas bajo los principios de proximidad y accesibilidad peatonal.</p>
            </div>
        </section>

        <!-- Step 5: Población en perspectiva -->
        <section class="step" data-step="5">
            <div class="step-content">
                <h2>Cinco Décadas de Crecimiento Extraordinario</h2>
                <p>Detrás de las cifras de crecimiento explosivo está el componente humano: <strong>"La Década de los Pioneros"</strong>. Los primeros equipos llegaron en enero de 1970 y tuvieron que <strong>"abrir brecha a machete"</strong> en la selva.</p>
                <p>Vivían en campamentos improvisados, en un entorno agreste sin servicios básicos. Esta experiencia de desafío colectivo forjó la identidad de la ciudad, creando un <strong>"mosaico de acentos, costumbres y esperanzas"</strong> y estableciendo el <strong>"ADN migrante, dinámico y multicultural"</strong> que define a Cancún hasta hoy.</p>
                
                <div class="chart-container">
                    <div id="populationGrowthChart"></div>
                    <div class="tooltip"></div>
                </div>
            </div>
        </section>

        <!-- Step 6: Imagen 6.jpg -->
        <section class="step" data-step="6" style="position: relative; min-height: 100vh;">
            <div class="lazy-bg" data-bg="assets/6.jpg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center;"></div>
        </section>

        <!-- Step 7: Expansión urbana sin freno -->
        <section class="step" data-step="7">
            <div class="step-content">
                <h2>Expansión Urbana Sin Freno</h2>
                <p>El modelo expansivo no solo fue rápido, fue segregado. La expansión, especialmente en los años 90, consolidó la fragmentación de Cancún en <strong>"tres ciudades"</strong> funcional y socialmente separadas: una para los turistas en la Zona Hotelera, otra para residentes acomodados en fraccionamientos privados, y una tercera, <strong>"precaria y con servicios deficientes"</strong>, para la mayoría de la fuerza laboral en asentamientos irregulares.</p>
                <p>Esta desigualdad no fue un fracaso del plan original, sino el <strong>"resultado lógico de su éxito"</strong> y de su dualidad codificada.</p>
            </div>
        </section>

        <!-- Step 8: Imagen 1975.jpg -->
        <section class="step urban-year-image" data-step="8" data-year="1975">
            <div class="evidence-overlay" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <img src="assets/diario.jpg" alt="Documento histórico, diario de 1975" class="evidence-img" style="max-width: 100%; max-height: 80vh; width: auto; height: auto; object-fit: contain;">
            </div>
            <div class="photo-credit" style="position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.5); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; line-height: 1.3; z-index: 4;">
                Fuente: <a href="https://cgc.qroo.gob.mx/cjg/wp-content/uploads/2019/11/Cap-09-OK-Mayo-7.pdf" target="_blank" rel="noopener" title="Capítulo 9 - cgc.qroo.gob.mx">cgc.qroo.gob.mx</a>
            </div>
        </section>

        <!-- Step 9: Imagen 1980.jpg -->
        <section class="step urban-year-image lazy-bg" data-step="9" data-year="1980">
            <span class="year-label-mobile" style="position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:4px; font-size:14px; display:none;">1980</span>
        </section>

        <!-- Step 10: Imagen 1985.jpg -->
        <section class="step urban-year-image" data-step="10" data-year="1985">
        </section>

        <!-- Step 11: Imagen 1990.jpg -->
        <section class="step urban-year-image" data-step="11" data-year="1990">
        </section>

        <!-- Step 12: Imagen 1995.jpg -->
        <section class="step urban-year-image" data-step="12" data-year="1995">
        </section>

        <!-- Step 13: Imagen 2000.jpg -->
        <section class="step urban-year-image" data-step="13" data-year="2000">
        </section>

        <!-- Step 14: Imagen 2005.jpg -->
        <section class="step urban-year-image" data-step="14" data-year="2005">
        </section>

        <!-- Step 15: Imagen 2010.jpg -->
        <section class="step urban-year-image" data-step="15" data-year="2010">
        </section>

        <!-- Step 16: Imagen 2015.jpg -->
        <section class="step urban-year-image" data-step="16" data-year="2015">
        </section>

        <!-- Step 17: Imagen 2020.jpg -->
        <section class="step urban-year-image" data-step="17" data-year="2020">
        </section>

        <!-- Step 18: Imagen 2025.jpg -->
        <section class="step urban-year-image" data-step="18" data-year="2025">
        </section>

        <!-- Step 19: Dispersión poblacional y abandono del centro -->
        <section class="step" data-step="19">
            <div class="step-content">
                <h2>Dispersión Poblacional y Abandono del Centro</h2>
                <p><strong>Entre 2010 y 2020, las zonas centrales perdieron más del 10% de su población, mientras que las periferias crecieron hasta un 30%</strong>. Más suelo para menos personas: un fenómeno que incrementa costos de transporte, servicios e infraestructura.</p>
                <p>Revitalizar nuestros barrios centrales, fortalecer los espacios comunitarios y equilibrar el desarrollo urbano es fundamental para recuperar cohesión social y calidad de vida.</p>
                <p><strong>Apostar por un Cancún más compacto significa reactivar la vida urbana en sus centros y acercar servicios a quienes habitan en la periferia.</strong></p>
            </div>
        </section>
        
        <!-- Step 20: Mapa de tasa de cambio poblacional por AGEB (2010-2020) -->
        <section class="step has-map" data-step="20" data-map="true" data-map-layer="cambio_poblacional_ageb" data-map-view="ciudad_central">
            <div class="step-content">
                <h2>Mapa de tasa de cambio poblacional por AGEB (2010-2020)</h2>
                <p>Visualización del cambio poblacional en la ciudad, mostrando cómo las zonas centrales perdieron población mientras las periferias experimentaron crecimiento acelerado.</p>
            </div>
        </section>

        <!-- Step 21: Impacto ambiental -->
        <section class="step" data-step="21">
            <div class="step-content">
                <h2>El Costo Ambiental del Crecimiento</h2>
                <p>La vulnerabilidad a huracanes ha forjado el carácter de la ciudad. <strong>"Gilberto"</strong> en 1988 fue el <strong>"bautismo de fuego"</strong>, y la respuesta colectiva para reconstruir la ciudad creó un fuerte sentido de comunidad y una <strong>"cultura de huracanes"</strong>.</p>
                <p>Años después, el devastador <strong>"Wilma"</strong> en 2005 llevó esto a otro nivel, requiriendo una reconstrucción a mega escala donde las playas tuvieron que ser <strong>"reconstruidas artificialmente"</strong> con arena dragada, consolidando la imagen de Cancún como un <strong>"paraíso construido y sostenido por la tecnología humana"</strong>.</p>
                <p>Hoy, a la presión sobre selvas y manglares se suma una nueva crisis ambiental: los arribazones masivos de sargazo, vinculados al cambio climático.</p>
            </div>
        </section>
        
        <!-- Step 22: Mapa de pérdida de cobertura forestal (2000-2020) + ANP Nichupté -->
        <section class="step has-map" data-step="22" data-map="true" data-map-layer="perdida_vegetacion" data-map-view="area_natural">
            <div class="step-content">
                <h2>Mapa de pérdida de cobertura forestal (2000-2020)</h2>
                <p>Visualización de la pérdida de cobertura forestal y áreas naturales protegidas, destacando las más de 90 km² de vegetación perdidos y el impacto en la recarga de acuíferos y protección ante huracanes.</p>
            </div>
        </section>

        <!-- Step 23: Desigualdad territorial -->
        <section class="step" data-step="23">
            <div class="step-content">
                <h2>Desigualdad Territorial</h2>
                <p>El municipio está organizado en 22 distritos con densidades contrastantes: <strong>algunos superan los 100 habitantes por hectárea, mientras que otros no alcanzan los 10</strong>.</p>
                <p>La baja densidad en periferias implica acceso desigual a servicios y altos costos de mantenimiento urbano. Reducir estas brechas es un compromiso estratégico: más educación, salud y transporte cerca de cada hogar.</p>
                <p><strong>La equidad territorial es la base de una ciudad justa, competitiva y con oportunidades para todas y todos.</strong></p>
            </div>
        </section>
        
        <!-- Step 24: Mapa de densidad poblacional por distrito -->
        <section class="step has-map" data-step="24" data-map="true" data-map-layer="densidad_poblacional" data-map-view="distritos">
            <div class="step-content">
                <h2>Mapa de densidad poblacional por distrito</h2>
                <p>Visualización de los 22 distritos del municipio con sus densidades contrastantes, donde algunos superan los 100 habitantes por hectárea mientras otros no alcanzan los 10, evidenciando la desigualdad territorial.</p>
            </div>
        </section>

        <!-- Step 25: Imagen de la desigualdad territorial (imagen 23.jpg) -->
        <section class="step" data-step="25" style="position: relative; min-height: 100vh;">
            <div class="lazy-bg" data-bg="assets/23.jpg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center;"></div>
        </section>

        <!-- Step 26: Motorización acelerada -->
        <section class="step" data-step="26">
            <div class="step-content">
                <h2>Motorización Acelerada</h2>
                <p>El parque vehicular ha crecido más rápido que la población: <strong>de 186 mil autos en 2010 a más de 452 mil en 2023 (+142%)</strong>. Pasamos de 0.41 autos por vivienda en 2010 a casi 0.7 en 2020.</p>
                <p>Este crecimiento refuerza la dependencia del automóvil, genera congestión y multiplica las desigualdades: quienes no tienen vehículo enfrentan traslados más largos y menos oportunidades.</p>
                <p><strong>El gran desafío es construir un modelo de movilidad equitativa, con transporte público eficiente y movilidad activa accesible para todas y todos.</strong></p>
            </div>
        </section>

        <!-- Step 27: Gráfico interactivo del parque vehicular -->
        <section class="step" data-step="27">
            <div class="step-content">
                <h2>Evolución del Parque Vehicular</h2>
                <div class="chart-container">
                    <div id="vehicleGrowthChart"></div>
                    <div class="tooltip"></div>
                </div>
                <p style="text-align: center; font-size: 20px; margin-top: 10px;">Fuente: INEGI, Vehículos de Motor Registrados en Circulación (2010-2023) y Censos de Población y Vivienda (2010 y 2020).</p>
            </div>
        </section>

        <!-- Step 28: Consecuencias sociales y urbanas -->
        <section class="step" data-step="28">
            <div class="step-content">
                <h2>Consecuencias Sociales y Urbanas</h2>
                <p>El modelo expansivo se refleja en la vida cotidiana: más horas en traslados, servicios lejanos, menor convivencia comunitaria. La ciudad se encarece al mantener colonias lejanas y pierde cohesión social.</p>
                <p><strong>Pero este rumbo puede cambiar: priorizar calidad sobre extensión, proximidad sobre distancia, equidad sobre desigualdad.</strong></p>
                <p>Estamos a tiempo de transformar los costos invisibles en oportunidades de bienestar compartido.</p>
            </div>
        </section>

        <!-- Step 29: Fotos de tráfico + periferias con servicios insuficientes -->
        <section class="step" data-step="29" style="position: relative; min-height: 100vh; overflow: hidden; padding: 0; margin: 0;">
            <!-- Contenedor principal que ocupa toda la pantalla -->
            <div class="consequence-images-wrapper" style="display: flex; width: 100%; height: 100vh; position: relative;">
                <!-- Imagen 25.jpg a la izquierda (lazy) -->
                <div class="consequence-image-left lazy-bg" data-bg="assets/25.jpg"></div>
                
                <!-- Imagen 20.jpg a la derecha (lazy) -->
                <div class="consequence-image-right lazy-bg" data-bg="assets/20.jpg"></div>
            </div>
            
            <style>
                /* Estado base (oculto) */
                section[data-step="29"] .consequence-image-left,
                section[data-step="29"] .consequence-image-right {
                    flex: 1;
                    background-size: cover;
                    background-position: center;
                    opacity: 0;
                    transform: scale(0.9);
                }

                section[data-step="29"] .consequence-image-left {
                    /* background-image aplicado de forma perezosa vía data-bg */
                    transform: scale(0.9) translateX(-40px);
                }

                section[data-step="29"] .consequence-image-right {
                    /* background-image aplicado de forma perezosa vía data-bg */
                    transform: scale(0.9) translateX(40px);
                }

                /* Animaciones */
                @keyframes popupLeft {
                    0% { opacity: 0; transform: scale(0.9) translateX(-40px); }
                    100% { opacity: 1; transform: scale(1) translateX(0); }
                }

                @keyframes popupRight {
                    0% { opacity: 0; transform: scale(0.9) translateX(40px); }
                    100% { opacity: 1; transform: scale(1) translateX(0); }
                }

                /* Entrando hacia abajo (desde arriba) */
                section[data-step="29"].animate-down .consequence-image-left { animation: popupLeft 0.6s ease-out 0.1s forwards; }
                section[data-step="29"].animate-down .consequence-image-right { animation: popupRight 0.6s ease-out 0.25s forwards; }

                /* Entrando hacia arriba (desde abajo) - reutilizamos animación para consistencia */
                section[data-step="29"].animate-up .consequence-image-left { animation: popupLeft 0.6s ease-out 0.1s forwards; }
                section[data-step="29"].animate-up .consequence-image-right { animation: popupRight 0.6s ease-out 0.25s forwards; }
            </style>
        </section>

        <!-- Step 30: Estrategias de Futuro -->
        <section class="step" data-step="30">
            <div class="step-content">
                <h2>Estrategias de Futuro</h2>
                <p>Las estrategias de futuro, como la <strong>"ciudad de la proximidad"</strong> de 15 minutos, no son solo una tendencia global importada, sino un regreso a la lógica fundacional de las supermanzanas del centro.</p>
                <p>El futuro de Cancún también se está adaptando a nuevas tendencias como los <strong>"nómadas digitales"</strong> y el <strong>"workation"</strong>.</p>
                <p>Sin embargo, la próxima era de la ciudad será definida por megaproyectos de conectividad que buscan reconfigurar la península, notablemente el Puente Vehicular Nichupté y, de forma crucial, el Tren Maya.</p>
            </div>
        </section>

        <!-- Step 31: Imagen 26.jpg -->
        <section class="step" data-step="31" style="position: relative; min-height: 100vh;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('assets/26.jpg'); background-size: cover; background-position: center;"></div>
            <div class="photo-credit">
                Fotografía: Parque de la Equidad en Cancún. Fuente: <a href="https://cgc.qroo.gob.mx/avanza-con-paso-firme-el-parque-de-la-equidad-en-cancun/" target="_blank" rel="noopener" title="Avanza con paso firme el Parque de la Equidad en Cancún - cgc.qroo.gob.mx">cgc.qroo.gob.mx</a>
            </div>
        </section>

        <!-- Step 32: Looking ahead (Cierre / Call to action) -->
        <section class="step" data-step="32" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)); color: white;">
            <div style="display: flex; align-items: center; max-width: 1200px; margin: 0 auto; gap: 30px;">
                <!-- Columna de texto a la izquierda -->
                <div class="step-content" style="flex: 1;">
                    <h2>El Futuro Está en Nuestras Manos</h2>
                    <p><strong>Cancún seguirá creciendo. La pregunta es: ¿cómo lo haremos?</strong></p>
                    <p>Hoy tenemos la posibilidad de transformar los retos en oportunidades y proyectar un Cancún ordenado, resiliente y justo. Desde el IMPLAN impulsamos estrategias de planeación que priorizan la equidad, la sostenibilidad y la proximidad.</p>
                    <p>Pero la construcción de esta ciudad no depende solo del gobierno: requiere la participación activa de la ciudadanía.</p>
                    <p><strong>El futuro de Cancún está en nuestras manos, y juntos podemos hacerlo posible.</strong></p>
                </div>
                
                <!-- Imagen a la derecha -->
                <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
                    <img src="assets/27.png" loading="lazy" decoding="async" style="max-width: 100%; max-height: 70vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);" alt="Futuro de Cancún">
                </div>
            </div>
        </section>

        <!-- Footer con logo IMPLAN -->
        <div class="footer">
            <p>IMPLAN Cancún | Instituto de Planeación del Desarrollo Urbano</p>
            <p>© 2025 - Todos los derechos reservados</p>
        </div>
    </main>

    <script>
        // Este script ha sido movido a archivos externos:
        // - cancun-main.js: configuración principal de Scrollama y mapas
        // - population-chart.js: gráfico interactivo de población 
        // - urban-evolution.js: visualización de evolución urbana
        
        // Script adicional para configurar fondos de secciones específicas
        document.addEventListener('DOMContentLoaded', function() {
            // Lazy-load para fondos de secciones con data-bg
            (function(){
                const lazyBgs = Array.from(document.querySelectorAll('.lazy-bg[data-bg]'));
                if (!lazyBgs.length) return;
                const supportIO = 'IntersectionObserver' in window;
                const applyBg = (el) => {
                    if (el.dataset.bgApplied) return;
                    const url = el.getAttribute('data-bg');
                    if (!url) return;
                    // Preload de imagen para evitar flash
                    const img = new Image();
                    img.onload = () => {
                        el.style.backgroundImage = `url('${url}')`;
                        el.dataset.bgApplied = '1';
                    };
                    img.src = url;
                };
                if (!supportIO) {
                    lazyBgs.forEach(applyBg);
                    return;
                }
                const io = new IntersectionObserver((entries)=>{
                    entries.forEach(entry=>{
                        if (entry.isIntersecting || entry.intersectionRatio > 0) {
                            applyBg(entry.target);
                            io.unobserve(entry.target);
                        }
                    });
                }, { root: null, rootMargin: '300px 0px', threshold: 0.01 });
                lazyBgs.forEach(el=>io.observe(el));
            })();
            // La configuración de fondo para la sección de cierre ha sido eliminada
            // El step 30 ahora usa solo el fondo de color sin imagen
            
            // Configurar otros fondos de secciones según sea necesario
            // Se reemplazó la asignación inmediata de background-image por lazy-load con .lazy-bg
            // La sección con fotos de tráfico ha sido eliminada
            
            // Asegurarnos de que el video de fondo se reproduce correctamente
            const bgVideo = document.getElementById('background-video');
            if (bgVideo) {
                console.log('Video de fondo encontrado, asegurando reproducción...');
                
                // Forzar la reproducción del video sin añadir botón
                const playPromise = bgVideo.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log('Video de fondo reproduciendo correctamente');
                    }).catch(error => {
                        console.warn('No se pudo reproducir el video automáticamente:', error);
                        // En caso de error, simplemente volvemos a intentar reproducir el video
                        setTimeout(() => {
                            bgVideo.play().catch(e => console.log('Segundo intento fallido, pero continuamos sin botón'));
                        }, 1000);
                    });
                }
                
                // Asegurarnos de que el video se mantenga en proporción y cubra la pantalla
                const handleResize = () => {
                    const step1 = document.querySelector('section[data-step="1"]');
                    if (step1 && bgVideo) {
                        const aspectRatio = bgVideo.videoWidth / bgVideo.videoHeight;
                        const containerWidth = step1.offsetWidth;
                        const containerHeight = step1.offsetHeight;
                        
                        if ((containerWidth / containerHeight) < aspectRatio) {
                            bgVideo.style.width = 'auto';
                            bgVideo.style.height = '100%';
                        } else {
                            bgVideo.style.width = '100%';
                            bgVideo.style.height = 'auto';
                        }
                    }
                };
                
                // Llamar al resize inicial y en cada cambio de tamaño
                window.addEventListener('resize', handleResize);
                bgVideo.addEventListener('loadedmetadata', handleResize);
            }
        });
    </script>
</body>
</html>