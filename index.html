<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancún: Entre el Destino Global y la Ciudad Justa</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <script src="lizmap-config.js"></script>
    <script src="lizmap-manager.js"></script>
    <script src="lizmap-scrollama-integration.js"></script>
    <script src="population-chart.js"></script>
    <script src="vehicle-chart.js?v=1727244000"></script>
    <script src="urban-evolution.js"></script>
    <script src="main.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Estilo específico para step 1 con video */
        section[data-step="1"] {
            background: none !important;
        }
        
        section[data-step="1"]::before,
        section[data-step="1"]::after {
            display: none !important;
        }
        
        /* Configuración del mapa base con transiciones tipo telón simplificadas */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0;
            bottom: 0; 
            width: 100%; 
            height: 100vh;
            z-index: 1; /* Debajo de Lizmap y steps */
            /* Transiciones suaves */
            transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;
            transform-origin: top center;
            /* Estado inicial: oculto */
            opacity: 0;
            visibility: hidden;
        }
        
        /* Estilos para el contenedor de Lizmap con transiciones de cortina */
        .lizmap-scrolly-container {
            width: 100% !important;
            background: white;
            transition: all 800ms cubic-bezier(0.4, 0, 0.2, 1) !important;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Cuando está como overlay (fuera del flujo) */
        .lizmap-scrolly-container.overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            height: 100vh !important;
            z-index: 1000 !important;
            display: none;
            opacity: 0;
            transform: translateY(-100%);
            visibility: hidden;
            pointer-events: none;
        }
        
        .lizmap-scrolly-container.overlay.curtain-up {
            opacity: 1 !important;
            transform: translateY(0) !important;
            visibility: visible !important;
            background: white !important;
            pointer-events: none !important;
        }
        
        .lizmap-scrolly-container.overlay.curtain-down {
            opacity: 0 !important;
            transform: translateY(-100%) !important;
            visibility: hidden !important;
            transition: all 800ms cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Cuando está integrado en un step (parte del flujo) */
        .step .lizmap-scrolly-container {
            position: relative !important;
            height: 600px !important;
            z-index: 1 !important;
            display: block !important;
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
            pointer-events: auto !important;
            margin: 20px 0 !important;
        }
        
        /* Estilo para el botón de cierre */
        .lizmap-close-btn {
            position: absolute !important;
            top: 20px !important;
            right: 20px !important;
            background-color: #FB8500 !important; /* Color naranja de la paleta */
            color: white !important;
            font-size: 36px !important;
            width: 60px !important;
            height: 60px !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            cursor: pointer !important;
            z-index: 99999 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            transition: all 0.2s ease !important;
            pointer-events: auto !important; /* Asegurarse de que siempre capture clics */
        }

        .lizmap-close-btn:hover {
            background-color: #FF9E2C !important;
            transform: scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7) !important;
        }

        .lizmap-close-btn:active {
            transform: scale(0.95) !important;
            background-color: #FF6500 !important;
        }
        
        /* Estilos para el iframe de Lizmap */
        .lizmap-scrolly-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        /* Asegurarse de que los steps con mapa permitan el scroll */
        .step.has-map {
            z-index: 3; /* Por encima del mapa para permitir scroll */
        }
        
        /* Estilos para el scrollytelling */
        #scroller {
            position: relative;
            z-index: 1;
            background: transparent;
        }
        
        .step {
            margin: 0;
            padding: 100px 50px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* Estilos especiales para los steps de años urbanos */
        .step.urban-year-image {
            padding: 0 !important;
            margin: 0 !important;
            background: transparent !important;
            z-index: 2;
            color: transparent !important;
        }
        
        .step.has-map {
            /* Steps con mapas/visualizaciones - fondo transparente, sin texto */
            background: transparent;
        }
        
        .step.has-map .step-content {
            /* Ocultar completamente el contenido de texto en steps de mapa */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* Estilos diferenciados para steps de texto vs mapa/visualizaciones */
        .step:not(.has-map):not(.urban-year-image) {
            /* Steps de texto - fondo gradiente como demo-lizmap */
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.95), rgba(25, 118, 210, 0.95));
            color: white;
        }
        
        /* Estilo del contenido de texto similar a demo-lizmap */
        .step-content {
            font-size: 24px;
            font-weight: normal;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Excepción para que la sombra no se aplique al contenido del gráfico */
        .chart-container text,
        .chart-container .data-selector,
        .chart-container .data-selector label {
            text-shadow: none;
        }
        
        .step-content h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            color: white;
            text-align: center;
        }
        
        .step-content h2 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            color: white;
            text-align: center;
        }
        
        .step-content p {
            margin-bottom: 20px;
            font-size: 20px;
            color: white;
        }
        
        .step-content strong {
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            color: white;
        }
        
        /* Estilos para el gráfico interactivo con D3 */
        .chart-container {
            width: 100%;
            height: 550px;
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            overflow: visible;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #populationGrowthChart {
            width: 100%;
            height: 100%;
            min-height: 480px;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container .axis path,
        .chart-container .axis line {
            stroke: rgba(120, 120, 120, 0.2);
            shape-rendering: crispEdges;
        }
        
        .chart-container .axis text {
            fill: #555;
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container .bar {
            fill: url(#bar-gradient);
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 1px;
            transition: all 0.3s;
        }
        
        .chart-container .bar:hover {
            filter: brightness(1.05);
            cursor: pointer;
        }
        
        .chart-container .value-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
            text-anchor: middle;
            filter: none;
            text-shadow: none;
        }
        
        .chart-container .title {
            font-size: 18px;
            font-weight: bold;
            fill: #023047;
            text-anchor: middle;
        }
        
        .chart-container .grid line {
            stroke: rgba(200, 200, 200, 0.2);
        }
        
        /* Estilos para el tooltip */
        .chart-container .tooltip {
            position: absolute;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            border-left: 4px solid #FB8500;
            min-width: 180px;
            transform: translateY(0);
        }
        
        .chart-container .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.97) transparent transparent transparent;
        }
        
        .chart-container .tooltip p {
            margin: 5px 0;
        }
        
        .chart-container .tooltip .value {
            color: #FB8500;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Transición de imágenes para la evolución urbana */
        .urban-evolution-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
        }
        
        .urban-evolution-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            background-size: cover;
            background-position: center;
        }
        
        .urban-evolution-image.active {
            opacity: 1;
        }

        /* Estilos específicos para las imágenes de evolución urbana */
        .urban-year-image {
            position: relative;
            width: 100%;
            height: 100vh;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        
        /* Contenedor de fondo para evolución urbana */
        #urban-evolution-background {
            pointer-events: none;
            background-color: #023047; /* Color de fondo para evitar flash blanco */
        }
        
        .urban-bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .urban-bg-image.active {
            opacity: 1;
        }
        

        
        /* Footer */
        .footer {
            background-color: #023047;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }
        
        .footer img {
            max-height: 60px;
            margin: 10px;
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        
        /* Media queries para responsividad */
        @media (max-width: 768px) {
            .step {
                padding: 60px 20px;
            }
            
            .step-content h1 {
                font-size: 2em;
            }
            
            .step-content h2 {
                font-size: 1.5em;
            }
            
            .chart-container {
                height: 450px;
            }
            
            #populationGrowthChart {
                min-height: 380px;
            }
            
            /* Cuando está integrado en un step */
            .step .lizmap-scrolly-container {
                height: 400px !important;
                margin: 20px 0 !important;
            }
            
            /* Cuando está como overlay */
            .lizmap-scrolly-container.overlay {
                height: 100vh !important;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa base de Mapbox -->
    <div id="map"></div>
    
    <!-- Contenedor para el mapa Lizmap -->
    <div id="lizmap-container" class="lizmap-scrolly-container">
        <!-- El iframe del mapa Lizmap se insertará aquí dinámicamente -->
    </div>
    
    <!-- Botón X independiente que siempre estará por encima de todo -->
    <button id="emergency-close-btn" style="position:fixed; top:20px; right:20px; z-index:999999; width:80px; height:80px; font-size:44px; background:#FB8500; color:white; border:3px solid white; border-radius:50%; cursor:pointer; display:none; box-shadow:0 6px 16px rgba(0,0,0,0.7); align-items:center; justify-content:center;" onclick="cerrarMapaAhora()">×</button>

    <script>
        // Función específica para cerrar el mapa directamente desde el botón X
        function cerrarMapaAhora() {
            console.log("¡BOTÓN X PRESIONADO! - Cerrando mapa ahora");
            
            // 1. Cerrar mediante manipulación directa del DOM (primero y rápido)
            console.log("Aplicando cierre manual directo");
            const container = document.querySelector('.lizmap-scrolly-container');
            if (container) {
                // Determinar si está dentro de un step o como overlay
                const isInStep = container.closest('.step') !== null;
                
                if (isInStep) {
                    // Está integrado en un step - ocultar completamente
                    console.log('Ocultando mapa integrado en step');
                    container.style.display = 'none';
                    container.style.opacity = '0';
                    container.style.visibility = 'hidden';
                    container.style.pointerEvents = 'none';
                    container.style.height = '0';
                    container.style.overflow = 'hidden';
                    
                    // Mover de vuelta al contenedor original
                    const originalContainer = document.getElementById('lizmap-container');
                    if (originalContainer && container.parentNode !== originalContainer) {
                        container.parentNode.removeChild(container);
                        originalContainer.appendChild(container);
                        console.log('Contenedor movido de vuelta al lugar original');
                    }
                } else {
                    // Está como overlay - aplicar animación de cortina
                    console.log('Ocultando mapa como overlay');
                    container.style.display = 'none';
                    container.style.opacity = '0';
                    container.style.visibility = 'hidden';
                    container.style.pointerEvents = 'none';
                    container.style.zIndex = '-1';
                    
                    // Añadir clase para animación
                    container.classList.remove('curtain-up');
                    container.classList.add('curtain-down');
                }
            }
            
            // 2. Restaurar scroll y estados del body
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            document.body.classList.remove('showing-map');
            
            // 3. Ocultar el botón X
            document.getElementById('emergency-close-btn').style.display = 'none';
            
            // 4. Intentar métodos programáticos
            if (typeof window.hideMapVisuals === 'function') {
                console.log("Usando hideMapVisuals");
                try {
                    window.hideMapVisuals();
                } catch(e) {
                    console.error("Error en hideMapVisuals:", e);
                }
            }
            
            if (typeof window.forceLizmapClose === 'function') {
                console.log("Usando forceLizmapClose");
                try {
                    window.forceLizmapClose();
                } catch(e) {
                    console.error("Error en forceLizmapClose:", e);
                }
            }
            
            if (window.lizmapManager && typeof window.lizmapManager.hide === 'function') {
                console.log("Usando lizmapManager.hide()");
                try {
                    window.lizmapManager.hide();
                } catch(e) {
                    console.error("Error en lizmapManager.hide:", e);
                }
            }
            
            if (window.LizmapScrollyManager && typeof window.LizmapScrollyManager.hide === 'function') {
                console.log("Usando LizmapScrollyManager.hide()");
                try {
                    window.LizmapScrollyManager.hide();
                } catch(e) {
                    console.error("Error en LizmapScrollyManager.hide:", e);
                }
            }
            
            console.log("Proceso de cierre de mapa completado");
            
            // Para evitar propagación de eventos
            return false;
        }
        
        // Mostrar botón X solo cuando el mapa esté visible y estemos en un paso con mapa
        setInterval(function() {
            const mapContainer = document.querySelector('.lizmap-scrolly-container');
            let mapVisible = false;
            let currentStepHasMap = false;
            
            // Verificar si el paso actual tiene un mapa
            const currentStepElement = document.querySelector('.step.is-active');
            if (currentStepElement && currentStepElement.getAttribute('data-map') === 'true') {
                currentStepHasMap = true;
            }
            
            if (mapContainer) {
                // Verificar si está como overlay
                const isOverlay = mapContainer.classList.contains('overlay');
                if (isOverlay) {
                    mapVisible = window.getComputedStyle(mapContainer).visibility !== 'hidden' || 
                               mapContainer.classList.contains('curtain-up');
                } else {
                    // Verificar si está integrado en un step
                    mapVisible = window.getComputedStyle(mapContainer).display !== 'none' && 
                               window.getComputedStyle(mapContainer).visibility !== 'hidden';
                }
            }
            
            // Mostrar botón X solo si el mapa está visible Y estamos en un paso con mapa
            const emergencyButton = document.getElementById('emergency-close-btn');
            if (emergencyButton) {
                emergencyButton.style.display = (mapVisible && currentStepHasMap) ? 'flex' : 'none';
                console.log("Estado botón X:", (mapVisible && currentStepHasMap) ? "VISIBLE" : "oculto", 
                           "Paso con mapa:", currentStepHasMap ? "SÍ" : "NO",
                           mapContainer ? (mapContainer.classList.contains('overlay') ? "(overlay)" : "(integrado)") : "(sin contenedor)");
            }
        }, 1000);
        
        // Función de emergencia global para cerrar el mapa con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                console.log('¡Escape presionado! Intentando cerrar mapa...');
                cerrarMapaAhora();
            }
        });
    </script>
    
    <!-- Contenedor para imágenes de fondo -->
    <div id="image-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden;">
        <img src="" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    
    <!-- Contenedor para evolución urbana -->
    <div id="urban-evolution-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0;">
        <!-- Las imágenes de años se insertarán aquí dinámicamente -->
    </div>
    
    <!-- Contenedor principal para el scrollytelling -->
    <main id="scroller">
        <!-- Step 1: Portada / Hook -->
        <section class="step" data-step="1" style="position: relative; overflow: hidden; background: none !important;">
            <!-- Video de fondo con mejor implementación -->
            <video autoplay muted loop playsinline id="background-video" style="position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: -2;">
                <source src="assets/1.mp4" type="video/mp4">
                Tu navegador no soporta video HTML5.
            </video>
            
            <!-- Capa de color con transparencia mayor -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(2, 48, 71, 0.4); z-index: -1;"></div>
            
            <!-- Contenido sin estilo de las tarjetas normales -->
            <div style="position: relative; z-index: 5; max-width: 800px; margin: 0 auto; padding: 40px 20px; text-align: center;">
                <h1 style="font-size: 48px; font-weight: bold; margin-bottom: 30px; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: white;">Cancún: Entre el Destino Global y la Ciudad Justa</h1>
                <p style="margin-bottom: 20px; font-size: 20px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">Cancún, destino internacional de primer nivel, es también un territorio urbano en constante transformación. Su crecimiento acelerado ha traído consigo retos de movilidad, sostenibilidad y justicia urbana.</p>
                <p style="margin-bottom: 20px; font-size: 20px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">Hoy, la gran oportunidad de nuestra ciudad es compatibilizar su liderazgo turístico global con la construcción de un espacio habitable, equitativo y resiliente para todas y todos sus habitantes.</p>
                <p style="margin-bottom: 20px; font-size: 20px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);"><strong>En esta contradicción se juega no solo la competitividad del destino, sino la posibilidad de construir un Cancún justo, sostenible y con calidad de vida.</strong></p>
            </div>
        </section>

        <!-- Step 2: Imagen 2.jpg -->
        <section class="step" data-step="2" style="position: relative; min-height: 100vh;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('assets/2.jpg'); background-size: cover; background-position: center; background-attachment: fixed;"></div>
        </section>

        <!-- Step 3: Digging in (Introducción al caso) -->
        <section class="step" data-step="3">
            <div class="step-content">
                <h2>De Proyecto Planificado a Ciudad Viva</h2>
                <p>A diferencia de muchas ciudades costeras de América Latina, Cancún nació como un proyecto planificado bajo el modelo de los Centros Integralmente Planeados de FONATUR en los años setenta.</p>
                <p>Desde su origen se trazaron dos espacios en tensión: <strong>la franja turística frente al Caribe y la ciudad continental separada por la laguna Nichupté</strong>.</p>
                <p>Lo que comenzó como un modelo de modernidad turística pronto se convirtió en el hogar de cientos de miles de familias. Este tránsito de destino global a ciudad viva explica gran parte de los retos actuales: desigualdades, expansión acelerada y presión ambiental, pero también abre la puerta a imaginar un Cancún más inclusivo y cercano.</p>
            </div>
        </section>
        
        <!-- Step 4: Mapa histórico de la franja hotelera y supermanzanas iniciales (usando Lizmap) -->
        <section class="step has-map" data-step="4" data-map="true" data-map-layer="desarrollo_historico" data-map-view="hotelera">
            <div class="step-content">
                <h2>Mapa histórico de la franja hotelera y supermanzanas iniciales</h2>
                <p>Visualización del crecimiento histórico de Cancún.</p>
            </div>
        </section>

        <!-- Step 5: Población en perspectiva -->
        <section class="step" data-step="5">
            <div class="step-content">
                <h2>Cinco Décadas de Crecimiento Extraordinario</h2>
                <p>En cinco décadas, <strong>Cancún pasó de 6,867 habitantes en 1970 a más de 911 mil en 2020</strong>. Este incremento del 441% en los setenta y del 375% en los noventa convirtió a nuestro municipio en uno de los territorios más dinámicos de América Latina.</p>
                <p>Esta urbanización acelerada desafió la capacidad de la planeación pública, pero también muestra la fuerza y resiliencia de quienes han hecho de Cancún su hogar.</p>
                <p><strong>Cada familia y cada migrante ha aportado al carácter único de la ciudad, construyendo un territorio de oportunidades y contrastes.</strong></p>
                
                <div class="chart-container">
                    <div id="populationGrowthChart"></div>
                    <div class="tooltip"></div>
                </div>
            </div>
        </section>

        <!-- Step 6: Imagen 6.jpg -->
        <section class="step" data-step="6" style="position: relative; min-height: 100vh;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('assets/6.jpg'); background-size: cover; background-position: center;"></div>
        </section>

        <!-- Step 7: Expansión urbana sin freno -->
        <section class="step" data-step="7">
            <div class="step-content">
                <h2>Expansión Urbana Sin Freno</h2>
                <p>El crecimiento poblacional se tradujo en expansión física: <strong>entre 1984 y 1990 la superficie urbana casi se duplicó, y entre 2000 y 2010 la mancha urbana se multiplicó en 145%</strong>.</p>
                <p>Aunque en la última década el ritmo bajó al 34%, la ciudad siguió consumiendo suelo más rápido que su población. El modelo expansivo ha privilegiado la extensión sobre la consolidación, generando altos costos de infraestructura y servicios.</p>
                <p><strong>Pero este reto es también una oportunidad: consolidar la ciudad existente, hacerla más eficiente y compacta, y aprovechar mejor cada metro cuadrado de suelo urbano.</strong></p>
            </div>
        </section>

        <!-- Step 8: Imagen 1975.jpg -->
        <section class="step urban-year-image" data-step="8" data-year="1975">
        </section>

        <!-- Step 9: Imagen 1980.jpg -->
        <section class="step urban-year-image" data-step="9" data-year="1980">
        </section>

        <!-- Step 10: Imagen 1985.jpg -->
        <section class="step urban-year-image" data-step="10" data-year="1985">
        </section>

        <!-- Step 11: Imagen 1990.jpg -->
        <section class="step urban-year-image" data-step="11" data-year="1990">
        </section>

        <!-- Step 12: Imagen 1995.jpg -->
        <section class="step urban-year-image" data-step="12" data-year="1995">
        </section>

        <!-- Step 13: Imagen 2000.jpg -->
        <section class="step urban-year-image" data-step="13" data-year="2000">
        </section>

        <!-- Step 14: Imagen 2005.jpg -->
        <section class="step urban-year-image" data-step="14" data-year="2005">
        </section>

        <!-- Step 15: Imagen 2010.jpg -->
        <section class="step urban-year-image" data-step="15" data-year="2010">
        </section>

        <!-- Step 16: Imagen 2015.jpg -->
        <section class="step urban-year-image" data-step="16" data-year="2015">
        </section>

        <!-- Step 17: Imagen 2020.jpg -->
        <section class="step urban-year-image" data-step="17" data-year="2020">
        </section>

        <!-- Step 18: Imagen 2025.jpg -->
        <section class="step urban-year-image" data-step="18" data-year="2025">
        </section>

        <!-- Step 19: Dispersión poblacional y abandono del centro -->
        <section class="step" data-step="19">
            <div class="step-content">
                <h2>Dispersión Poblacional y Abandono del Centro</h2>
                <p><strong>Entre 2010 y 2020, las zonas centrales perdieron más del 10% de su población, mientras que las periferias crecieron hasta un 30%</strong>. Más suelo para menos personas: un fenómeno que incrementa costos de transporte, servicios e infraestructura.</p>
                <p>Revitalizar nuestros barrios centrales, fortalecer los espacios comunitarios y equilibrar el desarrollo urbano es fundamental para recuperar cohesión social y calidad de vida.</p>
                <p><strong>Apostar por un Cancún más compacto significa reactivar la vida urbana en sus centros y acercar servicios a quienes habitan en la periferia.</strong></p>
            </div>
        </section>
        
        <!-- Step 20: Mapa de tasa de cambio poblacional por AGEB (2010-2020) -->
        <section class="step has-map" data-step="20" data-map="true" data-map-layer="cambio_poblacional_ageb" data-map-view="ciudad_central">
            <div class="step-content">
                <h2>Mapa de tasa de cambio poblacional por AGEB (2010-2020)</h2>
                <p>Visualización del cambio poblacional en la ciudad.</p>
            </div>
        </section>

        <!-- Step 21: Impacto ambiental -->
        <section class="step" data-step="21">
            <div class="step-content">
                <h2>El Costo Ambiental del Crecimiento</h2>
                <p>La expansión urbana ha presionado ecosistemas frágiles como selvas y manglares. <strong>Solo en 2006 se perdieron más de 90 km² de vegetación</strong>, comprometiendo la recarga de acuíferos, la protección ante huracanes y la captura de carbono.</p>
                <p>Cada hectárea perdida aumenta la vulnerabilidad de Cancún al cambio climático. Proteger estos ecosistemas no es solo un deber ambiental, es cuidar la vida y el futuro de nuestra ciudad.</p>
                <p><strong>Planear con responsabilidad es invertir en resiliencia climática y en seguridad para nuestras familias.</strong></p>
            </div>
        </section>
        
        <!-- Step 22: Mapa de pérdida de cobertura forestal (2000-2020) + ANP Nichupté -->
        <section class="step has-map" data-step="22" data-map="true" data-map-layer="perdida_vegetacion" data-map-view="area_natural">
            <div class="step-content">
                <h2>Mapa de pérdida de cobertura forestal (2000-2020)</h2>
                <p>Visualización de la pérdida de cobertura forestal y áreas naturales protegidas.</p>
            </div>
        </section>

        <!-- Step 23: Desigualdad territorial -->
        <section class="step" data-step="23">
            <div class="step-content">
                <h2>Desigualdad Territorial</h2>
                <p>El municipio está organizado en 22 distritos con densidades contrastantes: <strong>algunos superan los 100 habitantes por hectárea, mientras que otros no alcanzan los 10</strong>.</p>
                <p>La baja densidad en periferias implica acceso desigual a servicios y altos costos de mantenimiento urbano. Reducir estas brechas es un compromiso estratégico: más educación, salud y transporte cerca de cada hogar.</p>
                <p><strong>La equidad territorial es la base de una ciudad justa, competitiva y con oportunidades para todas y todos.</strong></p>
            </div>
        </section>
        
        <!-- Step 24: Mapa de densidad poblacional por distrito -->
        <section class="step has-map" data-step="24" data-map="true" data-map-layer="densidad_poblacional" data-map-view="distritos">
            <div class="step-content">
                <h2>Mapa de densidad poblacional por distrito</h2>
                <p>Visualización de la densidad poblacional por distritos.</p>
            </div>
        </section>

        <!-- Step 25: Imagen de la desigualdad territorial (imagen 23.jpg) -->
        <section class="step" data-step="25" style="position: relative; min-height: 100vh;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('assets/23.jpg'); background-size: cover; background-position: center;"></div>
        </section>

        <!-- Step 26: Motorización acelerada -->
        <section class="step" data-step="26">
            <div class="step-content">
                <h2>Motorización Acelerada</h2>
                <p>El parque vehicular ha crecido más rápido que la población: <strong>de 186 mil autos en 2010 a más de 452 mil en 2023 (+142%)</strong>. Pasamos de 0.41 autos por vivienda en 2010 a casi 0.7 en 2020.</p>
                <p>Este crecimiento refuerza la dependencia del automóvil, genera congestión y multiplica las desigualdades: quienes no tienen vehículo enfrentan traslados más largos y menos oportunidades.</p>
                <p><strong>El gran desafío es construir un modelo de movilidad equitativa, con transporte público eficiente y movilidad activa accesible para todas y todos.</strong></p>
            </div>
        </section>

        <!-- Step 27: Gráfico interactivo del parque vehicular -->
        <section class="step" data-step="27" style="max-width: 1400px; margin: 0 auto;">
            <div class="step-content" style="min-height: 100vh; padding: 20px;">
                <h2>Evolución del Parque Vehicular</h2>
                <p>Crecimiento del parque vehicular y autos por vivienda en Cancún.</p>

                <div class="chart-container" style="height: 80vh; width: 100%; margin: 20px auto; padding: 20px;">
                    <div id="vehicleGrowthChart" style="width: 100%; height: 100%; background-color: white;"></div>
                    <div class="tooltip"></div>
                </div>
            </div>
        </section>

        <!-- Step 28: Consecuencias sociales y urbanas -->
        <section class="step" data-step="28">
            <div class="step-content">
                <h2>Consecuencias Sociales y Urbanas</h2>
                <p>El modelo expansivo se refleja en la vida cotidiana: más horas en traslados, servicios lejanos, menor convivencia comunitaria. La ciudad se encarece al mantener colonias lejanas y pierde cohesión social.</p>
                <p><strong>Pero este rumbo puede cambiar: priorizar calidad sobre extensión, proximidad sobre distancia, equidad sobre desigualdad.</strong></p>
                <p>Estamos a tiempo de transformar los costos invisibles en oportunidades de bienestar compartido.</p>
            </div>
        </section>

        <!-- Step 29: Fotos de tráfico + periferias con servicios insuficientes -->
        <section class="step" data-step="29" style="position: relative; min-height: 100vh; overflow: hidden; padding: 0; margin: 0;">
            <!-- Contenedor principal que ocupa toda la pantalla -->
            <div style="display: flex; width: 100%; height: 100vh; position: relative;">
                <!-- Imagen 25.jpg a la izquierda -->
                <div class="consequence-image-left" style="flex: 1; background-image: url('assets/25.jpg'); background-size: cover; background-position: center; 
                           opacity: 0; transform: scale(0.8) translateX(-50px); 
                           animation: popupLeft 1.2s ease-out 0.3s forwards;"></div>
                
                <!-- Imagen 20.jpg a la derecha -->
                <div class="consequence-image-right" style="flex: 1; background-image: url('assets/20.jpg'); background-size: cover; background-position: center;
                            opacity: 0; transform: scale(0.8) translateX(50px);
                            animation: popupRight 1.2s ease-out 0.6s forwards;"></div>
            </div>
            
            <style>
                @keyframes popupLeft {
                    0% {
                        opacity: 0;
                        transform: scale(0.8) translateX(-50px);
                    }
                    100% {
                        opacity: 1;
                        transform: scale(1) translateX(0);
                    }
                }
                
                @keyframes popupRight {
                    0% {
                        opacity: 0;
                        transform: scale(0.8) translateX(50px);
                    }
                    100% {
                        opacity: 1;
                        transform: scale(1) translateX(0);
                    }
                }
            </style>
        </section>

        <!-- Step 30: Estrategias de Futuro -->
        <section class="step" data-step="30">
            <div class="step-content">
                <h2>Estrategias de Futuro</h2>
                <p>El futuro de Cancún no depende de crecer más, sino de <strong>crecer mejor</strong>. Contamos con experiencias que inspiran: las supermanzanas fundacionales, que integraban parques y equipamientos a escala de barrio; el Parque de la Equidad, con 16 km de espacio público y movilidad activa; y el PDU 2022, que propone una ciudad policéntrica, compacta y mixta.</p>
                <p>Todos apuntan hacia un mismo horizonte: <strong>la ciudad de la proximidad, donde vivienda, trabajo, educación y ocio estén a 15 minutos a pie o en bicicleta</strong>.</p>
                <p>No se trata de importar un modelo, sino de actualizar la lógica de proximidad con la que Cancún nació, adaptándola a los retos del siglo XXI.</p>
            </div>
        </section>

        <!-- Step 31: Imagen 26.jpg -->
        <section class="step" data-step="31" style="position: relative; min-height: 100vh;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('assets/26.jpg'); background-size: cover; background-position: center;"></div>
        </section>

        <!-- Step 32: Looking ahead (Cierre / Call to action) -->
        <section class="step" data-step="32" style="background: linear-gradient(135deg, rgba(13, 71, 161, 0.95), rgba(25, 118, 210, 0.95)); color: white;">
            <div style="display: flex; align-items: center; max-width: 1200px; margin: 0 auto; gap: 30px;">
                <!-- Columna de texto a la izquierda -->
                <div class="step-content" style="flex: 1;">
                    <h2>El Futuro Está en Nuestras Manos</h2>
                    <p><strong>Cancún seguirá creciendo. La pregunta es: ¿cómo lo haremos?</strong></p>
                    <p>Hoy tenemos la posibilidad de transformar los retos en oportunidades y proyectar un Cancún ordenado, resiliente y justo. Desde el IMPLAN impulsamos estrategias de planeación que priorizan la equidad, la sostenibilidad y la proximidad.</p>
                    <p>Pero la construcción de esta ciudad no depende solo del gobierno: requiere la participación activa de la ciudadanía.</p>
                    <p><strong>El futuro de Cancún está en nuestras manos, y juntos podemos hacerlo posible.</strong></p>
                </div>
                
                <!-- Imagen a la derecha -->
                <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
                    <img src="assets/27.png" style="max-width: 100%; max-height: 70vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);" alt="Futuro de Cancún">
                </div>
            </div>
        </section>

        <!-- Footer con logo IMPLAN -->
        <div class="footer">
            <p>IMPLAN Cancún | Instituto de Planeación del Desarrollo Urbano</p>
            <p>© 2025 - Todos los derechos reservados</p>
        </div>
    </main>

    <script>
        // Este script ha sido movido a archivos externos:
        // - cancun-main.js: configuración principal de Scrollama y mapas
        // - population-chart.js: gráfico interactivo de población 
        // - urban-evolution.js: visualización de evolución urbana
        
        // Script adicional para configurar fondos de secciones específicas
        document.addEventListener('DOMContentLoaded', function() {
            // La configuración de fondo para la sección de cierre ha sido eliminada
            // El step 30 ahora usa solo el fondo de color sin imagen
            
            // Configurar otros fondos de secciones según sea necesario
            const bgSections = {
                // "1" ha sido reemplazado por un video con overlay
                "2": "assets/2.jpg",
                "6": "assets/6.jpg",
                "25": "assets/23.jpg"
            };
            
            for (const [step, bgImage] of Object.entries(bgSections)) {
                const section = document.querySelector(`section[data-step="${step}"]`);
                if (section) {
                    section.classList.add('bg-image');
                    section.style.backgroundImage = `url('${bgImage}')`;
                    section.style.backgroundSize = "cover";
                    section.style.backgroundPosition = "center";
                    section.style.backgroundAttachment = "fixed";
                }
            }
            // La sección con fotos de tráfico ha sido eliminada
            
            // Asegurarnos de que el video de fondo se reproduce correctamente
            const bgVideo = document.getElementById('background-video');
            if (bgVideo) {
                console.log('Video de fondo encontrado, asegurando reproducción...');
                
                // Forzar la reproducción del video sin añadir botón
                const playPromise = bgVideo.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log('Video de fondo reproduciendo correctamente');
                    }).catch(error => {
                        console.warn('No se pudo reproducir el video automáticamente:', error);
                        // En caso de error, simplemente volvemos a intentar reproducir el video
                        setTimeout(() => {
                            bgVideo.play().catch(e => console.log('Segundo intento fallido, pero continuamos sin botón'));
                        }, 1000);
                    });
                }
                
                // Asegurarnos de que el video se mantenga en proporción y cubra la pantalla
                const handleResize = () => {
                    const step1 = document.querySelector('section[data-step="1"]');
                    if (step1 && bgVideo) {
                        const aspectRatio = bgVideo.videoWidth / bgVideo.videoHeight;
                        const containerWidth = step1.offsetWidth;
                        const containerHeight = step1.offsetHeight;
                        
                        if ((containerWidth / containerHeight) < aspectRatio) {
                            bgVideo.style.width = 'auto';
                            bgVideo.style.height = '100%';
                        } else {
                            bgVideo.style.width = '100%';
                            bgVideo.style.height = 'auto';
                        }
                    }
                };
                
                // Llamar al resize inicial y en cada cambio de tamaño
                window.addEventListener('resize', handleResize);
                bgVideo.addEventListener('loadedmetadata', handleResize);
            }
        });
    </script>
</body>
</html>