<!DOCTYPE html>
<html l        /* Configuración del mapa base con transiciones tipo telón simplificadas */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0;
            bottom: 0; 
            width: 100%; 
            height: 100vh;
            z-index: 1; /* Debajo del contenedor Lizmap (z-index: 2) */
            /* Transiciones suaves */
            transition: all 0.8s ease-in-out;
            transform-origin: top center;
            /* Estado inicial: oculto */
            opacity: 0;
            transform: translateY(-100%);
            visibility: hidden;
        }
        
        #map.curtain-up {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        
        #map.curtain-down {
            opacity: 0;
            transform: translateY(-100%);
            visibility: hidden;
        }>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lizmap Scrollytelling Integrado</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <!-- Comentado para evitar conflictos: <script src="main.js"></script> -->
    <script src="lizmap-config.js"></script>
    <script>console.log('lizmap-config.js cargado, lizmapLayerConfig:', typeof lizmapLayerConfig);</script>
    <script src="lizmap-manager.js"></script>
    <script>console.log('lizmap-manager.js cargado, LizmapScrollytellingManager:', typeof LizmapScrollytellingManager);</script>
    <script src="lizmap-scrollama-integration.js"></script>
    <script>console.log('lizmap-scrollama-integration.js cargado');</script>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Configuración del mapa base con transiciones tipo telón simplificadas */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0;
            bottom: 0; 
            width: 100%; 
            height: 100vh;
            z-index: 1; /* Debajo de Lizmap y steps */
            /* Transiciones suaves */
            transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;
            transform-origin: top center;
            /* Estado inicial: oculto */
            opacity: 0;
            visibility: hidden;
        }
        
        /* Estilos para el contenedor de Lizmap con transiciones de cortina */
        .lizmap-scrolly-container {
            transition: all 0.8s ease-in-out !important;
            opacity: 0;
            transform: translateY(100%);
            visibility: hidden;
        }
        
        .lizmap-scrolly-container.curtain-up {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        
        .lizmap-scrolly-container.curtain-down {
            opacity: 0;
            transform: translateY(-100%);
            visibility: hidden;
        }
        
        /* Estilos para el scrollytelling */
        #scroller {
            position: relative;
            z-index: 1;
            background: transparent;
        }
        
        .step {
            margin: 0;
            padding: 100px 50px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .step.has-map {
            /* Steps con mapas/visualizaciones - fondo transparente, sin texto */
            background: transparent;
        }
        
        .step.has-map .step-content {
            /* Ocultar completamente el contenido de texto en steps de mapa */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* Estos estilos son reemplazados por los de abajo para dar texto blanco y fondo azul */
        /* Se comentan para evitar conflictos */
        /*
        .step:nth-child(odd) {
            background: rgba(255, 255, 255, 0.95);
        }
        
        .step:nth-child(even) {
            background: rgba(248, 249, 250, 0.95);
        }
        */
        
        .step-content {
            max-width: 600px;
        }
        
        /* Estos estilos son sobrescritos más abajo para dar texto blanco */
        /*
        .step-content h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .step-content h2 {
            color: #34495e;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        */
        
        /* Estos estilos son sobrescritos más abajo para dar texto blanco */
        /*
        .step-content p {
            color: #555;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        */
        
        /* Estilos para el gráfico interactivo con D3 */
        .chart-container {
            width: 100%;
            height: 480px;
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
            border-left: 5px solid #FB8500;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #FB8500, #FFB703);
            border-radius: 12px 12px 0 0;
        }
        
        .chart-container .axis path,
        .chart-container .axis line {
            stroke: rgba(120, 120, 120, 0.2);
            shape-rendering: crispEdges;
        }
        
        .chart-container .axis text {
            fill: #555;
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container .bar {
            fill: url(#bar-gradient);
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 1px;
            transition: all 0.3s;
        }
        
        .chart-container .bar:hover {
            filter: brightness(1.05);
            cursor: pointer;
        }
        
        .chart-container .value-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
            text-anchor: middle;
            filter: none;
            text-shadow: none;
        }
        
        .chart-container .title {
            font-size: 18px;
            font-weight: bold;
            fill: #023047;
            text-anchor: middle;
        }
        
        .chart-container .grid line {
            stroke: rgba(200, 200, 200, 0.2);
        }
        
        .chart-container .annotation-note-title {
            font-weight: bold;
            font-size: 13px;
        }
        
        .chart-container .annotation-note-label {
            font-size: 12px;
        }
        
        .chart-container .annotation path {
            stroke: #FB8500;
            stroke-width: 2px;
        }
        
        .chart-container .tooltip {
            position: absolute;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            border-left: 4px solid #FB8500;
            min-width: 180px;
            transform: translateY(0);
        }
        
        .chart-container .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.97) transparent transparent transparent;
        }
        
        .chart-container .tooltip p {
            margin: 5px 0;
        }
        
        .chart-container .tooltip .value {
            color: #FB8500;
            font-weight: 700;
            font-size: 16px;
        }
        
        .chart-container .tooltip .growth {
            font-size: 13px;
            display: flex;
            align-items: center;
            margin-top: 8px;
            position: relative;
        }
        
        .chart-container .tooltip .growth::before {
            content: '↑';
            display: inline-block;
            margin-right: 5px;
            color: #FB8500;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .step {
                padding: 50px 20px;
            }
            
            .step-content h1 {
                font-size: 2em;
            }
            
            .step-content h2 {
                font-size: 1.5em;
            }
            
            .step.has-map .step-content {
                position: fixed;
                top: auto;
                bottom: 20px;
                left: 20px;
                right: 20px;
                transform: none;
                max-width: none;
            }
            
            .chart-container {
                height: 300px;
            }
        }
        
        /* Estilos diferenciados para steps de texto vs mapa/visualizaciones */
        .step:not(.has-map) {
            /* Steps de texto - fondo gradiente como demo-lizmap */
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.95), rgba(25, 118, 210, 0.95));
            color: white;
        }
        
        /* Estilo del contenido de texto similar a demo-lizmap */
        .step-content {
            font-size: 24px;
            font-weight: normal;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Excepción para que la sombra no se aplique al contenido del gráfico */
        .chart-container text {
            text-shadow: none;
        }
        
        .step-content h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            color: white;
            text-align: center;
        }
        
        .step-content h2 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            color: white;
            text-align: center;
        }
        
        .step-content p {
            margin-bottom: 20px;
            font-size: 20px;
            color: white;
        }
        
        .step-content strong {
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Contenedor para imágenes de fondo -->
    <div id="image-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden;">
        <img src="" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    
    <!-- Indicador de estado eliminado -->
    


    <main id="scroller">
        <!-- Sección 1: Portada / Hook -->
        <section class="step" data-step="1" style="position: relative; min-height: 100vh; background-image: url('assets/1.png'); background-size: cover; background-position: center;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(2, 48, 71, 0.75);"></div>
            <div class="step-content" style="background-color: transparent; position: relative; z-index: 2; border: none; box-shadow: none;">
                <h1 style="color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">Cancún: Entre el Destino Global y la Ciudad Justa</h1>
                <p style="color: white; background-color: transparent; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);">Cancún, destino internacional de primer nivel, es también un territorio urbano en constante transformación. Su crecimiento acelerado ha traído consigo retos de movilidad, sostenibilidad y justicia urbana.</p>
                <p style="color: white; background-color: transparent; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);">Hoy, la gran oportunidad de nuestra ciudad es compatibilizar su liderazgo turístico global con la construcción de un espacio habitable, equitativo y resiliente para todas y todos sus habitantes.</p>
                <p style="background-color: transparent;"><strong style="color: white; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);">En esta contradicción se juega no solo la competitividad del destino, sino la posibilidad de construir un Cancún justo, sostenible y con calidad de vida.</strong></p>
            </div>
        </section>

        <!-- Sección 2: Visual - Imagen aérea contrastando Zona Hotelera, Laguna Nichupté y ciudad continental -->
        <section class="step" data-step="2" style="position: relative; min-height: 150vh; background-image: url('assets/2.jpg'); background-size: cover; background-position: center; background-attachment: fixed;">
            <!-- Sin overlay, solo la imagen a pantalla completa con mayor espacio para verla completa -->
            <!-- Espacio adicional para asegurar que se vea completamente antes del mapa -->
            <div style="height: 100vh;"></div>
        </section>

        <!-- Sección 3: Digging in (Introducción al caso) -->
        <section class="step" data-step="3">
            <div class="step-content">
                <h2>De Proyecto Planificado a Ciudad Viva</h2>
                <p>A diferencia de muchas ciudades costeras de América Latina, Cancún nació como un proyecto planificado bajo el modelo de los Centros Integralmente Planeados de FONATUR en los años setenta.</p>
                <p>Desde su origen se trazaron dos espacios en tensión: <strong>la franja turística frente al Caribe y la ciudad continental separada por la laguna Nichupté</strong>.</p>
                <p>Lo que comenzó como un modelo de modernidad turística pronto se convirtió en el hogar de cientos de miles de familias. Este tránsito de destino global a ciudad viva explica gran parte de los retos actuales: desigualdades, expansión acelerada y presión ambiental, pero también abre la puerta a imaginar un Cancún más inclusivo y cercano.</p>
            </div>
        </section>
        
        <!-- Nueva Sección: Imagen 3.png después de "De Proyecto Planificado a Ciudad Viva" -->
        <section class="step" data-step="4" style="position: relative; min-height: 150vh; background-image: url('assets/3.png'); background-size: cover; background-position: center; background-attachment: fixed;">
            <!-- Sin overlay, solo la imagen a pantalla completa con mayor espacio para verla completa -->
            <div style="height: 100vh;"></div>
        </section>

        <!-- Step eliminado: Mapa histórico de la franja hotelera y supermanzanas iniciales -->
        <!-- Sección 6: Población en perspectiva -->
        <section class="step" data-step="6">
            <div class="step-content">
                <h2>Cinco Décadas de Crecimiento Extraordinario</h2>
                <p>En cinco décadas, <strong>Cancún pasó de 6,867 habitantes en 1970 a más de 911 mil en 2020</strong>. Este incremento del 441% en los setenta y del 375% en los noventa convirtió a nuestro municipio en uno de los territorios más dinámicos de América Latina.</p>
                <p>Esta urbanización acelerada desafió la capacidad de la planeación pública, pero también muestra la fuerza y resiliencia de quienes han hecho de Cancún su hogar.</p>
                <p><strong>Cada familia y cada migrante ha aportado al carácter único de la ciudad, construyendo un territorio de oportunidades y contrastes.</strong></p>
                
                <div class="chart-container">
                    <div id="populationGrowthD3Chart"></div>
                    <div class="tooltip"></div>
                </div>
            </div>
        </section>

        <!-- Sección 7: Visual - Gráfico comparativo (México – Mundo – Q. Roo – Benito Juárez, 1970–2020) -->
        <section class="step has-map" data-step="7" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>
            <!-- Step eliminado: mapa antes de cinco décadas de crecimiento -->
        <!-- Sección 8: Expansión urbana sin freno -->
        <section class="step" data-step="8">
            <div class="step-content">
                <h2>Expansión Urbana Sin Freno</h2>
                <p>El crecimiento poblacional se tradujo en expansión física: <strong>entre 1984 y 1990 la superficie urbana casi se duplicó, y entre 2000 y 2010 la mancha urbana se multiplicó en 145%</strong>.</p>
                <p>Aunque en la última década el ritmo bajó al 34%, la ciudad siguió consumiendo suelo más rápido que su población. El modelo expansivo ha privilegiado la extensión sobre la consolidación, generando altos costos de infraestructura y servicios.</p>
                <p><strong>Pero este reto es también una oportunidad: consolidar la ciudad existente, hacerla más eficiente y compacta, y aprovechar mejor cada metro cuadrado de suelo urbano.</strong></p>
            </div>
        </section>

        <!-- Sección 8: Visual - Gráfico de crecimiento de la mancha urbana (1984–2020) -->
        <section class="step has-map" data-step="9" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 9: Dispersión poblacional y abandono del centro -->
        <section class="step" data-step="10">
            <div class="step-content">
                <h2>Dispersión Poblacional y Abandono del Centro</h2>
                <p><strong>Entre 2010 y 2020, las zonas centrales perdieron más del 10% de su población, mientras que las periferias crecieron hasta un 30%</strong>. Más suelo para menos personas: un fenómeno que incrementa costos de transporte, servicios e infraestructura.</p>
                <p>Revitalizar nuestros barrios centrales, fortalecer los espacios comunitarios y equilibrar el desarrollo urbano es fundamental para recuperar cohesión social y calidad de vida.</p>
                <p><strong>Apostar por un Cancún más compacto significa reactivar la vida urbana en sus centros y acercar servicios a quienes habitan en la periferia.</strong></p>
            </div>
        </section>

        <!-- Sección 10: Visual - Mapa de tasa de cambio poblacional por AGEB (2010–2020) -->
        <section class="step has-map" data-step="10" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 11: Impacto ambiental -->
        <section class="step" data-step="11">
            <div class="step-content">
                <h2>El Costo Ambiental del Crecimiento</h2>
                <p>La expansión urbana ha presionado ecosistemas frágiles como selvas y manglares. <strong>Solo en 2006 se perdieron más de 90 km² de vegetación</strong>, comprometiendo la recarga de acuíferos, la protección ante huracanes y la captura de carbono.</p>
                <p>Cada hectárea perdida aumenta la vulnerabilidad de Cancún al cambio climático. Proteger estos ecosistemas no es solo un deber ambiental, es cuidar la vida y el futuro de nuestra ciudad.</p>
                <p><strong>Planear con responsabilidad es invertir en resiliencia climática y en seguridad para nuestras familias.</strong></p>
            </div>
        </section>

        <!-- Sección 12: Visual - Gráfico de pérdida de cobertura forestal (2000–2020) + mapa ANP Nichupté -->
        <section class="step has-map" data-step="12" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 13: Desigualdad territorial -->
        <section class="step" data-step="13">
            <div class="step-content">
                <h2>Desigualdad Territorial</h2>
                <p>El municipio está organizado en 22 distritos con densidades contrastantes: <strong>algunos superan los 100 habitantes por hectárea, mientras que otros no alcanzan los 10</strong>.</p>
                <p>La baja densidad en periferias implica acceso desigual a servicios y altos costos de mantenimiento urbano. Reducir estas brechas es un compromiso estratégico: más educación, salud y transporte cerca de cada hogar.</p>
                <p><strong>La equidad territorial es la base de una ciudad justa, competitiva y con oportunidades para todas y todos.</strong></p>
            </div>
        </section>

        <!-- Sección 14: Visual - Mapa de densidad poblacional por distrito -->
        <section class="step has-map" data-step="14" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 15: Motorización acelerada -->
        <section class="step" data-step="15">
            <div class="step-content">
                <h2>Motorización Acelerada</h2>
                <p>El parque vehicular ha crecido más rápido que la población: <strong>de 186 mil autos en 2010 a más de 452 mil en 2023 (+142%)</strong>. Pasamos de 0.41 autos por vivienda en 2010 a casi 0.7 en 2020.</p>
                <p>Este crecimiento refuerza la dependencia del automóvil, genera congestión y multiplica las desigualdades: quienes no tienen vehículo enfrentan traslados más largos y menos oportunidades.</p>
                <p><strong>El gran desafío es construir un modelo de movilidad equitativa, con transporte público eficiente y movilidad activa accesible para todas y todos.</strong></p>
            </div>
        </section>

        <!-- Sección 16: Visual - Gráfico del parque vehicular (2010–2023) + autos por vivienda -->
        <section class="step has-map" data-step="16" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 17: Consecuencias sociales y urbanas -->
        <section class="step" data-step="17">
            <div class="step-content">
                <h2>Consecuencias Sociales y Urbanas</h2>
                <p>El modelo expansivo se refleja en la vida cotidiana: más horas en traslados, servicios lejanos, menor convivencia comunitaria. La ciudad se encarece al mantener colonias lejanas y pierde cohesión social.</p>
                <p><strong>Pero este rumbo puede cambiar: priorizar calidad sobre extensión, proximidad sobre distancia, equidad sobre desigualdad.</strong></p>
                <p>Estamos a tiempo de transformar los costos invisibles en oportunidades de bienestar compartido.</p>
            </div>
        </section>

        <!-- Sección 18: Visual - Fotos de tráfico + periferias con servicios insuficientes -->
        <section class="step has-map" data-step="18" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 19: Sustainable Solutions (Estrategias de futuro) -->
        <section class="step" data-step="19">
            <div class="step-content">
                <h2>Estrategias de Futuro</h2>
                <p>El futuro de Cancún no depende de crecer más, sino de <strong>crecer mejor</strong>. Contamos con experiencias que inspiran: las supermanzanas fundacionales, que integraban parques y equipamientos a escala de barrio; el Parque de la Equidad, con 16 km de espacio público y movilidad activa; y el PDU 2022, que propone una ciudad policéntrica, compacta y mixta.</p>
                <p>Todos apuntan hacia un mismo horizonte: <strong>la ciudad de la proximidad, donde vivienda, trabajo, educación y ocio estén a 15 minutos a pie o en bicicleta</strong>.</p>
                <p>No se trata de importar un modelo, sino de actualizar la lógica de proximidad con la que Cancún nació, adaptándola a los retos del siglo XXI.</p>
            </div>
        </section>

        <!-- Sección 20: Visual - Mockup "antes/después" de calle completa + foto del Parque de la Equidad -->
        <section class="step has-map" data-step="20" style="min-height: 120vh;">
            <div style="height: 50vh;"></div>
        </section>

        <!-- Sección 21: Looking ahead (Cierre / Call to action) -->
        <section class="step" data-step="21">
            <div class="step-content">
                <h2>El Futuro Está en Nuestras Manos</h2>
                <p><strong>Cancún seguirá creciendo. La pregunta es: ¿cómo lo haremos?</strong></p>
                <p>Hoy tenemos la posibilidad de transformar los retos en oportunidades y proyectar un Cancún ordenado, resiliente y justo. Desde el IMPLAN impulsamos estrategias de planeación que priorizan la equidad, la sostenibilidad y la proximidad.</p>
                <p>Pero la construcción de esta ciudad no depende solo del gobierno: requiere la participación activa de la ciudadanía.</p>
                <p><strong>El futuro de Cancún está en nuestras manos, y juntos podemos hacerlo posible.</strong></p>
            </div>
        </section>
    </main>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibWVsbm90dGUiLCJhIjoiY21mNzhsc3FmMGtieTJrcTFtZ2FsZmNjMCJ9.z321w5lq62mb-7OQ4T8C0g';
        
        const mapboxMap = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-86.85, 21.05],
            zoom: 11
        });

        // Variables para Scrollama
        const scroller = scrollama();
        let currentStep = 0;
        let transitionInProgress = false;

        // Inicializar el mapa como oculto inmediatamente
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado - inicializando mapa como oculto');
            const mapElement = document.getElementById('map');
            mapElement.classList.add('curtain-down');
        });

        // Funciones para transiciones de mapa
        function showMapWithCurtainEffect() {
            console.log('Mostrando mapa con efecto telón');
            const mapElement = document.getElementById('map');
            console.log('Clases antes de mostrar:', mapElement.className);
            mapElement.classList.remove('curtain-down');
            mapElement.classList.add('curtain-up');
            console.log('Clases después de mostrar:', mapElement.className);
        }

        function hideMapWithCurtainEffect() {
            console.log('Ocultando mapa base con efecto telón');
            const mapElement = document.getElementById('map');
            console.log('Clases antes de ocultar:', mapElement.className);
            mapElement.classList.remove('curtain-up');
            mapElement.classList.add('curtain-down');
            console.log('Clases después de ocultar:', mapElement.className);
        }

        function hideAllMaps() {
            console.log('Ocultando todos los mapas');
            // Ocultar Lizmap si está disponible
            if (window.lizmapScrollytellingIntegration) {
                window.lizmapScrollytellingIntegration.hide();
            }
            // Ocultar mapa base
            hideMapWithCurtainEffect();
        }
        
        // Función updateStatus eliminada

        function triggerLizmapForStep(stepIndex) {
            if (transitionInProgress) {
                console.log(`Transición en progreso, ignorando step ${stepIndex}`);
                return;
            }
            
            transitionInProgress = true;
            console.log(`=== Activando mapa para step ${stepIndex} ===`);
            
            // Verificar si Lizmap está disponible y funcionando
            if (window.lizmapScrollytellingIntegration && 
                window.lizmapScrollytellingIntegration.manager && 
                window.lizmapScrollytellingIntegration.manager()) {
                
                console.log('✓ Lizmap disponible, activando...');
                // Primero ocultar el mapa base
                hideMapWithCurtainEffect();
                // Luego mostrar Lizmap con un delay apropiado
                setTimeout(() => {
                    try {
                        window.lizmapScrollytellingIntegration.showStep(stepIndex);
                        console.log(`✓ Lizmap activado para step ${stepIndex}`);
                    } catch (error) {
                        console.error(`Error activando Lizmap para step ${stepIndex}:`, error);
                        // Fallback al mapa base si hay error
                        showMapWithCurtainEffect();
                    }
                    
                    // Liberar el flag después de la transición
                    setTimeout(() => {
                        transitionInProgress = false;
                    }, 1000);
                }, 300);
            } else {
                console.log('⚠ Lizmap no disponible, usando mapa base Mapbox');
                // Si Lizmap no está disponible, mostrar el mapa base
                showMapWithCurtainEffect();
                setTimeout(() => {
                    transitionInProgress = false;
                }, 1000);
            }
        }

        // Configurar Scrollama
        function initScrollama() {
            console.log('Inicializando Scrollama...');
            scroller
                .setup({
                    step: '.step',
                    offset: 0.5,
                    progress: true,
                    debug: false
                })
                .onStepProgress(response => {
                    // Transición gradual basada en el progreso del scroll
                    const visualSteps = [1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
                    if (visualSteps.includes(response.index)) {
                        updateMapProgress(response.index, response.progress);
                    }
                })
                .onStepEnter(response => {
                    currentStep = response.index;
                    console.log('Entrando al step:', currentStep);
                    
                    // Agregar clase activa
                    document.querySelectorAll('.step').forEach(el => {
                        el.classList.remove('is-active', 'has-map');
                    });
                    response.element.classList.add('is-active');
                    
                    // Activar visualizaciones para steps que las requieren
                    const visualSteps = [1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
                    if (visualSteps.includes(currentStep)) {
                        console.log('Step con visualización detectado:', currentStep);
                        response.element.classList.add('has-map');
                        
                        setTimeout(() => {
                            triggerLizmapForStep(currentStep);
                        }, 200);
                    } else {
                        console.log('Step de texto detectado:', currentStep);
                        setTimeout(() => {
                            hideAllMaps();
                        }, 100);
                    }
                })
                .onStepExit(response => {
                    console.log('Saliendo del step:', response.index);
                    response.element.classList.remove('is-active', 'has-map');
                    
                    // Si estamos saliendo de un step con visualización
                    const exitingStep = response.index;
                    const visualSteps = [1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
                    if (visualSteps.includes(exitingStep)) {
                        // Pequeño delay para verificar si el siguiente step también tiene visualización
                        setTimeout(() => {
                            if (!visualSteps.includes(currentStep)) {
                                console.log('Saliendo de step con visualización, ocultando...');
                                hideAllMaps();
                            }
                        }, 100);
                    }
                });
        }

        // Función para transición gradual basada en progreso
        function updateMapProgress(stepIndex, progress) {
            console.log('Map progress update:', stepIndex, progress);
            
            // Calcular visibilidad basada en progreso del scroll
            const visibility = Math.max(0, Math.min(1, progress));
            
            // Usar el manager de Lizmap para transiciones suaves
            if (window.LizmapManager && window.LizmapManager.setOpacity) {
                window.LizmapManager.setOpacity(visibility);
            } else {
                // Fallback directo si el manager no está disponible
                const container = document.getElementById('lizmap-scrolly-container');
                if (container) {
                    container.style.opacity = visibility;
                    const scale = 0.9 + (0.1 * visibility);
                    const translateY = (1 - visibility) * 20;
                    container.style.transform = `translateY(${translateY}px) scale(${scale})`;
                }
            }
            
            // Cambiar configuración del mapa cuando el progreso sea suficiente
            const visualSteps = [1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
            if (progress > 0.4 && visualSteps.includes(stepIndex)) {
                // Solo mostrar si no está ya mostrado
                if (!window.LizmapManager || !window.LizmapManager.isVisible) {
                    triggerLizmapForStep(stepIndex);
                }
            } else if (progress < 0.2) {
                // Ocultar completamente si el progreso es muy bajo
                hideAllMaps();
            }
        }

        // Función para redimensionar Scrollama
        function handleResize() {
            scroller.resize();
        }

        // Inicialización
        mapboxMap.on('load', () => {
            mapboxMap.addControl(new mapboxgl.NavigationControl());
            console.log('Mapa base cargado');
            
            // Asegurar que todos los mapas inicen ocultos
            console.log('Inicializando mapas como ocultos...');
            hideAllMaps();
            
            // Esperar a que Lizmap esté inicializado antes de inicializar Scrollama
            waitForLizmapAndInitialize();
        });
        
        function waitForLizmapAndInitialize() {
            console.log('Esperando inicialización de Lizmap...');
            
            let attempts = 0;
            const maxAttempts = 20; // 10 segundos máximo
            
            const checkLizmap = () => {
                attempts++;
                console.log(`Intento ${attempts}: Verificando Lizmap...`);
                
                if (window.lizmapScrollytellingIntegration && window.lizmapScrollytellingIntegration.manager()) {
                    console.log('✓ Lizmap inicializado correctamente');
                    setTimeout(() => {
                        initScrollama();
                        console.log('✓ Sistema completo inicializado');
                    }, 100);
                } else if (attempts < maxAttempts) {
                    console.log('Lizmap aún no está listo, reintentando...');
                    setTimeout(checkLizmap, 500);
                } else {
                    console.warn('⚠ Lizmap no se inicializó en el tiempo esperado, continuando sin él');
                    setTimeout(() => {
                        initScrollama();
                        console.log('Sistema base inicializado (sin Lizmap)');
                    }, 100);
                }
            };
            
            checkLizmap();
        }

        // Event listeners
        window.addEventListener('resize', handleResize);
        


        // CSS adicional simplificado para evitar interferencias
        const additionalStyles = document.createElement('style');
        additionalStyles.textContent = `
            /* Lizmap interactivo pero permite scroll del documento */
            .lizmap-scrolly-container {
                pointer-events: none !important; /* No bloquea scroll */
            }
            
            .lizmap-scrolly-container.curtain-up {
                z-index: 10000 !important;
            }
            
            .lizmap-scrolly-iframe {
                pointer-events: auto !important; /* Solo el iframe es interactivo */
                user-select: auto !important;
                touch-action: pan-x pan-y zoom-inout !important; /* Permite interacción del mapa */
            }
            
            .lizmap-close-btn {
                pointer-events: auto !important; /* Botón de cerrar funcional */
            }
            
            /* Botón de test también debe ser interactivo */
            .lizmap-scrolly-container button {
                pointer-events: auto !important;
            }
            
            /* Asegurar que el scroll nunca se bloquee */
            body, html {
                overflow: auto !important;
            }
            
            /* Deshabilitar zoom con scroll en el iframe */
            .lizmap-scrolly-iframe {
                overflow: hidden !important;
            }
            
            /* Prevenir zoom con wheel en mapas */
            .lizmap-scrolly-container iframe {
                pointer-events: auto;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                transition: opacity 0.3s ease, transform 0.3s ease !important;
            }
            
            /* Transiciones suaves para contenedor principal */
            #lizmap-scrolly-container {
                transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                           transform 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                will-change: opacity, transform;
            }
            
            /* Animación de entrada suave para contenido */
            .step-content {
                animation: fadeInUp 0.6s ease-out;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(additionalStyles);
    </script>

    <!-- Script para el gráfico interactivo de crecimiento poblacional usando D3 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Datos de población de Cancún (Benito Juárez) a lo largo de las décadas
            const data = [
                { year: 1970, population: 6867, growth: null },
                { year: 1980, population: 37190, growth: 441.6, absolute: 30323 },
                { year: 1990, population: 176765, growth: 375.3, absolute: 139575 },
                { year: 2000, population: 419815, growth: 137.5, absolute: 243050 },
                { year: 2010, population: 659311, growth: 57.0, absolute: 239496 },
                { year: 2020, population: 911503, growth: 38.3, absolute: 252192 }
            ];
            
            // Función para formatear números con separadores de miles
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // Función para crear y animar el gráfico D3 cuando se hace visible
            function createD3Chart() {
                // Verificamos si el gráfico ya está creado
                if (d3.select('#populationGrowthD3Chart').select('svg').size() > 0) return;
                
                // Dimensiones y márgenes del gráfico
                const margin = {top: 60, right: 40, bottom: 60, left: 80};
                const container = document.getElementById('populationGrowthD3Chart');
                const width = container.clientWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;
                
                // Creamos el SVG
                const svg = d3.select('#populationGrowthD3Chart')
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);
                    
                // Definimos el gradiente
                const defs = svg.append("defs");
                const gradient = defs.append("linearGradient")
                    .attr("id", "bar-gradient")
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", 0)
                    .attr("y1", height)
                    .attr("x2", 0)
                    .attr("y2", 0);
                    
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "rgba(251, 133, 0, 0.7)");
                    
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#FB8500");
                
                // Escalas X e Y
                const x = d3.scaleBand()
                    .domain(data.map(d => d.year))
                    .range([0, width])
                    .padding(0.3);
                    
                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.population) * 1.1])
                    .range([height, 0]);
                
                // Añadimos el título del gráfico
                svg.append("text")
                    .attr("class", "title")
                    .attr("x", width / 2)
                    .attr("y", -30)
                    .text("Crecimiento Poblacional de Cancún (1970-2020)");
                
                // Añadimos las líneas de cuadrícula horizontales
                svg.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(y)
                        .tickSize(-width)
                        .tickFormat("")
                    );
                
                // Ejes X e Y
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x)
                        .tickFormat(d => d))
                    .selectAll("text")
                    .style("font-weight", "bold")
                    .style("font-size", "12px");
                    
                svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(y)
                        .tickFormat(d => {
                            if (d >= 1000000) return d / 1000000 + 'M';
                            if (d >= 1000) return d / 1000 + 'k';
                            return d;
                        }))
                    .selectAll("text")
                    .style("font-weight", "bold")
                    .style("font-size", "12px");
                
                // Tooltip mejorado
                const tooltip = d3.select('.chart-container .tooltip');
                
                // Creamos las barras con efecto de animación
                svg.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.year))
                    .attr("width", x.bandwidth())
                    .attr("y", height) // Empezamos desde abajo
                    .attr("height", 0) // Sin altura inicial
                    .attr("rx", 5) // Bordes redondeados
                    .attr("ry", 5) // Bordes redondeados
                    .on("mouseover", function(event, d) {
                        // Destacar la barra activa
                        d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("opacity", 0.9)
                            .attr("stroke-width", 2)
                            .attr("filter", "brightness(1.1)");
                        
                        // Mostrar tooltip mejorado con detalles
                        let tooltipContent = `
                            <p>Año: <strong>${d.year}</strong></p>
                            <p>Población: <span class="value">${formatNumber(d.population)}</span> habitantes</p>
                        `;
                        
                        // Agregar información sobre el crecimiento si existe
                        if (d.growth) {
                            tooltipContent += `
                                <p class="growth">Crecimiento: <span style="color:#FB8500; font-size:16px; font-weight:bold">+${d.growth}%</span></p>
                                <p class="growth" style="font-size:11px">desde ${d.year - 10} (+${formatNumber(d.absolute)} habitantes)</p>
                            `;
                        }
                        
                        tooltip.style("opacity", 1)
                            .style("left", (event.pageX - container.getBoundingClientRect().left - 50) + "px")
                            .style("top", (event.pageY - container.getBoundingClientRect().top - 120) + "px")
                            .html(tooltipContent);
                        
                        // Destacar también el valor numérico sobre la barra
                        svg.selectAll(".value-label")
                            .filter(label => label.year === d.year)
                            .transition()
                            .duration(200)
                            .attr("font-size", "16px")
                            .attr("font-weight", "bold")
                            .attr("fill", "#FB8500");
                            
                        // Si hay crecimiento, mostrar una etiqueta de porcentaje temporal y línea de comparación
                        if (d.growth) {
                            // Eliminar etiquetas temporales existentes primero
                            svg.selectAll(".temp-growth-label, .temp-comparison-line").remove();
                            
                            // Mostrar etiqueta de porcentaje
                            svg.append("text")
                                .attr("class", "temp-growth-label")
                                .attr("x", x(d.year) + x.bandwidth() / 2)
                                .attr("y", y(d.population) - 35)
                                .attr("text-anchor", "middle")
                                .attr("fill", "#FB8500")
                                .attr("font-weight", "bold")
                                .attr("font-size", "14px")
                                .text(`+${d.growth}%`)
                                .attr("opacity", 0)
                                .transition()
                                .duration(200)
                                .attr("opacity", 1);
                                
                            // Destacar solo la barra actual, sin líneas punteadas ni conexión con barras anteriores
                            // Podemos mantener una referencia a la década anterior para los datos
                            const prevYearIndex = data.findIndex(item => item.year === d.year - 10);
                            if (prevYearIndex >= 0) {
                                // Referencia disponible pero no añadimos ningún efecto visual entre barras
                            }
                        }
                    })
                    .on("mouseout", function(event, d) {
                        // Restaurar la barra a su estado normal
                        d3.select(this)
                            .transition()
                            .duration(300)
                            .attr("opacity", 1)
                            .attr("stroke-width", 1)
                            .attr("filter", null);
                            
                        // Restaurar también todas las barras a su estado original
                        svg.selectAll(".bar")
                            .transition()
                            .duration(300)
                            .attr("opacity", 1)
                            .attr("stroke-width", 1)
                            .attr("stroke", "rgba(255, 255, 255, 0.6)");
                        
                        // Ocultar el tooltip
                        tooltip.style("opacity", 0);
                        
                        // Restaurar el formato original de la etiqueta
                        svg.selectAll(".value-label")
                            .transition()
                            .duration(200)
                            .attr("font-size", "14px")
                            .attr("font-weight", "normal")
                            .attr("fill", "#333");
                            
                        // Eliminar etiquetas temporales
                        svg.selectAll(".temp-growth-label")
                            .transition()
                            .duration(200)
                            .attr("opacity", 0)
                            .remove();
                    })
                    .on("mousemove", function(event) {
                        // Actualizar posición del tooltip para que siga al cursor
                        tooltip
                            .style("left", (event.pageX - container.getBoundingClientRect().left - 50) + "px")
                            .style("top", (event.pageY - container.getBoundingClientRect().top - 120) + "px");
                    })
                    .transition() // Animación inicial
                    .delay((d, i) => i * 150)
                    .duration(1000)
                    .attr("y", d => y(d.population))
                    .attr("height", d => height - y(d.population))
                    .ease(d3.easeBounceOut);
                
                // Etiquetas de valor sobre las barras
                svg.selectAll(".value-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "value-label")
                    .attr("x", d => x(d.year) + x.bandwidth() / 2)
                    .attr("y", height) // Empezamos desde abajo
                    .attr("opacity", 0) // Inicialmente invisible
                    .text(d => formatNumber(d.population))
                    .transition()
                    .delay((d, i) => i * 150 + 700) // Un poco después de las barras
                    .duration(700)
                    .attr("y", d => y(d.population) - 10)
                    .attr("opacity", 1);
                
                // Anotaciones para destacar el crecimiento extraordinario
                if (width > 500) { // Solo si hay suficiente espacio
                    const annotations = [{
                        note: {
                            title: "Crecimiento Extraordinario",
                            label: "441.6% de incremento poblacional",
                            wrap: 150
                        },
                        connector: {
                            end: "arrow",
                            type: "curve",
                            curvature: 0.5
                        },
                        x: x(1980) + x.bandwidth() / 2,
                        y: y(37190) - 30,
                        dy: -30,
                        dx: -30
                    }];
                    
                    const makeAnnotations = d3.annotation()
                        .type(d3.annotationLabel)
                        .annotations(annotations);
                        
                    svg.append("g")
                        .attr("class", "annotation-group")
                        .attr("opacity", 0)
                        .call(makeAnnotations)
                        .transition()
                        .delay(1500)
                        .duration(800)
                        .attr("opacity", 1);
                }
                
                // Resaltar el período más dramático
                svg.append("path")
                    .attr("d", `M${x(1970) + x.bandwidth() / 2},${y(6867)} L${x(1990) + x.bandwidth() / 2},${y(176765)}`)
                    .attr("stroke", "#FFB703")
                    .attr("stroke-width", 3)
                    .attr("stroke-dasharray", "5,5")
                    .attr("fill", "none")
                    .attr("opacity", 0)
                    .transition()
                    .delay(2000)
                    .duration(800)
                    .attr("opacity", 0.7);
                    
                // Decorativos: círculos en los puntos clave
                svg.selectAll(".key-point")
                    .data([data[0], data[2]]) // 1970 y 1990
                    .enter()
                    .append("circle")
                    .attr("class", "key-point")
                    .attr("cx", d => x(d.year) + x.bandwidth() / 2)
                    .attr("cy", d => y(d.population))
                    .attr("r", 6)
                    .attr("fill", "#FFB703")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .attr("opacity", 0)
                    .transition()
                    .delay(2000)
                    .duration(800)
                    .attr("opacity", 1);
            }
            
            // Observamos el contenedor del gráfico para activar la animación cuando es visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        createD3Chart();
                        observer.unobserve(entry.target); // Solo animamos una vez
                    }
                });
            }, { threshold: 0.3 });
            
            // Observamos el contenedor del gráfico
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                observer.observe(chartContainer);
            }
            
            // Ajustamos el tamaño del gráfico cuando cambia el tamaño de la ventana
            window.addEventListener('resize', () => {
                // Limpiamos el gráfico anterior
                d3.select('#populationGrowthD3Chart').html('');
                // Lo creamos de nuevo con las nuevas dimensiones
                if (isElementInViewport(chartContainer)) {
                    createD3Chart();
                }
            });
            
            // Función auxiliar para verificar si un elemento está visible
            function isElementInViewport(el) {
                const rect = el.getBoundingClientRect();
                return (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
            }
            
            // Integración con scrollama
            if (window.scroller) {
                window.scroller.on('step.enter', (response) => {
                    if (response.element.querySelector('#populationGrowthD3Chart')) {
                        createD3Chart();
                    }
                });
            }
        });
    </script>
</body>
</html>