<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cancún: Entre el Destino Global y la Ciudad Justa</title>
    
        <!-- Meta descripción (SEO) -->
        <meta name="description" content="Scrollytelling interactivo sobre Cancún: crecimiento urbano, movilidad y densidad poblacional. Mapas, gráficos y datos para entender la evolución de la ciudad.">
        <meta name="robots" content="index, follow">
        <meta name="author" content="joangonzalez02">

        <!-- Canonical -->
        <link rel="canonical" href="https://joangonzalez02.github.io/SCROLLAMA/">

        <!-- Open Graph (Social) -->
        <meta property="og:type" content="website">
        <meta property="og:locale" content="es_ES">
        <meta property="og:title" content="Cancún: Entre el Destino Global y la Ciudad Justa">
        <meta property="og:description" content="Scrollytelling interactivo con mapas y gráficos sobre la evolución urbana de Cancún: población, movilidad y retos de una ciudad en transformación.">
        <meta property="og:url" content="https://joangonzalez02.github.io/SCROLLAMA/">
        <meta property="og:image" content="https://joangonzalez02.github.io/SCROLLAMA/assets/1.png">

        <!-- Twitter Cards -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Cancún: Entre el Destino Global y la Ciudad Justa">
        <meta name="twitter:description" content="Mapas y datos para entender el crecimiento urbano de Cancún. Explora la historia y los retos de la ciudad con visualizaciones interactivas.">
        <meta name="twitter:image" content="https://joangonzalez02.github.io/SCROLLAMA/assets/1.png">

        <!-- JSON-LD (Schema.org) para WebPage -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "Cancún: Entre el Destino Global y la Ciudad Justa",
            "url": "https://joangonzalez02.github.io/SCROLLAMA/",
            "inLanguage": "es",
            "description": "Scrollytelling interactivo con mapas y gráficos sobre la evolución urbana de Cancún: población, movilidad y densidad.",
            "isPartOf": {
                "@type": "WebSite",
                "name": "SCROLLAMA",
                "url": "https://joangonzalez02.github.io/SCROLLAMA/"
            }
        }
        </script>
    <!-- Preconnect to third-party origins to reduce DNS/TLS latency -->
    <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
    <link rel="preconnect" href="https://d3js.org" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Defer Mapbox CSS using preload to avoid render-blocking; noscript fallback -->
    <link rel="preload" as="style" href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css"></noscript>
    <!-- Mapbox GL JS library - DEBE cargarse ANTES de mapbox-integration -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <!-- Proyecciones para convertir GeoJSON en EPSG:32616 a WGS84 (lon/lat) en el navegador -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js" defer></script>
    <script src="https://unpkg.com/scrollama" defer></script>
    <script src="https://d3js.org/d3.v7.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" defer></script>
    <script src="dist/population-chart.min.js" defer></script>
    <script src="dist/vehicle-chart.min.js" defer></script>
    <script src="dist/urban-evolution.min.js" defer></script>
    <!-- Mapbox integration DEBE esperar a que mapboxgl esté disponible -->
    <script>
        // Asegurar que mapboxgl esté disponible antes de cargar mapbox-integration
        if (typeof mapboxgl === 'undefined') {
            console.error('❌ Mapbox GL JS no está cargado');
        } else {
        }
    </script>
    <script src="dist/mapbox-integration.min.js" defer></script>
    <script src="dist/main.min.js" defer></script>
    <style>
        /* Importación de fuentes: Boldonse, Playfair Display, Special Elite, Wix Madefor Text */
        @import url('https://fonts.googleapis.com/css2?family=Boldonse&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Special+Elite&family=Wix+Madefor+Text:ital,wght@0,400..800;1,400..800&display=swap');

        /* === ESTILOS PARA ANIMACIÓN DE TYPING EN STEP 1 === */
        
        .step[data-step="1"] h1 {
            font-family: 'Special Elite', Georgia, 'Times New Roman', serif !important;
            letter-spacing: 0.5px;
            line-height: 1.3;
            font-weight: 700;
            text-align: center;
            /* Tamaños base: se sobrescriben en media queries */
            font-size: clamp(1.2rem, 5vw, 2.5rem);
            margin: 0;
            padding: 20px 15px;
            color: white;
        }

        /* Contenedor de líneas */
        .step[data-step="1"] h1 .line,
        .step[data-step="1"] h1 .sline {
            display: inline;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Visualización según tamaño de pantalla */
        .title-lg { display: block; }
        .title-sm { display: none; }

        /* Caret blinking durante typing */
        .step[data-step="1"] h1 .line.typing::after,
        .step[data-step="1"] h1 .sline.typing::after {
            content: '|';
            display: inline;
            margin-left: 0.08em;
            color: currentColor;
            opacity: 1;
            animation: blinkCaret 0.7s step-end infinite;
            pointer-events: none;
        }

        /* Animaciones */
        @keyframes blinkCaret {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* ========== RESPONSIVE BREAKPOINTS ========== */
        
        /* PANTALLAS GRANDES (Desktop: >= 1200px) */
        @media (min-width: 1200px) {
            .step[data-step="1"] h1 {
                font-size: 2.2rem;
                margin-bottom: 30px;
            }
            
            .title-lg .line {
                display: inline;
            }
            
            .title-lg .line::after {
                content: ' ';
            }
            
            .title-lg .line:last-of-type::after {
                content: '';
            }
        }

        /* PANTALLAS MEDIANAS (Tablet/Desktop pequeño: 768px - 1199px) */
        @media (min-width: 768px) and (max-width: 1199px) {
            .step[data-step="1"] h1 {
                font-size: 1.7rem;
                margin-bottom: 25px;
            }
            
            .title-lg .line {
                display: inline;
            }
            
            .title-lg .line::after {
                content: ' ';
            }
            
            .title-lg .line:last-of-type::after {
                content: '';
            }
        }

        /* MÓVILES Y PANTALLAS PEQUEÑAS (< 768px) */
        @media (max-width: 767px) {
            .step[data-step="1"] h1 {
                font-size: clamp(1.1rem, 4vw, 1.5rem);
                margin-bottom: 20px;
                padding: 15px 12px;
                line-height: 1.25;
            }

            /* Mostrar versión mobile */
            .title-lg { display: none; }
            .title-sm { display: block; }

            /* Cada línea en su propia fila */
            .title-sm .sline {
                display: block;
                margin: 0;
                padding: 0;
            }
            
            .title-sm .sline + .sline {
                margin-top: 0.3em;
            }
        }

        /* PANTALLAS EXTRA PEQUEÑAS (< 480px) */
        @media (max-width: 479px) {
            .step[data-step="1"] h1 {
                font-size: clamp(1rem, 3.5vw, 1.3rem);
                padding: 12px 10px;
                letter-spacing: 0.3px;
            }
            
            .title-sm .sline {
                line-height: 1.2;
            }
        }

        /* Dispositivos muy pequeños */
        @media (max-width: 375px) {
            .step[data-step="1"] h1 {
                font-size: clamp(0.95rem, 3vw, 1.2rem);
                padding: 10px 8px;
                letter-spacing: 0.2px;
            }
        }

        /* Aplicar Wix Madefor Text a todos los párrafos */
        p, .step p, .content p {
            font-family: 'Wix Madefor Text', 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, serif;
        }

        /* Subtítulos con Playfair Display */
        .step h2, .step h3, .content h2, .content h3, .subtitle {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif !important;
            font-weight: 600;
            margin-bottom: 0.35em;
        }
        * { box-sizing: border-box; }

        #map {
            z-index: 1000 !important; 
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Estilo específico para step 1 con video */
        section[data-step="1"] {
            background: none !important;
        }
        section[data-step="1"] {
            overflow: visible; /* permitir pseudo-elementos fuera del contenedor */
        }

        /* Asegurar que el step 1 esté por encima del fixed-behind mientras está en pantalla */
        .step[data-step="1"] {
            z-index: 1010;
        }

        /* Elevar step 1 solo cuando está activo */
        .step.is-active[data-step="1"] {
            z-index: 1010; /* por encima del mapa (mapa usa 1000) */
        }

        /* Contenido del step esté por encima de la sombra solo cuando está activo */
        .step.is-active[data-step="1"] > div {
            position: relative;
            z-index: 1003;
        }
        section[data-step="1"]::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -20px;
            width: calc(100% - 40px);
            max-width: 1400px;
            height: 36px;
            pointer-events: none;
            background: radial-gradient(ellipse at center,
                rgba(2,48,71,0.20) 0%,
                rgba(2,48,71,0.12) 35%,
                rgba(2,48,71,0.06) 65%,
                rgba(2,48,71,0) 100%);
            border-radius: 50%;
            opacity: 1;
            transition: opacity 240ms ease-in-out, transform 240ms ease-in-out;
            z-index: 1001;
            filter: blur(4px);
            box-shadow: 0 10px 30px rgba(2,48,71,0.08);
        }

        .step.is-active[data-step="1"]::after {
            transform: translateX(-50%) translateY(2px);
        }

        /* Efecto 'telón' entre step 1 y step 2*/
        section[data-step="2"] {
            position: relative;
            z-index: 1000;
            margin: 0; /* asegura que no haya separación visual entre steps */
            padding-top: 0; /* deja que el contenido suba hasta la parte superior de la pantalla */
        }

        /* Fondo 'pegado' al viewport: pseudo-elemento fijo que hace ver el step 2 como fondo */
        section[data-step="2"]::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            z-index: 1000;
            background-color: #ffffff; /* match step 2 color to avoid white flash */
            pointer-events: none;
            opacity: 0;
            transition: opacity 200ms ease-in-out;
        }

        /* Mostrar el pseudo-fondo sólo cuando step 2 esté activo */
        .step.is-active[data-step="2"]::before {
            opacity: 1;
        }

        /* Mostrar el pseudo-fondo también cuando la clase bg-visible esté presente*/
        .step.bg-visible[data-step="2"]::before {
            opacity: 1;
        }

        section[data-step="2"] .fixed-behind {
            position: fixed;
            /* colocamos en su posición final: permanece fijo en el viewport */
            top: 15vh;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            max-width: 90%;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: top 360ms cubic-bezier(.2,.9,.2,1);
            pointer-events: none;
        }

        section[data-step="2"] .fixed-behind img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
            transition: none;
        }

        /* Peek: asoma 120px desde la parte inferior */
        .step.peek[data-step="2"] .fixed-behind {
            top: calc(100vh - 120px);
            opacity: 1;
            visibility: visible;
            pointer-events: none;
        }

        /* Fully visible: coloca en la posición final (coincide con padding-top) */
        .step.bg-visible[data-step="2"] .fixed-behind {
            top: 15vh;
            opacity: 1;
            visibility: visible;
            pointer-events: none;
        }

        /* Crédito de foto: colocar siempre debajo y centrado respecto a la imagen */
        section[data-step="2"] .fixed-behind {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        section[data-step="2"] .fixed-behind .photo-credit {
            position: static;
            margin-top: 8px;
            text-align: center;
            z-index: 1003;
            pointer-events: none;
        }

        /* Mostrar la imagen fija y permitir interacción con el crédito cuando
           el IntersectionObserver haya marcado el step 2 como visible */
        .step.bg-visible[data-step="2"] .fixed-behind {
            opacity: 1;
            visibility: visible;
            pointer-events: none; /* imagen sigue sin capturar clicks */
        }

        .step.bg-visible[data-step="2"] .fixed-behind .photo-credit {
            pointer-events: auto; /* permitir clicks en el enlace de la fuente */
        }

        /* Asegura que el contenido real del step 2 (excepto .fixed-behind)
           esté por encima del pseudo-fondo */
        section[data-step="2"] > div:not(.fixed-behind),
        section[data-step="2"] > div:not(.fixed-behind) * {
            position: relative;
            z-index: 1002;
        }

        /* Desktop */
        @media (min-width: 1200px) {
            section[data-step="2"] .fixed-behind {
                top: 18vh;
                width: 480px;
                max-width: 60%;
            }
            section[data-step="2"] .fixed-behind img {
                max-height: calc(70vh);
                width: 100%;
                height: auto; 
                object-fit: contain; 
            }
            section[data-step="2"] .fixed-behind .photo-credit {
                margin-top: 18px;
                text-align: center;
            }
        }

        /* Tablet */
        @media (min-width: 768px) and (max-width: 1199px) {
            section[data-step="2"] .fixed-behind {
                top: 16vh;
                width: 420px;
                max-width: 70%;
            }
            section[data-step="2"] .fixed-behind img {
                max-height: calc(65vh);
                width: 100%;
                height: auto; 
                object-fit: contain;
            }
            section[data-step="2"] .fixed-behind .photo-credit {
                bottom: 16px;
            }
        }

        /* Móviles */
        @media (max-width: 767px) {
            section[data-step="2"] .fixed-behind {
                position: relative; 
                top: auto;
                left: auto;
                transform: none;
                width: calc(100% - 32px);
                max-width: none;
                margin: 0 auto 18px auto;
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
            }
            section[data-step="2"] .fixed-behind img {
                width: 100%;
                height: auto;
                max-height: none;
                object-fit: contain;
                border-radius: 8px;
            }
            section[data-step="2"] .fixed-behind .photo-credit {
                position: relative;
                left: auto;
                transform: none;
                bottom: auto;
                margin-top: 8px;
                text-align: center;
                pointer-events: auto;
            }
            section[data-step="2"] > div:not(.fixed-behind) {
                z-index: 1002;
            }
        }
        
        /* Configuración del mapa base*/
        #map { 
            position: fixed; 
            top: 0; 
            left: 0;
            bottom: 0; 
            width: 100%; 
            height: 100vh;
            z-index: 1000; /* Aumentado para estar por encima de todo */
            /* Transiciones suaves */
            transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;
            transform-origin: top center;
            /* Estado inicial: oculto */
            opacity: 0;
            visibility: hidden;
            display: none; /* Añadido para garantizar que no se muestre inicialmente */
            /* Permitir que los eventos de scroll pasen al documento */
            pointer-events: none;
            /* Sin background-color para que el mapa base de Mapbox sea visible */
        }
        
        /* Estado activo del mapa */
        #map.active {
            opacity: 1;
            visibility: visible;
            display: block;
            /* Activar eventos del mapa solo cuando está activo */
            pointer-events: auto;
        }
        
        /* Asegurar que el canvas del mapa tenga opacidad completa */
        #map .mapboxgl-canvas {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Leyenda del mapa */
        #map-legend { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map-legend .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; line-height: 1.3; }
        #map-legend .legend-swatch { width: 18px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.2); flex: 0 0 18px; }
        #map-legend .legend-label { flex: 1 1 auto; color: #222; }
        @media (max-width: 640px) {
            #map-legend { right: 10px; bottom: 10px; min-width: 180px; }
        }
        
        /* Asegurar que las capas del mapa se muestren con colores nítidos */
        #map .mapboxgl-canvas-container {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Forzar que el control container sea visible */
        #map .mapboxgl-control-container {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Zona de scroll en los bordes del mapa */
        #map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        /* Sombra externa bajo el video (oculta por defecto) */
            .video-external-shadow {
                display: block;
                position: fixed;
                left: 0;
                right: 0;
                bottom: -28px; /* ligeramente fuera del viewport para crear sombra bajo el borde */
                height: 1px;
                pointer-events: none;
                z-index: 1001;
                box-shadow: 0 28px 90px rgba(2,48,71,0.18);
                filter: blur(3px);
                opacity: 1;
            }
        
            /* Mostrar la sombra solo cuando el step 1 esté activo */
            .step.is-active[data-step="1"] .video-external-shadow {
                display: block;
            }
        
        /* Crear zonas de scroll en los bordes */
        .map-scroll-zone {
            position: absolute;
            background: transparent;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .map-scroll-zone.top {
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
        }
        
        .map-scroll-zone.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
        }
        
        /* Estilo para el botón de cierre de mapa */
        .map-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #FB8500; 
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer !important;
            z-index: 99999 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            transition: all 0.2s ease !important;
            pointer-events: auto !important; /* Asegurarse de que siempre capture clics */
        }

        
        /* Asegurarse de que los steps con mapa permitan el scroll */
        .step.has-map {
            z-index: 3; /* Por encima del mapa para permitir scroll */
        }
        
        /* Estilos para el scrollytelling */
        #scroller {
            position: relative;
            z-index: 1;
            background: transparent;
        }
        
        .step {
            margin: 0;
            padding: 100px 50px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* Estilos especiales para los steps de años urbanos */
        .step.urban-year-image {
            padding: 0 !important;
            margin: 0 !important;
            background: transparent !important;
            z-index: 2;
            color: #000000;
        }

        /* Mostrar cuadro de texto en el step de 1980 */
        .step.urban-year-image .step9-caption {
            position: absolute;
            right: 24px;
            bottom: 24px;
            z-index: 3;
            background: rgba(255, 255, 255, 0.95);
            color: #000000;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: none;
            max-width: 520px;
            width: auto;
            text-align: left;
        }

        /* Mostrar cuadro de texto en el step de 1985 */
        .step.urban-year-image .step10-caption {
            position: absolute;
            right: 24px;
            bottom: 24px;
            z-index: 3;
            background: rgba(255, 255, 255, 0.95);
            color: #000000;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: none;
            max-width: 520px;
            width: auto;
            text-align: left;
        }

        /* Mostrar cuadro de texto en el step de 1990 */
        .step.urban-year-image .step11-caption {
            position: absolute;
            right: 24px;
            bottom: 24px;
            z-index: 3;
            background: rgba(255, 255, 255, 0.95);
            color: #000000;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: none;
            max-width: 520px;
            width: auto;
            text-align: left;
        }

        /* Estilo común para captions de años (steps 8–17) con efecto "liquid glass" */
        .step.urban-year-image .year-caption {
            position: absolute;
            right: 24px;
            bottom: 24px;
            z-index: 3;
            /* Liquid glass (glassmorphism) */
            background: rgba(255, 255, 255, 0.18);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            backdrop-filter: blur(16px) saturate(120%);
            color: #000000;
            padding: 16px 20px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 10px 25px rgba(2, 48, 71, 0.20);
            max-width: 520px;
            width: auto;
            text-align: left;
            transition: none;
            will-change: transform, opacity;
            overflow: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
            isolation: isolate;
            contain: paint;
            opacity: 0;
            /* Reset por defecto para que al reactivarse el step se reproduzca la animación */
            animation: none;
        }

        /* Garantizar reset cuando el step no está activo */
        .step.urban-year-image:not(.is-active) .year-caption {
            animation: none !important;
            opacity: 0 !important;
        }

        .step.urban-year-image.is-active .year-caption { opacity: 1; }
        .step.urban-year-image .year-caption { height: clamp(200px, 50vh, 360px); overflow-y: auto; }
        .step.urban-year-image .year-caption .caption-body { display: flex; flex-direction: column; gap: 8px; max-width: 520px; }
        .step.urban-year-image .year-caption .caption-image { display: flex; align-items: center; justify-content: center; }
        .step.urban-year-image .year-caption .caption-image img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }

        /* Brillo suave interior del vidrio */
        .step.urban-year-image .year-caption::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg,
              rgba(255, 255, 255, 0.35) 0%,
              rgba(255, 255, 255, 0.10) 35%,
              rgba(255, 255, 255, 0.06) 55%,
              rgba(255, 255, 255, 0.0) 100%
            );
            pointer-events: none;
            /* mix-blend-mode: screen;  Eliminado para evitar destellos en algunas GPUs/renderers */
        }

        /* Responsivo: ajustar captions en pantallas pequeñas */
        @media (max-width: 768px) {
            .step.urban-year-image .year-caption {
                right: 12px;
                bottom: 12px;
                max-width: calc(100% - 24px);
                padding: 12px 14px;
                background: rgba(255, 255, 255, 0.85);
                -webkit-backdrop-filter: blur(6px) saturate(110%);
                backdrop-filter: blur(6px) saturate(110%);
                border: 1px solid rgba(255, 255, 255, 0.75);
            }
            .step.urban-year-image .year-caption .caption-body { max-width: 100%; }
            .step.urban-year-image .year-caption p { 
                font-size: 16px; 
                line-height: 1.5; 
            }
            .step.urban-year-image .year-caption strong { 
                font-size: 17px; 
            }
        }

        @media (max-width: 480px) {
            .step.urban-year-image .year-caption {
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-width: 100%;
                padding: 12px 14px;
                border-radius: 12px 12px 0 0;
                background: rgba(255, 255, 255, 0.92);
                -webkit-backdrop-filter: blur(5px) saturate(110%);
                backdrop-filter: blur(5px) saturate(110%);
                border: 1px solid rgba(255, 255, 255, 0.85);
            }
            .step.urban-year-image .year-caption .caption-body { max-width: 100%; }
            .step.urban-year-image .year-caption p { 
                font-size: 15px; 
                line-height: 1.45; 
            }
            .step.urban-year-image .year-caption strong { 
                font-size: 16px; 
            }
        }

        /* Animaciones clave para variar la entrada por año */
        @keyframes fadeUpSoft {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRightSoft {
            from { opacity: 0; transform: translateX(24px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes zoomInSoft {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes tiltIn {
            0% { opacity: 0; transform: translateY(12px) rotate(-2deg); }
            60% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 1; transform: translateY(0) rotate(0deg); }
        }

        @keyframes dropIn {
            0% { opacity: 0; transform: translateY(-12px); }
            70% { opacity: 1; transform: translateY(6px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes riseIn {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes skewIn {
            from { opacity: 0; transform: translateY(12px) skewY(3deg); }
            to { opacity: 1; transform: translateY(0) skewY(0deg); }
        }

        @keyframes floatIn {
            0% { opacity: 0; transform: translateY(8px); }
            60% { opacity: 1; transform: translateY(0); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.95); }
            60% { opacity: 1; transform: scale(1.03); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Asignación de animaciones por año (cuando el step está activo) */
        .step.urban-year-image.is-active[data-year="1980"] .year-caption {
            animation: fadeUpSoft 700ms ease-out both;
            animation-delay: 80ms;
        }
        .step.urban-year-image.is-active[data-year="1985"] .year-caption {
            animation: slideInRightSoft 720ms ease-out both;
            animation-delay: 100ms;
        }
        .step.urban-year-image.is-active[data-year="1990"] .year-caption {
            animation: zoomInSoft 680ms ease-out both;
            animation-delay: 120ms;
        }
        .step.urban-year-image.is-active[data-year="1995"] .year-caption {
            animation: tiltIn 800ms cubic-bezier(0.22, 1.0, 0.36, 1.0) both;
            animation-delay: 90ms;
        }
        .step.urban-year-image.is-active[data-year="2000"] .year-caption {
            animation: dropIn 760ms cubic-bezier(0.22, 1.0, 0.36, 1.0) both;
            animation-delay: 110ms;
        }
        .step.urban-year-image.is-active[data-year="2005"] .year-caption {
            animation: riseIn 720ms ease-out both;
            animation-delay: 80ms;
        }
        .step.urban-year-image.is-active[data-year="2010"] .year-caption {
            animation: skewIn 700ms ease-out both;
            animation-delay: 120ms;
        }
        .step.urban-year-image.is-active[data-year="2015"] .year-caption {
            animation: floatIn 740ms ease-out both;
            animation-delay: 90ms;
        }
        .step.urban-year-image.is-active[data-year="2020"] .year-caption {
            animation: bounceIn 800ms cubic-bezier(0.22, 1.0, 0.36, 1.0) both;
            animation-delay: 130ms;
        }
        .step.urban-year-image.is-active[data-year="2025"] .year-caption {
            animation: fadeInScale 700ms ease-out both;
            animation-delay: 100ms;
        }
        
        .step.has-map {
            /* Steps con mapas/visualizaciones - fondo transparente, sin texto */
            background: transparent;
        }
        
        .step.has-map .step-content {
            /* Ocultar completamente el contenido de texto en steps de mapa */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* Estilos diferenciados para steps de texto vs mapa/visualizaciones */
        .step:not(.has-map):not(.urban-year-image) {
            /* Steps de texto - fondo blanco uniforme */
            background: #FFFFFF;
            color: #000000;
        }
        
        /* Estilo del contenido de texto*/
        .step-content {
    font-size: 24px;
    font-weight: normal;
    text-shadow: none;
    line-height: 1.6;
    max-width: 1200px;
    margin: 0 auto;
}
        
        /* Excepción para que la sombra no se aplique al contenido del gráfico */
        .chart-container text,
        .chart-container .data-selector,
        .chart-container .data-selector label {
            text-shadow: none;
        }
        
        .step-content h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: none;
            color: #000000;
            text-align: center;
        }
        
        .step-content h2 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: none;
            color: #000000;
            text-align: center;
        }
        
        .step-content p {
            margin-bottom: 20px;
            font-size: 20px;
            color: #000000;
        }
        
        .step-content strong {
            font-weight: 700;
            text-shadow: none;
            color: #000000;
        }
        
        /* Estilos para el gráfico interactivo con D3 */
        .chart-container {
            width: 100%;
            height: 550px;
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            overflow: visible;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #populationGrowthChart,
        #vehicleGrowthChart {
            width: 100%;
            height: 100%;
            min-height: 480px;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        /* Sticky behavior for population chart: cuando el step 4 esté activo
           mantenemos la caja del chart pegada en pantalla por un momento mientras
           el usuario hace scroll y cambiamos las series vía scroll */
        .step[data-step="4"] .chart-container {
            display: none; /* Ocultar inicialmente */
        }
        .step[data-step="4"] .chart-container.visible {
            display: block;
        }
        .step[data-step="4"] .chart-container.sticky {
            position: sticky;
            top: 14vh;
            z-index: 1005;
            margin-top: 0;
            transition: transform 300ms ease, box-shadow 200ms ease;
            will-change: transform;
            align-self: flex-start;
        }

        .step.is-active[data-step="4"] .chart-container.sticky {
            box-shadow: 0 20px 40px rgba(2,48,71,0.12);
        }

        /* Asegurar que el selector quede por encima del SVG cuando esté sticky */
        .step[data-step="4"] .chart-container.sticky .data-selector {
            z-index: 1006;
            position: relative;
        }
        
        /* Substeps discretos dentro del Step 4 */
        .step[data-step="4"] .substeps {
            position: relative;
            width: 100%;
        }
        .step[data-step="4"] .substep {
            min-height: 48vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
        }
        .step[data-step="4"] .substep h3 {
            display: none; 
            margin: 0;
            font-weight: 700;
            color: #023047;
        }
        
        .chart-container .axis path,
        .chart-container .axis line {
            stroke: rgba(120, 120, 120, 0.2);
            shape-rendering: crispEdges;
        }
        
        .chart-container .axis text {
            fill: #000000;
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container .bar {
            fill: url(#bar-gradient);
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 1px;
            transition: all 0.3s;
        }
        
        .chart-container .bar:hover {
            filter: brightness(1.05);
            cursor: pointer;
        }
        
        .chart-container .value-label {
            font-size: 14px;
            font-weight: bold;
            fill: #000000;
            text-anchor: middle;
            filter: none;
            text-shadow: none;
        }
        
        .chart-container .title {
            font-size: 18px;
            font-weight: bold;
            fill: #000000;
            text-anchor: middle;
        }
        
        .chart-container .grid line {
            stroke: rgba(200, 200, 200, 0.2);
        }
        
        /* Estilos para el tooltip */
        .chart-container .tooltip {
            position: absolute;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            border-left: 4px solid #FB8500;
            min-width: 180px;
            transform: translateY(0);
        }
        
        .chart-container .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.97) transparent transparent transparent;
        }
        
        .chart-container .tooltip p {
            margin: 5px 0;
        }
        
        .chart-container .tooltip .value {
            color: #FB8500;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Transición de imágenes para la evolución urbana */
        .urban-evolution-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
        }
        
        .urban-evolution-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            background-size: cover;
            background-position: center;
        }
        
        .urban-evolution-image.active {
            opacity: 1;
        }
        
        /* Estilos específicos para las imágenes de evolución forestal */
        .forest-year-image {
            background: transparent !important;
        }
        .forest-year-image .step-content h2 {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Arial, sans-serif;
            color: #095a4f !important;
            text-shadow: 0 2px 8px rgb(255, 255, 255);
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 10px;
        }
        .forest-year-image .step-content p {
            color: #095a4f !important;
            font-size: 18px;
            line-height: 1.5;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .forest-year-image .step-content h2 { font-size: 22px; }
            .forest-year-image .step-content p { font-size: 16px; }
        }

        /* Estilos específicos para las imágenes de evolución urbana */
        .urban-year-image {
            position: relative;
            width: 100%;
            height: 100vh;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        
        /* Contenedor de fondo para evolución urbana */
        #urban-evolution-background {
            pointer-events: none;
            background-color: #FFFFFF; /* Fondo blanco uniforme detrás de evolución urbana */
        }
        
        .urban-bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .urban-bg-image.active {
            opacity: 1;
        }
        

        
        /* Footer */
        .footer {
            background-color: #023047;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }
        
        .footer img {
            max-height: 60px;
            margin: 10px;
        }

        /* Crédito de foto en steps con imagen de fondo */
        .photo-credit {
            position: absolute;
            bottom: 14px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
            z-index: 5;
            pointer-events: auto;
        }
        .photo-credit a {
            color: #fff;
            text-decoration: underline;
        }
        .photo-credit a:hover {
            text-decoration: none;
        }

        /* Posición de la Fuente de diario.jpg*/
        .evidence-overlay .photo-credit {
            position: static !important;
            align-self: center;
            margin-top: 8px;
            text-align: center;
            pointer-events: auto;
        }

        /* En pantallas pequeñas la imagen aparece debajo del texto */
        @media (max-width: 768px) {
            .evidence-overlay {
                position: static !important;
                height: auto !important;
                width: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-start !important;
                padding: 12px !important;
                margin-top: 18px !important;
            }
            .evidence-overlay .evidence-img {
                max-width: 100% !important;
                max-height: 50vh !important;
                height: auto !important;
                width: auto !important;
            }
            /* Forzar que el step 3 muestre la imagen debajo del texto (el .step por defecto es flex row) */
            section[data-step="3"] {
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
                padding: 20px !important;
                gap: 12px;
            }
            section[data-step="3"] .step-content {
                order: 1;
                width: 100% !important;
            }
            section[data-step="3"] .evidence-overlay {
                order: 2;
                width: 100% !important;
            }
            /* En móvil: mantener el wrapper con posición relativa para que el crédito se mantenga dentro */
            section[data-step="5"] {
                display: block !important;
                padding: 0 !important;
                min-height: 100vh !important;
                position: relative !important;
            }
            section[data-step="5"] .floating-image-wrapper {
                position: relative !important;
                inset: auto !important;
                display: block !important;
                width: 100% !important;
                height: 100vh !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }
            section[data-step="5"] .floating-image {
                position: absolute !important;
                inset: 0 !important;
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                object-position: center center !important;
                display: block !important;
                opacity: 1 !important;
            }
            /* Mantener el credit del Step 5 pegado encima de la parte inferior de la imagen */
            section[data-step="5"] .photo-credit {
                position: absolute !important;
                left: 50% !important;
                bottom: 12px !important;
                transform: translateX(-50%) !important;
                margin: 0 !important;
                text-align: center !important;
                display: inline-block !important;
                background: rgba(0,0,0,0.55) !important;
                color: #fff !important;
                padding: 6px 10px !important;
                border-radius: 6px !important;
                max-width: 90% !important;
                z-index: 5 !important;
                font-size: 12px !important;
                white-space: normal !important;
                box-sizing: border-box !important;
                backdrop-filter: blur(4px) saturate(140%) !important;
                -webkit-backdrop-filter: blur(4px) saturate(140%) !important;
            }
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        
        /* Media queries para responsividad */
        @media (max-width: 768px) {
            .step {
                padding: 60px 20px;
            }
            
            .step-content h1 {
                font-size: 2em;
            }
            
            .step-content h2 {
                font-size: 1.5em;
            }
            
            .chart-container {
                height: 450px;
            }
            
            #populationGrowthChart,
            #vehicleGrowthChart {
                min-height: 380px;
            }
            
            /* Cuando está integrado en un step */
            .step .lizmap-scrolly-container {
                height: 400px !important;
                margin: 20px 0 !important;
            }
            
            /* Cuando está como overlay */
            .lizmap-scrolly-container.overlay {
                height: 100vh !important;
            }

            /* Último step: colocar la imagen debajo del texto en móvil */
            section[data-step="32"] > div {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            section[data-step="32"] .step-content {
                width: 100%;
                max-width: 700px;
            }
            section[data-step="32"] > div > div:last-child {
                width: 100%;
                display: flex;
                justify-content: center;
            }
            section[data-step="32"] > div > div:last-child img {
                width: 100%;
                height: auto;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa base de Mapbox -->
    <div id="map"></div>
    <!-- Leyenda de mapa (se rellena dinámicamente) -->
    <div id="map-legend" aria-live="polite" style="display:none; position: fixed; right: 14px; bottom: 14px; z-index: 2000; background: rgba(255,255,255,0.96); color: #222; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.18); padding: 10px 12px; min-width: 220px; pointer-events: none;">
        <div class="legend-title" style="font-weight: 700; font-size: 13px; margin-bottom: 8px;">Leyenda</div>
        <div class="legend-items" style="display: flex; flex-direction: column; gap: 6px;"></div>
    </div>
    
    <!-- Únicamente se usa el contenedor #map -->
    
    <!-- Botón X independiente que siempre estará por encima de todo -->
    <button id="emergency-close-btn" style="position:fixed; top:20px; left:20px; z-index:999999; width:60px; height:60px; font-size:36px; background:#FB8500; color:white; border:3px solid white; border-radius:50%; cursor:pointer; display:none; box-shadow:0 6px 16px rgba(0,0,0,0.7); align-items:center; justify-content:center; pointer-events:auto;" onclick="cerrarMapaAhora()">×</button>

    <script>
        // Función específica para cerrar el mapa directamente desde el botón X
        function cerrarMapaAhora() {
            
            // Cerrar el mapa usando la función de Mapbox
            if (window.mapboxHelper && typeof window.mapboxHelper.hideMapOverlay === 'function') {
                window.mapboxHelper.hideMapOverlay();
            }
            
            // Restaurar scroll y estados del body
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            document.body.classList.remove('showing-map');
            
            // Ocultar el botón X
            document.getElementById('emergency-close-btn').style.display = 'none';
            
            // Intentar método programático general
            if (typeof window.hideMapVisuals === 'function') {
                try {
                    window.hideMapVisuals();
                } catch(e) {
                    console.error("Error en hideMapVisuals:", e);
                }
            }
            
            
            // Para evitar propagación de eventos
            return false;
        }
        
        // Mostrar botón X solo cuando el mapa esté visible y estemos en un paso con mapa
        setInterval(function() {
            const mapContainer = document.getElementById('map');
            let mapVisible = false;
            let currentStepHasMap = false;
            
            // Verificar si el paso actual tiene un mapa
            const currentStepElement = document.querySelector('.step.is-active');
            if (currentStepElement && currentStepElement.getAttribute('data-map') === 'true') {
                currentStepHasMap = true;
            }
            
            if (mapContainer) {
                mapVisible = window.getComputedStyle(mapContainer).display !== 'none' && 
                             window.getComputedStyle(mapContainer).visibility !== 'hidden' &&
                             window.getComputedStyle(mapContainer).opacity !== '0';
            }
            
            // Mostrar botón X solo si el mapa está visible Y estamos en un paso con mapa
            const emergencyButton = document.getElementById('emergency-close-btn');
            if (emergencyButton) {
                emergencyButton.style.display = (mapVisible && currentStepHasMap) ? 'flex' : 'none';
            }
        }, 1000);
        
        // Función de emergencia global para cerrar el mapa con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarMapaAhora();
            }
        });
    </script>
    
    <!-- Contenedor para imágenes de fondo -->
    <div id="image-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden;">
        <img src="" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    
    <!-- Contenedor para evolución urbana -->
    <div id="urban-evolution-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; display: none; visibility: hidden; opacity: 0; transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;">
        <!-- Las imágenes de años se insertarán aquí dinámicamente -->
    </div>
    
    <!-- Contenedor para serie de pérdida de cobertura forestal (2000, 2010, 2020) -->
    <div id="forest-loss-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; display: none; visibility: hidden; opacity: 0; transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out;"></div>
    
    <!-- Contenedor principal para el scrollytelling -->
    <main id="scroller">
        <!-- Step 1: Portada / Hook -->
        <section class="step" data-step="1" style="position: relative; overflow: visible; background: none !important; min-height: 100vh;">
            <!-- Video de fondo -->
            <video autoplay muted loop playsinline preload="metadata" poster="assets/1.png" id="background-video" style="position: absolute; width: 100%; height: 100vh; object-fit: cover; z-index: -2;">
                <source src="assets/1.mp4" type="video/mp4">
                Tu navegador no soporta video HTML5.
            </video>
            <button id="bgVideoPlayBtn" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#023047;color:#fff;padding:12px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;display:none;z-index:10;">Reproducir video</button>
            
            <!-- Capa de color con transparencia mayor -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(2, 48, 71, 0.4); z-index: -1;"></div>
            <div class="video-external-shadow" style="height: 1px; pointer-events: none;"></div>
            
            <!-- Contenido sin estilo de las tarjetas normales -->
            <div style="position: relative; z-index: 5; max-width: 800px; margin: 0 auto; padding: 40px 20px; text-align: center;">
                <h1 style="font-size: 48px; font-weight: bold; margin-bottom: 30px; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); color: white;">
                    <!-- Desktop / Tablet 2 líneas -->
                    <span class="title-lg">
                        <span class="line line1">Cancún: Entre el Destino</span>
                        <span class="line line2">Global y la Ciudad Justa</span>
                    </span>
                    <!-- Mobile 2 líneas-->
                    <span class="title-sm">
                        <span class="sline sline1">Cancún: Entre el</span>
                        <span class="sline sline2">Destino Global y</span>
                        <span class="sline sline3">la Ciudad Justa</span>
                    </span>
                </h1>

            </div>
        </section>

        <!-- Step 2: Imagen cuadernobancodemex.jpg (contenido visual fijado) -->
        <section class="step" data-step="2" style="min-height: 100vh; background: transparent; display: flex; align-items: flex-start; justify-content: center; position: relative; padding-top: 15vh;">
            <div class="fixed-behind">
                <img src="assets/cuadernobancodemex.jpg" alt="Cuaderno Banco de México">
                <div class="photo-credit">
                    Fuente: <a href="https://cgc.qroo.gob.mx/cjg/wp-content/uploads/2019/11/Cap-09-OK-Mayo-7.pdf" target="_blank" rel="noopener" title="Capítulo 9 - cgc.qroo.gob.mx">cgc.qroo.gob.mx</a>
                </div>
            </div>
        </section>
        <script>
            (function(){
                try {
                    const step1 = document.querySelector('section[data-step="1"]');
                    const step2 = document.querySelector('section[data-step="2"]');
                    const fixed = step2 ? step2.querySelector('.fixed-behind') : null;
                    const credit = step2 ? step2.querySelector('.photo-credit') : null;
                    if (!step1 || !step2 || !fixed) return;

                    // Generar thresholds finos para obtener cambios suaves
                    const thresholds = [];
                    for (let i=0;i<=100;i++) thresholds.push(i/100);

                        const io = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                try {
                                    // Si otro step está activo, ocultar el fixed-behind
                                    const active = document.querySelector('.step.is-active');
                                    const activeStep = active ? active.getAttribute('data-step') : null;
                                    if (activeStep && activeStep !== '1' && activeStep !== '2') {
                                        fixed.style.opacity = '0';
                                        fixed.style.visibility = 'hidden';
                                        if (credit) credit.style.pointerEvents = 'none';
                                        return;
                                    }

                                    // entry.intersectionRatio es la fracción visible de step1 (1 = totalmente visible)
                                    const visibleFrac = entry.intersectionRatio;
                                    // Revelar step2 en fondo a medida que step1 deja de ser visible
                                    const reveal = Math.min(1, Math.max(0, 1 - visibleFrac));

                                    // Comprobar el step activo y actuar en consecuencia
                                    const activeNow = document.querySelector('.step.is-active');
                                    const activeStepNow = activeNow ? activeNow.getAttribute('data-step') : null;

                                    if (activeStepNow === '2') {
                                        fixed.style.display = '';
                                        fixed.style.opacity = '1';
                                        fixed.style.visibility = 'visible';
                                        if (credit) {
                                            credit.style.pointerEvents = 'auto';
                                            credit.style.opacity = '1';
                                        }
                                        return;
                                    }

                                    // Si el step 1 está activo, usamos el reveal gradual controlado por la visibilidad de step1
                                    if (activeStepNow === '1') {
                                        const step2Rect = step2.getBoundingClientRect();
                                        const step2InViewport = (step2Rect.top < window.innerHeight) && (step2Rect.bottom > 0);

                                        if (!step2InViewport) {
                                            fixed.style.opacity = '0';
                                            fixed.style.visibility = 'hidden';
                                            fixed.style.display = 'none';
                                            if (credit) credit.style.pointerEvents = 'none';
                                        } else {
                                            const show = reveal > 0;
                                            if (show) {
                                                fixed.style.display = '';
                                                fixed.style.opacity = '1';
                                                fixed.style.visibility = 'visible';
                                                if (credit) {
                                                    credit.style.pointerEvents = 'auto';
                                                    credit.style.opacity = '1';
                                                }
                                            } else {
                                                fixed.style.opacity = '0';
                                                fixed.style.visibility = 'hidden';
                                                fixed.style.display = 'none';
                                                if (credit) credit.style.pointerEvents = 'none';
                                            }
                                        }
                                        return;
                                    }

                                    // En cualquier otro caso (no step 1 ni 2 activos), ocultar totalmente
                                    fixed.style.opacity = '0';
                                    fixed.style.visibility = 'hidden';
                                    fixed.style.display = 'none';
                                    if (credit) credit.style.pointerEvents = 'none';
                                } catch (err) {
                                    console.warn('Error en IO callback:', err);
                                }
                            });
                        }, { threshold: thresholds });

                    io.observe(step1);
                } catch (e) {
                    console.warn('IntersectionObserver (reveal by step1) no disponible:', e);
                }
            })();
        </script>


        <!-- Step 3: Digging in (Introducción al caso) -->
        <section class="step" data-step="3">
            <div class="step-content">
                <h2>De Proyecto Planificado a Ciudad Viva</h2>
                <p>Cancún no fue solo un destino turístico, sino un proyecto político y tecnocrático. Nació en 1969, en un momento en que el gobierno mexicano buscaba redefinir su imagen internacional tras Tlatelolco, proponiendo un paraíso de alta tecnología, ordenado y apolítico.</p>
                <p>Impulsado por tecnócratas del Banco de México, que buscaban una industria sin chimeneas para captar divisas, su ubicación fue seleccionada por algoritmos computacionales en un lienzo en blanco.</p>
                <p>El Plan Maestro original codificó intencionalmente la tensión que vemos hoy: una dualidad urbana que separaba funcional y físicamente la isla de 19 km para el turismo de clase mundial de la zona continental, diseñada como el centro de apoyo logístico y residencial para la fuerza laboral.</p>
            </div>
            <div class="evidence-overlay" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; flex-direction: column; gap:12px;">
                <img src="assets/diario.jpg" alt="Documento histórico, diario de 1975" class="evidence-img" style="max-width: 100%; max-height: 80vh; width: auto; height: auto; object-fit: contain; display:block;">
                <div class="photo-credit" style="background: rgba(0, 0, 0, 0.5); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; line-height: 1.3;">
                    Fuente: <a href="https://cgc.qroo.gob.mx/cjg/wp-content/uploads/2019/11/Cap-09-OK-Mayo-7.pdf" target="_blank" rel="noopener" title="Capítulo 9 - cgc.qroo.gob.mx" style="color:#fff; text-decoration:underline;">cgc.qroo.gob.mx</a>
                </div>
            </div>
        </section>
        
        

        <!-- Step 4: Población en perspectiva  -->
        <section class="step" data-step="4" style="min-height: 200vh;">
            <div class="step-content">
                <h2>Cinco Décadas de Crecimiento Extraordinario</h2>
                <p>Detrás de las cifras de crecimiento explosivo está el componente humano: "La Década de los Pioneros". Los primeros equipos llegaron en enero de 1970 y tuvieron que abrir brecha a machete en la selva.</p>
                <p>Vivían en campamentos improvisados, en un entorno agreste sin servicios básicos. Esta experiencia de desafío colectivo forjó la identidad de la ciudad, creando un mosaico de acentos, costumbres y esperanzas y estableciendo el ADN migrante, dinámico y multicultural que define a Cancún hasta hoy.</p>
                
                <!-- Substeps discretos para controlar la gráfica-->
                <div class="substeps">
                    <div class="substep" data-chart="benito">
                        <h3>Cancún (Benito Juárez)</h3>
                    </div>
                    <div class="substep" data-chart="qroo">
                        <h3>Quintana Roo</h3>
                    </div>
                    <div class="substep" data-chart="mexico">
                        <h3>México</h3>
                    </div>
                    <div class="substep" data-chart="mundo">
                        <h3>Mundo</h3>
                    </div>
                </div>

                <div class="chart-container">
                    <div id="populationGrowthChart"></div>
                    <div class="tooltip"></div>
                </div>
            </div>
        </section>

        <!-- Step 5: Imagen 6.jpg como separador a pantalla completa con fade por scroll -->
        <section class="step" data-step="5" style="position:relative; padding:0; margin:0; background:none !important; display:block; overflow:hidden; min-height:100vh;">
            <div class="floating-image-wrapper" style="position:relative; width:100%; height:100vh; overflow:hidden;">
                <img src="assets/6.jpg" alt="Cancún histórico" class="floating-image" loading="lazy" decoding="async">
                <div class="photo-credit step5-credit">
                    Fuente: <a href="https://www.reportur.com/agencias/2025/04/22/fotos-asi-lucia-cancun-hace-55-anos-antes-de-ser-destino-turistico/" target="_blank" rel="noopener" title="Fotos – Así lucía Cancún hace 55 años antes de ser destino turístico">Fotos – Así lucía Cancún hace 55 años</a>
                </div>
            </div>
            <style>
                /* Imagen llena siempre el viewport sin distorsión */
                section[data-step="5"] .floating-image {
                    position:absolute;
                    inset:0;
                    width:100%;
                    height:100%;
                    object-fit:cover;
                    object-position:center center;
                    display:block;
                    opacity:0; /* fade controlado por scroll */
                    transition:opacity 120ms linear;
                    will-change:opacity;
                }
                section[data-step="5"] .floating-image-wrapper .step5-credit {
                    position:absolute !important;
                    left:50% !important;
                    bottom:12px !important;
                    transform:translateX(-50%) !important;
                    background:rgba(0,0,0,0.55) !important;
                    color:#fff !important;
                    font-size:clamp(11px,1.05vw,14px) !important;
                    line-height:1.25 !important;
                    padding:6px 12px !important;
                    text-align:center !important;
                    width:auto !important;
                    max-width:84% !important;
                    display:inline-block !important;
                    border-radius:6px !important;
                    box-sizing:border-box !important;
                    z-index:4 !important;
                    backdrop-filter:blur(4px) saturate(140%) !important;
                    -webkit-backdrop-filter:blur(4px) saturate(140%) !important;
                    pointer-events:auto !important;
                    margin: 0 !important;
                }
                section[data-step="5"] .step5-credit a { color:#fff; text-decoration:underline; }
                @media (max-width: 600px) {
                    section[data-step="5"] .floating-image-wrapper .step5-credit { font-size:12px !important; padding:6px 10px !important; bottom:8px !important; }
                }
                /* Móviles y tablets: forzar cobertura total (permitir recorte) hasta 768px */
                @media (max-width: 768px) {
                    section[data-step="5"] { min-height:100vh !important; }
                    section[data-step="5"] .floating-image-wrapper { height:100vh !important; }
                    /* Altura más robusta en navegadores móviles modernos */
                    @supports (height: 100svh) {
                        section[data-step="5"] .floating-image-wrapper { height:100svh !important; }
                    }
                    @supports (height: 100dvh) {
                        section[data-step="5"] .floating-image-wrapper { height:100dvh !important; }
                    }
                    /* Anular flex heredado de .step (centrado) que puede provocar desplazamientos */
                    section[data-step="5"] { display:block !important; align-items:initial !important; justify-content:initial !important; }
                    section[data-step="5"] .floating-image { object-fit:cover !important; background:#000; }
                }
            </style>
        </section>

        <!-- Step 6: Expansión urbana sin freno  -->
        <section class="step" data-step="6">
            <div class="step-content">
                <h2>Expansión Urbana Sin Freno</h2>
                <p>El modelo expansivo no solo fue rápido, fue segregado. La expansión, especialmente en los años 90, consolidó la fragmentación de Cancún en tres ciudades funcional y socialmente separadas: una para los turistas en la Zona Hotelera, otra para residentes acomodados en fraccionamientos privados, y una tercera, precaria y con servicios deficientes, para la mayoría de la fuerza laboral en asentamientos irregulares.</p>
                <p>Esta desigualdad no fue un fracaso del plan original, sino el resultado lógico de su éxito y de su dualidad codificada.</p>
            </div>
        </section>

        <!-- Step 7: Imagen 1975.jpg  -->
        <section class="step urban-year-image" data-step="7" data-year="1975">
            
        </section>

        <!-- Step 8 -->
        <section class="step urban-year-image lazy-bg" data-step="8" data-year="1980" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <div class="caption-body">
                    <div class="caption-text">
                        <p>Este crecimiento lento pero constante se explica por un contexto nacional complicado. Los años 80 son conocidos en México como la "Década Perdida".</p>
                        <ul>
                            <li><strong>Crisis de la Deuda (1982):</strong> México sufre una severa crisis económica que frena la inversión.</li>
                        </ul>
                    </div>
                    <div class="caption-image">
                        <img src="assets/evento1.jpg" alt="Evento 1980">
                    </div>
                </div>
            </div>
            <span class="year-label-mobile" style="position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:4px; font-size:14px; display:none;">1980</span>
        </section>

        <!-- Step 9: Imagen 1985.jpg  -->
        <section class="step urban-year-image" data-step="9" data-year="1985">
            <div class="year-caption">
                <p><strong>1985: Consolidación en medio de adversidad</strong></p>
                <p>La ciudad alcanza las 5,515 hectáreas, con un crecimiento del 11.7% desde 1980.</p>
                <p>El contexto económico nacional dificulta el desarrollo del proyecto turístico.</p>
                <ul>
                    <li><strong>Terremoto de 1985 (CDMX):</strong> Redirigió recursos federales a la capital.</li>
                </ul>
                
            </div>
        </section>

        <!-- Step 10: Carrusel texto/imagen (1990) -->
        <section class="step urban-year-image" data-step="10" data-year="1990" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <div class="caption-body">
                    <div class="caption-text">
                        <p><strong>1990: Fin de la primera década</strong></p>
                        <p>La huella urbana llega a 6,244 hectáreas, con un crecimiento acumulado del 26.4% desde 1980.</p>
                        <p>Los primeros 10 años fueron de consolidación y supervivencia en un entorno nacional muy adverso.</p>
                        <ul>
                            <li><strong>Firma del TLCAN (NAFTA) (1992-1994): </strong> Abrió a México a una inversión extranjera sin precedentes.</li>
                        </ul>
                    </div>
                    <div class="caption-image">
                        <img src="assets/evento2.jpg" alt="Evento 1990">
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 11: Imagen 1995.jpg  -->
        <section class="step urban-year-image" data-step="11" data-year="1995" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <p><strong>1995: El primer gran salto</strong></p>
                <p>La ciudad alcanza las 8,009 hectáreas, con un crecimiento del 28.3% en solo cinco años.</p>
                <p>El TLCAN y la devaluación del peso impulsan el turismo y la inversión.</p>
                <ul>
                    <li><strong>La "Crisis del Tequila" (1994-1995):</strong>  La devaluación del peso hizo que Cancún fuera extremadamente barato para el turismo internacional.</li>
                </ul>
                <ul>
                    <li><strong>Consolidación del Modelo:</strong> Cancún se establece como una marca global.</li>
                </ul>
            </div>
        </section>

        <!-- Step 12: Imagen 2000.jpg  -->
        <section class="step urban-year-image" data-step="12" data-year="2000" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <div class="caption-body">
                    <div class="caption-text">
                        <p><strong>2000: Fin de la explosión inicial</strong></p>
                        <p>La huella urbana llega a 9,848 hectáreas, casi el doble que en 1990.</p>
                        <p>Este fue el "milagro" de Cancún, impulsado por la inversión extranjera y un tipo de cambio favorable.</p>
                        <ul>
                            <li><strong>Ataques del 9/11 (2001):</strong> Frenó en seco el turismo aéreo global.</li>
                        </ul>
                    </div>
                    <div class="caption-image">
                        <img src="assets/evento3.jpg" alt="Evento 2000">
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 13: Imagen 2005.jpg  -->
        <section class="step urban-year-image" data-step="13" data-year="2005" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <p><strong>2005: Antes del huracán Wilma</strong></p>
                <p>La ciudad alcanza las 11,247 hectáreas, con un crecimiento del 14.2% desde 2000.</p>
                <p>El crecimiento se había desacelerado tras los ataques del 9/11.</p>
                <ul>
                    <li><strong>Huracán Wilma (Octubre 2005):</strong> El peor desastre natural en la historia de Cancún.</li>
                </ul>
                <ul>
                    <li><strong>Crisis Financiera Global (2008-2009) y Gripe H1N1 (2009):</strong> Secaron el crédito y paralizaron el turismo.</li>
                </ul>
            </div>
        </section>

        <!-- Step 14: Imagen 2010.jpg  -->
        <section class="step urban-year-image" data-step="14" data-year="2010" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <div class="caption-body">
                    <div class="caption-text">
                        <p><strong>2010: Superando la adversidad</strong></p>
                        <p>La huella urbana llega a 12,516 hectáreas, con un crecimiento acumulado del 153.4% desde 1980.</p>
                        <p>A pesar de todo, la ciudad siguió creciendo, demostrando su increíble capacidad de recuperación.</p>
                        <ul>
                            <li><strong>Tras sobrevivir a la década anterior, Cancún entra en una nueva fase de expansión masiva.
                                Recuperación Post-Crisis:</strong>  El capital de inversión regresa con fuerza.</li>
                        </ul>
                    </div>
                    <div class="caption-image">
                        <img src="assets/evento4.jpg" alt="Evento 2010">
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 15: Imagen 2015.jpg  -->
        <section class="step urban-year-image" data-step="15" data-year="2015" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <p><strong>2015: La mayor expansión absoluta</strong></p>
                <p>La ciudad alcanza las 15,197 hectáreas, con un crecimiento del 21.4% en cinco años.</p>
                <p>El crecimiento ya no es solo de hoteles, sino de urbanización residencial.</p>
                <ul>
                    <li><strong>Boom de la Riviera Maya:</strong>Cancún se consolida como la metrópoli regional.
                        <li><strong>Nuevos Mercados:</strong>Crecimiento de desarrollos residenciales, condominios y plazas comerciales.</li>
                </ul>
            </div>
        </section>

        <!-- Step 16. Imagen 2020.jpg  -->
        <section class="step urban-year-image" data-step="16" data-year="2020" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <div class="caption-body">
                    <div class="caption-text">
                        <p><strong>2020: Metropolización consolidada</strong></p>
                        <p>La huella urbana llega a 17,309 hectáreas, con un crecimiento acumulado del 250.5% desde 1980.</p>
                        <p>Cancún se ha convertido en la metrópoli regional con aeropuerto internacional, servicios especializados y vivienda para la creciente fuerza laboral.</p>
                        <ul>
                            <li><strong>Pandemia de COVID-19 (2020-2021):</strong> Cancún se convirtió en un "oasis" global, atrayendo turismo y "nómadas digitales".</li>
                        </ul>
                        <ul>
                            <li><strong>El Tren Maya (2019-Presente):</strong> Ha generado una nueva ola de especulación inmobiliaria.</li>
                        </ul>
                    </div>
                    <div class="caption-image">
                        <img src="assets/evento5.jpg" alt="Evento 2020">
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 17: Imagen 2025.jpg  -->
        <section class="step urban-year-image" data-step="17" data-year="2025" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="year-caption">
                <p><strong>2025: Proyección a futuro</strong></p>
                <p>La huella urbana proyectada es de 18,762 hectáreas, con un crecimiento acumulado del 279.9% desde 1980.</p>
                <p>La desaceleración actual puede deberse a la saturación del mercado y nuevos retos como el sargazo y preocupaciones ambientales.</p>
            </div>
        </section>

        <!-- Step 18: Dispersión poblacional y abandono del centro  -->
        <section class="step" data-step="18">
            <div class="step-content">
                <h2>Dispersión Poblacional y Abandono del Centro</h2>
                <p>Entre 2010 y 2020, diversas AGEB del área central (Supermanzanas históricas alrededor de la Av. Tulum y el primer cuadro) registraron caídas acumuladas superiores al 10% en población residente, mientras que frentes periféricos de expansión alcanzaron incrementos del 20–30%. Este contraste evidencia un patrón de urbanización más dispersa: más superficie urbanizada para alojar proporcionalmente menos personas en el corazón de la ciudad.</p>
                <p>La pérdida de densidad central y el crecimiento extensivo periférico elevan costos de movilidad, servicios e infraestructura, diluyen la vida comunitaria cotidiana y generan vacíos funcionales donde antes había cercanía y mezcla de usos.</p>
                <p>Revertir la tendencia implica revitalizar barrios centrales, diversificar usos y acercar oportunidades a la periferia para construir un Cancún más compacto, equitativo y sostenible.</p>
            </div>
        </section>
        
        <!-- Step 19: Cambio porcentual de población por AGEB (2010–2020) -->
        <section class="step has-map" data-step="19" data-map="true" data-map-layer="cambio-poblacional-ageb" data-map-view="ciudad_central">
            <div class="step-content">
                <h2>Cambio porcentual de población por AGEB (2010–2020)</h2>
                <p>El mapa muestra <strong>el cambio porcentual de población por AGEB entre 2010 y 2020</strong>. Los tonos más claros indican pérdida de población y los tonos verdes oscuros crecimiento intenso.</p>
                <p>La periferia absorbió gran parte del aumento demográfico mientras áreas centrales experimentaron estanque o retrocesos, acentuando la expansión dispersa.</p>
            </div>
        </section>

        <!-- Step 20: Impacto ambiental  -->
        <section class="step" data-step="20">
            <div class="step-content">
                <h2>El Costo Ambiental del Crecimiento</h2>
                <p>La vulnerabilidad a huracanes ha forjado el carácter de la ciudad. "Gilberto" en 1988 fue el bautismo de fuego, y la respuesta colectiva para reconstruir la ciudad creó un fuerte sentido de comunidad y una cultura de huracanes.</p>
                <p>Años después, el devastador "Wilma" en 2005 llevó esto a otro nivel, requiriendo una reconstrucción a mega escala donde las playas tuvieron que ser reconstruidas artificialmente con arena dragada, consolidando la imagen de Cancún como un paraíso construido y sostenido por la tecnología humana.</p>
                <p>Hoy, a la presión sobre selvas y manglares se suma una nueva crisis ambiental: los arribazones masivos de sargazo, vinculados al cambio climático.</p>
            </div>
        </section>
        
        <!-- Steps 21–23: Serie de pérdida de cobertura forestal (2000, 2010, 2020) -->
        <section class="step forest-year-image" data-step="21" data-forest-year="2000" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="step-content">
                <h2>Pérdida de cobertura forestal – 2000</h2>
            </div>
        </section>

        <section class="step forest-year-image" data-step="22" data-forest-year="2010" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="step-content">
                <h2>Pérdida de cobertura forestal – 2010</h2>
            </div>
        </section>

        <section class="step forest-year-image" data-step="23" data-forest-year="2020" style="position: relative; overflow: hidden; min-height: 100vh;">
            <div class="step-content">
                <h2>Pérdida de cobertura forestal – 2020</h2>
            </div>
        </section>

        <!-- Step 24: Desigualdad territorial  -->
        <section class="step" data-step="24">
            <div class="step-content">
                <h2>Desigualdad Territorial</h2>
                <p>Cancún presenta una organización en 22 distritos con densidades contrastantes: mientras algunos núcleos superan los 100 habitantes por hectárea y concentran oferta de servicios, otros bordes permanecen por debajo de los 10, con menor mezcla de usos y mayores tiempos de traslado.</p>
                <p>Estas diferencias espaciales se reflejan en el grado de marginación: carencias simultáneas en acceso a educación, salud, equipamiento público, infraestructura urbana básica y calidad de vivienda se superponen con baja conectividad y fragmentación funcional.</p>
                <p>La combinación de alta marginación más la baja densidad genera costos crecientes para dotar servicios y perpetúa brechas de oportunidad. Invertir estratégicamente implica densificar con calidad donde exista infraestructura subutilizada y mejorar accesos y equipamientos en áreas rezagadas.</p>
                <p>La equidad territorial es el pilar para una ciudad justa y resiliente: redistribuir oportunidades, reducir desplazamientos obligados y articular vivienda, trabajo y cuidados en proximidad.</p>
            </div>
        </section>
        
        <!-- Step 25: Mapa de grado de marginación (GM_2020) -->
        <section class="step has-map" data-step="25" data-map="true" data-map-layer="indice_marginacion" data-map-view="distritos">
            <div class="step-content">
                <h2>Grado de Marginación 2020</h2>
                <p>Visualización territorial del grado de marginación (GM 2020) clasificado en cinco categorías: Muy alto, Alto, Medio, Bajo y Muy bajo, que evidencian diferencias estructurales en acceso a servicios y condiciones socioeconómicas.</p>
                <p>Esta capa permite identificar zonas que requieren prioridad en políticas de inclusión social y mejoramiento urbano.</p>
            </div>
        </section>

        <!-- Step 26: Motorización acelerada  -->
        <section class="step" data-step="26">
            <div class="step-content">
                <h2>Motorización Acelerada</h2>
                <p>El parque vehicular ha crecido significativamente: de unos 220 mil autos en 2010 a casi 529 mil en 2025 (+140%). Este desbalance es notable frente a las viviendas; pasamos de 1.20 autos por vivienda en 2010 a 1.60 en 2020.</p>
                <p>Como se observa en la gráfica, este desequilibrio no es reciente: fue en el año 2006 cuando el número de vehículos registrados superó por primera vez al número de viviendas.</p>
                <p>Este crecimiento refuerza la dependencia del automóvil, genera congestión y multiplica las desigualdades: quienes no tienen vehículo enfrentan traslados más largos y menos oportunidades. El gran desafío es construir un modelo de movilidad equitativa, con transporte público eficiente y movilidad activa accesible para todas y todos.</p>
            </div>
        </section>

        <!-- Step 27: Gráfico interactivo del parque vehicular  -->
        <section class="step" data-step="27">
            <div class="step-content">
                <h2>Evolución del Parque Vehicular</h2>
                <div class="chart-container">
                    <div id="vehicleGrowthChart"></div>
                    <div class="tooltip"></div>
                </div>
                <p style="text-align: center; font-size: 20px; margin-top: 10px;">Fuente: INEGI, Vehículos de Motor Registrados en Circulación y Censos de Población y Vivienda.</p>
            </div>
        </section>

        <!-- Step 28: Consecuencias sociales y urbanas  -->
        <section class="step" data-step="28">
            <div class="step-content">
                <h2>Consecuencias Sociales y Urbanas</h2>
                <p>El modelo expansivo se refleja en la vida cotidiana: más horas en traslados, servicios lejanos, menor convivencia comunitaria. La ciudad se encarece al mantener colonias lejanas y pierde cohesión social.</p>
                <p>Pero este rumbo puede cambiar: priorizar calidad sobre extensión, proximidad sobre distancia, equidad sobre desigualdad.</p>
                <p>Estamos a tiempo de transformar los costos invisibles en oportunidades de bienestar compartido.</p>
            </div>
        </section>

        <!-- Step 29: Fotos de tráfico + periferias con servicios insuficientes  -->
        <section class="step" data-step="29" style="position: relative; min-height: 100vh; overflow: hidden; padding: 0; margin: 0;">
            <!-- Contenedor principal que ocupa toda la pantalla -->
            <div class="consequence-images-wrapper" style="display: flex; width: 100%; height: 100vh; position: relative;">
                <!-- Imagen 25.jpg a la izquierda (lazy) -->
                <div class="consequence-image-left lazy-bg" data-bg="assets/25.jpg"></div>
                
                <!-- Imagen 20.jpg a la derecha (lazy) -->
                <div class="consequence-image-right lazy-bg" data-bg="assets/20.jpg"></div>
            </div>
            
            <style>
                /* Estado base (oculto) */
                section[data-step="29"] .consequence-image-left,
                section[data-step="29"] .consequence-image-right {
                    flex: 1;
                    background-size: cover;
                    background-position: center;
                    opacity: 0;
                    transform: scale(0.9);
                }

                section[data-step="29"] .consequence-image-left {
                    /* background-image aplicado de forma perezosa vía data-bg */
                    transform: scale(0.9) translateX(-40px);
                }

                section[data-step="29"] .consequence-image-right {
                    /* background-image aplicado de forma perezosa vía data-bg */
                    transform: scale(0.9) translateX(40px);
                }

                /* Animaciones */
                @keyframes popupLeft {
                    0% { opacity: 0; transform: scale(0.9) translateX(-40px); }
                    100% { opacity: 1; transform: scale(1) translateX(0); }
                }

                @keyframes popupRight {
                    0% { opacity: 0; transform: scale(0.9) translateX(40px); }
                    100% { opacity: 1; transform: scale(1) translateX(0); }
                }

                @keyframes popupTop {
                    0% { opacity: 0; transform: scale(0.9) translateY(-40px); }
                    100% { opacity: 1; transform: scale(1) translateY(0); }
                }

                @keyframes popupBottom {
                    0% { opacity: 0; transform: scale(0.9) translateY(40px); }
                    100% { opacity: 1; transform: scale(1) translateY(0); }
                }

                /* Entrando hacia abajo (desde arriba) */
                section[data-step="29"].animate-down .consequence-image-left { animation: popupLeft 0.6s ease-out 0.1s forwards; }
                section[data-step="29"].animate-down .consequence-image-right { animation: popupRight 0.6s ease-out 0.25s forwards; }

                /* Entrando hacia arriba (desde abajo) - reutilizamos animación para consistencia */
                section[data-step="29"].animate-up .consequence-image-left { animation: popupLeft 0.6s ease-out 0.1s forwards; }
                section[data-step="29"].animate-up .consequence-image-right { animation: popupRight 0.6s ease-out 0.25s forwards; }

                /* Responsive: apilar imágenes en pantallas pequeñas */
                @media (max-width: 768px) {
                    section[data-step="29"] .consequence-images-wrapper {
                        flex-direction: column !important;
                    }

                    section[data-step="29"] .consequence-image-left {
                        transform: scale(0.9) translateY(-40px);
                    }

                    section[data-step="29"] .consequence-image-right {
                        transform: scale(0.9) translateY(40px);
                    }

                    /* Animaciones verticales para móviles */
                    section[data-step="29"].animate-down .consequence-image-left { 
                        animation: popupTop 0.6s ease-out 0.1s forwards; 
                    }
                    section[data-step="29"].animate-down .consequence-image-right { 
                        animation: popupBottom 0.6s ease-out 0.25s forwards; 
                    }

                    section[data-step="29"].animate-up .consequence-image-left { 
                        animation: popupTop 0.6s ease-out 0.1s forwards; 
                    }
                    section[data-step="29"].animate-up .consequence-image-right { 
                        animation: popupBottom 0.6s ease-out 0.25s forwards; 
                    }
                }
            </style>
        </section>

        <!-- Step 30: Estrategias de Futuro  -->
        <section class="step" data-step="30">
            <div class="step-content">
                <h2>Estrategias de Futuro</h2>
                <p>La ciudad de la proximidad de 15 minutos no es una moda importada: retoma la lógica original de las supermanzanas centrales donde vivienda, abastecimiento, aprendizaje, cuidados y recreación coexistían caminando.</p>
                <p>Mientras megaproyectos como el Puente Nichupté y el Tren Maya redefinen escalas regionales y flujos turísticos, la calidad de vida cotidiana depende de reducir desplazamientos obligatorios mediante densidad funcional cercana.</p>
                <p>Las nuevas dinámicas (nómadas digitales, <em>workation</em>, servicios especializados) exigen flexibilidad; la equidad demanda que la proximidad se democratice y no permanezca como privilegio de zonas consolidadas.</p>
                <p>Medir proximidad implica pasar del inventario aislado de equipamientos a cuantificar la diversidad agregada de funciones accesibles a pie y su distribución territorial.</p>
            </div>
        </section>

        <!-- Step 31: Mapa de dimensiones de caminar -->
        <section class="step has-map" data-step="31" data-map="true" data-map-layer="dimensiones_caminar" data-map-view="dimensiones" style="position: relative; min-height: 100vh;">
            <div class="step-content">
                <h2>Mapa: Proximidad Funcional Caminable</h2>
        </section>

        <!-- Step 32: Looking ahead (Cierre / Call to action)  -->
        <section class="step" data-step="32" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)); color: white;">
            <div style="display: flex; align-items: center; max-width: 1200px; margin: 0 auto; gap: 30px;">
                <!-- Columna de texto a la izquierda -->
                <div class="step-content" style="flex: 1;">
                    <h2>El Futuro Está en Nuestras Manos</h2>
                    <p>Cancún seguirá creciendo. La pregunta es: ¿cómo lo haremos?</p>
                    <p>Hoy tenemos la posibilidad de transformar los retos en oportunidades y proyectar un Cancún ordenado, resiliente y justo. Desde el IMPLAN impulsamos estrategias de planeación que priorizan la equidad, la sostenibilidad y la proximidad.</p>
                    <p>Pero la construcción de esta ciudad no depende solo del gobierno: requiere la participación activa de la ciudadanía.</p>
                    <p>El futuro de Cancún está en nuestras manos, y juntos podemos hacerlo posible.</p>
                </div>
                
                <!-- Imagen a la derecha -->
                <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
                    <img src="assets/27.png" loading="lazy" decoding="async" style="max-width: 100%; max-height: 70vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);" alt="Futuro de Cancún">
                </div>
            </div>
        </section>

        <!-- Footer con logo IMPLAN -->
        <div class="footer">
            <p>IMPLAN Cancún | Instituto de Planeación del Desarrollo Urbano</p>
            <p>© 2025 - Todos los derechos reservados</p>
        </div>
    </main>

    <script>
        // Este script ha sido movido a archivos externos:
        // - cancun-main.js: configuración principal de Scrollama y mapas
        // - population-chart.js: gráfico interactivo de población 
        // - urban-evolution.js: visualización de evolución urbana
        
        // Script adicional para configurar fondos de secciones específicas
        document.addEventListener('DOMContentLoaded', function() {
            // Lazy-load para fondos de secciones con data-bg
            (function(){
                const lazyBgs = Array.from(document.querySelectorAll('.lazy-bg[data-bg]'));
                if (!lazyBgs.length) return;
                const supportIO = 'IntersectionObserver' in window;
                const applyBg = (el) => {
                    if (el.dataset.bgApplied) return;
                    const url = el.getAttribute('data-bg');
                    if (!url) return;
                    // Preload de imagen para evitar flash
                    const img = new Image();
                    img.onload = () => {
                        el.style.backgroundImage = `url('${url}')`;
                        el.dataset.bgApplied = '1';
                    };
                    img.src = url;
                };
                if (!supportIO) {
                    lazyBgs.forEach(applyBg);
                    return;
                }
                const io = new IntersectionObserver((entries)=>{
                    entries.forEach(entry=>{
                        if (entry.isIntersecting || entry.intersectionRatio > 0) {
                            applyBg(entry.target);
                            io.unobserve(entry.target);
                        }
                    });
                }, { root: null, rootMargin: '300px 0px', threshold: 0.01 });
                lazyBgs.forEach(el=>io.observe(el));
            })();
            // La configuración de fondo para la sección de cierre ha sido eliminada
            // El step 30 ahora usa solo el fondo de color sin imagen
            
            // Configurar otros fondos de secciones según sea necesario
            // Se reemplazó la asignación inmediata de background-image por lazy-load con .lazy-bg
            // La sección con fotos de tráfico ha sido eliminada
            
            // Asegurarnos de que el video de fondo se reproduce correctamente
            const bgVideo = document.getElementById('background-video');
            const playBtn = document.getElementById('bgVideoPlayBtn');
            if (bgVideo) {
                bgVideo.muted = true; // asegurar mute para autoplay
                const attemptPlay = () => {
                    const playPromise = bgVideo.play();
                    if (playPromise && typeof playPromise.then === 'function') {
                        playPromise.then(() => {
                            if (playBtn) playBtn.style.display = 'none';
                        }).catch(err => {
                            console.warn('Autoplay rechazado, esperando interacción del usuario:', err);
                            if (playBtn) playBtn.style.display = 'block';
                        });
                    }
                };
                attemptPlay();
                if (playBtn) {
                    playBtn.addEventListener('click', () => {
                        playBtn.disabled = true;
                        attemptPlay();
                        setTimeout(() => { playBtn.disabled = false; }, 1200);
                    });
                }
                // Un solo intento adicional tras primera interacción global
                const oneTimeRetry = () => attemptPlay();
                document.addEventListener('click', oneTimeRetry, { once: true });
                document.addEventListener('keydown', oneTimeRetry, { once: true });
                // Mantener proporciones del video
                const handleResize = () => {
                    const step1 = document.querySelector('section[data-step="1"]');
                    if (step1 && bgVideo.videoWidth && bgVideo.videoHeight) {
                        const aspectRatio = bgVideo.videoWidth / bgVideo.videoHeight;
                        const containerWidth = step1.offsetWidth;
                        const containerHeight = step1.offsetHeight;
                        if ((containerWidth / containerHeight) < aspectRatio) {
                            bgVideo.style.width = 'auto';
                            bgVideo.style.height = '100%';
                        } else {
                            bgVideo.style.width = '100%';
                            bgVideo.style.height = 'auto';
                        }
                    }
                };
                window.addEventListener('resize', handleResize);
                bgVideo.addEventListener('loadedmetadata', handleResize);
            }
        });
    </script>
    
    <script>
        // Fade controlado por scroll: entrada (fade in) y salida (fade out) para imagen del step 5
        (function(){
            const step = document.querySelector('section[data-step="5"]');
            const img = step ? step.querySelector('.floating-image') : null;
            if(!step || !img) return;

            function updateOpacity(){
                const rect = step.getBoundingClientRect();
                const vh = window.innerHeight;
                const stepHeight = rect.height;

                // Si el step está completamente fuera de vista
                if (rect.bottom <= 0 || rect.top >= vh) {
                    img.style.opacity = 0;
                    return;
                }

                // Progreso de entrada: de top justo entrando (rect.top ~ vh) a completamente dentro (rect.top <= 0)
                const enterProgress = 1 - Math.min(1, Math.max(0, rect.top / vh)); // 0 -> 1

                // Progreso de salida: cuando la parte inferior comienza a subir por encima del viewport
                const exitStart = stepHeight - vh; // exceso de altura si lo hay
                let exitProgress = 0;
                if (stepHeight > vh) {
                    // scrolled dentro del step
                    const scrolledInside = Math.min(stepHeight, Math.max(0, -rect.top));
                    exitProgress = Math.min(1, Math.max(0, (scrolledInside - (exitStart * 0.2)) / (exitStart * 0.8)));
                } else {
                    // Si el crédito añade altura extra mínima: usar parte inferior
                    exitProgress = Math.min(1, Math.max(0, (vh - rect.bottom) / (vh * 0.4))); // comienza a 0 cuando bottom=vh
                }

                // Opacidad: primero aparece (enterProgress), luego se mantiene y finalmente se desvanece (exitProgress)
                let opacity = enterProgress * (1 - exitProgress);
                opacity = Math.min(1, Math.max(0, opacity));
                img.style.opacity = opacity;
            }

            window.addEventListener('scroll', updateOpacity, { passive: true });
            window.addEventListener('resize', updateOpacity);
            updateOpacity();
        })();
    </script>
</body>
</html>