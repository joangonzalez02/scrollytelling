document.addEventListener("DOMContentLoaded",function(){const t="vehicleGrowthChart",e=`public/data/parque-vehicular.csv?v=${Date.now()}`,a=document.getElementById(t);if(a&&a.parentElement){a.parentElement;a.style.display="flex",a.style.flexDirection="column",a.style.width="100%",a.style.height="100%",a.style.position="relative",a.style.overflow="hidden"}const n="#219EBC",r="#FB8500",s="#023047",l="rgba(2,48,71,0.08)",i={data:[],hasDrawn:!1,hasLoaded:!1,resizeObserver:null,refs:{g:null,bars:null,labels:null,path:null,points:null,overlay:null,dims:null,scales:null},tooltip:null};function o(t){return String(t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"")}function d(t){const e=Object.keys(t),a={};for(const n of e)a[o(n)]=t[n];let n=+a.ano||+a.anio||+a.year;if(!n){n=+t[e[0]]}let r=+a.vehiculos_totales||+a.vehiculos||+a.total;if(!r){const n=Object.keys(a).find(t=>t.includes("vehicul")&&!t.includes("por_vivienda"));n?r=+a[n]:e.length>1&&(r=+t[e[1]])}const s=a.vehiculos_por_vivienda||a.autos_por_vivienda||a.vph;return{year:n,vehicles:r,vehiclesPerHousehold:void 0===s||""===s?null:+s}}function c(t){return t>=1e6?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e3?(t/1e3).toFixed(0)+"k":t>=100?(t/1e3).toFixed(1)+"k":String(t)}function h(){const e=d3.select(`#${t}`);if(e.empty()||!i.data.length)return;e.html(""),d3.select("body").select(".vehicle-tooltip").remove(),i.tooltip=d3.select("body").append("div").attr("class","vehicle-tooltip").style("position","absolute").style("background","rgba(2, 48, 71, 0.95)").style("color","white").style("padding","12px 16px").style("border-radius","8px").style("font-size","14px").style("font-weight","500").style("line-height","1.4").style("pointer-events","none").style("opacity",0).style("box-shadow","0 4px 12px rgba(0,0,0,0.15)").style("transition","opacity 0.2s ease").style("z-index","1000").style("max-width","200px");const a=function(){const e=document.getElementById(t),a=e?e.getBoundingClientRect():null,n=a?a.width:1e3;let r;r=n<=480?80:n<=768?100:120;const s={top:40,right:r,bottom:80,left:r};return{width:1e3,height:400,margin:s,innerW:1e3-s.left-s.right,innerH:400-s.top-s.bottom}}(),o={axis:14,title:18,labels:14,legend:14},d=e.append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${a.width} ${a.height}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%"),h=d.append("g").attr("transform",`translate(${a.margin.left},${a.margin.top})`),p=`veh-bar-gradient-${Date.now()}`,y=d.append("defs").append("linearGradient").attr("id",p).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");y.append("stop").attr("offset","0%").attr("stop-color",n),y.append("stop").attr("offset","100%").attr("stop-color","#8ECAE6");let u=null,v=null;i.data.forEach(t=>{null!=u&&null!=t.vehicles&&t.vehicles>0?t.growthVehicles=(t.vehicles-u)/u*100:t.growthVehicles=null,u=t.vehicles,null==t.vehiclesPerHousehold||isNaN(t.vehiclesPerHousehold)?t.growthVPH=null:(t.growthVPH=null!=v&&v>0?(t.vehiclesPerHousehold-v)/v*100:null,v=t.vehiclesPerHousehold)});const f=i.data.map(t=>t.year),x=d3.scaleBand().domain(f).range([0,a.innerW]).padding(.2),g=d3.scaleLinear().domain([0,1.1*d3.max(i.data,t=>t.vehicles)]).nice().range([a.innerH,0]),m=d3.max(i.data,t=>t.vehiclesPerHousehold||0)||1,w=d3.scaleLinear().domain([0,1.15*m]).nice().range([a.innerH,0]),b=d3.axisBottom(x).tickValues(f.filter((t,e)=>!(f.length>10)||e%1==0)).tickFormat(d3.format("d")),$=d3.axisLeft(g).ticks(6).tickFormat(t=>c(t)),H=d3.axisRight(w).ticks(5);h.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${a.innerH})`).call(b).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none").attr("transform","rotate(-45)").attr("text-anchor","end").attr("dx","-.8em").attr("dy",".15em"),h.select(".x-axis").style("pointer-events","none"),h.append("g").attr("class","axis y-axis-left").call($).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),h.select(".y-axis-left").style("pointer-events","none"),h.append("g").attr("class","axis y-axis-right").attr("transform",`translate(${a.innerW},0)`).call(H).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),h.select(".y-axis-right").style("pointer-events","none"),h.append("g").attr("class","grid").call(d3.axisLeft(g).tickSize(-a.innerW).tickFormat("")).selectAll("line").attr("stroke",l);[".x-axis",".y-axis-left",".y-axis-right"].forEach(t=>{h.select(t).selectAll("path, line").style("stroke","rgba(120, 120, 120, 0.2)")});const k=x.bandwidth(),P=h.selectAll(".veh-bar").data(i.data,t=>t.year).enter().append("rect").attr("class","veh-bar").style("pointer-events","all").attr("x",t=>x(t.year)).attr("y",a.innerH).attr("width",k).attr("height",0).attr("fill",`url(#${p})`).attr("rx",Math.max(2,.08*k)),V=h.selectAll(".value-label").data(i.data,t=>t.year).enter().append("text").attr("class","value-label").attr("x",t=>x(t.year)+x.bandwidth()/2).attr("y",t=>g(t.vehicles)-8).attr("text-anchor","middle").style("font-size",`${o.labels}px`).style("fill",s).style("text-shadow","none").style("pointer-events","none").style("opacity",0).text(t=>c(t.vehicles)),C=t=>null!=t.vehiclesPerHousehold&&!isNaN(t.vehiclesPerHousehold),A=d3.line().defined(C).x(t=>x(t.year)+x.bandwidth()/2).y(t=>w(t.vehiclesPerHousehold)).curve(d3.curveMonotoneX),E=h.append("path").datum(i.data.filter(C)).attr("class","vph-line").attr("fill","none").attr("stroke",r).attr("stroke-width",3).attr("d",A).style("pointer-events","none"),L=h.selectAll(".vph-point").data(i.data.filter(C)).enter().append("circle").attr("class","vph-point").attr("cx",t=>x(t.year)+x.bandwidth()/2).attr("cy",t=>w(t.vehiclesPerHousehold)).attr("r",0).attr("fill",r).attr("stroke","#fff").attr("stroke-width",1.5).style("pointer-events","auto").on("mouseover",function(t,e){let a=`\n                    <div><strong>Año ${e.year}</strong></div>\n                    <div>Autos/vivienda: <span style="color: ${r}">${e.vehiclesPerHousehold.toFixed(2)}</span></div>\n                `;if(null!=e.growthVPH&&!isNaN(e.growthVPH)){const t=e.growthVPH>0?"+":"";let n="#e5e7eb";e.growthVPH>0?n="#2ECC71":e.growthVPH<0&&(n="#E63946"),a+=`<div>Incremento: <span style="color:${n}">${t}${e.growthVPH.toFixed(1)}%</span></div>`}e.vehicles&&(a+=`<div>Vehículos totales: <span style="color: #8ECAE6">${c(e.vehicles)}</span></div>`);const n=t.pageX-100,s=t.pageY-120;i.tooltip.html(a).style("left",n+"px").style("top",s+"px").style("opacity",1)}).on("mouseout",function(){i.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;i.tooltip.style("left",e+"px").style("top",a+"px")});E.raise(),L.raise(),h.append("text").attr("x",a.innerW/2).attr("y",-24).attr("text-anchor","middle").style("font-size",`${o.title}px`).style("font-weight","700").style("fill",s).style("text-shadow","none").text("Crecimiento del Parque Vehicular y Autos por vivienda en Cancún, 2010–2023");const M=h.append("g").attr("class","legend").style("pointer-events","none"),z=[{color:n,type:"rect",label:"Parque vehicular (total)"},{color:r,type:"line",label:"Autos por vivienda"}],F=a.innerW<480?12:a.innerW<768?13:14,O=Math.round(1.3*F),W=Math.round(.85*F),_=Math.round(.5*F),B=Math.round(Math.min(16,.02*a.innerW));M.attr("transform",`translate(${B}, 6)`);const D=Math.round(.4*F)+6;M.selectAll(".legend-item").data(z).enter().append("g").attr("class","legend-item").attr("transform",(t,e)=>`translate(0, ${e*(F+D)})`).each(function(t){const e=d3.select(this);"rect"===t.type?e.append("rect").attr("x",0).attr("y",-Math.round(W/2)).attr("width",O).attr("height",W).attr("fill",`url(#${p})`).attr("rx",2):e.append("line").attr("x1",0).attr("y1",0).attr("x2",O).attr("y2",0).attr("stroke",t.color).attr("stroke-width",3).attr("stroke-linecap","round").attr("transform","rotate(0)"),e.append("text").attr("x",O+_).attr("y",0).attr("dominant-baseline","central").style("font-size",`${F}px`).style("fill","#555").style("text-shadow","none").text(t.label)}),d.append("text").attr("x",a.margin.left+a.innerW/2).attr("y",a.margin.top+a.innerH+a.margin.bottom-10).style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Año"),d.append("text").attr("transform","rotate(-90)").attr("y",20).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Vehículos (total)"),d.append("text").attr("transform","rotate(-90)").attr("y",a.margin.left+a.innerW+40).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Autos por vivienda"),P.on("mouseenter",function(t,e){d3.select(this).raise().transition().duration(300).attr("opacity",.6);let a=`\n                    <div><strong>Año ${e.year}</strong></div>\n                    <div>Vehículos: <span style="color: #8ECAE6">${d3.format(",")(e.vehicles)}</span></div>\n                `;if(null!=e.growthVehicles&&!isNaN(e.growthVehicles)){const t=e.growthVehicles>0?"+":"";let n="#e5e7eb";e.growthVehicles>0?n="#2ECC71":e.growthVehicles<0&&(n="#E63946"),a+=`<div>Incremento: <span style="color:${n}">${t}${e.growthVehicles.toFixed(1)}%</span></div>`}null!=e.vehiclesPerHousehold&&(a+=`<div>Autos/vivienda: <span style="color: ${r}">${e.vehiclesPerHousehold.toFixed(2)}</span></div>`);const n=t.pageX-100,s=t.pageY-120;i.tooltip.html(a).style("left",n+"px").style("top",s+"px").style("opacity",1)}).on("mouseleave",function(){d3.select(this).transition().duration(300).attr("opacity",1),i.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;i.tooltip.style("left",e+"px").style("top",a+"px")});const N=h.insert("rect",":first-child").attr("class","hover-overlay").attr("x",0).attr("y",0).attr("width",a.innerW).attr("height",a.innerH).style("fill","transparent").style("pointer-events","none");if(i.hasDrawn)P.attr("y",t=>g(t.vehicles)).attr("height",t=>a.innerH-g(t.vehicles)),V.style("opacity",1).attr("y",t=>g(t.vehicles)-8).style("font-size",`${o.labels}px`),L.attr("r",Math.min(5,Math.max(3,.2*k)));else{const t=h.transition().duration(900).ease(d3.easeCubicOut);P.transition(t).attr("y",t=>g(t.vehicles)).attr("height",t=>a.innerH-g(t.vehicles)),V.transition().delay(700).duration(400).style("opacity",1).attr("y",t=>g(t.vehicles)-8);const e=E.node().getTotalLength();E.attr("stroke-dasharray",`${e} ${e}`).attr("stroke-dashoffset",e).transition().delay(350).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),L.transition().delay(900).duration(400).attr("r",Math.min(5,Math.max(3,.2*k))),i.hasDrawn=!0}i.refs={g:h,bars:P,labels:V,path:E,points:L,overlay:N,dims:a,scales:{x:x,yLeft:g,yRight:w}}}function p(){const e=document.getElementById(t);e&&(i.resizeObserver||(i.resizeObserver=new ResizeObserver(()=>{i.hasLoaded&&h()}),i.resizeObserver.observe(e)))}function y(){i.hasLoaded?h():d3.csv(e).then(t=>{const e=t.map(d);i.data=e.filter(t=>t.year&&t.vehicles).sort((t,e)=>d3.ascending(t.year,e.year)),i.hasLoaded=!0,p(),h()}).catch(t=>{console.error("Error cargando CSV, usando datos vacíos:",t),i.data=[],i.hasLoaded=!0,p(),h()})}window.initVehicleChart=function(){y()},window.vehicleChart={enter:function(){if(!i.hasLoaded)return void y();const t=i.refs;if(!t||!t.g)return;const{g:e,bars:a,labels:n,path:r,points:s,dims:l,scales:o}=t,d=e.transition().duration(800).ease(d3.easeCubicOut);a.attr("y",l.innerH).attr("height",0).transition(d).attr("y",t=>o.yLeft(t.vehicles)).attr("height",t=>l.innerH-o.yLeft(t.vehicles)),n.style("opacity",0).attr("y",t=>o.yLeft(t.vehicles)-8).transition().delay(600).duration(350).style("opacity",1);const c=r.node().getTotalLength();r.attr("stroke-dasharray",`${c} ${c}`).attr("stroke-dashoffset",c).transition().delay(250).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),s.attr("r",0).transition().delay(950).duration(350).attr("r",Math.min(5,Math.max(3,.2*o.x.bandwidth())))},exit:function(){const t=i.refs;if(!t||!t.g)return;const{g:e,bars:a,labels:n,path:r,points:s,dims:l,scales:o}=t,d=e.transition().duration(500).ease(d3.easeCubicIn);a.transition(d).attr("y",l.innerH).attr("height",0),n.transition(d).style("opacity",0);const c=r.node().getTotalLength();r.transition(d).attr("stroke-dasharray",`${c} ${c}`).attr("stroke-dashoffset",c),s.transition(d).attr("r",0),i.hasDrawn=!1}}});