document.addEventListener("DOMContentLoaded",function(){const t="vehicleGrowthChart",e=`public/data/parque-vehicular.csv?v=${Date.now()}`,a=document.getElementById(t);if(a&&a.parentElement){a.parentElement;a.style.display="flex",a.style.flexDirection="column",a.style.width="100%",a.style.height="100%",a.style.position="relative",a.style.overflow="hidden"}const n="#219EBC",l="#FB8500",r="#023047",i="rgba(2,48,71,0.08)",s={data:[],hasDrawn:!1,hasLoaded:!1,resizeObserver:null,refs:{g:null,bars:null,labels:null,path:null,points:null,overlay:null,dims:null,scales:null},tooltip:null};function o(t){return String(t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"")}function d(t){const e=t=>{if(null==t)return null;if("string"==typeof t){const e=t.trim().replace(/\u00a0/g,"").replace(/,/g,"").replace(/\s+/g,"").replace(/%$/,"");if(""===e||"-"===e)return null;const a=+e;return isFinite(a)?a:null}return isFinite(t)?+t:null},a=Object.keys(t),n={};for(const e of a)n[o(e)]=t[e];let l=e(n.ano)??e(n.anio)??e(n.year);null==l&&(l=e(t[a[0]]));let r=e(n.vehiculos_totales)??e(n.vehiculos)??e(n.total);if(null==r){const l=Object.keys(n).find(t=>t.includes("vehicul")&&!t.includes("por_vivienda"));l&&(r=e(n[l])),null==r&&a.length>1&&(r=e(t[a[1]]))}return{year:l,vehicles:r,dwellings:e(n.viviendas||n.vivienda||n.viviendas_totales||n.houses||n.housing),autosPerDwelling:e(n.autos_por_vivienda)}}function c(){const e=d3.select(`#${t}`);if(e.empty()||!s.data.length)return;e.html(""),d3.select("body").select(".vehicle-tooltip").remove(),s.tooltip=d3.select("body").append("div").attr("class","vehicle-tooltip").style("position","absolute").style("background","rgba(2, 48, 71, 0.95)").style("color","white").style("padding","12px 16px").style("border-radius","8px").style("font-size","14px").style("font-weight","500").style("line-height","1.4").style("pointer-events","none").style("opacity",0).style("box-shadow","0 4px 12px rgba(0,0,0,0.15)").style("transition","opacity 0.2s ease").style("z-index","1000").style("max-width","200px");const a=function(){const e=document.getElementById(t),a=e?e.getBoundingClientRect():null,n=a?a.width:1e3;let l;l=n<=480?80:n<=768?100:120;const r={top:40,right:l,bottom:80,left:l};return{width:1e3,height:400,margin:r,innerW:1e3-r.left-r.right,innerH:400-r.top-r.bottom}}(),o={axis:14,title:18,labels:14,legend:14},d=e.append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${a.width} ${a.height}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%"),c=d.append("g").attr("transform",`translate(${a.margin.left},${a.margin.top})`),h=`veh-bar-gradient-${Date.now()}`,p=d.append("defs").append("linearGradient").attr("id",h).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");p.append("stop").attr("offset","0%").attr("stop-color",n),p.append("stop").attr("offset","100%").attr("stop-color","#8ECAE6");let y=null,u=null;s.data.forEach(t=>{null!=y&&null!=t.vehicles&&t.vehicles>0?t.growthVehicles=(t.vehicles-y)/y*100:t.growthVehicles=null,y=t.vehicles,null==t.dwellings||isNaN(t.dwellings)?t.growthDwellings=null:(t.growthDwellings=null!=u&&u>0?(t.dwellings-u)/u*100:null,u=t.dwellings)});const g=s.data.map(t=>t.year).filter(t=>null!=t&&isFinite(t)),f=d3.scaleBand().domain(g).range([0,a.innerW]).padding(.2),m=d3.max(s.data,t=>isFinite(t.vehicles)?t.vehicles:0)||0,x=d3.scaleLinear().domain([0,1.1*m]).nice().range([a.innerH,0]),v=d3.max(s.data,t=>isFinite(t.dwellings)?t.dwellings:0)||1,w=Math.max(1.1*m,1.15*v),b=d3.scaleLinear().domain([0,w]).nice().range([a.innerH,0]),$=d3.axisBottom(f).tickValues(g).tickFormat(d3.format("d")),k=d3.format(","),D=d3.axisLeft(x).ticks(6).tickFormat(k),A=d3.axisRight(b).ticks(5).tickFormat(k),M=(Math.max(20,o.axis+8),c.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${a.innerH})`).call($)),F=f.bandwidth();M.selectAll(".tick").attr("transform",t=>`translate(${f(t)+F/2},0)`),M.selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none").style("text-anchor","start").attr("transform",t=>"translate(0, 40) rotate(-90)").attr("dx","0em").attr("dy","0em"),c.select(".x-axis").style("pointer-events","none"),c.append("g").attr("class","axis y-axis-left").call(D).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),c.select(".y-axis-left").style("pointer-events","none"),c.append("g").attr("class","axis y-axis-right").attr("transform",`translate(${a.innerW},0)`).call(A).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),c.select(".y-axis-right").style("pointer-events","none"),c.append("g").attr("class","grid").call(d3.axisLeft(x).tickSize(-a.innerW).tickFormat("")).selectAll("line").attr("stroke",i);[".x-axis",".y-axis-left",".y-axis-right"].forEach(t=>{c.select(t).selectAll("path, line").style("stroke","rgba(120, 120, 120, 0.2)")});const C=f.bandwidth(),E=c.selectAll(".veh-bar").data(s.data,t=>t.year).enter().append("rect").attr("class","veh-bar").style("pointer-events","all").attr("x",t=>f(t.year)).attr("y",a.innerH).attr("width",C).attr("height",0).attr("fill",`url(#${h})`).attr("rx",Math.max(2,.08*C)),L=t=>null!=t.dwellings&&isFinite(t.dwellings)&&isFinite(t.year),V=d3.line().defined(L).x(t=>f(t.year)+f.bandwidth()/2).y(t=>b(t.dwellings)).curve(d3.curveMonotoneX),z=s.data.filter(L),H=c.append("path").datum(z).attr("class","dwellings-line").attr("fill","none").attr("stroke",l).attr("stroke-width",3).attr("d",z.length?V(z):null).style("pointer-events","none"),W=c.selectAll(".dwellings-point").data(z).enter().append("circle").attr("class","dwellings-point").attr("cx",t=>f(t.year)+f.bandwidth()/2).attr("cy",t=>b(t.dwellings)).attr("r",0).attr("fill",l).attr("stroke","#fff").attr("stroke-width",1.5).style("pointer-events","auto").on("mouseover",function(t,e){let a=`\n                    <div>Viviendas: <span style="color: ${l}">${d3.format(",")(e.dwellings)}</span></div>\n                `;if(null!=e.growthDwellings&&!isNaN(e.growthDwellings)){const t=e.growthDwellings>0?"+":"";let n="#e5e7eb";e.growthDwellings>0?n="#2ECC71":e.growthDwellings<0&&(n="#E63946");a+=`<div>${e.growthDwellings<0?"Decremento":"Incremento"}: <span style="color:${n}">${t}${e.growthDwellings.toFixed(1)}%</span></div>`}null==e.autosPerDwelling||isNaN(e.autosPerDwelling)||(a+=`<div>Autos por vivienda: <span style="color:#FFD166">${e.autosPerDwelling.toFixed(2)}</span></div>`);const n=t.pageX-100,r=t.pageY-120;s.tooltip.html(a).style("left",n+"px").style("top",r+"px").style("opacity",1)}).on("mouseout",function(){s.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;s.tooltip.style("left",e+"px").style("top",a+"px")});H.raise(),W.raise(),c.append("text").attr("x",a.innerW/2).attr("y",-24).attr("text-anchor","middle").style("font-size",`${o.title}px`).style("font-weight","700").style("fill",r).style("text-shadow","none").text("Crecimiento del Parque Vehicular y Viviendas en Cancún, 1980–2025");const O=c.append("g").attr("class","legend").style("pointer-events","none"),N=[{color:n,type:"rect",label:"Parque vehicular"},{color:l,type:"line",label:"Viviendas"}],P=a.innerW<480?12:a.innerW<768?13:14,B=Math.round(1.3*P),_=Math.round(.85*P),I=Math.round(.5*P),R=Math.round(Math.min(16,.02*a.innerW));O.attr("transform",`translate(${R}, 28)`);const X=Math.round(.4*P)+6;O.selectAll(".legend-item").data(N).enter().append("g").attr("class","legend-item").attr("transform",(t,e)=>`translate(0, ${e*(P+X)})`).each(function(t){const e=d3.select(this);"rect"===t.type?e.append("rect").attr("x",0).attr("y",-Math.round(_/2)).attr("width",B).attr("height",_).attr("fill",`url(#${h})`).attr("rx",2):e.append("line").attr("x1",0).attr("y1",0).attr("x2",B).attr("y2",0).attr("stroke",t.color).attr("stroke-width",3).attr("stroke-linecap","round").attr("transform","rotate(0)"),e.append("text").attr("x",B+I).attr("y",0).attr("dominant-baseline","central").style("font-size",`${P}px`).style("fill","#555").style("text-shadow","none").text(t.label)}),d.append("text").attr("transform","rotate(-90)").attr("x",a.margin.left+a.innerW/2).attr("y",a.margin.top+a.innerH+a.margin.bottom-10).style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Año"),d.append("text").attr("transform","rotate(-90)").attr("y",20).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Parque vehicular"),d.append("text").attr("transform","rotate(-90)").attr("y",a.margin.left+a.innerW+60).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Viviendas"),E.on("mouseenter",function(t,e){d3.select(this).transition().duration(300).attr("opacity",.6);let a=`\n                    <div>Vehículos: <span style="color: #8ECAE6">${d3.format(",")(e.vehicles)}</span></div>\n                `;if(null!=e.growthVehicles&&!isNaN(e.growthVehicles)){const t=e.growthVehicles>0?"+":"";let n="#e5e7eb";e.growthVehicles>0?n="#2ECC71":e.growthVehicles<0&&(n="#E63946");a+=`<div>${e.growthVehicles<0?"Decremento":"Incremento"}: <span style="color:${n}">${t}${e.growthVehicles.toFixed(1)}%</span></div>`}null==e.autosPerDwelling||isNaN(e.autosPerDwelling)||(a+=`<div>Autos por vivienda: <span style="color:#FFD166">${e.autosPerDwelling.toFixed(2)}</span></div>`);const n=t.pageX-100,l=t.pageY-120;s.tooltip.html(a).style("left",n+"px").style("top",l+"px").style("opacity",1)}).on("mouseleave",function(){d3.select(this).transition().duration(300).attr("opacity",1),s.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;s.tooltip.style("left",e+"px").style("top",a+"px")});const Y=c.insert("rect",":first-child").attr("class","hover-overlay").attr("x",0).attr("y",0).attr("width",a.innerW).attr("height",a.innerH).style("fill","transparent").style("pointer-events","none");c.selectAll(".dwellings-line").raise(),c.selectAll(".dwellings-point").raise(),c.selectAll(".annotation-group.marker-2006").remove(),c.selectAll(".marker-2006-line").remove(),c.selectAll(".marker-2006-point").remove();const q=s.data.find(t=>2006===t.year&&isFinite(t.vehicles));if(q&&a.innerW>420){const t=f(2006)+f.bandwidth()/2,e=x(q.vehicles);if(isFinite(t)&&isFinite(e)){c.append("line").attr("class","marker-2006-line").attr("x1",t).attr("x2",t).attr("y1",0).attr("y2",a.innerH).attr("stroke","#E63946").attr("stroke-width",1).attr("stroke-dasharray","4 6").attr("opacity",.95).style("pointer-events","none");const n=110,l=160,r=t<a.innerW-l?Math.min(t+n,a.innerW-30):Math.max(t-n,30),i=-80,s=Math.max(20,Math.min(e+i,a.innerH-30)),o=[{note:{label:"En 2006 los vehículos registrados superaron por primera vez al número de viviendas.",wrap:140},subject:{x:t,y:e,radius:Math.max(6,Math.min(10,.12*f.bandwidth()))},connector:{end:"arrow",type:"line"},x:r,y:s}];let h=null;try{const t=d3.annotation().type(d3.annotationLabel).annotations(o);h=d.append("g").attr("class","annotation-group marker-2006").attr("opacity",0).style("pointer-events","none").call(t)}catch(t){console.warn("Anotación 2006 falló y fue omitida:",t)}h&&(h.selectAll("text").style("font-size","12px"),h.selectAll(".annotation-note").attr("transform",null),h.selectAll(".annotation-note-title, .annotation-note-label, .annotation-note").style("fill","#E63946"),h.transition().delay(700).duration(700).attr("opacity",1),d.selectAll(".marker-2006-line").raise(),d.selectAll(".marker-2006-point").raise())}else console.warn("Anotación 2006 omitida por coordenadas inválidas")}if(s.hasDrawn)E.attr("y",t=>x(t.vehicles)).attr("height",t=>a.innerH-x(t.vehicles)),W.attr("r",Math.min(5,Math.max(3,.2*C)));else{const t=c.transition().duration(900).ease(d3.easeCubicOut);E.transition(t).attr("y",t=>x(t.vehicles)).attr("height",t=>a.innerH-x(t.vehicles));const e=H.node().getTotalLength();H.attr("stroke-dasharray",`${e} ${e}`).attr("stroke-dashoffset",e).transition().delay(350).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),W.transition().delay(900).duration(400).attr("r",Math.min(5,Math.max(3,.2*C))),s.hasDrawn=!0}s.refs={g:c,bars:E,path:H,points:W,overlay:Y,dims:a,scales:{x:f,yLeft:x,yRight:b}}}function h(){const e=document.getElementById(t);e&&(s.resizeObserver||(s.resizeObserver=new ResizeObserver(()=>{s.hasLoaded&&c()}),s.resizeObserver.observe(e)))}function p(){s.hasLoaded?c():d3.csv(e).then(t=>{const e=t.map(d);s.data=e.filter(t=>t.year&&t.vehicles).sort((t,e)=>d3.ascending(t.year,e.year)),s.hasLoaded=!0,h(),c()}).catch(t=>{console.error("Error cargando CSV, usando datos vacíos:",t),s.data=[],s.hasLoaded=!0,h(),c()})}window.initVehicleChart=function(){p()},window.vehicleChart={enter:function(){if(!s.hasLoaded)return void p();const t=s.refs;if(!t||!t.g)return;const{g:e,bars:a,path:n,points:l,dims:r,scales:i}=t,o=e.transition().duration(800).ease(d3.easeCubicOut);a.attr("y",r.innerH).attr("height",0).transition(o).attr("y",t=>i.yLeft(t.vehicles)).attr("height",t=>r.innerH-i.yLeft(t.vehicles));const d=n.node().getTotalLength();n.attr("stroke-dasharray",`${d} ${d}`).attr("stroke-dashoffset",d).transition().delay(250).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),l.attr("r",0).transition().delay(950).duration(350).attr("r",Math.min(5,Math.max(3,.2*i.x.bandwidth())))},exit:function(){const t=s.refs;if(!t||!t.g)return;const{g:e,bars:a,path:n,points:l,dims:r,scales:i}=t,o=e.transition().duration(500).ease(d3.easeCubicIn);a.transition(o).attr("y",r.innerH).attr("height",0);const d=n.node().getTotalLength();n.transition(o).attr("stroke-dasharray",`${d} ${d}`).attr("stroke-dashoffset",d),l.transition(o).attr("r",0),s.hasDrawn=!1}}});