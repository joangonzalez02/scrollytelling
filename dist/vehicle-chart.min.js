document.addEventListener("DOMContentLoaded",function(){const t="vehicleGrowthChart",e=`public/data/parque-vehicular.csv?v=${Date.now()}`,a=document.getElementById(t);if(a&&a.parentElement){a.parentElement;a.style.display="flex",a.style.flexDirection="column",a.style.width="100%",a.style.height="100%",a.style.position="relative",a.style.overflow="hidden"}const n="#219EBC",l="#FB8500",r="#023047",s="rgba(2,48,71,0.08)",i={data:[],hasDrawn:!1,hasLoaded:!1,resizeObserver:null,refs:{g:null,bars:null,labels:null,path:null,points:null,overlay:null,dims:null,scales:null},tooltip:null};function o(t){return String(t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"")}function d(t){const e=Object.keys(t),a={};for(const n of e)a[o(n)]=t[n];let n=+a.ano||+a.anio||+a.year;if(!n){n=+t[e[0]]}let l=+a.vehiculos_totales||+a.vehiculos||+a.total;if(!l){const n=Object.keys(a).find(t=>t.includes("vehicul")&&!t.includes("por_vivienda"));n?l=+a[n]:e.length>1&&(l=+t[e[1]])}const r=a.viviendas||a.vivienda||a.viviendas_totales||a.houses||a.housing,s=void 0===r||""===r?null:+r,i=a.autos_por_vivienda;return{year:n,vehicles:l,dwellings:s,autosPerDwelling:void 0===i||""===i?null:+i}}function c(t){return t>=1e6?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e3?(t/1e3).toFixed(0)+"k":t>=100?(t/1e3).toFixed(1)+"k":String(t)}function h(){const e=d3.select(`#${t}`);if(e.empty()||!i.data.length)return;e.html(""),d3.select("body").select(".vehicle-tooltip").remove(),i.tooltip=d3.select("body").append("div").attr("class","vehicle-tooltip").style("position","absolute").style("background","rgba(2, 48, 71, 0.95)").style("color","white").style("padding","12px 16px").style("border-radius","8px").style("font-size","14px").style("font-weight","500").style("line-height","1.4").style("pointer-events","none").style("opacity",0).style("box-shadow","0 4px 12px rgba(0,0,0,0.15)").style("transition","opacity 0.2s ease").style("z-index","1000").style("max-width","200px");const a=function(){const e=document.getElementById(t),a=e?e.getBoundingClientRect():null,n=a?a.width:1e3;let l;l=n<=480?80:n<=768?100:120;const r={top:40,right:l,bottom:80,left:l};return{width:1e3,height:400,margin:r,innerW:1e3-r.left-r.right,innerH:400-r.top-r.bottom}}(),o={axis:14,title:18,labels:14,legend:14},d=e.append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${a.width} ${a.height}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%"),h=d.append("g").attr("transform",`translate(${a.margin.left},${a.margin.top})`),p=`veh-bar-gradient-${Date.now()}`,y=d.append("defs").append("linearGradient").attr("id",p).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");y.append("stop").attr("offset","0%").attr("stop-color",n),y.append("stop").attr("offset","100%").attr("stop-color","#8ECAE6");let g=null,u=null;i.data.forEach(t=>{null!=g&&null!=t.vehicles&&t.vehicles>0?t.growthVehicles=(t.vehicles-g)/g*100:t.growthVehicles=null,g=t.vehicles,null==t.dwellings||isNaN(t.dwellings)?t.growthDwellings=null:(t.growthDwellings=null!=u&&u>0?(t.dwellings-u)/u*100:null,u=t.dwellings)});const x=i.data.map(t=>t.year),f=d3.scaleBand().domain(x).range([0,a.innerW]).padding(.2),m=d3.scaleLinear().domain([0,1.1*d3.max(i.data,t=>t.vehicles)]).nice().range([a.innerH,0]),v=d3.max(i.data,t=>t.dwellings||0)||1,w=Math.max(1.1*d3.max(i.data,t=>t.vehicles),1.15*v),b=d3.scaleLinear().domain([0,w]).nice().range([a.innerH,0]),k=d3.axisBottom(f).tickValues(x).tickFormat(d3.format("d")),$=d3.axisLeft(m).ticks(6).tickFormat(t=>c(t)),D=d3.axisRight(b).ticks(5).tickFormat(t=>c(t)),M=(Math.max(20,o.axis+8),h.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${a.innerH})`).call(k)),A=f.bandwidth();M.selectAll(".tick").attr("transform",t=>`translate(${f(t)+A/2},0)`),M.selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none").style("text-anchor","start").attr("transform",t=>"translate(0, 40) rotate(-90)").attr("dx","0em").attr("dy","0em"),h.select(".x-axis").style("pointer-events","none"),h.append("g").attr("class","axis y-axis-left").call($).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),h.select(".y-axis-left").style("pointer-events","none"),h.append("g").attr("class","axis y-axis-right").attr("transform",`translate(${a.innerW},0)`).call(D).selectAll("text").style("font-size",`${o.axis}px`).style("fill","#555").style("text-shadow","none"),h.select(".y-axis-right").style("pointer-events","none"),h.append("g").attr("class","grid").call(d3.axisLeft(m).tickSize(-a.innerW).tickFormat("")).selectAll("line").attr("stroke",s);[".x-axis",".y-axis-left",".y-axis-right"].forEach(t=>{h.select(t).selectAll("path, line").style("stroke","rgba(120, 120, 120, 0.2)")});const C=f.bandwidth(),E=h.selectAll(".veh-bar").data(i.data,t=>t.year).enter().append("rect").attr("class","veh-bar").style("pointer-events","all").attr("x",t=>f(t.year)).attr("y",a.innerH).attr("width",C).attr("height",0).attr("fill",`url(#${p})`).attr("rx",Math.max(2,.08*C)),L=h.selectAll(".value-label").data(i.data,t=>t.year).enter().append("text").attr("class","value-label").style("display","none"),z=t=>null!=t.dwellings&&!isNaN(t.dwellings),V=d3.line().defined(z).x(t=>f(t.year)+f.bandwidth()/2).y(t=>b(t.dwellings)).curve(d3.curveMonotoneX),F=h.append("path").datum(i.data.filter(z)).attr("class","dwellings-line").attr("fill","none").attr("stroke",l).attr("stroke-width",3).attr("d",V).style("pointer-events","none"),H=h.selectAll(".dwellings-point").data(i.data.filter(z)).enter().append("circle").attr("class","dwellings-point").attr("cx",t=>f(t.year)+f.bandwidth()/2).attr("cy",t=>b(t.dwellings)).attr("r",0).attr("fill",l).attr("stroke","#fff").attr("stroke-width",1.5).style("pointer-events","auto").on("mouseover",function(t,e){let a=`\n                    <div>Viviendas: <span style="color: ${l}">${d3.format(",")(e.dwellings)}</span></div>\n                `;if(null!=e.growthDwellings&&!isNaN(e.growthDwellings)){const t=e.growthDwellings>0?"+":"";let n="#e5e7eb";e.growthDwellings>0?n="#2ECC71":e.growthDwellings<0&&(n="#E63946");a+=`<div>${e.growthDwellings<0?"Decremento":"Incremento"}: <span style="color:${n}">${t}${e.growthDwellings.toFixed(1)}%</span></div>`}null==e.autosPerDwelling||isNaN(e.autosPerDwelling)||(a+=`<div>Autos por vivienda: <span style="color:#FFD166">${e.autosPerDwelling.toFixed(2)}</span></div>`);const n=t.pageX-100,r=t.pageY-120;i.tooltip.html(a).style("left",n+"px").style("top",r+"px").style("opacity",1)}).on("mouseout",function(){i.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;i.tooltip.style("left",e+"px").style("top",a+"px")});F.raise(),H.raise(),h.append("text").attr("x",a.innerW/2).attr("y",-24).attr("text-anchor","middle").style("font-size",`${o.title}px`).style("font-weight","700").style("fill",r).style("text-shadow","none").text("Crecimiento del Parque Vehicular y Viviendas en Cancún, 1980–2025");const W=h.append("g").attr("class","legend").style("pointer-events","none"),N=[{color:n,type:"rect",label:"Parque vehicular"},{color:l,type:"line",label:"Viviendas"}],O=a.innerW<480?12:a.innerW<768?13:14,P=Math.round(1.3*O),B=Math.round(.85*O),_=Math.round(.5*O),I=Math.round(Math.min(16,.02*a.innerW));W.attr("transform",`translate(${I}, 28)`);const R=Math.round(.4*O)+6;W.selectAll(".legend-item").data(N).enter().append("g").attr("class","legend-item").attr("transform",(t,e)=>`translate(0, ${e*(O+R)})`).each(function(t){const e=d3.select(this);"rect"===t.type?e.append("rect").attr("x",0).attr("y",-Math.round(B/2)).attr("width",P).attr("height",B).attr("fill",`url(#${p})`).attr("rx",2):e.append("line").attr("x1",0).attr("y1",0).attr("x2",P).attr("y2",0).attr("stroke",t.color).attr("stroke-width",3).attr("stroke-linecap","round").attr("transform","rotate(0)"),e.append("text").attr("x",P+_).attr("y",0).attr("dominant-baseline","central").style("font-size",`${O}px`).style("fill","#555").style("text-shadow","none").text(t.label)}),d.append("text").attr("transform","rotate(-90)").attr("x",a.margin.left+a.innerW/2).attr("y",a.margin.top+a.innerH+a.margin.bottom-10).style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Año"),d.append("text").attr("transform","rotate(-90)").attr("y",20).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Parque vehicular"),d.append("text").attr("transform","rotate(-90)").attr("y",a.margin.left+a.innerW+40).attr("x",-(a.margin.top+a.innerH/2)).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").style("text-shadow","none").text("Viviendas"),E.on("mouseenter",function(t,e){d3.select(this).transition().duration(300).attr("opacity",.6);let a=`\n                    <div>Vehículos: <span style="color: #8ECAE6">${d3.format(",")(e.vehicles)}</span></div>\n                `;if(null!=e.growthVehicles&&!isNaN(e.growthVehicles)){const t=e.growthVehicles>0?"+":"";let n="#e5e7eb";e.growthVehicles>0?n="#2ECC71":e.growthVehicles<0&&(n="#E63946");a+=`<div>${e.growthVehicles<0?"Decremento":"Incremento"}: <span style="color:${n}">${t}${e.growthVehicles.toFixed(1)}%</span></div>`}null==e.autosPerDwelling||isNaN(e.autosPerDwelling)||(a+=`<div>Autos por vivienda: <span style="color:#FFD166">${e.autosPerDwelling.toFixed(2)}</span></div>`);const n=t.pageX-100,l=t.pageY-120;i.tooltip.html(a).style("left",n+"px").style("top",l+"px").style("opacity",1)}).on("mouseleave",function(){d3.select(this).transition().duration(300).attr("opacity",1),i.tooltip.style("opacity",0)}).on("mousemove",function(t){const e=t.pageX-100,a=t.pageY-120;i.tooltip.style("left",e+"px").style("top",a+"px")});const X=h.insert("rect",":first-child").attr("class","hover-overlay").attr("x",0).attr("y",0).attr("width",a.innerW).attr("height",a.innerH).style("fill","transparent").style("pointer-events","none");h.selectAll(".dwellings-line").raise(),h.selectAll(".dwellings-point").raise(),h.selectAll(".annotation-group.marker-2006").remove(),h.selectAll(".marker-2006-line").remove(),h.selectAll(".marker-2006-point").remove();const Y=i.data.find(t=>2006===t.year);if(Y&&a.innerW>420){const t=f(2006)+f.bandwidth()/2,e=m(Y.vehicles);h.append("line").attr("class","marker-2006-line").attr("x1",t).attr("x2",t).attr("y1",0).attr("y2",a.innerH).attr("stroke","#E63946").attr("stroke-width",1).attr("stroke-dasharray","4 6").attr("opacity",.95).style("pointer-events","none");const n=110,l=160,r=t<a.innerW-l?Math.min(t+n,a.innerW-30):Math.max(t-n,30),s=-80,i=Math.max(20,Math.min(e+s,a.innerH-30)),o=[{note:{label:"En 2006 los vehículos registrados superaron por primera vez al número de viviendas.",wrap:140},subject:{x:t,y:e,radius:Math.max(6,Math.min(10,.12*f.bandwidth()))},connector:{end:"arrow",type:"line"},x:r,y:i}],c=d3.annotation().type(d3.annotationLabel).annotations(o),p=d.append("g").attr("class","annotation-group marker-2006").attr("opacity",0).style("pointer-events","none").call(c);p.selectAll("text").style("font-size","12px"),p.selectAll(".annotation-note").attr("transform",null),p.selectAll(".annotation-note-title, .annotation-note-label, .annotation-note").style("fill","#E63946"),p.transition().delay(700).duration(700).attr("opacity",1),d.selectAll(".marker-2006-line").raise(),d.selectAll(".marker-2006-point").raise()}if(i.hasDrawn)E.attr("y",t=>m(t.vehicles)).attr("height",t=>a.innerH-m(t.vehicles)),L.style("opacity",1).attr("y",t=>m(t.vehicles)-8).style("font-size",`${o.labels}px`),H.attr("r",Math.min(5,Math.max(3,.2*C)));else{const t=h.transition().duration(900).ease(d3.easeCubicOut);E.transition(t).attr("y",t=>m(t.vehicles)).attr("height",t=>a.innerH-m(t.vehicles)),L.transition().delay(700).duration(400).style("opacity",1).attr("y",t=>m(t.vehicles)-8);const e=F.node().getTotalLength();F.attr("stroke-dasharray",`${e} ${e}`).attr("stroke-dashoffset",e).transition().delay(350).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),H.transition().delay(900).duration(400).attr("r",Math.min(5,Math.max(3,.2*C))),i.hasDrawn=!0}i.refs={g:h,bars:E,labels:L,path:F,points:H,overlay:X,dims:a,scales:{x:f,yLeft:m,yRight:b}}}function p(){const e=document.getElementById(t);e&&(i.resizeObserver||(i.resizeObserver=new ResizeObserver(()=>{i.hasLoaded&&h()}),i.resizeObserver.observe(e)))}function y(){i.hasLoaded?h():d3.csv(e).then(t=>{const e=t.map(d);i.data=e.filter(t=>t.year&&t.vehicles).sort((t,e)=>d3.ascending(t.year,e.year)),i.hasLoaded=!0,p(),h()}).catch(t=>{console.error("Error cargando CSV, usando datos vacíos:",t),i.data=[],i.hasLoaded=!0,p(),h()})}window.initVehicleChart=function(){y()},window.vehicleChart={enter:function(){if(!i.hasLoaded)return void y();const t=i.refs;if(!t||!t.g)return;const{g:e,bars:a,labels:n,path:l,points:r,dims:s,scales:o}=t,d=e.transition().duration(800).ease(d3.easeCubicOut);a.attr("y",s.innerH).attr("height",0).transition(d).attr("y",t=>o.yLeft(t.vehicles)).attr("height",t=>s.innerH-o.yLeft(t.vehicles)),n.style("opacity",0).attr("y",t=>o.yLeft(t.vehicles)-8).transition().delay(600).duration(350).style("opacity",1);const c=l.node().getTotalLength();l.attr("stroke-dasharray",`${c} ${c}`).attr("stroke-dashoffset",c).transition().delay(250).duration(900).ease(d3.easeCubicOut).attr("stroke-dashoffset",0),r.attr("r",0).transition().delay(950).duration(350).attr("r",Math.min(5,Math.max(3,.2*o.x.bandwidth())))},exit:function(){const t=i.refs;if(!t||!t.g)return;const{g:e,bars:a,labels:n,path:l,points:r,dims:s,scales:o}=t,d=e.transition().duration(500).ease(d3.easeCubicIn);a.transition(d).attr("y",s.innerH).attr("height",0),n.transition(d).style("opacity",0);const c=l.node().getTotalLength();l.transition(d).attr("stroke-dasharray",`${c} ${c}`).attr("stroke-dashoffset",c),r.transition(d).attr("r",0),i.hasDrawn=!1}}});