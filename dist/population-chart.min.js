document.addEventListener("DOMContentLoaded",function(){let t=[],e="benito",o=null,n=null,a=null;function r(){function o(t){if(!t||""===t.trim())return null;const e=+t.replace(/\./g,"");return isNaN(e)?null:e}d3.csv(`public/data/poblacion-valores.csv?v=${Date.now()}`).then(function(r){t=r.map(t=>({year:+t.Año,benitoJuarez:o(t["Población Benito Juárez"]),mexico:o(t["Poblacion México"]),mundo:o(t["Poblacion Mundo"]),qrooTotal:o(t["Población Todo de Quintana Roo"]),qrooResto:o(t["Población Resto de Quintana Roo"]),benitoJuarezRaw:t["Población Benito Juárez"],mexicoRaw:t["Poblacion México"],mundoRaw:t["Poblacion Mundo"],qrooTotalRaw:t["Población Todo de Quintana Roo"],qrooRestoRaw:t["Población Resto de Quintana Roo"]})).filter(t=>t.year&&!isNaN(t.year)&&t.year<=2020),t.forEach((e,o)=>{e.growthBenito=null,e.growthMexico=null,e.growthMundo=null,e.growthQRooTotal=null,o>0&&(null!==e.benitoJuarez&&null!==t[o-1].benitoJuarez&&(e.growthBenito=Number(((e.benitoJuarez-t[o-1].benitoJuarez)/t[o-1].benitoJuarez*100).toFixed(1))),null!==e.mexico&&null!==t[o-1].mexico&&(e.growthMexico=Number(((e.mexico-t[o-1].mexico)/t[o-1].mexico*100).toFixed(1))),null!==e.mundo&&null!==t[o-1].mundo&&(e.growthMundo=Number(((e.mundo-t[o-1].mundo)/t[o-1].mundo*100).toFixed(1))),null!==e.qrooTotal&&null!==t[o-1].qrooTotal&&(e.growthQRooTotal=Number(((e.qrooTotal-t[o-1].qrooTotal)/t[o-1].qrooTotal*100).toFixed(1)))),1===o&&(e.year,e.growthBenito,e.growthMexico,e.growthMundo,e.growthQRooTotal)}),t.filter(t=>null!==t.mexico).length,t.filter(t=>null!==t.mundo).length,t.filter(t=>null!==t.benitoJuarez).length;t.filter(t=>null!==t.mexico).slice(0,3),t.filter(t=>null!==t.mundo).slice(0,3);!function(){const t=document.querySelector("#populationGrowthChart");if(!t)return;const e=document.createElement("div");e.className="data-selector",e.style.marginBottom="15px",e.style.textAlign="center",a=e;[{value:"benito",label:"Cancún"},{value:"qroo",label:"Quintana Roo"},{value:"mexico",label:"México"},{value:"mundo",label:"Mundo"}].forEach(t=>{const o=document.createElement("label");o.style.marginRight="15px",o.style.cursor="default",o.style.color="benito"===t.value?"#FB8500":"#023047",o.style.fontWeight="benito"===t.value?"700":"600",o.style.transition="color 0.2s",o.style.pointerEvents="none";const n=document.createElement("input");n.type="radio",n.name="dataType",n.value=t.value,n.checked="benito"===t.value,n.style.marginRight="5px",o.appendChild(n),o.appendChild(document.createTextNode(t.label)),e.appendChild(o)}),t.prepend(e),e._originalParent=t}();const i=n||"benito";if(e=i,a){a.querySelectorAll('input[name="dataType"]').forEach(t=>t.checked=t.value===i);a.querySelectorAll("label").forEach(t=>{const e=t.querySelector("input");t.style.color=e.checked?"#FB8500":"#023047",t.style.fontWeight=e.checked?"700":"600"})}l(i)}).catch(function(t){console.error("Error cargando los datos:",t)})}function l(e){if(!document.querySelector("#populationGrowthChart"))return;d3.select("#populationGrowthChart svg").remove();const n=44,a=80,r=120,l=800-r-60,c=400-n-a,s=d3.select("#populationGrowthChart").append("svg").attr("viewBox","0 0 800 400").attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%").append("g").attr("transform",`translate(${r},${n})`),d=`bar-gradient-${e}-${Date.now()}`,u=s.append("defs").append("linearGradient").attr("id",d).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");u.append("stop").attr("offset","0%").attr("stop-color",i(e,"start")),u.append("stop").attr("offset","100%").attr("stop-color",i(e,"end"));const p=t.filter(t=>{switch(e){case"benito":default:return null!==t.benitoJuarez&&!isNaN(t.benitoJuarez);case"mexico":return null!==t.mexico&&!isNaN(t.mexico);case"mundo":return null!==t.mundo&&!isNaN(t.mundo);case"qroo":return null!==t.qrooTotal&&!isNaN(t.qrooTotal)}});p.length,p.slice(0,3);const m=t=>{switch(e){case"benito":default:return t.benitoJuarez;case"mexico":return t.mexico;case"mundo":return t.mundo;case"qroo":return t.qrooTotal}},h=d3.scaleBand().domain(p.map(t=>t.year)).range([0,l]).padding(.3);let y;const x=d3.max(p,t=>m(t));y="mundo"===e?[0,9e9]:"mexico"===e?[0,14e7]:[0,1.15*x];const f=d3.scaleLinear().domain(y).nice().range([c,0]);if(s.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${c})`).call(d3.axisBottom(h).tickFormat(t=>t.toString())).selectAll("text").attr("transform","rotate(-45)").attr("text-anchor","end").attr("dx","-.8em").attr("dy",".15em"),"mundo"===e){const t=d3.range(0,10).map(t=>1e9*t);s.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(t).tickFormat(t=>0===t?"0":d3.format("d")(t/1e9)+" MM"))}else if("mexico"===e){const t=d3.ticks(0,y[1],6).map(t=>1e6*Math.round(t/1e6)),e=Array.from(new Set(t)).sort((t,e)=>t-e);s.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(e).tickFormat(t=>0===t?"0":d3.format("d")(Math.round(t/1e6))+" M"))}else{const t=y[1],e=d3.ticks(0,t,6).map(t=>Math.round(t)),o=Array.from(new Set(e)).sort((t,e)=>t-e);s.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(o).tickFormat(t=>0===t?"0":t>=1e6?d3.format(".1f")(t/1e6)+"M":t>=1e3?d3.format("d")(Math.round(t/1e3))+"K":d3.format(",")(Math.round(t))))}s.append("text").attr("class","title").attr("x",l/2).attr("y",6).attr("text-anchor","middle").attr("fill","#023047").attr("font-weight","bold").attr("font-size","16px").text({benito:"Crecimiento Poblacional de Cancún (1970-2020)",qroo:"Crecimiento Poblacional de Quintana Roo (1970-2020)",mexico:"Crecimiento Poblacional de México (1910-2020) - en millones",mundo:"Crecimiento Poblacional Mundial (1910-2020) - en miles de millones"}[e]),s.append("text").attr("transform",`translate(${l/2}, ${c+a-10})`).style("text-anchor","middle").attr("fill","#023047").text("Año"),s.append("text").attr("transform","rotate(-90)").attr("y",20-r).attr("x",-c/2).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").attr("font-size","14px").text("Población");const b=document.getElementById("population-chart-tooltip");b&&b.remove();const g=document.createElement("div");g.id="population-chart-tooltip",g.className="vehicle-tooltip",g.style.position="fixed",g.style.padding="12px 16px",g.style.background="rgba(2, 48, 71, 0.95)",g.style.borderRadius="8px",g.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",g.style.pointerEvents="none",g.style.opacity="0",g.style.zIndex="99999",g.style.fontSize="14px",g.style.fontWeight="500",g.style.color="white",g.style.maxWidth="220px",g.style.transition="opacity 0.2s ease",document.body.appendChild(g);const w=d3.select("#population-chart-tooltip");if(w.node(),s.selectAll(".bar").data(p).enter().append("rect").attr("class","bar").attr("x",t=>h(t.year)).attr("width",h.bandwidth()).attr("y",c).attr("height",0).attr("rx",5).attr("ry",5).attr("fill",`url(#${d})`).on("mouseover",function(t,o){d3.select(this).transition().duration(300).attr("opacity",.9).attr("stroke-width",2).style("fill",`url(#${d})`);const n=(t=>{switch(e){case"benito":default:return t.benitoJuarezRaw||null;case"mexico":return t.mexicoRaw||null;case"mundo":return t.mundoRaw||null;case"qroo":return t.qrooTotalRaw||null}})(o),a=(n&&""!==String(n).trim()?String(n).replace(/\./g,","):null)||(r=m(o),"mundo"===e&&r>=1e9?`${(r/1e9).toFixed(1)}`:"mexico"===e&&r>=1e6?`${(r/1e6).toFixed(1)} millones`:r>=1e6?`${(r/1e6).toFixed(2)} millones`:r>=1e3?`${(r/1e3).toFixed(0)} mil`:new Intl.NumberFormat("es-MX").format(r));var r;let l=`\n                    <div><strong>Año ${o.year}</strong></div>\n                    <div>Población: <span style="color: #8ECAE6; font-weight:700">${a}</span></div>\n                `;const i=(t=>{switch(e){case"benito":default:return t.growthBenito;case"mexico":return t.growthMexico;case"mundo":return t.growthMundo;case"qroo":return t.growthQRooTotal}})(o);if(null!==i&&!isNaN(i)){let t="#e5e7eb";i>0?t="#2ECC71":i<0&&(t="#E63946"),l+=`\n                        <div>${i>0?"Incremento":i<0?"Decremento":"Incremento"}: <span style="color:${t}; font-weight:700">${i>0?"+":""}${i}%</span></div>\n                    `}const c=t.clientX-100,s=t.clientY-110;w.html(l).style("left",c+"px").style("top",s+"px").style("opacity",1).style("display","block")}).on("mouseout",function(){d3.select(this).transition().duration(300).attr("opacity",1).attr("stroke-width",1).style("fill",`url(#${d})`),w.style("opacity",0).style("display","none")}).on("mousemove",function(t){const e=t.clientX-100,o=t.clientY-110;w.style("left",e+"px").style("top",o+"px")}).transition().delay((t,e)=>150*e).duration(1e3).attr("y",t=>f(m(t))).attr("height",t=>c-f(m(t))).ease(d3.easeBounceOut).style("fill",`url(#${d})`),s.selectAll(".value-label").data(p).enter().append("text").attr("class","value-label").attr("x",t=>h(t.year)+h.bandwidth()/2).attr("y",c).attr("opacity",0).text(t=>"mundo"===e&&m(t)>1e9?`${(m(t)/1e9).toFixed(1)}`:m(t)>1e6?`${(m(t)/1e6).toFixed(1)}M`:"benito"===e?new Intl.NumberFormat("es-MX").format(m(t)):m(t)>1e3?`${(m(t)/1e3).toFixed(0)}K`:m(t)).attr("font-size","10px").transition().delay((t,e)=>150*e+700).duration(700).attr("y",t=>f(m(t))-10).attr("opacity",1),"benito"===e&&l>500){const t=l>600?90:70,e=[{note:{label:"Crecimiento Extraordinario 441.6% de incremento en los 70s",wrap:Math.min(Math.round(1.3*t),Math.floor(.25*l)),padding:4,align:"middle"},className:"annotation-responsive",connector:{end:"arrow",type:"line",endScale:.9},x:h(1980)+h.bandwidth()/2,y:f(37190)-30,dy:-15,dx:0}],o=d3.annotation().type(d3.annotationLabel).annotations(e);s.append("g").attr("class","annotation-group").attr("opacity",0).call(o).transition().delay(1500).duration(800).attr("opacity",1);const n=s.select(".annotation-group"),a=l>900?16:l>700?13:11,r=Math.round(1.5*a);n.selectAll(".annotation-note-label").style("font-size",r+"px").style("line-height","1.1").style("font-weight","600").style("word-break","break-word")}o=s}function i(t,e){return{benito:{start:"#FB8500",end:"#FFB703"},qroo:{start:"#219EBC",end:"#8ECAE6"},mexico:{start:"#023047",end:"#219EBC"},mundo:{start:"#8ECAE6",end:"#023047"}}[t][e]}const c=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&0===t.length&&(r(),c.unobserve(e.target))})},{threshold:.3}),s=document.querySelector("#populationGrowthChart");s&&c.observe(s),window.addEventListener("resize",()=>{t.length>0&&l(e)}),window.populationChart=window.populationChart||{},window.populationChart.setDataType=function(o){if(o){if(n=o,a){a.querySelectorAll('input[name="dataType"]').forEach(t=>t.checked=t.value===o);a.querySelectorAll("label").forEach(t=>{const e=t.querySelector("input");t.style.color=e.checked?"#FB8500":"#023047",t.style.fontWeight=e.checked?"700":"600"})}if(e!==o)e=o,t&&t.length>0&&l(e)}},window.populationChart.getCurrentType=()=>e,window.populationChart.getSelectorElement=()=>a,window.populationChart.attachSelectorTo=t=>{try{if(!a)return;if(!t){const t=a._originalParent;return void(t&&t.prepend(a))}if(a.parentNode===t)return;t.appendChild(a)}catch(t){console.warn("attachSelectorTo error",t)}}});