document.addEventListener("DOMContentLoaded",function(){let t=[],e="benito",o=null;function n(){function o(t){if(!t||""===t.trim())return null;const e=+t.replace(/\./g,"");return isNaN(e)?null:e}d3.csv(`public/data/poblacion-valores.csv?v=${Date.now()}`).then(function(n){t=n.map(t=>({year:+t.Año,benitoJuarez:o(t["Población Benito Juárez"]),mexico:o(t["Poblacion México"]),mundo:o(t["Poblacion Mundo"]),qrooTotal:o(t["Población Todo de Quintana Roo"]),qrooResto:o(t["Población Resto de Quintana Roo"])})).filter(t=>t.year&&!isNaN(t.year)&&t.year<=2020),t.forEach((e,o)=>{e.growthBenito=null,e.growthMexico=null,e.growthMundo=null,e.growthQRooTotal=null,o>0&&(null!==e.benitoJuarez&&null!==t[o-1].benitoJuarez&&(e.growthBenito=Number(((e.benitoJuarez-t[o-1].benitoJuarez)/t[o-1].benitoJuarez*100).toFixed(1))),null!==e.mexico&&null!==t[o-1].mexico&&(e.growthMexico=Number(((e.mexico-t[o-1].mexico)/t[o-1].mexico*100).toFixed(1))),null!==e.mundo&&null!==t[o-1].mundo&&(e.growthMundo=Number(((e.mundo-t[o-1].mundo)/t[o-1].mundo*100).toFixed(1))),null!==e.qrooTotal&&null!==t[o-1].qrooTotal&&(e.growthQRooTotal=Number(((e.qrooTotal-t[o-1].qrooTotal)/t[o-1].qrooTotal*100).toFixed(1)))),1===o&&console.log("Ejemplo de crecimiento calculado para "+e.year+":",{benito:e.growthBenito,mexico:e.growthMexico,mundo:e.growthMundo,qroo:e.growthQRooTotal})}),console.log("Datos cargados:",t),console.log("Datos México disponibles:",t.filter(t=>null!==t.mexico).length),console.log("Datos Mundo disponibles:",t.filter(t=>null!==t.mundo).length),console.log("Datos Benito Juárez disponibles:",t.filter(t=>null!==t.benitoJuarez).length);const r=t.filter(t=>null!==t.mexico).slice(0,3),l=t.filter(t=>null!==t.mundo).slice(0,3);console.log("Muestra México:",r),console.log("Muestra Mundo:",l),function(){const t=document.querySelector("#populationGrowthChart");if(!t)return;const o=document.createElement("div");o.className="data-selector",o.style.marginBottom="15px",o.style.textAlign="center";[{value:"benito",label:"Benito Juárez"},{value:"qroo",label:"Quintana Roo"},{value:"mexico",label:"México"},{value:"mundo",label:"Mundo"}].forEach(t=>{const n=document.createElement("label");n.style.marginRight="20px",n.style.cursor="pointer",n.style.fontWeight="benito"===t.value?"700":"600",n.style.color="benito"===t.value?"#FB8500":"#023047",n.style.transition="color 0.3s ease";const r=document.createElement("input");r.type="radio",r.name="population-data",r.value=t.value,r.checked="benito"===t.value,r.style.marginRight="5px",r.addEventListener("change",function(){if(this.checked){e=this.value,a(e);o.querySelectorAll("label").forEach(t=>{const e=t.querySelector("input");t.style.color=e.checked?"#FB8500":"#023047",t.style.fontWeight=e.checked?"700":"600"})}}),n.addEventListener("mouseenter",function(){r.checked||(this.style.color="#219EBC")}),n.addEventListener("mouseleave",function(){r.checked||(this.style.color="#023047")}),n.appendChild(r),n.appendChild(document.createTextNode(t.label)),o.appendChild(n)}),t.prepend(o)}(),a("benito")}).catch(function(t){console.error("Error cargando los datos:",t)})}function a(e){if(!document.querySelector("#populationGrowthChart"))return;d3.select("#populationGrowthChart svg").remove();const n=40,a=80,l=100,i=800-l-60,s=400-n-a,c=d3.select("#populationGrowthChart").append("svg").attr("viewBox","0 0 800 400").attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%").append("g").attr("transform",`translate(${l},${n})`),d=`bar-gradient-${e}-${Date.now()}`,u=c.append("defs").append("linearGradient").attr("id",d).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");u.append("stop").attr("offset","0%").attr("stop-color",r(e,"start")),u.append("stop").attr("offset","100%").attr("stop-color",r(e,"end"));const m=t.filter(t=>{switch(e){case"benito":default:return null!==t.benitoJuarez&&!isNaN(t.benitoJuarez);case"mexico":return null!==t.mexico&&!isNaN(t.mexico);case"mundo":return null!==t.mundo&&!isNaN(t.mundo);case"qroo":return null!==t.qrooTotal&&!isNaN(t.qrooTotal)}});console.log(`Datos filtrados para ${e}:`,m.length,"registros"),console.log("Primeros 3 registros:",m.slice(0,3));const p=t=>{switch(e){case"benito":default:return t.benitoJuarez;case"mexico":return t.mexico;case"mundo":return t.mundo;case"qroo":return t.qrooTotal}},x=d3.scaleBand().domain(m.map(t=>t.year)).range([0,i]).padding(.3);let h;const y=d3.max(m,t=>p(t));h="mundo"===e?[0,1.05*y]:"mexico"===e?[0,1.08*y]:[0,1.15*y];const g=d3.scaleLinear().domain(h).nice().range([s,0]);c.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${s})`).call(d3.axisBottom(x).tickFormat(t=>t.toString())).selectAll("text").attr("transform","rotate(-45)").attr("text-anchor","end").attr("dx","-.8em").attr("dy",".15em"),c.append("g").attr("class","axis y-axis").call(d3.axisLeft(g).tickFormat(t=>"mundo"===e&&t>1e9?d3.format(".1f")(t/1e9):t>1e6?d3.format(".1f")(t/1e6)+" M":t>1e3?d3.format(".1f")(t/1e3)+" K":d3.format(",")(t))),c.append("text").attr("class","title").attr("x",i/2).attr("y",-20).attr("text-anchor","middle").attr("fill","#023047").attr("font-weight","bold").attr("font-size","16px").text({benito:"Crecimiento Poblacional de Cancún (1970-2020)",qroo:"Crecimiento Poblacional de Quintana Roo (1970-2020)",mexico:"Crecimiento Poblacional de México (1910-2020) - en millones",mundo:"Crecimiento Poblacional Mundial (1910-2020) - en miles de millones"}[e]),c.append("text").attr("transform",`translate(${i/2}, ${s+a-10})`).style("text-anchor","middle").attr("fill","#023047").text("Año"),c.append("text").attr("transform","rotate(-90)").attr("y",15-l).attr("x",-s/2).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").text("Población");const b=document.getElementById("population-chart-tooltip");b&&b.remove();const f=document.createElement("div");f.id="population-chart-tooltip",f.className="vehicle-tooltip",f.style.position="fixed",f.style.padding="12px 16px",f.style.background="rgba(2, 48, 71, 0.95)",f.style.borderRadius="8px",f.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",f.style.pointerEvents="none",f.style.opacity="0",f.style.zIndex="99999",f.style.fontSize="14px",f.style.fontWeight="500",f.style.color="white",f.style.maxWidth="220px",f.style.transition="opacity 0.2s ease",document.body.appendChild(f);const v=d3.select("#population-chart-tooltip");if(console.log("Tooltip creado:",v.node()),c.selectAll(".bar").data(m).enter().append("rect").attr("class","bar").attr("x",t=>x(t.year)).attr("width",x.bandwidth()).attr("y",s).attr("height",0).attr("rx",5).attr("ry",5).attr("fill",`url(#${d})`).on("mouseover",function(t,o){d3.select(this).transition().duration(300).attr("opacity",.9).attr("stroke-width",2).style("fill",`url(#${d})`);let n=`\n                    <div><strong>Año ${o.year}</strong></div>\n                    <div>Población: <span style="color: #8ECAE6; font-weight:700">${a=p(o),"mundo"===e&&a>=1e9?`${(a/1e9).toFixed(1)}`:"mexico"===e&&a>=1e6?`${(a/1e6).toFixed(1)} millones`:a>=1e6?`${(a/1e6).toFixed(2)} millones`:a>=1e3?`${(a/1e3).toFixed(0)} mil`:new Intl.NumberFormat("es-MX").format(a)}</span></div>\n                `;var a;const r=(t=>{switch(e){case"benito":default:return t.growthBenito;case"mexico":return t.growthMexico;case"mundo":return t.growthMundo;case"qroo":return t.growthQRooTotal}})(o);if(null!==r&&!isNaN(r)){let t="#e5e7eb";r>0?t="#2ECC71":r<0&&(t="#E63946"),n+=`\n                        <div>Incremento: <span style="color:${t}; font-weight:700">${r>0?"+":""}${r}%</span></div>\n                    `}const l=t.clientX-100,i=t.clientY-110;v.html(n).style("left",l+"px").style("top",i+"px").style("opacity",1).style("display","block"),console.log("Tooltip mostrado en:",l,i,"Contenido:",n)}).on("mouseout",function(){d3.select(this).transition().duration(300).attr("opacity",1).attr("stroke-width",1).style("fill",`url(#${d})`),v.style("opacity",0).style("display","none")}).on("mousemove",function(t){const e=t.clientX-100,o=t.clientY-110;v.style("left",e+"px").style("top",o+"px")}).transition().delay((t,e)=>150*e).duration(1e3).attr("y",t=>g(p(t))).attr("height",t=>s-g(p(t))).ease(d3.easeBounceOut).style("fill",`url(#${d})`),c.selectAll(".value-label").data(m).enter().append("text").attr("class","value-label").attr("x",t=>x(t.year)+x.bandwidth()/2).attr("y",s).attr("opacity",0).text(t=>"mundo"===e&&p(t)>1e9?`${(p(t)/1e9).toFixed(1)}`:p(t)>1e6?`${(p(t)/1e6).toFixed(1)}M`:p(t)>1e3?`${(p(t)/1e3).toFixed(0)}K`:p(t)).transition().delay((t,e)=>150*e+700).duration(700).attr("y",t=>g(p(t))-10).attr("opacity",1),"benito"===e&&i>500){const t=[{note:{title:"Crecimiento Extraordinario",label:"441.6% de incremento en los 70s",wrap:150},connector:{end:"arrow",type:"curve",curvature:.5},x:x(1980)+x.bandwidth()/2,y:g(37190)-30,dy:-30,dx:-30}],e=d3.annotation().type(d3.annotationLabel).annotations(t);c.append("g").attr("class","annotation-group").attr("opacity",0).call(e).transition().delay(1500).duration(800).attr("opacity",1)}o=c}function r(t,e){return{benito:{start:"#FB8500",end:"#FFB703"},qroo:{start:"#219EBC",end:"#8ECAE6"},mexico:{start:"#023047",end:"#219EBC"},mundo:{start:"#8ECAE6",end:"#023047"}}[t][e]}const l=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&0===t.length&&(n(),l.unobserve(e.target))})},{threshold:.3}),i=document.querySelector("#populationGrowthChart");i&&l.observe(i),window.addEventListener("resize",()=>{t.length>0&&a(e)})});