document.addEventListener("DOMContentLoaded",function(){let t=[],e="benito",o=null;function n(){function o(t){if(!t||""===t.trim())return null;const e=+t.replace(/\./g,"");return isNaN(e)?null:e}d3.csv(`public/data/poblacion-valores.csv?v=${Date.now()}`).then(function(n){t=n.map(t=>({year:+t.Año,benitoJuarez:o(t["Población Benito Juárez"]),mexico:o(t["Poblacion México"]),mundo:o(t["Poblacion Mundo"]),qrooTotal:o(t["Población Todo de Quintana Roo"]),qrooResto:o(t["Población Resto de Quintana Roo"]),benitoJuarezRaw:t["Población Benito Juárez"],mexicoRaw:t["Poblacion México"],mundoRaw:t["Poblacion Mundo"],qrooTotalRaw:t["Población Todo de Quintana Roo"],qrooRestoRaw:t["Población Resto de Quintana Roo"]})).filter(t=>t.year&&!isNaN(t.year)&&t.year<=2020),t.forEach((e,o)=>{e.growthBenito=null,e.growthMexico=null,e.growthMundo=null,e.growthQRooTotal=null,o>0&&(null!==e.benitoJuarez&&null!==t[o-1].benitoJuarez&&(e.growthBenito=Number(((e.benitoJuarez-t[o-1].benitoJuarez)/t[o-1].benitoJuarez*100).toFixed(1))),null!==e.mexico&&null!==t[o-1].mexico&&(e.growthMexico=Number(((e.mexico-t[o-1].mexico)/t[o-1].mexico*100).toFixed(1))),null!==e.mundo&&null!==t[o-1].mundo&&(e.growthMundo=Number(((e.mundo-t[o-1].mundo)/t[o-1].mundo*100).toFixed(1))),null!==e.qrooTotal&&null!==t[o-1].qrooTotal&&(e.growthQRooTotal=Number(((e.qrooTotal-t[o-1].qrooTotal)/t[o-1].qrooTotal*100).toFixed(1)))),1===o&&(e.year,e.growthBenito,e.growthMexico,e.growthMundo,e.growthQRooTotal)}),t.filter(t=>null!==t.mexico).length,t.filter(t=>null!==t.mundo).length,t.filter(t=>null!==t.benitoJuarez).length;t.filter(t=>null!==t.mexico).slice(0,3),t.filter(t=>null!==t.mundo).slice(0,3);!function(){const t=document.querySelector("#populationGrowthChart");if(!t)return;const o=document.createElement("div");o.className="data-selector",o.style.marginBottom="15px",o.style.textAlign="center";[{value:"benito",label:"Cancún"},{value:"qroo",label:"Quintana Roo"},{value:"mexico",label:"México"},{value:"mundo",label:"Mundo"}].forEach(t=>{const n=document.createElement("label");n.style.marginRight="15px",n.style.cursor="pointer",n.style.color="benito"===t.value?"#FB8500":"#023047",n.style.fontWeight="benito"===t.value?"700":"600",n.style.transition="color 0.2s";const r=document.createElement("input");r.type="radio",r.name="dataType",r.value=t.value,r.checked="benito"===t.value,r.style.marginRight="5px",r.addEventListener("change",function(){if(this.checked){e=this.value,a(e);o.querySelectorAll("label").forEach(t=>{const e=t.querySelector("input");t.style.color=e.checked?"#FB8500":"#023047",t.style.fontWeight=e.checked?"700":"600"})}}),n.addEventListener("mouseenter",function(){r.checked||(this.style.color="#219EBC")}),n.addEventListener("mouseleave",function(){r.checked||(this.style.color="#023047")}),n.appendChild(r),n.appendChild(document.createTextNode(t.label)),o.appendChild(n)}),t.prepend(o)}(),a("benito")}).catch(function(t){console.error("Error cargando los datos:",t)})}function a(e){if(!document.querySelector("#populationGrowthChart"))return;d3.select("#populationGrowthChart svg").remove();const n=40,a=80,l=120,i=800-l-60,s=400-n-a,c=d3.select("#populationGrowthChart").append("svg").attr("viewBox","0 0 800 400").attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").style("max-width","100%").append("g").attr("transform",`translate(${l},${n})`),d=`bar-gradient-${e}-${Date.now()}`,u=c.append("defs").append("linearGradient").attr("id",d).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");u.append("stop").attr("offset","0%").attr("stop-color",r(e,"start")),u.append("stop").attr("offset","100%").attr("stop-color",r(e,"end"));const m=t.filter(t=>{switch(e){case"benito":default:return null!==t.benitoJuarez&&!isNaN(t.benitoJuarez);case"mexico":return null!==t.mexico&&!isNaN(t.mexico);case"mundo":return null!==t.mundo&&!isNaN(t.mundo);case"qroo":return null!==t.qrooTotal&&!isNaN(t.qrooTotal)}});m.length,m.slice(0,3);const p=t=>{switch(e){case"benito":default:return t.benitoJuarez;case"mexico":return t.mexico;case"mundo":return t.mundo;case"qroo":return t.qrooTotal}},h=d3.scaleBand().domain(m.map(t=>t.year)).range([0,i]).padding(.3);let x;const y=d3.max(m,t=>p(t));x="mundo"===e?[0,9e9]:"mexico"===e?[0,14e7]:[0,1.15*y];const f=d3.scaleLinear().domain(x).nice().range([s,0]);if(c.append("g").attr("class","axis x-axis").attr("transform",`translate(0,${s})`).call(d3.axisBottom(h).tickFormat(t=>t.toString())).selectAll("text").attr("transform","rotate(-45)").attr("text-anchor","end").attr("dx","-.8em").attr("dy",".15em"),"mundo"===e){const t=d3.range(0,10).map(t=>1e9*t);c.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(t).tickFormat(t=>0===t?"0":d3.format("d")(t/1e9)+" MM"))}else if("mexico"===e){const t=d3.ticks(0,x[1],6).map(t=>1e6*Math.round(t/1e6)),e=Array.from(new Set(t)).sort((t,e)=>t-e);c.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(e).tickFormat(t=>0===t?"0":d3.format("d")(Math.round(t/1e6))+" M"))}else{const t=x[1],e=d3.ticks(0,t,6).map(t=>Math.round(t)),o=Array.from(new Set(e)).sort((t,e)=>t-e);c.append("g").attr("class","axis y-axis").call(d3.axisLeft(f).tickValues(o).tickFormat(t=>0===t?"0":t>=1e6?d3.format(".1f")(t/1e6)+"M":t>=1e3?d3.format("d")(Math.round(t/1e3))+"K":d3.format(",")(Math.round(t))))}c.append("text").attr("class","title").attr("x",i/2).attr("y",-20).attr("text-anchor","middle").attr("fill","#023047").attr("font-weight","bold").attr("font-size","16px").text({benito:"Crecimiento Poblacional de Cancún (1970-2020)",qroo:"Crecimiento Poblacional de Quintana Roo (1970-2020)",mexico:"Crecimiento Poblacional de México (1910-2020) - en millones",mundo:"Crecimiento Poblacional Mundial (1910-2020) - en miles de millones"}[e]),c.append("text").attr("transform",`translate(${i/2}, ${s+a-10})`).style("text-anchor","middle").attr("fill","#023047").text("Año"),c.append("text").attr("transform","rotate(-90)").attr("y",20-l).attr("x",-s/2).attr("dy","1em").style("text-anchor","middle").attr("fill","#023047").attr("font-size","14px").text("Población");const b=document.getElementById("population-chart-tooltip");b&&b.remove();const g=document.createElement("div");g.id="population-chart-tooltip",g.className="vehicle-tooltip",g.style.position="fixed",g.style.padding="12px 16px",g.style.background="rgba(2, 48, 71, 0.95)",g.style.borderRadius="8px",g.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",g.style.pointerEvents="none",g.style.opacity="0",g.style.zIndex="99999",g.style.fontSize="14px",g.style.fontWeight="500",g.style.color="white",g.style.maxWidth="220px",g.style.transition="opacity 0.2s ease",document.body.appendChild(g);const w=d3.select("#population-chart-tooltip");if(w.node(),c.selectAll(".bar").data(m).enter().append("rect").attr("class","bar").attr("x",t=>h(t.year)).attr("width",h.bandwidth()).attr("y",s).attr("height",0).attr("rx",5).attr("ry",5).attr("fill",`url(#${d})`).on("mouseover",function(t,o){d3.select(this).transition().duration(300).attr("opacity",.9).attr("stroke-width",2).style("fill",`url(#${d})`);const n=(t=>{switch(e){case"benito":default:return t.benitoJuarezRaw||null;case"mexico":return t.mexicoRaw||null;case"mundo":return t.mundoRaw||null;case"qroo":return t.qrooTotalRaw||null}})(o),a=(n&&""!==String(n).trim()?String(n).replace(/\./g,","):null)||(r=p(o),"mundo"===e&&r>=1e9?`${(r/1e9).toFixed(1)}`:"mexico"===e&&r>=1e6?`${(r/1e6).toFixed(1)} millones`:r>=1e6?`${(r/1e6).toFixed(2)} millones`:r>=1e3?`${(r/1e3).toFixed(0)} mil`:new Intl.NumberFormat("es-MX").format(r));var r;let l=`\n                    <div><strong>Año ${o.year}</strong></div>\n                    <div>Población: <span style="color: #8ECAE6; font-weight:700">${a}</span></div>\n                `;const i=(t=>{switch(e){case"benito":default:return t.growthBenito;case"mexico":return t.growthMexico;case"mundo":return t.growthMundo;case"qroo":return t.growthQRooTotal}})(o);if(null!==i&&!isNaN(i)){let t="#e5e7eb";i>0?t="#2ECC71":i<0&&(t="#E63946"),l+=`\n                        <div>${i>0?"Incremento":i<0?"Decremento":"Incremento"}: <span style="color:${t}; font-weight:700">${i>0?"+":""}${i}%</span></div>\n                    `}const s=t.clientX-100,c=t.clientY-110;w.html(l).style("left",s+"px").style("top",c+"px").style("opacity",1).style("display","block")}).on("mouseout",function(){d3.select(this).transition().duration(300).attr("opacity",1).attr("stroke-width",1).style("fill",`url(#${d})`),w.style("opacity",0).style("display","none")}).on("mousemove",function(t){const e=t.clientX-100,o=t.clientY-110;w.style("left",e+"px").style("top",o+"px")}).transition().delay((t,e)=>150*e).duration(1e3).attr("y",t=>f(p(t))).attr("height",t=>s-f(p(t))).ease(d3.easeBounceOut).style("fill",`url(#${d})`),c.selectAll(".value-label").data(m).enter().append("text").attr("class","value-label").attr("x",t=>h(t.year)+h.bandwidth()/2).attr("y",s).attr("opacity",0).text(t=>"mundo"===e&&p(t)>1e9?`${(p(t)/1e9).toFixed(1)}`:p(t)>1e6?`${(p(t)/1e6).toFixed(1)}M`:"benito"===e?new Intl.NumberFormat("es-MX").format(p(t)):p(t)>1e3?`${(p(t)/1e3).toFixed(0)}K`:p(t)).attr("font-size","10px").transition().delay((t,e)=>150*e+700).duration(700).attr("y",t=>f(p(t))-10).attr("opacity",1),"benito"===e&&i>500){const t=i>600?90:70,e=[{note:{label:"Crecimiento Extraordinario 441.6% de incremento en los 70s",wrap:Math.min(Math.round(1.3*t),Math.floor(.25*i)),padding:4,align:"middle"},className:"annotation-responsive",connector:{end:"arrow",type:"line",endScale:.9},x:h(1980)+h.bandwidth()/2,y:f(37190)-30,dy:-15,dx:0}],o=d3.annotation().type(d3.annotationLabel).annotations(e);c.append("g").attr("class","annotation-group").attr("opacity",0).call(o).transition().delay(1500).duration(800).attr("opacity",1);const n=c.select(".annotation-group"),a=i>900?16:i>700?13:11,r=Math.round(1.5*a);n.selectAll(".annotation-note-label").style("font-size",r+"px").style("line-height","1.1").style("font-weight","600").style("word-break","break-word")}o=c}function r(t,e){return{benito:{start:"#FB8500",end:"#FFB703"},qroo:{start:"#219EBC",end:"#8ECAE6"},mexico:{start:"#023047",end:"#219EBC"},mundo:{start:"#8ECAE6",end:"#023047"}}[t][e]}const l=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&0===t.length&&(n(),l.unobserve(e.target))})},{threshold:.3}),i=document.querySelector("#populationGrowthChart");i&&l.observe(i),window.addEventListener("resize",()=>{t.length>0&&a(e)})});