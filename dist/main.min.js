document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("map");function t(e,t=1,n="block"){if(e)try{e.style.display=n,e.style.visibility="visible",e.offsetWidth,requestAnimationFrame(()=>{e.style.opacity=String(t)})}catch(e){}}function n(e,t=520){if(e)try{e.style.opacity="0",setTimeout(()=>{try{e.style.display="none",e.style.visibility="hidden"}catch(e){}},t)}catch(e){}}e&&(e.style.opacity="0",e.style.visibility="hidden",e.style.display="none"),function(){try{document.querySelectorAll(".step .step-content").forEach(e=>{e.style.opacity="0",e.style.visibility="hidden",e.style.pointerEvents="none"}),document.querySelectorAll(".forest-floating-text").forEach(e=>{try{e.classList.remove("visible"),e.classList.add("hidden"),e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.transform="translateX(0px)"}catch(e){}})}catch(e){}}();const s=scrollama();let o=null;let i=0;function l(e){if(!e)return;const t=e.querySelector&&e.querySelector(".chart-container");if(t){t.classList.contains("visible")||t.classList.add("visible");try{r(e)}catch{}}}function a(e){if(!e)return;const t=e.querySelector&&e.querySelector(".chart-container");if(t){t.classList.contains("visible")&&t.classList.remove("visible");try{c(e)}catch{}}}function r(e){if(!e)return;const t=e.querySelector&&e.querySelector(".chart-container");if(!t)return;if("true"===t.dataset.pinned)return;const n=t.getBoundingClientRect(),s=document.createElement("div");s.className="chart-placeholder",s.style.width=n.width+"px";const o=Math.max(80,Math.round(.2*window.innerHeight));s.style.height=n.height+o+"px",s.style.display=getComputedStyle(t).display||"block",t.parentNode.insertBefore(s,t);try{if(window.populationChart&&"function"==typeof window.populationChart.attachSelectorTo){const e=window.populationChart.getSelectorElement&&window.populationChart.getSelectorElement();e&&(window.populationChart.attachSelectorTo(t),e.style.position="absolute",e.style.top="8px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="10060",e.style.pointerEvents="auto",e.style.background=e.style.background||"transparent",e.style.padding=e.style.padding||"6px 0 12px 0",e.style.width=e.style.width||"auto")}}catch(e){console.warn("pinChart: could not move selector to chartCont",e)}const i=window.innerHeight||document.documentElement.clientHeight||800,l=n.height||500,a=Math.round((i-l)/2),r=Math.max(Math.round(.02*i),a),c=Math.min(n.width,Math.round(.92*window.innerWidth));t.style.position="fixed",t.style.top=r+"px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.width=c+"px",t.style.maxWidth="92%",t.style.zIndex="10050",t.style.transition="transform 200ms ease, box-shadow 200ms ease, width 120ms ease",t.style.boxShadow="0 20px 40px rgba(2,48,71,0.12)",t.dataset.pinned="true",s.style.height}function c(e){if(!e)return;const t=e.querySelector&&e.querySelector(".chart-container");if(!t)return;if("true"!==t.dataset.pinned)return;try{window.populationChart&&"function"==typeof window.populationChart.attachSelectorTo&&window.populationChart.attachSelectorTo(null)}catch(e){console.warn("unpinChart: could not restore selector to original",e)}const n=t.parentNode&&t.parentNode.querySelector&&t.parentNode.querySelector(".chart-placeholder");n&&n.remove(),t.style.position="",t.style.top="",t.style.left="",t.style.transform="",t.style.width="",t.style.zIndex="",t.style.transition="",t.style.boxShadow="",t.style.pointerEvents="",delete t.dataset.pinned}function d(e){const t=document.querySelector(`section[data-step="${e+1}"]`);if(!t)return void console.error(`No se encontró el elemento para step ${e+1}`);const n="true"===t.getAttribute("data-map");if(n){try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}const n=document.getElementById("map");n?(n.style.display="block",n.style.opacity="1",n.style.visibility="visible",n.style.zIndex="1000",n.classList.add("active")):console.error("❌ No se encontró el contenedor #map"),document.body.classList.add("showing-map"),document.body.style.overflow="auto";t.getAttribute("data-map-layer"),t.getAttribute("data-map-view");window.mapboxHelper&&"function"==typeof window.mapboxHelper.updateMapForStep?window.mapboxHelper.updateMapForStep(e+1):console.error("❌ No se encontró window.mapboxHelper.updateMapForStep");try{const t=document.getElementById("emergency-close-btn");if(t){const n=[19,25,31].includes(e+1),s=window.matchMedia&&window.matchMedia("(min-width: 992px)").matches;t.style.display=n&&s?"none":"flex"}}catch(e){}}else{document.body.style.overflow="auto",document.body.classList.remove("showing-map");const n=document.getElementById("emergency-close-btn");n&&(n.style.display="none");const s=document.getElementById("map-legend");s&&(s.style.display="none");const o=document.getElementById("map-lustro-control");if(o&&(o.style.display="none"),e>=6&&e<=16){const t=document.getElementById("urban-evolution-background");t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),function(e){const t={6:1975,7:1980,8:1985,9:1990,10:1995,11:2e3,12:2005,13:2010,14:2015,15:2020,16:2025};if(!Object.keys(t).includes(String(e)))return void document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const n=t[e];document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const s=document.getElementById(`urban-bg-${n}`);if(s){if(!s.getAttribute("src")){const e=s.getAttribute("data-src");e&&s.setAttribute("src",e)}requestAnimationFrame(()=>{s.classList.add("active"),s.style.opacity="1",s.style.visibility="visible",s.style.display="block"});const e={1975:1980,1980:1985,1985:1990,1990:1995,1995:2e3,2e3:2005,2005:2010,2010:2015,2015:2020,2020:2025}[n];if(e){const t=document.getElementById(`urban-bg-${e}`);if(t&&!t.getAttribute("src")){const e=t.getAttribute("data-src");e&&t.setAttribute("src",e)}}}else console.error(`No se encontró la imagen para el año ${n}`)}(e)}else{const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"}))}if(e>=20&&e<=22){const n=document.getElementById("forest-loss-background");n&&(n.style.display="block",n.style.visibility="visible",n.style.opacity="1"),p(e);try{const e=t,n=e&&e.querySelector&&e.querySelector(".forest-floating-text");n&&(n.classList.add("visible"),n.classList.remove("hidden"),n.style.display="inline-flex",n.style.opacity="1",n.style.visibility="visible")}catch(e){}}else{const e=document.getElementById("forest-loss-background");if(e){e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",document.querySelectorAll(".forest-bg-frame").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden",e.style.display="none"});try{document.querySelectorAll(".forest-floating-text").forEach(e=>{e.classList.remove("visible"),e.classList.add("hidden"),e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.transform="translateX(0px)"})}catch(e){}}}}const s=document.querySelectorAll('section[data-step="2"] .fixed-behind');1===e?s.forEach(e=>{e.style.display="",e.style.opacity="",e.style.visibility="",e.style.pointerEvents="none"}):s.forEach(e=>{e.style.opacity="0",e.style.visibility="hidden",e.style.display="none",e.style.pointerEvents="none"});const o=document.getElementById("map");o&&(o.style.opacity=n?"1":"0",o.style.visibility=n?"visible":"hidden",o.style.display=n?"block":"none")}function y(e){if(e)try{(e._typingTimers||[]).forEach(e=>{try{clearTimeout(e)}catch(e){}try{clearInterval(e)}catch(e){}}),e._typingTimers=[];e.querySelectorAll(".line, .sline").forEach(e=>{e.dataset&&e.dataset.fulltext&&(e.textContent=e.dataset.fulltext),e.classList.remove("reveal"),e.classList.remove("typing"),e.style.animation=""})}catch(e){console.warn("Error clearing typing timers:",e)}}function m(e){if(e)try{y(e);const t=window.matchMedia("(max-width: 767px)").matches?Array.from(e.querySelectorAll(".title-sm .sline")):Array.from(e.querySelectorAll(".title-lg .line"));t.forEach(e=>{const t=(e.textContent||"").trim();e.dataset.fulltext=t,e.textContent=""});if(!t.some(e=>e.dataset&&e.dataset.fulltext&&e.dataset.fulltext.length))return console.warn("startTypingStep1: no se detectó texto en las líneas, restaurando por seguridad"),void t.forEach(e=>{e.dataset&&e.dataset.fulltext&&(e.textContent=e.dataset.fulltext)});const n=function(){const e=window.innerWidth;return window.innerHeight,e<=375?35:e<=480?40:e<=768?45:e<=1024?50:e<=1200?55:60}();e._typingTimers=[];const s=(t,n,s)=>new Promise(o=>{t.classList.add("typing");let i=0;const l=setInterval(()=>{i+=1,t.textContent=n.slice(0,i),i>=n.length&&(clearInterval(l),setTimeout(()=>{t.classList.remove("typing")},80),o())},s);e._typingTimers.push(l)});(async()=>{for(let o=0;o<t.length;o++){const i=t[o],l=i.dataset.fulltext||"";o>0&&await new Promise(t=>{const n=setTimeout(t,200);e._typingTimers.push(n)}),await s(i,l,n)}})()}catch(e){console.warn("Error en startTypingStep1:",e)}}function u(){document.body.classList.remove("showing-map"),document.body.style.overflow="auto",document.documentElement.style.overflow="auto";const e=document.getElementById("emergency-close-btn");e&&(e.style.display="none"),window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay&&window.mapboxHelper.hideMapOverlay();const t=document.getElementById("map");t&&(t.style.display="none",t.style.opacity="0",t.style.visibility="hidden"),setTimeout(()=>{document.querySelectorAll("#map").forEach(e=>{if(e&&("none"!==window.getComputedStyle(e).display||window.getComputedStyle(e).opacity>0||"visible"===window.getComputedStyle(e).visibility)&&(e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.zIndex="-9999"),2===response.index)try{const e=document.getElementById("diario-img"),t=e&&e.closest(".evidence-overlay");e&&(e.style.transform="",e.style.zIndex="10",e.style.willChange="",t&&(t.style.zIndex="10"))}catch(e){}})},500)}function p(e){const s={20:2e3,21:2010,22:2020}[e];if(!s)return;const o=Array.from(document.querySelectorAll(".forest-bg-frame")),i=document.getElementById(`forest-frame-${s}`);if(i){i.style.zIndex="2";const e=i.querySelector(".forest-main-image");if(e&&!e.getAttribute("src")){const t=e.getAttribute("data-src");t&&e.setAttribute("src",t)}const l=i.querySelector(".forest-blur-layer");if(l&&!l.style.backgroundImage){const e=l.getAttribute("data-bg");e&&(l.style.backgroundImage=`url('${e}')`)}requestAnimationFrame(()=>{i.classList.add("active"),t(i,1,"block")});const a={2e3:2010,2010:2020}[s];if(a){const e=document.getElementById(`forest-frame-${a}`);if(e){const n=e.querySelector(".forest-main-image");if(n&&!n.getAttribute("src")){const e=n.getAttribute("data-src");e&&n.setAttribute("src",e)}const s=e.querySelector(".forest-blur-layer");if(s&&!s.style.backgroundImage){const e=s.getAttribute("data-bg");e&&(s.style.backgroundImage=`url('${e}')`)}e.classList.contains("active")||e.classList.add("active"),e.style.opacity=e.style.opacity||"0",t(e,0,"block")}}o.forEach(e=>{const t=e===i,s=a&&e.id===`forest-frame-${a}`;if(!t&&!s)try{e.style.zIndex="1",e.classList.remove("active"),n(e,420)}catch(e){}})}}window.hideMapVisuals=u,function(){!function(){const e=[1975,1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],t=document.getElementById("urban-evolution-background");t?(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.innerHTML="",e.forEach(e=>{const n=document.createElement("img");n.setAttribute("data-src",`assets/${e}.jpg`),n.className="urban-bg-image",n.id=`urban-bg-${e}`,n.alt=`Cancún ${e}`,n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.objectFit="cover",n.style.opacity="0",n.style.visibility="hidden",n.style.display="none",n.style.transition="opacity 0.8s ease-in-out, visibility 0.8s ease-in-out",t.appendChild(n)})):console.error("No se encontró el contenedor para imágenes de evolución urbana")}(),function(){const e=document.getElementById("forest-loss-background");e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.innerHTML="",[2e3,2010,2020].forEach(t=>{const n=document.createElement("div");n.className="forest-bg-frame",n.id=`forest-frame-${t}`,n.style.position="absolute",n.style.inset="0",n.style.opacity="0",n.style.visibility="hidden",n.style.display="none",n.style.zIndex="1",n.style.transition="opacity 0.6s ease, visibility 0.6s ease";const s=document.createElement("div");s.className="forest-blur-layer",s.style.position="absolute",s.style.inset="0",s.style.backgroundSize="cover",s.style.backgroundPosition="center",s.style.filter="blur(20px) brightness(0.9)",s.style.transform="scale(1.05)",s.style.willChange="transform, filter",s.setAttribute("data-bg",`assets/perdida-forestal-${t}.jpeg`);const o=document.createElement("img");o.className="forest-main-image",o.setAttribute("data-src",`assets/perdida-forestal-${t}.jpeg`),o.alt=`Pérdida de cobertura forestal ${t}`,o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.height="100vh",o.style.maxHeight="100vh",o.style.width="auto",o.style.maxWidth="90vw",o.style.objectFit="contain",o.style.borderRadius="12px",o.style.boxShadow="0 16px 40px rgba(0,0,0,0.35)",o.style.opacity="1",n.appendChild(s),n.appendChild(o),e.appendChild(n)})}();try{(function(e=5e3){return new Promise(t=>{try{const n=Array.from(document.querySelectorAll(".forest-bg-frame"));if(!n.length)return t([]);const s=[];n.forEach(t=>{const n=t.querySelector&&t.querySelector(".forest-main-image"),o=t.querySelector&&t.querySelector(".forest-blur-layer");if(n){const t=n.getAttribute("data-src");t&&s.push(new Promise(s=>{const o=new Image;let i=!1;o.onload=()=>{try{n.getAttribute("src")||n.setAttribute("src",t)}catch(e){}i=!0,s({ok:!0,src:t})},o.onerror=()=>{i=!0,s({ok:!1,src:t})},o.src=t,setTimeout(()=>{i||s({ok:!1,src:t})},e)}))}if(o){const t=o.getAttribute("data-bg");t&&s.push(new Promise(n=>{const s=new Image;let i=!1;s.onload=()=>{try{o.style.backgroundImage||(o.style.backgroundImage=`url('${t}')`)}catch(e){}i=!0,n({ok:!0,bg:t})},s.onerror=()=>{i=!0,n({ok:!1,bg:t})},s.src=t,setTimeout(()=>{i||n({ok:!1,bg:t})},e)}))}}),Promise.all(s).then(e=>t(e)).catch(()=>t([]))}catch(e){t([])}})})(6e3).then(e=>{})}catch(e){console.warn("preloadForestImages failed",e)}!function(){s.setup({step:".step",offset:.5,progress:!0,debug:!1}).onStepEnter(e=>{if(e.index,e.element&&e.element.getAttribute&&e.element.getAttribute("data-step"),i=e.index,i<20||i>22)try{document.querySelectorAll(".forest-floating-text").forEach(e=>{e.classList.remove("visible"),e.classList.add("hidden"),e.style.display="none",e.style.transform=""})}catch{}try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}d(i),document.querySelectorAll(".step").forEach(e=>{e.classList.remove("is-active"),e.classList.remove("active")}),e.element.classList.add("is-active"),e.element.classList.add("active");try{const t=e.element.querySelector&&e.element.querySelector(".step-content");t&&(t.style.opacity="1",t.style.visibility="visible",t.style.pointerEvents="auto")}catch(e){}try{0===e.index&&m(e.element)}catch(e){console.warn("Error aplicando typing secuencial en step 1:",e)}if(28===i){const t=e.element;t.classList.remove("animate-up","animate-down"),"down"===e.direction?t.classList.add("animate-down"):t.classList.add("animate-up")}try{if(2===e.index){const t=e.element,n=t&&t.querySelector&&t.querySelector(".step-content"),s=document.getElementById("diario-img"),o=s&&s.closest(".evidence-overlay");if(s&&(s.style.transform="",s.style.zIndex="10",s.style.opacity="1",s.style.visibility="visible",s.style.willChange="auto"),o&&(o.style.zIndex="10"),n&&!t.dataset._pinned){const s=n.getBoundingClientRect(),o=Math.round(.15*window.innerHeight),i="down"===e.direction;if(i&&s.top-o>12||!i)try{const e=document.createElement("div");e.className="step-content-placeholder",e.style.width=s.width+"px",e.style.height=s.height+"px",e.style.display=getComputedStyle(n).display||"block",n.parentNode.insertBefore(e,n),n.style.position="fixed",n.style.top=o+"px",n.style.left=s.left+"px",n.style.width=s.width+"px",n.style.zIndex="1",n.style.transition="none",t.dataset._pinned="1",t.dataset._placeholderId=""}catch(e){console.warn("pin step3 failed",e)}}}}catch(e){console.warn("step3 pin error",e)}if(4===i){const t=e.element;try{t.classList.remove("animate-up","animate-down")}catch{}const n=t.querySelector&&t.querySelector(".floating-image");n&&(n.style.transform="")}if(26===i&&window.vehicleChart&&"function"==typeof window.vehicleChart.enter&&window.vehicleChart.enter(),e.index>=20&&e.index<=22&&e.element.getAttribute("data-forest-year")){p(e.index);const n=e.element.querySelector(".forest-floating-text");if(n)try{n.classList.remove("hidden"),n.classList.add("visible"),t(n,1,"inline-flex")}catch(e){}}if(e.index,3!==e.index)try{const e=document.querySelector('section[data-step="4"]');if(e){const t=e.querySelector(".chart-container");t&&t.classList.contains("visible")&&t.classList.remove("visible"),t&&"true"===t.dataset.pinned&&c(e)}}catch{}}).onStepExit(e=>{e.index,e.element&&e.element.getAttribute&&e.element.getAttribute("data-step"),e.element.classList.remove("is-active"),e.element.classList.remove("active");try{const t=e.element.querySelector&&e.element.querySelector(".step-content");t&&(t.style.opacity="0",t.style.visibility="hidden",t.style.pointerEvents="none")}catch(e){}try{const t=e.element&&e.element.getAttribute&&e.element.getAttribute("data-step"),n=document.querySelector(".footer");n&&"32"===String(t)&&n.classList.remove("visible-footer")}catch(e){}try{0===e.index&&y(e.element)}catch(e){console.warn("Error limpiando typing al salir de step 1:",e)}if(2===e.index)try{const t=e.element,n=t&&t.querySelector&&t.querySelector(".step-content");if(n){n.style.transition="",n.style.transform="",n.style.position="",n.style.top="",n.style.left="",n.style.width="",n.style.zIndex="";try{const e=n.parentNode&&n.parentNode.querySelector(".step-content-placeholder");e&&e.parentNode&&e.parentNode.removeChild(e)}catch(e){}}try{delete t.dataset._pinned}catch(e){}try{delete t.dataset._nudgeDone}catch(e){}try{delete t.dataset._nudgeActive}catch(e){}try{const e=document.getElementById("diario-img"),t=e&&e.closest(".evidence-overlay");e&&(e.style.transform="",e.style.zIndex="10",e.style.willChange=""),t&&(t.style.zIndex="10")}catch(e){}}catch(e){}if(28===e.index){const t=e.element;t.classList.remove("animate-up","animate-down");const n=t.querySelector(".consequence-image-left"),s=t.querySelector(".consequence-image-right");n&&s&&(n.style.opacity="0",s.style.opacity="0",n.style.transform="scale(0.9) translateX(-40px)",s.style.transform="scale(0.9) translateX(40px)")}if(4===e.index){const t=e.element;try{t.classList.remove("animate-up","animate-down")}catch{}const n=t.querySelector&&t.querySelector(".floating-image");n&&(n.style.opacity="0",n.style.transform="")}if(18===e.index||24===e.index)try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}if(e.index>=20&&e.index<=22){try{const t=e.element.querySelector(".forest-floating-text");if(t)try{t.classList.add("hidden"),t.classList.remove("visible"),t.style.transform="translateX(0px)",n(t,420)}catch(e){}}catch{}(i<20||i>22)&&setTimeout(()=>{const e=document.getElementById("forest-loss-background");e&&n(e,520),document.querySelectorAll(".forest-bg-frame").forEach(e=>{try{e.classList.remove("active"),n(e,520)}catch(e){}})},200)}e.index>=6&&e.index<=16&&(i<6||i>16)&&setTimeout(()=>{const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"})},200);const t=e.element;if(t&&"true"===t.getAttribute("data-map")&&u(),26===e.index&&window.vehicleChart&&"function"==typeof window.vehicleChart.exit&&window.vehicleChart.exit(),3===e.index)try{const t=e.element.querySelector(".chart-container");t&&t.classList.remove("visible");try{window.populationChart&&"function"==typeof window.populationChart.attachSelectorTo&&window.populationChart.attachSelectorTo(null);const e=document.getElementById("floating-population-selector");e&&e.remove()}catch(e){console.warn("exit step: could not restore selector",e)}c(e.element)}catch(e){}}),s.onStepProgress(e=>{const n=e.progress;try{const t=e.element&&e.element.getAttribute&&e.element.getAttribute("data-step"),n=document.querySelector(".footer");if(n)if("32"===String(t)){e.element.getBoundingClientRect().bottom<=window.innerHeight+2?n.classList.add("visible-footer"):n.classList.remove("visible-footer")}else n.classList.remove("visible-footer")}catch(e){}if(2===e.index)try{const e=document.getElementById("diario-img"),t=e&&e.closest(".evidence-overlay");if(e){const s=Math.max(0,Math.min(1,n)),o=window.matchMedia("(min-width: 768px)").matches,i=0,l=1;let a=0;a=s<=i?0:s>=l?1:(s-i)/(l-i);const r=Math.sin(a*Math.PI);e.style.opacity="1",e.style.visibility="visible",e.style.willChange="transform";const c=r>0?"9999":"10";if(e.style.zIndex=c,t&&(t.style.zIndex=c),o){const t=30*r,n=1+.5*r;e.style.transform=`translate(-${t}vw, 0) scale(${n})`}else{const t=1+.08*Math.sin(s*Math.PI);e.style.transform=`scale(${t})`}}}catch(e){console.warn("[onStepProgress] diario-img animation error:",e)}if(3===e.index){const t=e.element;if(!t.querySelector||!t.querySelector(".chart-container"))return;const s=document.querySelector('.step[data-step="4"] .substep.is-active');return void(n>=.82?a(t):s?l(t):n<.38?a(t):l(t))}e.index;try{if(e.index>=20&&e.index<=22){try{document.querySelectorAll(".forest-floating-text").forEach(t=>{t!==(e.element&&e.element.querySelector(".forest-floating-text"))&&(t.classList.remove("visible"),t.classList.add("hidden"),t.style.display="none",t.style.transform="translateX(0px)")})}catch{}const s=e.element.querySelector(".forest-floating-text");if(s){s.classList.add("visible"),s.classList.remove("hidden"),s.style.display="block";const o=window.matchMedia("(max-width: 767px)").matches;o?(s.style.top="14px",s.style.bottom=""):(s.style.bottom="24px",s.style.top="");const i=e.element.getAttribute("data-forest-year"),l=i?parseInt(i,10):null,a=l?document.getElementById(`forest-frame-${l}`):null,r=a?a.querySelector(".forest-main-image"):null,c=parseFloat(window.getComputedStyle(s).left||"24")||24,d=s.getBoundingClientRect(),y=r?r.getBoundingClientRect():null,m=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),u=window.matchMedia("(max-width: 1199px)").matches,p=y&&y.left>=0&&y.right<=m,h=p||u?Math.max(0,Math.min(1,n)):0,f=32;let g=0,b=0,v=0;if(o)s.style.transform="none";else{let e=0,t=0;y&&y.width>0?(e=Math.round(y.left-c+f),t=Math.round(y.right-c-d.width-f),e=Math.max(0,e),t=Math.max(e,t)):(e=0,t=0);const n=Math.max(0,t-e);g=Math.round(e+n*h),b=n,v=e,s.style.transform=`translateX(${g}px)`}const w={2e3:2010,2010:2020},x=l&&w[l]?w[l]:null,S=x?document.getElementById(`forest-frame-${x}`):null;if(a){const e=o?0:g,s=b>0?Math.max(0,Math.min(1,(e-v)/b)):0,i=2020===l,r=.6,c=.6;let d=s;if(2e3===l){const e=1-r;d=(o||p)&&n>=r?Math.max(0,Math.min(1,(n-r)/e)):0,t(a,S?Math.max(.2,1-d):1,"block")}else if(i)t(a,1,"block");else{const e=1-c;d=(o||p)&&n>=c?Math.max(0,Math.min(1,(n-c)/e)):0,t(a,S?1-d:1,"block")}}if(S){const e=S.querySelector(".forest-main-image");if(e&&!e.getAttribute("src")){const t=e.getAttribute("data-src");t&&e.setAttribute("src",t)}const s=S.querySelector(".forest-blur-layer");if(s&&!s.style.backgroundImage){const e=s.getAttribute("data-bg");e&&(s.style.backgroundImage=`url('${e}')`)}t(S,0,"block");const i=o?0:g;let a=b>0?Math.max(0,Math.min(1,(i-v)/b)):0;if(2e3===l){const e=.6,t=1-e;a=(o||p)&&n>=e?Math.max(0,Math.min(1,(n-e)/t)):0}else if(2010===l){const e=.6,t=1-e;a=(o||p)&&n>=e?Math.max(0,Math.min(1,(n-e)/t)):0}t(S,a,"block")}}}}catch(e){console.warn("[onStepProgress] forest loss animation error:",e)}try{const t=document.getElementById("map");if(t&&"none"!==t.style.display&&"hidden"!==t.style.visibility&&"0"!==t.style.opacity&&window.mapboxHelper&&"function"==typeof window.mapboxHelper.setCameraProgress){if(18===e.index){const e=Math.max(0,Math.min(1,n));window.mapboxHelper.setCameraProgress("step-19",e)}if(24===e.index){const e=Math.max(0,Math.min(1,n));window.mapboxHelper.setCameraProgress("step-25",e)}if(30===e.index){const e=Math.max(0,Math.min(1,n));window.mapboxHelper.setCameraProgress("step-31",e),"function"==typeof window.mapboxHelper.updateDimensionesOpacity&&window.mapboxHelper.updateDimensionesOpacity(e)}}}catch(e){}});const e=()=>{try{const e=document.querySelector(".footer");if(!e)return;const t=document.querySelector('.step.is-active[data-step="32"]');if(!t)return void e.classList.remove("visible-footer");t.getBoundingClientRect().bottom<=window.innerHeight+2?e.classList.add("visible-footer"):e.classList.remove("visible-footer")}catch(e){}};let r=null;window.addEventListener("scroll",()=>{r||(r=setTimeout(()=>{r=null,e()},120))},{passive:!0}),window.addEventListener("resize",e),setTimeout(e,60);try{o=scrollama(),o.setup({step:'.step[data-step="4"] .substep',offset:.55,debug:!1}).onStepEnter(e=>{e.element.classList.add("is-active");const t=e.element&&e.element.getAttribute("data-chart");t&&window.populationChart&&"function"==typeof window.populationChart.setDataType&&window.populationChart.setDataType(t),l(document.querySelector('section[data-step="4"]'))}).onStepExit(e=>{const t=Array.from(document.querySelectorAll('.step[data-step="4"] .substep')),n=t.indexOf(e.element),s=t.length-1,o=document.querySelector('section[data-step="4"]');e.element.classList.remove("is-active"),(0===n&&"up"===e.direction||n===s&&"down"===e.direction)&&a(o)})}catch(e){console.warn("No se pudo inicializar subScroller para substeps del Step 4:",e)}}(),document.addEventListener("mapbox-ready",function(){i>0&&d(i)})}();try{const e=document.querySelector('section[data-step="1"]');if(e){const t=e.getBoundingClientRect(),n=.5*(window.innerHeight||document.documentElement.clientHeight);t.top<=n&&t.bottom>=n&&(e.classList.add("is-active"),m(e))}}catch(e){console.warn("Error comprobando step1 en carga inicial:",e)}window.addEventListener("resize",()=>{if(s.resize(),o)try{o.resize()}catch{}try{const e=document.querySelector('section[data-step="4"]');if(e){const t=e.querySelector(".chart-container");t&&"true"===t.dataset.pinned&&(c(e),r(e))}}catch{}})});