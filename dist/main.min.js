document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("map");e&&(e.style.opacity="0",e.style.visibility="hidden",e.style.display="none");const t=scrollama();let s=0;function i(e){const t=document.querySelector(`section[data-step="${e+1}"]`);if(!t)return void console.error(`No se encontró el elemento para step ${e+1}`);const s="true"===t.getAttribute("data-map");if(s){try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}const s=document.getElementById("map");s?(s.style.display="block",s.style.opacity="1",s.style.visibility="visible",s.style.zIndex="1000",s.classList.add("active"),s.style.display,s.style.opacity,s.style.visibility):console.error("❌ No se encontró el contenedor #map"),document.body.classList.add("showing-map"),document.body.style.overflow="auto";t.getAttribute("data-map-layer"),t.getAttribute("data-map-view");window.mapboxHelper&&"function"==typeof window.mapboxHelper.updateMapForStep?window.mapboxHelper.updateMapForStep(e+1):(console.error("❌ No se encontró window.mapboxHelper.updateMapForStep"),window.mapboxHelper);const i=document.getElementById("emergency-close-btn");i&&(i.style.display="flex")}else{document.body.style.overflow="auto",document.body.classList.remove("showing-map");const t=document.getElementById("emergency-close-btn");t&&(t.style.display="none");const s=document.getElementById("map-legend");s&&(s.style.display="none");const i=document.getElementById("map-lustro-control");if(i&&(i.style.display="none"),e>=6&&e<=16){const t=document.getElementById("urban-evolution-background");t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),function(e){const t={6:1975,7:1980,8:1985,9:1990,10:1995,11:2e3,12:2005,13:2010,14:2015,15:2020,16:2025};if(!Object.keys(t).includes(String(e)))return void document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const s=t[e];document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const i=document.getElementById(`urban-bg-${s}`);if(i){if(!i.getAttribute("src")){const e=i.getAttribute("data-src");e&&i.setAttribute("src",e)}requestAnimationFrame(()=>{i.classList.add("active"),i.style.opacity="1",i.style.visibility="visible",i.style.display="block"});const e={1975:1980,1980:1985,1985:1990,1990:1995,1995:2e3,2e3:2005,2005:2010,2010:2015,2015:2020,2020:2025}[s];if(e){const t=document.getElementById(`urban-bg-${e}`);if(t&&!t.getAttribute("src")){const e=t.getAttribute("data-src");e&&t.setAttribute("src",e)}}}else console.error(`No se encontró la imagen para el año ${s}`)}(e)}else{const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"}))}if(e>=20&&e<=22){const t=document.getElementById("forest-loss-background");t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),function(e){const t={20:2e3,21:2010,22:2020}[e];if(!t)return;const s=Array.from(document.querySelectorAll(".forest-bg-frame.active")),i=document.getElementById(`forest-frame-${t}`);if(i){i.style.zIndex="2";const e=i.querySelector(".forest-main-image");if(e&&!e.getAttribute("src")){const t=e.getAttribute("data-src");t&&e.setAttribute("src",t)}const o=i.querySelector(".forest-blur-layer");if(o&&!o.style.backgroundImage){const e=o.getAttribute("data-bg");e&&(o.style.backgroundImage=`url('${e}')`)}requestAnimationFrame(()=>{i.classList.add("active"),i.style.display="block",i.style.visibility="visible",i.style.opacity="1"});const n={2e3:2010,2010:2020}[t];if(n){const e=document.getElementById(`forest-frame-${n}`);if(e){const t=e.querySelector(".forest-main-image");if(t&&!t.getAttribute("src")){const e=t.getAttribute("data-src");e&&t.setAttribute("src",e)}const s=e.querySelector(".forest-blur-layer");if(s&&!s.style.backgroundImage){const e=s.getAttribute("data-bg");e&&(s.style.backgroundImage=`url('${e}')`)}}}s.forEach(e=>{e!==i&&(e.style.zIndex="1",e.style.opacity="0",e.style.visibility="hidden",setTimeout(()=>{e.classList.remove("active"),e.style.display="none"},700))})}}(e)}else{const e=document.getElementById("forest-loss-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",document.querySelectorAll(".forest-bg-frame").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden",e.style.display="none"}))}}26===e&&window.initVehicleChart&&window.initVehicleChart();const i=document.getElementById("map");i&&(i.style.opacity=s?"1":"0",i.style.visibility=s?"visible":"hidden",i.style.display=s?"block":"none")}function o(){document.body.classList.remove("showing-map"),document.body.style.overflow="auto",document.documentElement.style.overflow="auto";const e=document.getElementById("emergency-close-btn");e&&(e.style.display="none"),window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay&&window.mapboxHelper.hideMapOverlay();const t=document.getElementById("map");t&&(t.style.display="none",t.style.opacity="0",t.style.visibility="hidden"),setTimeout(()=>{document.querySelectorAll("#map").forEach(e=>{e&&("none"!==window.getComputedStyle(e).display||window.getComputedStyle(e).opacity>0||"visible"===window.getComputedStyle(e).visibility)&&(e.id,e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.zIndex="-9999")})},500)}window.hideMapVisuals=o,function(){const e=[1975,1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],t=document.getElementById("urban-evolution-background");t?(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.innerHTML="",e.forEach(e=>{const s=document.createElement("img");s.setAttribute("data-src",`assets/${e}.jpg`),s.className="urban-bg-image",s.id=`urban-bg-${e}`,s.alt=`Cancún ${e}`,s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.objectFit="cover",s.style.opacity="0",s.style.visibility="hidden",s.style.display="none",s.style.transition="opacity 0.8s ease-in-out, visibility 0.8s ease-in-out",t.appendChild(s)})):console.error("No se encontró el contenedor para imágenes de evolución urbana")}(),function(){const e=document.getElementById("forest-loss-background");e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.innerHTML="",[2e3,2010,2020].forEach(t=>{const s=document.createElement("div");s.className="forest-bg-frame",s.id=`forest-frame-${t}`,s.style.position="absolute",s.style.inset="0",s.style.opacity="0",s.style.visibility="hidden",s.style.display="none",s.style.zIndex="1",s.style.transition="opacity 0.8s ease-in-out, visibility 0.8s ease-in-out";const i=document.createElement("div");i.className="forest-blur-layer",i.style.position="absolute",i.style.inset="0",i.style.backgroundSize="cover",i.style.backgroundPosition="center",i.style.filter="blur(20px) brightness(0.9)",i.style.transform="scale(1.05)",i.style.willChange="transform, filter",i.setAttribute("data-bg",`assets/perdida-forestal-${t}.jpeg`);const o=document.createElement("img");o.className="forest-main-image",o.setAttribute("data-src",`assets/perdida-forestal-${t}.jpeg`),o.alt=`Pérdida de cobertura forestal ${t}`,o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.height="100vh",o.style.maxHeight="100vh",o.style.width="auto",o.style.maxWidth="90vw",o.style.objectFit="contain",o.style.borderRadius="12px",o.style.boxShadow="0 16px 40px rgba(0,0,0,0.35)",o.style.opacity="1",s.appendChild(i),s.appendChild(o),e.appendChild(s)})}(),t.setup({step:".step",offset:.5,progress:!0,debug:!1}).onStepEnter(e=>{s=e.index;try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}if(i(s),document.querySelectorAll(".step").forEach(e=>{e.classList.remove("is-active"),e.classList.remove("active")}),e.element.classList.add("is-active"),e.element.classList.add("active"),28===s){const t=e.element;t.classList.remove("animate-up","animate-down"),"down"===e.direction?t.classList.add("animate-down"):t.classList.add("animate-up")}if(4===s){const t=e.element;t.classList.remove("animate-up","animate-down"),"down"===e.direction?t.classList.add("animate-down"):t.classList.add("animate-up")}e.element.classList.toString(),26===s&&window.vehicleChart&&"function"==typeof window.vehicleChart.enter&&window.vehicleChart.enter()}).onStepExit(e=>{if(e.index,e.element.classList.remove("is-active"),e.element.classList.remove("active"),28===e.index){const t=e.element;t.classList.remove("animate-up","animate-down");const s=t.querySelector(".consequence-image-left"),i=t.querySelector(".consequence-image-right");s&&i&&(s.style.opacity="0",i.style.opacity="0",s.style.transform="scale(0.9) translateX(-40px)",i.style.transform="scale(0.9) translateX(40px)")}if(4===e.index){const t=e.element;t.classList.remove("animate-up","animate-down");const s=t.querySelector(".floating-image");s&&(s.style.opacity="0",s.style.transform="scale(0.85) translateY(0)")}if(18===e.index||24===e.index)try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}e.index>=20&&e.index<=22&&(s<20||s>22)&&setTimeout(()=>{const e=document.getElementById("forest-loss-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),document.querySelectorAll(".forest-bg-frame").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden",e.style.display="none"})},200),e.index>=6&&e.index<=16&&(s<6||s>16)&&setTimeout(()=>{const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"})},200);const t=e.element;t&&"true"===t.getAttribute("data-map")&&o(),26===e.index&&window.vehicleChart&&"function"==typeof window.vehicleChart.exit&&window.vehicleChart.exit()}),document.addEventListener("mapbox-ready",function(){s>0&&i(s)}),window.addEventListener("resize",()=>{t.resize()})});