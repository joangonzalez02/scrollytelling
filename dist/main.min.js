document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("map");e&&(e.style.opacity="0",e.style.visibility="hidden",e.style.display="none");const t=scrollama();let o=0;function n(e){console.log(`Activando visuales para step ${e}`);const t=document.querySelector(`section[data-step="${e+1}"]`);if(!t)return void console.error(`No se encontró el elemento para step ${e+1}`);const o="true"===t.getAttribute("data-map");if(o){console.log(`=== ACTIVANDO MAPA PARA STEP ${e+1} ===`);try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}const o=document.getElementById("map");o?(console.log("🗺️ Forzando visibilidad del contenedor #map..."),o.style.display="block",o.style.opacity="1",o.style.visibility="visible",o.style.zIndex="1000",o.classList.add("active"),console.log("✅ Estilos aplicados a #map"),console.log("Display:",o.style.display),console.log("Opacity:",o.style.opacity),console.log("Visibility:",o.style.visibility)):console.error("❌ No se encontró el contenedor #map"),document.body.classList.add("showing-map"),document.body.style.overflow="auto";const n=t.getAttribute("data-map-layer"),l=t.getAttribute("data-map-view");console.log("📊 Datos del step:"),console.log("- Map Layer:",n),console.log("- Map View:",l),window.mapboxHelper&&"function"==typeof window.mapboxHelper.updateMapForStep?(console.log(`🚀 Llamando updateMapForStep(${e+1})...`),window.mapboxHelper.updateMapForStep(e+1)):(console.error("❌ No se encontró window.mapboxHelper.updateMapForStep"),console.log("window.mapboxHelper:",window.mapboxHelper));const i=document.getElementById("emergency-close-btn");i&&(i.style.display="flex",console.log("✅ Botón de emergencia mostrado"))}else{document.body.style.overflow="auto",document.body.classList.remove("showing-map");const t=document.getElementById("emergency-close-btn");t&&(t.style.display="none");const o=document.getElementById("map-legend");o&&(o.style.display="none");const n=document.getElementById("map-lustro-control");if(n&&(n.style.display="none"),e>=7&&e<=17){const t=document.getElementById("urban-evolution-background");t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),function(e){const t={7:1975,8:1980,9:1985,10:1990,11:1995,12:2e3,13:2005,14:2010,15:2015,16:2020,17:2025};if(!Object.keys(t).includes(String(e)))return console.log("No estamos en un step de evolución urbana, ocultando imágenes"),void document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const o=t[e];console.log(`Activando evolución urbana para año ${o}`),document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"});const n=document.getElementById(`urban-bg-${o}`);if(n){if(!n.getAttribute("src")){const e=n.getAttribute("data-src");e&&n.setAttribute("src",e)}requestAnimationFrame(()=>{n.classList.add("active"),n.style.opacity="1",n.style.visibility="visible",n.style.display="block",console.log(`Imagen de ${o} activada`)});const e={1975:1980,1980:1985,1985:1990,1990:1995,1995:2e3,2e3:2005,2005:2010,2010:2015,2015:2020,2020:2025}[o];if(e){const t=document.getElementById(`urban-bg-${e}`);if(t&&!t.getAttribute("src")){const e=t.getAttribute("data-src");e&&t.setAttribute("src",e)}}}else console.error(`No se encontró la imagen para el año ${o}`)}(e)}else{const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"}))}}26===e?(console.log("Activando gráfico de vehículos para el paso 27"),window.initVehicleChart&&window.initVehicleChart()):5===e&&console.log("Mostrando gráfico de población para el paso 6");const n=document.getElementById("map");n&&(n.style.opacity=o?"1":"0",n.style.visibility=o?"visible":"hidden",n.style.display=o?"block":"none")}function l(){console.log("Ejecutando hideMapVisuals - versión para Mapbox"),document.body.classList.remove("showing-map"),document.body.style.overflow="auto",document.documentElement.style.overflow="auto";const e=document.getElementById("emergency-close-btn");e&&(e.style.display="none"),window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay&&window.mapboxHelper.hideMapOverlay();const t=document.getElementById("map");t&&(t.style.display="none",t.style.opacity="0",t.style.visibility="hidden"),setTimeout(()=>{document.querySelectorAll("#map").forEach(e=>{e&&("none"!==window.getComputedStyle(e).display||window.getComputedStyle(e).opacity>0||"visible"===window.getComputedStyle(e).visibility)&&(console.log("¡EMERGENCIA! Contenedor de mapa aún visible, aplicando medidas adicionales",e.id),e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.zIndex="-9999")})},500)}window.hideMapVisuals=l,function(){console.log("Inicializando imágenes de evolución urbana");const e=[1975,1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],t=document.getElementById("urban-evolution-background");t?(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.innerHTML="",e.forEach(e=>{const o=document.createElement("img");o.setAttribute("data-src",`assets/${e}.jpg`),o.className="urban-bg-image",o.id=`urban-bg-${e}`,o.alt=`Cancún ${e}`,o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",o.style.opacity="0",o.style.visibility="hidden",o.style.display="none",o.style.transition="opacity 0.8s ease-in-out, visibility 0.8s ease-in-out",t.appendChild(o)})):console.error("No se encontró el contenedor para imágenes de evolución urbana"),console.log("Imágenes de evolución urbana inicializadas")}(),console.log("Inicializando Scrollama..."),t.setup({step:".step",offset:.5,progress:!0,debug:!1}).onStepProgress(e=>{}).onStepEnter(e=>{o=e.index,console.log("Entrando al step:",o);try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}if(n(o),document.querySelectorAll(".step").forEach(e=>{e.classList.remove("is-active")}),e.element.classList.add("is-active"),28===o){const t=e.element;t.classList.remove("animate-up","animate-down"),"down"===e.direction?t.classList.add("animate-down"):t.classList.add("animate-up")}console.log("Step activo:",o,"elemento:",e.element.classList.toString()),26===o&&window.vehicleChart&&"function"==typeof window.vehicleChart.enter&&window.vehicleChart.enter()}).onStepExit(e=>{if(console.log("Saliendo del step:",e.index),e.element.classList.remove("is-active"),28===e.index){const t=e.element;t.classList.remove("animate-up","animate-down");const o=t.querySelector(".consequence-image-left"),n=t.querySelector(".consequence-image-right");o&&n&&(o.style.opacity="0",n.style.opacity="0",o.style.transform="scale(0.9) translateX(-40px)",n.style.transform="scale(0.9) translateX(40px)")}if(3===e.index||19===e.index||23===e.index){console.log("Saliendo de step con leyenda (4/20/24), ocultando leyenda y panel de lustros");try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}}e.index>=7&&e.index<=17&&(o<7||o>17)&&setTimeout(()=>{console.log("Saliendo de steps de evolución urbana, ocultando imágenes");const e=document.getElementById("urban-evolution-background");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),document.querySelectorAll(".urban-bg-image").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden"})},200);const t=e.element;t&&"true"===t.getAttribute("data-map")&&(console.log("Saliendo de un step con mapa, ocultando Mapbox"),l()),26===e.index&&window.vehicleChart&&"function"==typeof window.vehicleChart.exit&&window.vehicleChart.exit()}),document.addEventListener("mapbox-ready",function(){console.log("Mapbox está listo, actualizando visuales para el step actual"),o>0&&n(o)}),window.addEventListener("resize",()=>{t.resize()})});