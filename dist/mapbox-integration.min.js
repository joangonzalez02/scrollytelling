let mapboxMap=null,currentBaseStyle="mapbox://styles/mapbox/light-v10";const MAPBOX_DEBUG=!1,dbg=(...e)=>{false},MAP_CONFIG={scoreMin:0,scoreMax:1901,cameraStart:{zoom:14,center:[-86.85,21.168]},cameraStartOverride:{center:[-86.8535,21.1715],zoom:12.99},cameraEnd:{zoom:10.5,center:[-86.85,21.16]}},LUSTROS=[1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],LUSTRO_COLORS={1980:"#E3F2FA",1985:"#CDEAF6",1990:"#B7E1F2",1995:"#A1D8EE",2e3:"#8ECAE6",2005:"#6FBAD8",2010:"#4BAAD0",2015:"#219EBC",2020:"#1A7D95",2025:"#023047"};let selectedLustros=new Set(LUSTROS);const mapboxAccessToken="pk.eyJ1IjoiMHhqZmVyIiwiYSI6ImNtZjRjNjczdTA0MGsya3Bwb3B3YWw4ejgifQ.8IZ5PTYktl5ss1gREda3fg",mapStepsConfig={visibleSteps:[19,25,31],stepConfigs:{19:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"cambio-poblacional-ageb",type:"fill",source:{type:"geojson",data:"public/data/cambio-poblacional.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","p100_dife_pob"]],0],"#f7fcf5",-16,"#e5f5e0",-8.8,"#c7e9c0",-2,"#a1d99b",7.5,"#74c476",30.5,"#41ab5d",82.5,"#238b45",100,"#006d2c",101.9,"#00441b"],"fill-opacity":.85,"fill-outline-color":"#ffffff"},popup:e=>{const t=Number(e.POBTOT||e.Pob2020||0),o=Number(e.Pob2010||0),a=Number(e.Dif_pob||t-o),n=Number(e.p100_dife_pob||(0!==o?(t-o)/o*100:0));return`<h3>AGEB ${e.CVE_AGEB||""}</h3>\n                                <p><strong>Población 2010:</strong> ${isFinite(o)?o.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Población 2020:</strong> ${isFinite(t)?t.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Diferencia absoluta:</strong> ${isFinite(a)?a.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Cambio porcentual:</strong> ${isFinite(n)?n.toFixed(1):"N/D"}%</p>`}}]},21:{center:[-86.8515,21.1619],zoom:11,pitch:20,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[]},25:{center:[-86.8515,21.1619],zoom:11,pitch:30,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"indice-marginacion-distritos",type:"fill",source:{type:"geojson",data:"public/data/indice-marginacion.geojson"},paint:{"fill-color":["match",["get","GM_2020"],"Muy alto","#5e0a26","Alto","#a11742","Medio","#d24d71","Bajo","#ee89a6","Muy bajo","#f9c2d1","#cccccc"],"fill-opacity":.8,"fill-outline-color":"#ffffff"},popup:e=>{const t=Number(e.POB_TOTAL||e.POBTOT||0),o=e.GM_2020||"N/D",a=Number(e.IM_2020||0);return`<h3>AGEB ${e.CVE_AGEB||e.CVEGEO||e.CVE||e.fid||e.id||""}</h3>\n                                <p><strong>Grado de marginación:</strong> ${o}</p>\n                                <p><strong>Índice de marginación (IM 2020):</strong> ${isFinite(a)?a.toFixed(2):"N/D"}</p>\n                                <p><strong>Población 2020:</strong> ${isFinite(t)?t.toLocaleString():"N/D"} habitantes</p>`}}]},31:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"dimensiones-caminar",type:"fill",source:{type:"geojson",data:"public/data/dimensiones-de-caminar.geojson"},paint:{"fill-color":["step",["+",["to-number",["get","Eval_D_abastecerse_cnt"]],["to-number",["get","Eval_aprender_cnt"]],["to-number",["get","Eval_D_circular_cnt"]],["to-number",["get","Eval_D_cuidados_cnt"]],["to-number",["get","Eval_D_disfrutar_cnt"]],["to-number",["get","Eval_D_reutil_reparar_cnt"]],["to-number",["get","Eval_D_trabajar_cnt"]]],"#f1faee",1,"#d4e9e7",301,"#a8dadc",701,"#6ca9c1",1250,"#1d3557",1901,"#e63946"],"fill-opacity":.85,"fill-outline-color":"#ffffff"},popup:e=>{const t=Number(e.Eval_D_abastecerse_cnt||0),o=Number(e.Eval_aprender_cnt||0),a=Number(e.Eval_D_circular_cnt||0),n=Number(e.Eval_D_cuidados_cnt||0),r=Number(e.Eval_D_disfrutar_cnt||0),i=Number(e.Eval_D_reutil_reparar_cnt||0),l=Number(e.Eval_D_trabajar_cnt||0);return`<h3>Oportunidades de las dimensiones del desarrollo</h3>\n                            <p><strong>Total agregado:</strong> ${t+o+a+n+r+i+l}</p>\n                            <p><strong>Abastecerse:</strong> ${t}</p>\n                            <p><strong>Aprender:</strong> ${o}</p>\n                            <p><strong>Circular:</strong> ${a}</p>\n                            <p><strong>Cuidados:</strong> ${n}</p>\n                            <p><strong>Disfrutar:</strong> ${r}</p>\n                            <p><strong>Reutilizar/Reparar:</strong> ${i}</p>\n                            <p><strong>Trabajar:</strong> ${l}</p>`}}]}}};function initializeMapbox(){mapboxgl.accessToken=mapboxAccessToken;try{mapboxgl.setTelemetryEnabled&&mapboxgl.setTelemetryEnabled(!1)}catch(e){}const e=document.getElementById("map");if(!e)return void console.error("No se encontró el contenedor #map");e.style.display,e.style.visibility,e.style.opacity;e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.width="100vw",e.style.height="100vh",mapboxMap=new mapboxgl.Map({container:"map",style:currentBaseStyle,center:[-86.8515,21.1619],zoom:12,pitch:0,bearing:0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0});try{const e=console.error;console.error=function(...t){t.some(e=>"string"==typeof e&&e.includes("events.mapbox.com/events"))||e.apply(console,t)}}catch(e){}let t;mapboxMap.on("load",()=>{e.classList.remove("active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",setTimeout(()=>{mapboxMap&&mapboxMap.resize()},100),setTimeout(()=>{const e=mapboxMap.getStyle();e&&e.layers&&dbg(e.layers.length,e.layers.slice(0,5).map(e=>`${e.id} (${e.type})`))},500),document.dispatchEvent(new CustomEvent("mapbox-ready"))}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{mapboxMap&&"block"===e.style.display&&mapboxMap.resize()},250)}),mapboxMap.addControl(new mapboxgl.NavigationControl,"top-right"),mapboxMap.addControl(new mapboxgl.FullscreenControl,"top-right")}function ensureProjDefs(){"undefined"==typeof proj4||proj4.defs["EPSG:32616"]||proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}function reprojectGeoJSONToWGS84(e){try{if(!e||"undefined"==typeof proj4)return e;const t=e.crs&&e.crs.properties&&e.crs.properties.name;if(!t)return e;const o=(t.match(/EPSG::(\d+)/)||[])[1]||(t.match(/EPSG:(\d+)/)||[])[1];if(!o)return e;let a=`EPSG:${o}`;if("EPSG:6371"===a&&(a="EPSG:32616"),"EPSG:4326"===a)return e;if(ensureProjDefs(),!proj4.defs[a]){if("EPSG:32616"!==a){console.warn("CRS no reconocido para reproyección:",a);const t=JSON.parse(JSON.stringify(e));return delete t.crs,t}proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}const n=proj4(a,"EPSG:4326"),r=e=>{const[t,o]=e,[a,r]=n.forward([t,o]);return[a,r]},i=(e,t)=>2===t?r(e):e.map(e=>i(e,t-1)),l=e=>{if(!e||!e.geometry)return e;const t=e.geometry;if(!t.coordinates)return e;let o;switch(t.type){case"Point":o=2;break;case"MultiPoint":case"LineString":o=3;break;case"MultiLineString":case"Polygon":o=4;break;case"MultiPolygon":o=5;break;case"GeometryCollection":return Array.isArray(t.geometries)&&(t.geometries=t.geometries.map(e=>({...e,coordinates:e.coordinates?i(e.coordinates,"Point"===e.type?2:"MultiPoint"===e.type||"LineString"===e.type?3:"MultiLineString"===e.type||"Polygon"===e.type?4:5):e.coordinates}))),e;default:return e}return t.coordinates=i(t.coordinates,o),e},s=JSON.parse(JSON.stringify(e)),c=e=>{if(!e||!e.type||null==e.coordinates)return!1;return Array.isArray(e.coordinates)&&e.coordinates.length>0};if("FeatureCollection"===s.type)s.features=s.features.map(l).filter(e=>e&&e.geometry&&c(e.geometry));else if("Feature"===s.type&&(l(s),!c(s.geometry)))return{type:"FeatureCollection",features:[]};return delete s.crs,s}catch(t){return console.warn("Fallo al reproyectar GeoJSON, usando datos originales:",t),e}}async function loadGeoJSONWithReprojection(e){const t=e.includes("?")?"&":"?",o=`${e}${t}v=${Date.now()}`,a=await fetch(o,{cache:"no-store"});return reprojectGeoJSONToWGS84(await a.json())}function showMapOverlay(e){const t=document.getElementById("map");if(!t)return void console.error("❌ No se encontró el contenedor #map");if(!mapboxMap)return void console.error("❌ mapboxMap no está inicializado");t.style.display="block",t.style.opacity="1",t.style.visibility="visible",t.style.zIndex="1000",t.style.backgroundColor="",t.classList.add("active");const o=t.querySelector(".mapboxgl-canvas");o?o.style.opacity="1":console.warn("⚠️ No se encontró el canvas del mapa");const a=t.querySelector(".mapboxgl-canvas-container");a&&(a.style.opacity="1"),mapboxMap&&mapboxMap.resize(),t._wheelForwardHandler||(t._wheelForwardHandler=function(e){try{e.preventDefault(),e.stopPropagation()}catch(e){}const t=e.deltaY||0;window.scrollBy(0,t)}),t.addEventListener("wheel",t._wheelForwardHandler,{passive:!1,capture:!0}),addKeyboardScrollSupport();try{mapboxMap.scrollZoom.disable()}catch(e){}setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},100),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},300),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},600);const n=async()=>{["densidad-poblacional","densidad-poblacional-distritos","indice-marginacion-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb","supermanzanas-iniciales","crecimiento-urbano","dimensiones-caminar"].forEach(e=>{mapboxMap.getLayer(e)&&mapboxMap.removeLayer(e)});["densidad-poblacional-src","densidad-poblacional-distritos-src","indice-marginacion-distritos-src","tasa-cambio-poblacional-src","cambio-poblacional-ageb-src","supermanzanas-iniciales-src","crecimiento-urbano-src","dimensiones-caminar-src"].forEach(e=>{mapboxMap.getSource(e)&&mapboxMap.removeSource(e)});const t=(()=>{try{const e=mapboxMap.getStyle();if(!e||!e.layers)return null;const t=e.layers.find(e=>"symbol"===e.type);return t?t.id:null}catch{return null}})();if(e.layers&&e.layers.length>0)for(const o of e.layers)try{const e=o.id+"-src";let a={...o.source};if("geojson"===a.type&&"string"==typeof a.data){if(a.data.toLowerCase().endsWith(".gpkg")){console.warn(`⛔ Formato GPKG no soportado para ${o.id}. Omite esta capa hasta convertir a GeoJSON.`);continue}if(a.data.toLowerCase().endsWith(".geojson"))try{const e=await loadGeoJSONWithReprojection(a.data);a={...a,data:e}}catch(e){console.warn("⚠️ No se pudo cargar/reproyectar",a.data,e)}}mapboxMap.getSource(e)?dbg():mapboxMap.addSource(e,a);const n={...o.paint},r={id:o.id,type:o.type,source:e,paint:n};if(mapboxMap.getLayer(o.id)?dbg(o.id):t?mapboxMap.addLayer(r,t):mapboxMap.addLayer(r),o.popup){let e=null;mapboxMap.on("mousemove",o.id,t=>{e&&e.remove();const a=t.features[0].properties,n=o.popup(a);e=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}).setLngLat(t.lngLat).setHTML(n).addTo(mapboxMap)}),mapboxMap.on("mouseenter",o.id,()=>{mapboxMap.getCanvas().style.cursor="pointer"}),mapboxMap.on("mouseleave",o.id,()=>{mapboxMap.getCanvas().style.cursor="",e&&(e.remove(),e=null)})}}catch(e){console.error(`❌ Error añadiendo capa ${o.id}:`,e)}else dbg();setTimeout(()=>{mapboxMap&&mapboxMap.resize()},500)},r=e.style||currentBaseStyle;r!==currentBaseStyle?(mapboxMap.once("style.load",n),mapboxMap.setStyle(r),currentBaseStyle=r):mapboxMap.isStyleLoaded&&mapboxMap.isStyleLoaded()?n():mapboxMap.once("style.load",n),mapboxMap.flyTo({center:e.center,zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,duration:2e3,essential:!0}),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},1e3),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},2500),dbg()}function hideMapOverlay(){const e=document.getElementById("map");if(e){e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.classList.remove("active");e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove()),e._wheelForwardHandler&&e.removeEventListener("wheel",e._wheelForwardHandler,{capture:!0})}else console.error("❌ No se encontró el contenedor #map para ocultar");try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch(e){console.warn("Error en limpieza de leyendas:",e)}}async function updateMapForStep(e){try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none"),dbg()}catch{}const t=String(e);mapStepsConfig.visibleSteps.includes(Number(e))&&mapStepsConfig.stepConfigs[t]?(await ensureMapboxReady(),window.mapboxHelper&&"function"==typeof window.mapboxHelper.showMapOverlay?window.mapboxHelper.showMapOverlay(mapStepsConfig.stepConfigs[t]):showMapOverlay(mapStepsConfig.stepConfigs[t])):window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay?window.mapboxHelper.hideMapOverlay():hideMapOverlay()}function createScrollZones(e){e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove());const t=document.createElement("div");t.className="map-scroll-zone top",t.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(t);if(31===targetStepId){const e="dimensiones-caminar",t=e+"-src",o=mapboxMap.getSource&&mapboxMap.getSource(t),a=o&&(o._data||o._options&&o._options.data);if(a&&Array.isArray(a.features)&&a.features.length>0){const t=e=>Number(e.Eval_D_abastecerse_cnt||0)+Number(e.Eval_aprender_cnt||0)+Number(e.Eval_D_circular_cnt||0)+Number(e.Eval_D_cuidados_cnt||0)+Number(e.Eval_D_disfrutar_cnt||0)+Number(e.Eval_D_reutil_reparar_cnt||0)+Number(e.Eval_D_trabajar_cnt||0),o=1901;let n=1/0,r=1/0,i=-1/0,l=-1/0;const s=e=>{if(e)if("number"==typeof e[0]&&"number"==typeof e[1]){const t=e[0],o=e[1];isFinite(t)&&isFinite(o)&&(t<n&&(n=t),o<r&&(r=o),t>i&&(i=t),o>l&&(l=o))}else Array.isArray(e)&&e.forEach(s)};a.features.forEach(e=>{try{t(e.properties||{})>=o&&e.geometry&&e.geometry.coordinates&&s(e.geometry.coordinates)}catch{}});const c=isFinite(n)&&isFinite(r)&&isFinite(i)&&isFinite(l)&&i>n&&l>r;if(MAP_CONFIG.cameraStartOverride&&Array.isArray(MAP_CONFIG.cameraStartOverride.center)){try{mapboxMap.jumpTo({center:MAP_CONFIG.cameraStartOverride.center,zoom:MAP_CONFIG.cameraStartOverride.zoom||14})}catch{}sceneManager.setScene("step-31",{center:MAP_CONFIG.cameraStartOverride.center,zoom:MAP_CONFIG.cameraStartOverride.zoom||14},{center:MAP_CONFIG.cameraEnd.center,zoom:MAP_CONFIG.cameraEnd.zoom})}else if(c){const t=[[n,r],[i,l]];try{mapboxMap.fitBounds(t,{padding:60,duration:800,essential:!0})}catch{}const o=[(n+i)/2,(r+l)/2];let a=mapboxMap.getZoom?mapboxMap.getZoom():12.5;sceneManager.setScene("step-31",{center:o,zoom:a},{center:MAP_CONFIG.cameraEnd.center,zoom:MAP_CONFIG.cameraEnd.zoom});const s=["+",["to-number",["get","Eval_D_abastecerse_cnt"]],["to-number",["get","Eval_aprender_cnt"]],["to-number",["get","Eval_D_circular_cnt"]],["to-number",["get","Eval_D_cuidados_cnt"]],["to-number",["get","Eval_D_disfrutar_cnt"]],["to-number",["get","Eval_D_reutil_reparar_cnt"]],["to-number",["get","Eval_D_trabajar_cnt"]]];try{mapboxMap.setPaintProperty(e,"fill-opacity",["case",[">=",["coalesce",s,-9999],1901],.85,.02])}catch{}}}}const o=document.createElement("div");o.className="map-scroll-zone bottom",o.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(o)}function handleScrollZoneWheel(e){e.preventDefault(),e.stopPropagation();const t=e.deltaY;window.scrollBy(0,t)}function addKeyboardScrollSupport(){document.addEventListener("keydown",function(e){const t=document.getElementById("map");t&&"none"!==t.style.display&&("ArrowDown"===e.key||"PageDown"===e.key?(e.preventDefault(),window.scrollBy(0,100)):"ArrowUp"===e.key||"PageUp"===e.key?(e.preventDefault(),window.scrollBy(0,-100)):"Home"===e.key?(e.preventDefault(),window.scrollTo(0,0)):"End"===e.key&&(e.preventDefault(),window.scrollTo(0,document.body.scrollHeight)))})}let mapInitPromise=null;async function ensureMapboxReady(){return!!mapboxMap||(mapInitPromise||(mapInitPromise=new Promise(e=>{if("undefined"!=typeof mapboxgl){initializeMapbox();const t=()=>{document.removeEventListener("mapbox-ready",t),e(!0)};return void document.addEventListener("mapbox-ready",t)}const t=document.createElement("script");t.src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js",t.async=!0,t.onload=()=>{initializeMapbox();const t=()=>{document.removeEventListener("mapbox-ready",t),e(!0)};document.addEventListener("mapbox-ready",t)},t.onerror=()=>{console.error("❌ No se pudo cargar Mapbox GL"),e(!1)},document.head.appendChild(t)})),mapInitPromise)}window.mapboxHelper={updateMapForStep:updateMapForStep,showMapOverlay:showMapOverlay,hideMapOverlay:hideMapOverlay};const sceneManager=function(){function e(e,t,o){return e+(t-e)*o}const t={"step-25":{from:{center:[-86.9,21.2],zoom:10.5,pitch:10,bearing:0},to:{center:[-86.83,21.15],zoom:12.8,pitch:28,bearing:-10},durationMs:0},"step-19":{from:{center:[-86.89,21.18],zoom:10.8,pitch:0,bearing:0},to:{center:[-86.85,21.16],zoom:12.2,pitch:12,bearing:5},durationMs:0},"step-31":{from:{center:MAP_CONFIG.cameraStart.center,zoom:MAP_CONFIG.cameraStart.zoom,pitch:0,bearing:0},to:{center:MAP_CONFIG.cameraEnd.center,zoom:MAP_CONFIG.cameraEnd.zoom,pitch:0,bearing:0},durationMs:0}};return{applyCameraProgress:function(o,a){if(!mapboxMap)return;const n=t[o];if(!n)return;const r=(i=a,Math.max(0,Math.min(1,i)));var i;const l=function(t,o,a){return[e(t[0],o[0],a),e(t[1],o[1],a)]}(n.from.center,n.to.center,r),s=e(n.from.zoom,n.to.zoom,r),c=e(n.from.pitch,n.to.pitch,r),p=e(n.from.bearing,n.to.bearing,r);try{mapboxMap.jumpTo({center:l,zoom:s,pitch:c,bearing:p})}catch(e){dbg()}},has:e=>Boolean(t[e]),setScene:(e,o,a)=>{t[e]&&(o&&(t[e].from={...t[e].from,...o}),a&&(t[e].to={...t[e].to,...a}))}}}();function ensureLustroPanel(){if(document.getElementById("map-lustro-control"))return;const e=document.createElement("div");e.id="map-lustro-control",e.style.position="fixed",e.style.zIndex="2000",e.style.background="rgba(255,255,255,0.96)",e.style.color="#222",e.style.borderRadius="8px",e.style.boxShadow="0 6px 18px rgba(0,0,0,0.18)",e.style.padding="10px 12px",e.style.minWidth="220px",e.style.pointerEvents="auto",e.style.display="none";const t=document.createElement("div");t.className="lustro-title",t.textContent="Expansión urbana por periodo",t.style.fontWeight="700",t.style.fontSize="13px",t.style.marginBottom="8px",e.appendChild(t);const o=document.createElement("div");o.className="lustro-list",o.style.display="grid",o.style.gridTemplateColumns="repeat(2, minmax(100px, 1fr))",o.style.gap="6px 12px",LUSTROS.forEach(e=>{const t=document.createElement("label");t.style.display="flex",t.style.alignItems="center",t.style.gap="6px";const a=document.createElement("input");a.type="checkbox",a.value=String(e),a.checked=!0,a.addEventListener("change",()=>{a.checked?selectedLustros.add(Number(a.value)):selectedLustros.delete(Number(a.value)),applyLustroFilterWhenReady()});const n=document.createElement("span");n.style.width="14px",n.style.height="10px",n.style.borderRadius="2px",n.style.border="1px solid rgba(0,0,0,0.2)",n.style.display="inline-block",n.style.background=LUSTRO_COLORS[e];const r=document.createElement("span");r.textContent=String(e),t.appendChild(a),t.appendChild(n),t.appendChild(r),o.appendChild(t)}),e.appendChild(o),document.body.appendChild(e)}function toggleLustroPanel(e){ensureLustroPanel();const t=document.getElementById("map-lustro-control");t&&(t.style.display=e?"block":"none",e?(positionLustroPanel(),window.addEventListener("resize",positionLustroPanel)):window.removeEventListener("resize",positionLustroPanel))}function positionLustroPanel(){const e=document.getElementById("map-lustro-control");if(!e||"none"===e.style.display)return;document.getElementById("map-legend");const t=e.style.visibility,o=e.style.display;"none"===o&&(e.style.visibility="hidden",e.style.display="block");const a=e.getBoundingClientRect(),n=(a.width,a.height,Math.max(document.documentElement.clientWidth,window.innerWidth||0)),r=(Math.max(document.documentElement.clientHeight,window.innerHeight||0),n<=640);e.style.right="14px",e.style.left="",e.style.top="",e.style.bottom="14px",e.style.minWidth=r?"190px":"240px",e.style.padding=r?"6px 8px":"10px 12px",e.style.maxHeight=r?"40vh":"60vh",e.style.overflowY="auto";const i=e.querySelector(".lustro-title");i&&(i.style.fontSize=r?"12px":"13px",i.style.marginBottom=r?"6px":"8px");const l=e.querySelector(".lustro-list");l&&(l.style.gridTemplateColumns=r?"repeat(2, minmax(90px, 1fr))":"repeat(1, minmax(140px, 1fr))",l.style.gap=r?"4px 8px":"6px 12px",Array.from(l.children).forEach(e=>{if(!(e instanceof HTMLElement))return;e.style.gap=r?"4px":"6px";const t=e.querySelector('input[type="checkbox"]');t&&(t.style.transform=r?"scale(0.9)":"scale(1)");const o=e.querySelector("span");o&&(o.style.width=r?"12px":"14px",o.style.height=r?"8px":"10px");const a=e.querySelector("span + span");a&&(a.style.fontSize=r?"12px":"13px")})),"none"===o&&(e.style.display="none",e.style.visibility=t||"visible")}function applyLustroFilter(){if(!mapboxMap)return;const e="crecimiento-urbano";if(!mapboxMap.getLayer||!mapboxMap.getLayer(e))return;const t=Array.from(selectedLustros);if(0===t.length){try{mapboxMap.setLayoutProperty(e,"visibility","none")}catch{}const t=document.getElementById("map-legend");t&&(t.style.display="none");try{mapboxMap.setFilter(e,null)}catch{}return}try{mapboxMap.setLayoutProperty(e,"visibility","visible")}catch{}const o=["match",["to-number",["get","LUSTRO"]]];t.forEach(e=>{o.push(e,!0)}),o.push(!1),mapboxMap.setFilter(e,o);try{console.debug("Filtro aplicado a crecimiento-urbano:",JSON.stringify(o))}catch{}}function applyLustroFilterWhenReady(e=0){if(!mapboxMap)return;if(mapboxMap.getLayer&&mapboxMap.getLayer("crecimiento-urbano"))applyLustroFilter();else if(!(e>10)){setTimeout(()=>applyLustroFilterWhenReady(e+1),150);try{mapboxMap.once&&mapboxMap.once("idle",()=>applyLustroFilter())}catch{}}}window.mapboxHelper.setCameraProgress=function(e,t){sceneManager.applyCameraProgress(e,t)},window.mapboxHelper.updateDimensionesOpacity=function(e){try{if(!mapboxMap)return;const t="dimensiones-caminar";if(!mapboxMap.getLayer||!mapboxMap.getLayer(t))return;const o=Math.max(0,Math.min(1,Number(e)||0)),a=["case",[">=",["coalesce",["+",["to-number",["get","Eval_D_abastecerse_cnt"]],["to-number",["get","Eval_aprender_cnt"]],["to-number",["get","Eval_D_circular_cnt"]],["to-number",["get","Eval_D_cuidados_cnt"]],["to-number",["get","Eval_D_disfrutar_cnt"]],["to-number",["get","Eval_D_reutil_reparar_cnt"]],["to-number",["get","Eval_D_trabajar_cnt"]]],-9999],MAP_CONFIG.scoreMax-o*(MAP_CONFIG.scoreMax-MAP_CONFIG.scoreMin)],.8,.05];mapboxMap.setPaintProperty(t,"fill-opacity",a)}catch(e){dbg()}},function(){const e=()=>document.getElementById("map-legend"),t=()=>e()?e().querySelector(".legend-items"):null;function o(t){const o=e();if(o){if(t){const e=o.querySelector(".legend-title");e&&(e.textContent=t)}o.style.display="block"}}function a(){const t=e();t&&(t.style.display="none")}function n(e,o){const a=t();if(!a)return;const n=document.createElement("div");n.className="legend-item";const r=document.createElement("span");r.className="legend-swatch",r.style.background=e;const i=document.createElement("span");i.className="legend-label",i.textContent=o,n.appendChild(r),n.appendChild(i),a.appendChild(n)}function r(e,r={}){!function(){const e=t();e&&(e.innerHTML="")}();const l=r.title||"Leyenda",s=r.layerId||null,c=r.allowedValues?new Set(r.allowedValues):null,p=e&&e["fill-color"];if(!p)return a();if(Array.isArray(p)&&"step"===p[0]){const e=p,t=e[2],a=[];for(let t=3;t<e.length;t+=2){const o=e[t],n=e[t+1];"number"==typeof o&&"string"==typeof n&&a.push({stop:o,color:n})}if("cambio-poblacional-ageb"===s){o(l);return void[{color:t,label:"-100 – -16 %"},{color:a[0]?.color,label:"-16 – -8.8 %"},{color:a[1]?.color,label:"-8.8 – -2 %"},{color:a[2]?.color,label:"-2 – 7.5 %"},{color:a[3]?.color,label:"7.5 – 30.5 %"},{color:a[4]?.color,label:"30.5 – 82.5 %"},{color:a[5]?.color,label:"82.5 – 100 %"},{color:a[6]?.color,label:"100 – 101.9 %"},{color:a[7]?.color||a[a.length-1]?.color,label:"≥ 101.9 %"}].forEach(e=>{e.color&&e.label&&n(e.color,e.label)})}if(o(l),0===a.length)return void n(t,"Valor bajo");n(t,`< ${i(a[0].stop)} %`);for(let e=0;e<a.length;e++){const t=a[e].stop,o=e+1<a.length?a[e+1].stop:null;n(a[e].color,null==o?`≥ ${i(t)} %`:`${i(t)} – ${i(o)} %`)}return}if(Array.isArray(p)&&"match"===p[0]){const e=p,t=[];for(let o=2;o<e.length-1;o+=2){const a=e[o],n=e[o+1];if("number"!=typeof a&&"string"!=typeof a||"string"!=typeof n)break;c&&!c.has(a)||t.push({value:a,color:n})}if(t.length>0)return o(l),void t.forEach(e=>n(e.color,String(e.value)))}if("string"==typeof p)return o(l),void n(p,"Área destacada");a()}function i(e){try{return Number(e).toLocaleString("es-MX")}catch{return String(e)}}const l=showMapOverlay,s=hideMapOverlay,c={"crecimiento-urbano":"Expansión urbana por periodo","tasa-cambio-poblacional":"Tasa de cambio poblacional (2010–2020)","cambio-poblacional-ageb":"Cambio porcentual de población (2010–2020)","densidad-poblacional":"Densidad poblacional (hab/ha)","densidad-poblacional-distritos":"Densidad poblacional (hab/ha)","indice-marginacion-distritos":"Grado de marginación (GM 2020)","dimensiones-caminar":"Diversidad funcional caminable"};window.mapboxHelper.showMapOverlay=function(e){try{const e=document.getElementById("map-legend");if(e){const t=e.querySelector(".legend-items");t&&(t.innerHTML=""),e.style.display="none"}const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}l(e);try{const t=(e.layers||[]).some(e=>"crecimiento-urbano"===e.id);let o=null;for(const[t,a]of Object.entries(mapStepsConfig.stepConfigs))if(a===e){o=parseInt(t);break}const n=t&&4===o;if(toggleLustroPanel(n),n)applyLustroFilterWhenReady(),a();else{const t=["indice-marginacion-distritos","densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb"],o=e.layers||[];let n=null;for(const e of t){const t=o.find(t=>t.id===e);if(t){n=t;break}}if(n||(n=o.find(e=>"fill"===e.type&&e.paint&&e.paint["fill-color"])),n&&n.paint){const e=c[n.id]||"Leyenda";if("dimensiones-caminar"===n.id){const t=document.getElementById("map-legend");if(t){const o=t.querySelector(".legend-title"),a=t.querySelector(".legend-items");a&&(a.innerHTML=""),o&&(o.textContent=e),t.style.display="block";const r=(e,t)=>{const o=document.createElement("div");o.className="legend-item";const n=document.createElement("span");n.className="legend-swatch",n.style.background=e;const r=document.createElement("span");r.className="legend-label",r.textContent=t,o.appendChild(n),o.appendChild(r),a.appendChild(o)},i=n.paint["fill-color"],l=i[2],s=i[4],c=i[6],p=i[8],d=i[10],m=i[12];r(l,"0 Sin registros"),r(s,"1–300 Muy baja"),r(c,"301–700 Baja"),r(p,"701–1250 Media"),r(d,"1251–1900 Alta"),r(m,"1901+ Muy alta")}}else r(n.paint,{title:e,layerId:n.id})}else a()}}catch(e){console.warn("No se pudo construir la leyenda:",e),a()}},window.mapboxHelper.hideMapOverlay=function(){s();try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch(e){console.warn("Error ocultando leyendas:",e)}a(),toggleLustroPanel(!1)},window.mapboxLegend={buildFromPaint:(e,t)=>{try{r(e,t||{})}catch{}},hide:()=>{try{a()}catch{}},show:e=>{try{o(e)}catch{}}}}();