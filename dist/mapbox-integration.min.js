let mapboxMap=null,currentBaseStyle="mapbox://styles/mapbox/light-v10";const MAPBOX_DEBUG=!1,dbg=(...e)=>{false},LUSTROS=[1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],LUSTRO_COLORS={1980:"#E3F2FA",1985:"#CDEAF6",1990:"#B7E1F2",1995:"#A1D8EE",2e3:"#8ECAE6",2005:"#6FBAD8",2010:"#4BAAD0",2015:"#219EBC",2020:"#1A7D95",2025:"#023047"};let selectedLustros=new Set(LUSTROS);const mapboxAccessToken="pk.eyJ1IjoiMHhqZmVyIiwiYSI6ImNtZjRjNjczdTA0MGsya3Bwb3B3YWw4ejgifQ.8IZ5PTYktl5ss1gREda3fg",mapStepsConfig={visibleSteps:[19,25,31],stepConfigs:{19:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"cambio-poblacional-ageb",type:"fill",source:{type:"geojson",data:"public/data/cambio-poblacional.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","p100_dife_pob"]],0],"#f7fcf5",-16,"#e5f5e0",-8.8,"#c7e9c0",-2,"#a1d99b",7.5,"#74c476",30.5,"#41ab5d",82.5,"#238b45",100,"#006d2c",101.9,"#00441b"],"fill-opacity":.85,"fill-outline-color":"#ffffff"},popup:e=>{const o=Number(e.POBTOT||e.Pob2020||0),t=Number(e.Pob2010||0),a=Number(e.Dif_pob||o-t),n=Number(e.p100_dife_pob||(0!==t?(o-t)/t*100:0));return`<h3>AGEB ${e.CVE_AGEB||""}</h3>\n                                <p><strong>Población 2010:</strong> ${isFinite(t)?t.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Población 2020:</strong> ${isFinite(o)?o.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Diferencia absoluta:</strong> ${isFinite(a)?a.toLocaleString():"N/D"} hab.</p>\n                                <p><strong>Cambio porcentual:</strong> ${isFinite(n)?n.toFixed(1):"N/D"}%</p>`}}]},21:{center:[-86.8515,21.1619],zoom:11,pitch:20,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[]},25:{center:[-86.8515,21.1619],zoom:11,pitch:30,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"indice-marginacion-distritos",type:"fill",source:{type:"geojson",data:"public/data/indice-marginacion.geojson"},paint:{"fill-color":["match",["get","GM_2020"],"Muy alto","#5e0a26","Alto","#a11742","Medio","#d24d71","Bajo","#ee89a6","Muy bajo","#f9c2d1","#cccccc"],"fill-opacity":.8,"fill-outline-color":"#ffffff"},popup:e=>{const o=Number(e.POB_TOTAL||e.POBTOT||0),t=e.GM_2020||"N/D",a=Number(e.IM_2020||0);return`<h3>Área ${e.fid??""}</h3>\n                                <p><strong>Grado de marginación:</strong> ${t}</p>\n                                <p><strong>Índice de marginación (IM 2020):</strong> ${isFinite(a)?a.toFixed(2):"N/D"}</p>\n                                <p><strong>Población 2020:</strong> ${isFinite(o)?o.toLocaleString():"N/D"} habitantes</p>`}}]},31:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"dimensiones-caminar",type:"fill",source:{type:"geojson",data:"public/data/dimensiones-de-caminar.geojson"},paint:{"fill-color":["step",["+",["to-number",["get","Eval_D_abastecerse_cnt"]],["to-number",["get","Eval_aprender_cnt"]],["to-number",["get","Eval_D_circular_cnt"]],["to-number",["get","Eval_D_cuidados_cnt"]],["to-number",["get","Eval_D_disfrutar_cnt"]],["to-number",["get","Eval_D_reutil_reparar_cnt"]],["to-number",["get","Eval_D_trabajar_cnt"]]],"#f1faee",5,"#a8dadc",10,"#457b9d",20,"#1d3557",35,"#e63946"],"fill-opacity":.85,"fill-outline-color":"#ffffff"},popup:e=>{const o=Number(e.Eval_D_abastecerse_cnt||0),t=Number(e.Eval_aprender_cnt||0),a=Number(e.Eval_D_circular_cnt||0),n=Number(e.Eval_D_cuidados_cnt||0),r=Number(e.Eval_D_disfrutar_cnt||0),l=Number(e.Eval_D_reutil_reparar_cnt||0),i=Number(e.Eval_D_trabajar_cnt||0);return`<h3>Dimensiones de Caminar</h3>\n                            <p><strong>Total agregado:</strong> ${o+t+a+n+r+l+i}</p>\n                            <p><strong>Abastecerse:</strong> ${o}</p>\n                            <p><strong>Aprender:</strong> ${t}</p>\n                            <p><strong>Circular:</strong> ${a}</p>\n                            <p><strong>Cuidados:</strong> ${n}</p>\n                            <p><strong>Disfrutar:</strong> ${r}</p>\n                            <p><strong>Reutilizar/Reparar:</strong> ${l}</p>\n                            <p><strong>Trabajar:</strong> ${i}</p>`}}]}}};function initializeMapbox(){mapboxgl.accessToken=mapboxAccessToken;try{mapboxgl.setTelemetryEnabled&&mapboxgl.setTelemetryEnabled(!1)}catch(e){}const e=document.getElementById("map");if(!e)return void console.error("No se encontró el contenedor #map");e.style.display,e.style.visibility,e.style.opacity;e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.width="100vw",e.style.height="100vh",mapboxMap=new mapboxgl.Map({container:"map",style:currentBaseStyle,center:[-86.8515,21.1619],zoom:12,pitch:0,bearing:0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0});try{const e=console.error;console.error=function(...o){o.some(e=>"string"==typeof e&&e.includes("events.mapbox.com/events"))||e.apply(console,o)}}catch(e){}let o;mapboxMap.on("load",()=>{e.classList.remove("active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",setTimeout(()=>{mapboxMap&&mapboxMap.resize()},100),setTimeout(()=>{const e=mapboxMap.getStyle();e&&e.layers&&dbg(e.layers.length,e.layers.slice(0,5).map(e=>`${e.id} (${e.type})`))},500),document.dispatchEvent(new CustomEvent("mapbox-ready"))}),window.addEventListener("resize",()=>{clearTimeout(o),o=setTimeout(()=>{mapboxMap&&"block"===e.style.display&&mapboxMap.resize()},250)}),mapboxMap.addControl(new mapboxgl.NavigationControl,"top-right"),mapboxMap.addControl(new mapboxgl.FullscreenControl,"top-right")}function ensureProjDefs(){"undefined"==typeof proj4||proj4.defs["EPSG:32616"]||proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}function reprojectGeoJSONToWGS84(e){try{if(!e||"undefined"==typeof proj4)return e;const o=e.crs&&e.crs.properties&&e.crs.properties.name;if(!o)return e;const t=(o.match(/EPSG::(\d+)/)||[])[1]||(o.match(/EPSG:(\d+)/)||[])[1];if(!t)return e;let a=`EPSG:${t}`;if("EPSG:6371"===a&&(a="EPSG:32616"),"EPSG:4326"===a)return e;if(ensureProjDefs(),!proj4.defs[a]){if("EPSG:32616"!==a){console.warn("CRS no reconocido para reproyección:",a);const o=JSON.parse(JSON.stringify(e));return delete o.crs,o}proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}const n=proj4(a,"EPSG:4326"),r=e=>{const[o,t]=e,[a,r]=n.forward([o,t]);return[a,r]},l=(e,o)=>2===o?r(e):e.map(e=>l(e,o-1)),i=e=>{if(!e||!e.geometry)return e;const o=e.geometry;if(!o.coordinates)return e;let t;switch(o.type){case"Point":t=2;break;case"MultiPoint":case"LineString":t=3;break;case"MultiLineString":case"Polygon":t=4;break;case"MultiPolygon":t=5;break;case"GeometryCollection":return Array.isArray(o.geometries)&&(o.geometries=o.geometries.map(e=>({...e,coordinates:e.coordinates?l(e.coordinates,"Point"===e.type?2:"MultiPoint"===e.type||"LineString"===e.type?3:"MultiLineString"===e.type||"Polygon"===e.type?4:5):e.coordinates}))),e;default:return e}return o.coordinates=l(o.coordinates,t),e},s=JSON.parse(JSON.stringify(e)),c=e=>{if(!e||!e.type||null==e.coordinates)return!1;return Array.isArray(e.coordinates)&&e.coordinates.length>0};if("FeatureCollection"===s.type)s.features=s.features.map(i).filter(e=>e&&e.geometry&&c(e.geometry));else if("Feature"===s.type&&(i(s),!c(s.geometry)))return{type:"FeatureCollection",features:[]};return delete s.crs,s}catch(o){return console.warn("Fallo al reproyectar GeoJSON, usando datos originales:",o),e}}async function loadGeoJSONWithReprojection(e){const o=e.includes("?")?"&":"?",t=`${e}${o}v=${Date.now()}`,a=await fetch(t,{cache:"no-store"});return reprojectGeoJSONToWGS84(await a.json())}function showMapOverlay(e){const o=document.getElementById("map");if(!o)return void console.error("❌ No se encontró el contenedor #map");if(!mapboxMap)return void console.error("❌ mapboxMap no está inicializado");o.style.display="block",o.style.opacity="1",o.style.visibility="visible",o.style.zIndex="1000",o.style.backgroundColor="",o.classList.add("active");const t=o.querySelector(".mapboxgl-canvas");t?t.style.opacity="1":console.warn("⚠️ No se encontró el canvas del mapa");const a=o.querySelector(".mapboxgl-canvas-container");a&&(a.style.opacity="1"),mapboxMap&&mapboxMap.resize(),o._wheelForwardHandler||(o._wheelForwardHandler=function(e){try{e.preventDefault(),e.stopPropagation()}catch(e){}const o=e.deltaY||0;window.scrollBy(0,o)}),o.addEventListener("wheel",o._wheelForwardHandler,{passive:!1,capture:!0}),addKeyboardScrollSupport();try{mapboxMap.scrollZoom.disable()}catch(e){}setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},100),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},300),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),dbg())},600);const n=async()=>{["densidad-poblacional","densidad-poblacional-distritos","indice-marginacion-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb","supermanzanas-iniciales","crecimiento-urbano","dimensiones-caminar"].forEach(e=>{mapboxMap.getLayer(e)&&mapboxMap.removeLayer(e)});["densidad-poblacional-src","densidad-poblacional-distritos-src","indice-marginacion-distritos-src","tasa-cambio-poblacional-src","cambio-poblacional-ageb-src","supermanzanas-iniciales-src","crecimiento-urbano-src","dimensiones-caminar-src"].forEach(e=>{mapboxMap.getSource(e)&&mapboxMap.removeSource(e)});const o=(()=>{try{const e=mapboxMap.getStyle();if(!e||!e.layers)return null;const o=e.layers.find(e=>"symbol"===e.type);return o?o.id:null}catch{return null}})();if(e.layers&&e.layers.length>0)for(const t of e.layers)try{const e=t.id+"-src";let a={...t.source};if("geojson"===a.type&&"string"==typeof a.data){if(a.data.toLowerCase().endsWith(".gpkg")){console.warn(`⛔ Formato GPKG no soportado para ${t.id}. Omite esta capa hasta convertir a GeoJSON.`);continue}if(a.data.toLowerCase().endsWith(".geojson"))try{const e=await loadGeoJSONWithReprojection(a.data);a={...a,data:e}}catch(e){console.warn("⚠️ No se pudo cargar/reproyectar",a.data,e)}}mapboxMap.getSource(e)?dbg():mapboxMap.addSource(e,a);const n={...t.paint},r={id:t.id,type:t.type,source:e,paint:n};if(mapboxMap.getLayer(t.id)?dbg(t.id):o?mapboxMap.addLayer(r,o):mapboxMap.addLayer(r),t.popup){let e=null;mapboxMap.on("mousemove",t.id,o=>{e&&e.remove();const a=o.features[0].properties,n=t.popup(a);e=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}).setLngLat(o.lngLat).setHTML(n).addTo(mapboxMap)}),mapboxMap.on("mouseenter",t.id,()=>{mapboxMap.getCanvas().style.cursor="pointer"}),mapboxMap.on("mouseleave",t.id,()=>{mapboxMap.getCanvas().style.cursor="",e&&(e.remove(),e=null)})}}catch(e){console.error(`❌ Error añadiendo capa ${t.id}:`,e)}else dbg();setTimeout(()=>{mapboxMap&&mapboxMap.resize()},500)},r=e.style||currentBaseStyle;r!==currentBaseStyle?(mapboxMap.once("style.load",n),mapboxMap.setStyle(r),currentBaseStyle=r):mapboxMap.isStyleLoaded&&mapboxMap.isStyleLoaded()?n():mapboxMap.once("style.load",n),mapboxMap.flyTo({center:e.center,zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,duration:2e3,essential:!0}),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},1e3),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},2500),dbg()}function hideMapOverlay(){const e=document.getElementById("map");if(e){e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.classList.remove("active");e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove()),e._wheelForwardHandler&&e.removeEventListener("wheel",e._wheelForwardHandler,{capture:!0})}else console.error("❌ No se encontró el contenedor #map para ocultar");try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const o=document.getElementById("map-lustro-control");o&&(o.style.display="none")}catch(e){console.warn("Error en limpieza de leyendas:",e)}}async function updateMapForStep(e){try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const o=document.getElementById("map-lustro-control");o&&(o.style.display="none"),dbg()}catch{}const o=String(e);mapStepsConfig.visibleSteps.includes(Number(e))&&mapStepsConfig.stepConfigs[o]?(await ensureMapboxReady(),window.mapboxHelper&&"function"==typeof window.mapboxHelper.showMapOverlay?window.mapboxHelper.showMapOverlay(mapStepsConfig.stepConfigs[o]):showMapOverlay(mapStepsConfig.stepConfigs[o])):window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay?window.mapboxHelper.hideMapOverlay():hideMapOverlay()}function createScrollZones(e){e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove());const o=document.createElement("div");o.className="map-scroll-zone top",o.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(o);const t=document.createElement("div");t.className="map-scroll-zone bottom",t.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(t)}function handleScrollZoneWheel(e){e.preventDefault(),e.stopPropagation();const o=e.deltaY;window.scrollBy(0,o)}function addKeyboardScrollSupport(){document.addEventListener("keydown",function(e){const o=document.getElementById("map");o&&"none"!==o.style.display&&("ArrowDown"===e.key||"PageDown"===e.key?(e.preventDefault(),window.scrollBy(0,100)):"ArrowUp"===e.key||"PageUp"===e.key?(e.preventDefault(),window.scrollBy(0,-100)):"Home"===e.key?(e.preventDefault(),window.scrollTo(0,0)):"End"===e.key&&(e.preventDefault(),window.scrollTo(0,document.body.scrollHeight)))})}let mapInitPromise=null;async function ensureMapboxReady(){return!!mapboxMap||(mapInitPromise||(mapInitPromise=new Promise(e=>{if("undefined"!=typeof mapboxgl){initializeMapbox();const o=()=>{document.removeEventListener("mapbox-ready",o),e(!0)};return void document.addEventListener("mapbox-ready",o)}const o=document.createElement("script");o.src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js",o.async=!0,o.onload=()=>{initializeMapbox();const o=()=>{document.removeEventListener("mapbox-ready",o),e(!0)};document.addEventListener("mapbox-ready",o)},o.onerror=()=>{console.error("❌ No se pudo cargar Mapbox GL"),e(!1)},document.head.appendChild(o)})),mapInitPromise)}function ensureLustroPanel(){if(document.getElementById("map-lustro-control"))return;const e=document.createElement("div");e.id="map-lustro-control",e.style.position="fixed",e.style.zIndex="2000",e.style.background="rgba(255,255,255,0.96)",e.style.color="#222",e.style.borderRadius="8px",e.style.boxShadow="0 6px 18px rgba(0,0,0,0.18)",e.style.padding="10px 12px",e.style.minWidth="220px",e.style.pointerEvents="auto",e.style.display="none";const o=document.createElement("div");o.className="lustro-title",o.textContent="Expansión urbana por periodo",o.style.fontWeight="700",o.style.fontSize="13px",o.style.marginBottom="8px",e.appendChild(o);const t=document.createElement("div");t.className="lustro-list",t.style.display="grid",t.style.gridTemplateColumns="repeat(2, minmax(100px, 1fr))",t.style.gap="6px 12px",LUSTROS.forEach(e=>{const o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.gap="6px";const a=document.createElement("input");a.type="checkbox",a.value=String(e),a.checked=!0,a.addEventListener("change",()=>{a.checked?selectedLustros.add(Number(a.value)):selectedLustros.delete(Number(a.value)),applyLustroFilterWhenReady()});const n=document.createElement("span");n.style.width="14px",n.style.height="10px",n.style.borderRadius="2px",n.style.border="1px solid rgba(0,0,0,0.2)",n.style.display="inline-block",n.style.background=LUSTRO_COLORS[e];const r=document.createElement("span");r.textContent=String(e),o.appendChild(a),o.appendChild(n),o.appendChild(r),t.appendChild(o)}),e.appendChild(t),document.body.appendChild(e)}function toggleLustroPanel(e){ensureLustroPanel();const o=document.getElementById("map-lustro-control");o&&(o.style.display=e?"block":"none",e?(positionLustroPanel(),window.addEventListener("resize",positionLustroPanel)):window.removeEventListener("resize",positionLustroPanel))}function positionLustroPanel(){const e=document.getElementById("map-lustro-control");if(!e||"none"===e.style.display)return;document.getElementById("map-legend");const o=e.style.visibility,t=e.style.display;"none"===t&&(e.style.visibility="hidden",e.style.display="block");const a=e.getBoundingClientRect(),n=(a.width,a.height,Math.max(document.documentElement.clientWidth,window.innerWidth||0)),r=(Math.max(document.documentElement.clientHeight,window.innerHeight||0),n<=640);e.style.right="14px",e.style.left="",e.style.top="",e.style.bottom="14px",e.style.minWidth=r?"190px":"240px",e.style.padding=r?"6px 8px":"10px 12px",e.style.maxHeight=r?"40vh":"60vh",e.style.overflowY="auto";const l=e.querySelector(".lustro-title");l&&(l.style.fontSize=r?"12px":"13px",l.style.marginBottom=r?"6px":"8px");const i=e.querySelector(".lustro-list");i&&(i.style.gridTemplateColumns=r?"repeat(2, minmax(90px, 1fr))":"repeat(1, minmax(140px, 1fr))",i.style.gap=r?"4px 8px":"6px 12px",Array.from(i.children).forEach(e=>{if(!(e instanceof HTMLElement))return;e.style.gap=r?"4px":"6px";const o=e.querySelector('input[type="checkbox"]');o&&(o.style.transform=r?"scale(0.9)":"scale(1)");const t=e.querySelector("span");t&&(t.style.width=r?"12px":"14px",t.style.height=r?"8px":"10px");const a=e.querySelector("span + span");a&&(a.style.fontSize=r?"12px":"13px")})),"none"===t&&(e.style.display="none",e.style.visibility=o||"visible")}function applyLustroFilter(){if(!mapboxMap)return;const e="crecimiento-urbano";if(!mapboxMap.getLayer||!mapboxMap.getLayer(e))return;const o=Array.from(selectedLustros);if(0===o.length){try{mapboxMap.setLayoutProperty(e,"visibility","none")}catch{}const o=document.getElementById("map-legend");o&&(o.style.display="none");try{mapboxMap.setFilter(e,null)}catch{}return}try{mapboxMap.setLayoutProperty(e,"visibility","visible")}catch{}const t=["match",["to-number",["get","LUSTRO"]]];o.forEach(e=>{t.push(e,!0)}),t.push(!1),mapboxMap.setFilter(e,t);try{console.debug("Filtro aplicado a crecimiento-urbano:",JSON.stringify(t))}catch{}}function applyLustroFilterWhenReady(e=0){if(!mapboxMap)return;if(mapboxMap.getLayer&&mapboxMap.getLayer("crecimiento-urbano"))applyLustroFilter();else if(!(e>10)){setTimeout(()=>applyLustroFilterWhenReady(e+1),150);try{mapboxMap.once&&mapboxMap.once("idle",()=>applyLustroFilter())}catch{}}}window.mapboxHelper={updateMapForStep:updateMapForStep,showMapOverlay:showMapOverlay,hideMapOverlay:hideMapOverlay},function(){const e=()=>document.getElementById("map-legend"),o=()=>e()?e().querySelector(".legend-items"):null;function t(o){const t=e();if(t){if(o){const e=t.querySelector(".legend-title");e&&(e.textContent=o)}t.style.display="block"}}function a(){const o=e();o&&(o.style.display="none")}function n(e,t){const a=o();if(!a)return;const n=document.createElement("div");n.className="legend-item";const r=document.createElement("span");r.className="legend-swatch",r.style.background=e;const l=document.createElement("span");l.className="legend-label",l.textContent=t,n.appendChild(r),n.appendChild(l),a.appendChild(n)}function r(e,r={}){!function(){const e=o();e&&(e.innerHTML="")}();const i=r.title||"Leyenda",s=r.layerId||null,c=r.allowedValues?new Set(r.allowedValues):null,p=e&&e["fill-color"];if(!p)return a();if(Array.isArray(p)&&"step"===p[0]){const e=p,o=e[2],a=[];for(let o=3;o<e.length;o+=2){const t=e[o],n=e[o+1];"number"==typeof t&&"string"==typeof n&&a.push({stop:t,color:n})}if("cambio-poblacional-ageb"===s){t(i);return void[{color:o,label:"-100 – -16 %"},{color:a[0]?.color,label:"-16 – -8.8 %"},{color:a[1]?.color,label:"-8.8 – -2 %"},{color:a[2]?.color,label:"-2 – 7.5 %"},{color:a[3]?.color,label:"7.5 – 30.5 %"},{color:a[4]?.color,label:"30.5 – 82.5 %"},{color:a[5]?.color,label:"82.5 – 100 %"},{color:a[6]?.color,label:"100 – 101.9 %"},{color:a[7]?.color||a[a.length-1]?.color,label:"≥ 101.9 %"}].forEach(e=>{e.color&&e.label&&n(e.color,e.label)})}if(t(i),0===a.length)return void n(o,"Valor bajo");n(o,`< ${l(a[0].stop)} %`);for(let e=0;e<a.length;e++){const o=a[e].stop,t=e+1<a.length?a[e+1].stop:null;n(a[e].color,null==t?`≥ ${l(o)} %`:`${l(o)} – ${l(t)} %`)}return}if(Array.isArray(p)&&"match"===p[0]){const e=p,o=[];for(let t=2;t<e.length-1;t+=2){const a=e[t],n=e[t+1];if("number"!=typeof a&&"string"!=typeof a||"string"!=typeof n)break;c&&!c.has(a)||o.push({value:a,color:n})}if(o.length>0)return t(i),void o.forEach(e=>n(e.color,String(e.value)))}if("string"==typeof p)return t(i),void n(p,"Área destacada");a()}function l(e){try{return Number(e).toLocaleString("es-MX")}catch{return String(e)}}const i=showMapOverlay,s=hideMapOverlay,c={"crecimiento-urbano":"Expansión urbana por periodo","tasa-cambio-poblacional":"Tasa de cambio poblacional (2010–2020)","cambio-poblacional-ageb":"Cambio porcentual de población (2010–2020)","densidad-poblacional":"Densidad poblacional (hab/ha)","densidad-poblacional-distritos":"Densidad poblacional (hab/ha)","indice-marginacion-distritos":"Grado de marginación (GM 2020)","dimensiones-caminar":"Diversidad funcional caminable"};window.mapboxHelper.showMapOverlay=function(e){try{const e=document.getElementById("map-legend");if(e){const o=e.querySelector(".legend-items");o&&(o.innerHTML=""),e.style.display="none"}const o=document.getElementById("map-lustro-control");o&&(o.style.display="none")}catch{}i(e);try{const o=(e.layers||[]).some(e=>"crecimiento-urbano"===e.id);let t=null;for(const[o,a]of Object.entries(mapStepsConfig.stepConfigs))if(a===e){t=parseInt(o);break}const n=o&&4===t;if(toggleLustroPanel(n),n)applyLustroFilterWhenReady(),a();else{const o=["indice-marginacion-distritos","densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb"],t=e.layers||[];let n=null;for(const e of o){const o=t.find(o=>o.id===e);if(o){n=o;break}}if(n||(n=t.find(e=>"fill"===e.type&&e.paint&&e.paint["fill-color"])),n&&n.paint){const e=c[n.id]||"Leyenda";r(n.paint,{title:e,layerId:n.id})}else a()}}catch(e){console.warn("No se pudo construir la leyenda:",e),a()}},window.mapboxHelper.hideMapOverlay=function(){s();try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const o=document.getElementById("map-lustro-control");o&&(o.style.display="none")}catch(e){console.warn("Error ocultando leyendas:",e)}a(),toggleLustroPanel(!1)},window.mapboxLegend={buildFromPaint:(e,o)=>{try{r(e,o||{})}catch{}},hide:()=>{try{a()}catch{}},show:e=>{try{t(e)}catch{}}}}();