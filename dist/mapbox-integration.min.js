let mapboxMap=null,currentBaseStyle="mapbox://styles/mapbox/light-v10";const LUSTROS=[1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],LUSTRO_COLORS={1980:"#E3F2FA",1985:"#CDEAF6",1990:"#B7E1F2",1995:"#A1D8EE",2e3:"#8ECAE6",2005:"#6FBAD8",2010:"#4BAAD0",2015:"#219EBC",2020:"#1A7D95",2025:"#023047"};let selectedLustros=new Set(LUSTROS);const mapboxAccessToken="pk.eyJ1IjoiMHhqZmVyIiwiYSI6ImNtZjRjNjczdTA0MGsya3Bwb3B3YWw4ejgifQ.8IZ5PTYktl5ss1gREda3fg",mapStepsConfig={visibleSteps:[19,25],stepConfigs:{19:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"cambio-poblacional-ageb",type:"fill",source:{type:"geojson",data:"public/data/tasa-de-cambio-poblacional-por-AGEB.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","pobtot"]],0],"#f7f4f9",100,"#e7e1ef",500,"#d4b9da",1e3,"#c994c7",5e3,"#df65b0",1e4,"#e7298a",5e4,"#ce1256",1e5,"#91003f"],"fill-opacity":.8,"fill-outline-color":"#ffffff"},popup:e=>`<h3>AGEB</h3>\n                                <p><strong>Población total:</strong> ${(e.pobtot||0).toLocaleString()} habitantes</p>\n                                <p><strong>Supermanzana:</strong> ${e.supermanzana||"N/A"}</p>`}]},21:{center:[-86.8515,21.1619],zoom:11,pitch:20,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[]},25:{center:[-86.8515,21.1619],zoom:11,pitch:30,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"densidad-poblacional-distritos",type:"fill",source:{type:"geojson",data:"public/data/densidad-poblacional-por-distrito.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","DEN_HAB_HA"]],0],"#f1faee",10,"#a8dadc",30,"#457b9d",60,"#1d3557",100,"#e63946"],"fill-opacity":.8,"fill-outline-color":"#555"},popup:e=>{const t=Number(e.POBTOT||0),o=Number(e.DEN_HAB_HA||0),a=Number(e.SUPERFICIE_HA||0);return`<h3>Distrito ${e.fid??""}</h3>\n                                <p>Población: ${isFinite(t)?t.toLocaleString():"N/D"} habitantes</p>\n                                <p>Densidad: ${isFinite(o)?o.toFixed(1):"N/D"} hab/ha</p>\n                                <p>Superficie: ${isFinite(a)?a.toFixed(1):"N/D"} hectáreas</p>`}}]}}};function initializeMapbox(){mapboxgl.accessToken=mapboxAccessToken;const e=document.getElementById("map");if(!e)return void console.error("No se encontró el contenedor #map");e.style.display,e.style.visibility,e.style.opacity;let t;e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.width="100vw",e.style.height="100vh",mapboxMap=new mapboxgl.Map({container:"map",style:currentBaseStyle,center:[-86.8515,21.1619],zoom:12,pitch:0,bearing:0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0}),mapboxMap.on("styledata",()=>{}),mapboxMap.on("style.load",()=>{}),mapboxMap.on("error",e=>{console.error("❌ Error en Mapbox:",e.error)}),mapboxMap.on("load",()=>{e.classList.remove("active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",setTimeout(()=>{mapboxMap&&mapboxMap.resize()},100),setTimeout(()=>{const e=mapboxMap.getStyle();e&&e.layers&&(e.layers.length,e.layers.slice(0,5).map(e=>`${e.id} (${e.type})`))},500),document.dispatchEvent(new CustomEvent("mapbox-ready"))}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{mapboxMap&&"block"===e.style.display&&mapboxMap.resize()},250)}),mapboxMap.addControl(new mapboxgl.NavigationControl,"top-right"),mapboxMap.addControl(new mapboxgl.FullscreenControl,"top-right")}function ensureProjDefs(){"undefined"==typeof proj4||proj4.defs["EPSG:32616"]||proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}function reprojectGeoJSONToWGS84(e){try{if(!e||"undefined"==typeof proj4)return e;const t=e.crs&&e.crs.properties&&e.crs.properties.name;if(!t)return e;const o=(t.match(/EPSG::(\d+)/)||[])[1]||(t.match(/EPSG:(\d+)/)||[])[1];if(!o)return e;let a=`EPSG:${o}`;if("EPSG:6371"===a&&(a="EPSG:32616"),"EPSG:4326"===a)return e;if(ensureProjDefs(),!proj4.defs[a]){if("EPSG:32616"!==a){console.warn("CRS no reconocido para reproyección:",a);const t=JSON.parse(JSON.stringify(e));return delete t.crs,t}proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}const n=proj4(a,"EPSG:4326"),l=e=>{const[t,o]=e,[a,l]=n.forward([t,o]);return[a,l]},r=(e,t)=>2===t?l(e):e.map(e=>r(e,t-1)),s=e=>{if(!e||!e.geometry)return e;const t=e.geometry;if(!t.coordinates)return e;let o;switch(t.type){case"Point":o=2;break;case"MultiPoint":case"LineString":o=3;break;case"MultiLineString":case"Polygon":o=4;break;case"MultiPolygon":o=5;break;case"GeometryCollection":return Array.isArray(t.geometries)&&(t.geometries=t.geometries.map(e=>({...e,coordinates:e.coordinates?r(e.coordinates,"Point"===e.type?2:"MultiPoint"===e.type||"LineString"===e.type?3:"MultiLineString"===e.type||"Polygon"===e.type?4:5):e.coordinates}))),e;default:return e}return t.coordinates=r(t.coordinates,o),e},i=JSON.parse(JSON.stringify(e)),p=e=>{if(!e||!e.type||null==e.coordinates)return!1;return Array.isArray(e.coordinates)&&e.coordinates.length>0};if("FeatureCollection"===i.type)i.features=i.features.map(s).filter(e=>e&&e.geometry&&p(e.geometry));else if("Feature"===i.type&&(s(i),!p(i.geometry)))return{type:"FeatureCollection",features:[]};return delete i.crs,i}catch(t){return console.warn("Fallo al reproyectar GeoJSON, usando datos originales:",t),e}}async function loadGeoJSONWithReprojection(e){const t=e.includes("?")?"&":"?",o=`${e}${t}v=${Date.now()}`,a=await fetch(o,{cache:"no-store"});return reprojectGeoJSONToWGS84(await a.json())}function showMapOverlay(e){const t=document.getElementById("map");if(!t)return void console.error("❌ No se encontró el contenedor #map");if(!mapboxMap)return void console.error("❌ mapboxMap no está inicializado");t.style.display="block",t.style.opacity="1",t.style.visibility="visible",t.style.zIndex="1000",t.style.backgroundColor="",t.classList.add("active");const o=t.querySelector(".mapboxgl-canvas");o?o.style.opacity="1":console.warn("⚠️ No se encontró el canvas del mapa");const a=t.querySelector(".mapboxgl-canvas-container");a&&(a.style.opacity="1"),t.style.display,t.style.opacity,t.style.visibility,t.style.zIndex,mapboxMap&&mapboxMap.resize(),t._wheelForwardHandler||(t._wheelForwardHandler=function(e){try{e.preventDefault(),e.stopPropagation()}catch(e){}const t=e.deltaY||0;window.scrollBy(0,t)}),t.addEventListener("wheel",t._wheelForwardHandler,{passive:!1,capture:!0}),addKeyboardScrollSupport();try{mapboxMap.scrollZoom.disable()}catch(e){}setTimeout(()=>{mapboxMap&&mapboxMap.resize()},100),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},300),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},600);const n=async()=>{["densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb","supermanzanas-iniciales","crecimiento-urbano"].forEach(e=>{mapboxMap.getLayer(e)&&mapboxMap.removeLayer(e)});["densidad-poblacional-src","densidad-poblacional-distritos-src","tasa-cambio-poblacional-src","cambio-poblacional-ageb-src","supermanzanas-iniciales-src","crecimiento-urbano-src"].forEach(e=>{mapboxMap.getSource(e)&&mapboxMap.removeSource(e)});const t=(()=>{try{const e=mapboxMap.getStyle();if(!e||!e.layers)return null;const t=e.layers.find(e=>"symbol"===e.type);return t?t.id:null}catch{return null}})();if(e.layers&&e.layers.length>0){e.layers.length;for(const o of e.layers)try{const e=o.id+"-src";let a={...o.source};if("geojson"===a.type&&"string"==typeof a.data){if(a.data.toLowerCase().endsWith(".gpkg")){console.warn(`⛔ Formato GPKG no soportado para ${o.id}. Omite esta capa hasta convertir a GeoJSON.`);continue}o.id,a.data;const e=await loadGeoJSONWithReprojection(a.data);a={...a,data:e}}mapboxMap.addSource(e,a);const n={...o.paint},l={id:o.id,type:o.type,source:e,paint:n};if(t?mapboxMap.addLayer(l,t):mapboxMap.addLayer(l),o.popup){let e=null;mapboxMap.on("mousemove",o.id,t=>{e&&e.remove();const a=t.features[0].properties,n=o.popup(a);e=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}).setLngLat(t.lngLat).setHTML(n).addTo(mapboxMap)}),mapboxMap.on("mouseenter",o.id,()=>{mapboxMap.getCanvas().style.cursor="pointer"}),mapboxMap.on("mouseleave",o.id,()=>{mapboxMap.getCanvas().style.cursor="",e&&(e.remove(),e=null)})}o.id}catch(e){console.error(`❌ Error añadiendo capa ${o.id}:`,e)}}setTimeout(()=>{mapboxMap&&mapboxMap.resize()},500)},l=e.style||currentBaseStyle;l!==currentBaseStyle?(mapboxMap.once("style.load",n),mapboxMap.setStyle(l),currentBaseStyle=l):mapboxMap.isStyleLoaded&&mapboxMap.isStyleLoaded()?n():mapboxMap.once("style.load",n),mapboxMap.flyTo({center:e.center,zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,duration:2e3,essential:!0}),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},1e3),setTimeout(()=>{mapboxMap&&mapboxMap.resize()},2500)}function hideMapOverlay(){const e=document.getElementById("map");if(e){e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.classList.remove("active");e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove()),e._wheelForwardHandler&&e.removeEventListener("wheel",e._wheelForwardHandler,{capture:!0})}else console.error("❌ No se encontró el contenedor #map para ocultar");try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch(e){console.warn("Error en limpieza de leyendas:",e)}}async function updateMapForStep(e){try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}const t=String(e);mapStepsConfig.visibleSteps,mapStepsConfig.visibleSteps.includes(Number(e)),mapStepsConfig.stepConfigs[t],mapStepsConfig.visibleSteps.includes(Number(e))&&mapStepsConfig.stepConfigs[t]?(await ensureMapboxReady(),window.mapboxHelper&&"function"==typeof window.mapboxHelper.showMapOverlay?window.mapboxHelper.showMapOverlay(mapStepsConfig.stepConfigs[t]):showMapOverlay(mapStepsConfig.stepConfigs[t])):window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay?window.mapboxHelper.hideMapOverlay():hideMapOverlay()}function createScrollZones(e){e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove());const t=document.createElement("div");t.className="map-scroll-zone top",t.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(t);const o=document.createElement("div");o.className="map-scroll-zone bottom",o.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(o)}function handleScrollZoneWheel(e){e.preventDefault(),e.stopPropagation();const t=e.deltaY;window.scrollBy(0,t)}function addKeyboardScrollSupport(){document.addEventListener("keydown",function(e){const t=document.getElementById("map");t&&"none"!==t.style.display&&("ArrowDown"===e.key||"PageDown"===e.key?(e.preventDefault(),window.scrollBy(0,100)):"ArrowUp"===e.key||"PageUp"===e.key?(e.preventDefault(),window.scrollBy(0,-100)):"Home"===e.key?(e.preventDefault(),window.scrollTo(0,0)):"End"===e.key&&(e.preventDefault(),window.scrollTo(0,document.body.scrollHeight)))})}let mapInitPromise=null;async function ensureMapboxReady(){return!!mapboxMap||(mapInitPromise||(mapInitPromise=new Promise(e=>{if("undefined"!=typeof mapboxgl){initializeMapbox();const t=()=>{document.removeEventListener("mapbox-ready",t),e(!0)};return void document.addEventListener("mapbox-ready",t)}const t=document.createElement("script");t.src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js",t.async=!0,t.onload=()=>{initializeMapbox();const t=()=>{document.removeEventListener("mapbox-ready",t),e(!0)};document.addEventListener("mapbox-ready",t)},t.onerror=()=>{console.error("❌ No se pudo cargar Mapbox GL"),e(!1)},document.head.appendChild(t)})),mapInitPromise)}function ensureLustroPanel(){if(document.getElementById("map-lustro-control"))return;const e=document.createElement("div");e.id="map-lustro-control",e.style.position="fixed",e.style.zIndex="2000",e.style.background="rgba(255,255,255,0.96)",e.style.color="#222",e.style.borderRadius="8px",e.style.boxShadow="0 6px 18px rgba(0,0,0,0.18)",e.style.padding="10px 12px",e.style.minWidth="220px",e.style.pointerEvents="auto",e.style.display="none";const t=document.createElement("div");t.className="lustro-title",t.textContent="Expansión urbana por periodo",t.style.fontWeight="700",t.style.fontSize="13px",t.style.marginBottom="8px",e.appendChild(t);const o=document.createElement("div");o.className="lustro-list",o.style.display="grid",o.style.gridTemplateColumns="repeat(2, minmax(100px, 1fr))",o.style.gap="6px 12px",LUSTROS.forEach(e=>{const t=document.createElement("label");t.style.display="flex",t.style.alignItems="center",t.style.gap="6px";const a=document.createElement("input");a.type="checkbox",a.value=String(e),a.checked=!0,a.addEventListener("change",()=>{a.checked?selectedLustros.add(Number(a.value)):selectedLustros.delete(Number(a.value)),applyLustroFilterWhenReady()});const n=document.createElement("span");n.style.width="14px",n.style.height="10px",n.style.borderRadius="2px",n.style.border="1px solid rgba(0,0,0,0.2)",n.style.display="inline-block",n.style.background=LUSTRO_COLORS[e];const l=document.createElement("span");l.textContent=String(e),t.appendChild(a),t.appendChild(n),t.appendChild(l),o.appendChild(t)}),e.appendChild(o),document.body.appendChild(e)}function toggleLustroPanel(e){ensureLustroPanel();const t=document.getElementById("map-lustro-control");t&&(t.style.display=e?"block":"none",t.style.display,e?(positionLustroPanel(),window.addEventListener("resize",positionLustroPanel)):window.removeEventListener("resize",positionLustroPanel))}function positionLustroPanel(){const e=document.getElementById("map-lustro-control");if(!e||"none"===e.style.display)return;document.getElementById("map-legend");const t=e.style.visibility,o=e.style.display;"none"===o&&(e.style.visibility="hidden",e.style.display="block");const a=e.getBoundingClientRect(),n=(a.width,a.height,Math.max(document.documentElement.clientWidth,window.innerWidth||0)),l=(Math.max(document.documentElement.clientHeight,window.innerHeight||0),n<=640);e.style.right="14px",e.style.left="",e.style.top="",e.style.bottom="14px",e.style.minWidth=l?"190px":"240px",e.style.padding=l?"6px 8px":"10px 12px",e.style.maxHeight=l?"40vh":"60vh",e.style.overflowY="auto";const r=e.querySelector(".lustro-title");r&&(r.style.fontSize=l?"12px":"13px",r.style.marginBottom=l?"6px":"8px");const s=e.querySelector(".lustro-list");s&&(s.style.gridTemplateColumns=l?"repeat(2, minmax(90px, 1fr))":"repeat(1, minmax(140px, 1fr))",s.style.gap=l?"4px 8px":"6px 12px",Array.from(s.children).forEach(e=>{if(!(e instanceof HTMLElement))return;e.style.gap=l?"4px":"6px";const t=e.querySelector('input[type="checkbox"]');t&&(t.style.transform=l?"scale(0.9)":"scale(1)");const o=e.querySelector("span");o&&(o.style.width=l?"12px":"14px",o.style.height=l?"8px":"10px");const a=e.querySelector("span + span");a&&(a.style.fontSize=l?"12px":"13px")})),"none"===o&&(e.style.display="none",e.style.visibility=t||"visible")}function applyLustroFilter(){if(!mapboxMap)return;const e="crecimiento-urbano";if(!mapboxMap.getLayer||!mapboxMap.getLayer(e))return;const t=Array.from(selectedLustros);if(0===t.length){try{mapboxMap.setLayoutProperty(e,"visibility","none")}catch{}const t=document.getElementById("map-legend");t&&(t.style.display="none");try{mapboxMap.setFilter(e,null)}catch{}return}try{mapboxMap.setLayoutProperty(e,"visibility","visible")}catch{}const o=["match",["to-number",["get","LUSTRO"]]];t.forEach(e=>{o.push(e,!0)}),o.push(!1),mapboxMap.setFilter(e,o);try{console.debug("Filtro aplicado a crecimiento-urbano:",JSON.stringify(o))}catch{}}function applyLustroFilterWhenReady(e=0){if(!mapboxMap)return;if(mapboxMap.getLayer&&mapboxMap.getLayer("crecimiento-urbano"))applyLustroFilter();else if(!(e>10)){setTimeout(()=>applyLustroFilterWhenReady(e+1),150);try{mapboxMap.once&&mapboxMap.once("idle",()=>applyLustroFilter())}catch{}}}window.mapboxHelper={updateMapForStep:updateMapForStep,showMapOverlay:showMapOverlay,hideMapOverlay:hideMapOverlay},function(){const e=()=>document.getElementById("map-legend"),t=()=>e()?e().querySelector(".legend-items"):null;function o(t){const o=e();if(o){if(t){const e=o.querySelector(".legend-title");e&&(e.textContent=t)}o.style.display="block",o.style.display}}function a(){const t=e();t&&(t.style.display="none")}function n(e,o){const a=t();if(!a)return;const n=document.createElement("div");n.className="legend-item";const l=document.createElement("span");l.className="legend-swatch",l.style.background=e;const r=document.createElement("span");r.className="legend-label",r.textContent=o,n.appendChild(l),n.appendChild(r),a.appendChild(n)}function l(e,l={}){!function(){const e=t();e&&(e.innerHTML="")}();const s=l.title||"Leyenda",i=l.allowedValues?new Set(l.allowedValues):null,p=e&&e["fill-color"];if(!p)return a();if(Array.isArray(p)&&"step"===p[0]){const e=p,t=e[2],a=[];for(let t=3;t<e.length;t+=2){const o=e[t],n=e[t+1];"number"==typeof o&&"string"==typeof n&&a.push({stop:o,color:n})}if(o(s),0===a.length)return void n(t,"Valor bajo");n(t,`< ${r(a[0].stop)}`);for(let e=0;e<a.length;e++){const t=a[e].stop,o=e+1<a.length?a[e+1].stop:null;n(a[e].color,null==o?`≥ ${r(t)}`:`${r(t)} – ${r(o)}`)}return}if(Array.isArray(p)&&"match"===p[0]){const e=p,t=[];for(let o=2;o<e.length-1;o+=2){const a=e[o],n=e[o+1];if("number"!=typeof a&&"string"!=typeof a||"string"!=typeof n)break;i&&!i.has(a)||t.push({value:a,color:n})}if(t.length>0)return o(s),void t.forEach(e=>n(e.color,String(e.value)))}if("string"==typeof p)return o(s),void n(p,"Área destacada");a()}function r(e){try{return Number(e).toLocaleString("es-MX")}catch{return String(e)}}const s=showMapOverlay,i=hideMapOverlay,p={"crecimiento-urbano":"Expansión urbana por periodo","tasa-cambio-poblacional":"Tasa de cambio poblacional (2010–2020)","cambio-poblacional-ageb":"Tasa de cambio poblacional (2010–2020)","densidad-poblacional":"Densidad poblacional (hab/ha)","densidad-poblacional-distritos":"Densidad poblacional (hab/ha)"};window.mapboxHelper.showMapOverlay=function(e){try{const e=document.getElementById("map-legend");if(e){const t=e.querySelector(".legend-items");t&&(t.innerHTML=""),e.style.display="none"}const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch{}s(e);try{const t=(e.layers||[]).some(e=>"crecimiento-urbano"===e.id);let o=null;for(const[t,a]of Object.entries(mapStepsConfig.stepConfigs))if(a===e){o=parseInt(t);break}const n=t&&4===o;if(toggleLustroPanel(n),n)applyLustroFilterWhenReady(),a();else{const t=["densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb"],o=e.layers||[];let n=null;for(const e of t){const t=o.find(t=>t.id===e);if(t){n=t;break}}if(n||(n=o.find(e=>"fill"===e.type&&e.paint&&e.paint["fill-color"])),n&&n.paint){const e=p[n.id]||"Leyenda";l(n.paint,{title:e})}else a()}}catch(e){console.warn("No se pudo construir la leyenda:",e),a()}},window.mapboxHelper.hideMapOverlay=function(){i();try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const t=document.getElementById("map-lustro-control");t&&(t.style.display="none")}catch(e){console.warn("Error ocultando leyendas:",e)}a(),toggleLustroPanel(!1)},window.mapboxLegend={buildFromPaint:(e,t)=>{try{l(e,t||{})}catch{}},hide:()=>{try{a()}catch{}},show:e=>{try{o(e)}catch{}}}}(),window.debugMapa=function(e=19){const t=document.getElementById("map"),o=(document.getElementById("map-legend"),document.getElementById("map-lustro-control"),document.querySelector(".step.is-active"));o&&o.getAttribute("data-step"),t&&(window.getComputedStyle(t).display,window.getComputedStyle(t).opacity,window.getComputedStyle(t).visibility,window.getComputedStyle(t).zIndex),window.mapboxHelper&&window.mapboxHelper.updateMapForStep(e)};