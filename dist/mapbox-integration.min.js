let mapboxMap=null,currentBaseStyle="mapbox://styles/mapbox/light-v10";const LUSTROS=[1980,1985,1990,1995,2e3,2005,2010,2015,2020,2025],LUSTRO_COLORS={1980:"#E3F2FA",1985:"#CDEAF6",1990:"#B7E1F2",1995:"#A1D8EE",2e3:"#8ECAE6",2005:"#6FBAD8",2010:"#4BAAD0",2015:"#219EBC",2020:"#1A7D95",2025:"#023047"};let selectedLustros=new Set(LUSTROS);const mapboxAccessToken="pk.eyJ1IjoiMHhqZmVyIiwiYSI6ImNtZjRjNjczdTA0MGsya3Bwb3B3YWw4ejgifQ.8IZ5PTYktl5ss1gREda3fg",mapStepsConfig={visibleSteps:[19,21,23],stepConfigs:{19:{center:[-86.8515,21.1619],zoom:11,pitch:0,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"cambio-poblacional-ageb",type:"fill",source:{type:"geojson",data:"public/data/tasa-de-cambio-poblacional-por-AGEB.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","pobtot"]],0],"#f7f4f9",100,"#e7e1ef",500,"#d4b9da",1e3,"#c994c7",5e3,"#df65b0",1e4,"#e7298a",5e4,"#ce1256",1e5,"#91003f"],"fill-opacity":.8,"fill-outline-color":"#ffffff"},popup:e=>`<h3>AGEB</h3>\n                                <p><strong>Poblaci√≥n total:</strong> ${(e.pobtot||0).toLocaleString()} habitantes</p>\n                                <p><strong>Supermanzana:</strong> ${e.supermanzana||"N/A"}</p>`}]},21:{center:[-86.8515,21.1619],zoom:11,pitch:20,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[]},23:{center:[-86.8515,21.1619],zoom:11,pitch:30,bearing:0,style:"mapbox://styles/mapbox/light-v10",layers:[{id:"densidad-poblacional-distritos",type:"fill",source:{type:"geojson",data:"public/data/densidad-poblacional-por-distrito.geojson"},paint:{"fill-color":["step",["coalesce",["to-number",["get","DEN_HAB_HA"]],0],"#f1faee",10,"#a8dadc",30,"#457b9d",60,"#1d3557",100,"#e63946"],"fill-opacity":.8,"fill-outline-color":"#555"},popup:e=>{const o=Number(e.POBTOT||0),t=Number(e.DEN_HAB_HA||0),a=Number(e.SUPERFICIE_HA||0);return`<h3>Distrito ${e.fid??""}</h3>\n                                <p>Poblaci√≥n: ${isFinite(o)?o.toLocaleString():"N/D"} habitantes</p>\n                                <p>Densidad: ${isFinite(t)?t.toFixed(1):"N/D"} hab/ha</p>\n                                <p>Superficie: ${isFinite(a)?a.toFixed(1):"N/D"} hect√°reas</p>`}}]}}};function initializeMapbox(){console.log("=== Inicializando Mapbox ==="),mapboxgl.accessToken=mapboxAccessToken;const e=document.getElementById("map");if(!e)return void console.error("No se encontr√≥ el contenedor #map");e.style.display,e.style.visibility,e.style.opacity;let o;e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.width="100vw",e.style.height="100vh",console.log("üìè Contenedor temporal visible para inicializaci√≥n del mapa"),mapboxMap=new mapboxgl.Map({container:"map",style:currentBaseStyle,center:[-86.8515,21.1619],zoom:12,pitch:0,bearing:0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0}),console.log("üó∫Ô∏è Instancia de mapa creada con estilo:",currentBaseStyle),mapboxMap.on("styledata",()=>{console.log("üé® Estilo del mapa cargando datos...")}),mapboxMap.on("style.load",()=>{console.log("üé® Estilo del mapa completamente cargado")}),mapboxMap.on("error",e=>{console.error("‚ùå Error en Mapbox:",e.error)}),mapboxMap.on("load",()=>{console.log("üó∫Ô∏è Mapa cargado correctamente"),e.classList.remove("active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize inicial del mapa completado"))},100),setTimeout(()=>{const e=mapboxMap.getStyle();console.log("üé® Estilo del mapa:",e?"Cargado":"NO CARGADO"),e&&e.layers&&(console.log("üìä Capas del estilo base:",e.layers.length),console.log("üìã Primeras capas:",e.layers.slice(0,5).map(e=>`${e.id} (${e.type})`)))},500),document.dispatchEvent(new CustomEvent("mapbox-ready"))}),window.addEventListener("resize",()=>{clearTimeout(o),o=setTimeout(()=>{mapboxMap&&"block"===e.style.display&&(mapboxMap.resize(),console.log("‚úÖ Mapa redimensionado por cambio en ventana"))},250)}),mapboxMap.addControl(new mapboxgl.NavigationControl,"top-right"),mapboxMap.addControl(new mapboxgl.FullscreenControl,"top-right"),console.log("Mapa de Mapbox inicializado correctamente (solo mapa principal)")}function ensureProjDefs(){"undefined"==typeof proj4||proj4.defs["EPSG:32616"]||proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}function reprojectGeoJSONToWGS84(e){try{if(!e||"undefined"==typeof proj4)return e;const o=e.crs&&e.crs.properties&&e.crs.properties.name;if(!o)return e;const t=(o.match(/EPSG::(\d+)/)||[])[1]||(o.match(/EPSG:(\d+)/)||[])[1];if(!t)return e;let a=`EPSG:${t}`;if("EPSG:6371"===a&&(a="EPSG:32616"),"EPSG:4326"===a)return e;if(ensureProjDefs(),!proj4.defs[a]){if("EPSG:32616"!==a){console.warn("CRS no reconocido para reproyecci√≥n:",a);const o=JSON.parse(JSON.stringify(e));return delete o.crs,o}proj4.defs("EPSG:32616","+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs +type=crs")}const n=proj4(a,"EPSG:4326"),l=e=>{const[o,t]=e,[a,l]=n.forward([o,t]);return[a,l]},s=(e,o)=>2===o?l(e):e.map(e=>s(e,o-1)),i=e=>{if(!e||!e.geometry)return e;const o=e.geometry;if(!o.coordinates)return e;let t;switch(o.type){case"Point":t=2;break;case"MultiPoint":case"LineString":t=3;break;case"MultiLineString":case"Polygon":t=4;break;case"MultiPolygon":t=5;break;case"GeometryCollection":return Array.isArray(o.geometries)&&(o.geometries=o.geometries.map(e=>({...e,coordinates:e.coordinates?s(e.coordinates,"Point"===e.type?2:"MultiPoint"===e.type||"LineString"===e.type?3:"MultiLineString"===e.type||"Polygon"===e.type?4:5):e.coordinates}))),e;default:return e}return o.coordinates=s(o.coordinates,t),e},r=JSON.parse(JSON.stringify(e)),p=e=>{if(!e||!e.type||null==e.coordinates)return!1;return Array.isArray(e.coordinates)&&e.coordinates.length>0};if("FeatureCollection"===r.type)r.features=r.features.map(i).filter(e=>e&&e.geometry&&p(e.geometry));else if("Feature"===r.type&&(i(r),!p(r.geometry)))return{type:"FeatureCollection",features:[]};return delete r.crs,r}catch(o){return console.warn("Fallo al reproyectar GeoJSON, usando datos originales:",o),e}}async function loadGeoJSONWithReprojection(e){const o=e.includes("?")?"&":"?",t=`${e}${o}v=${Date.now()}`,a=await fetch(t,{cache:"no-store"});return reprojectGeoJSONToWGS84(await a.json())}function showMapOverlay(e){console.log("=== showMapOverlay INICIANDO ==="),console.log("Config recibida:",e);const o=document.getElementById("map");if(!o)return void console.error("‚ùå No se encontr√≥ el contenedor #map");if(!mapboxMap)return void console.error("‚ùå mapboxMap no est√° inicializado");console.log("‚úÖ Contenedor y mapa encontrados, procediendo..."),o.style.display="block",o.style.opacity="1",o.style.visibility="visible",o.style.zIndex="1000",o.style.backgroundColor="",o.classList.add("active");const t=o.querySelector(".mapboxgl-canvas");t?(t.style.opacity="1",console.log("‚úÖ Canvas del mapa configurado con opacidad 1")):console.warn("‚ö†Ô∏è No se encontr√≥ el canvas del mapa");const a=o.querySelector(".mapboxgl-canvas-container");a&&(a.style.opacity="1",console.log("‚úÖ Contenedor del canvas configurado")),console.log("‚úÖ Estilos aplicados al contenedor"),console.log("Contenedor display:",o.style.display),console.log("Contenedor opacity:",o.style.opacity),console.log("Contenedor visibility:",o.style.visibility),console.log("Contenedor z-index:",o.style.zIndex),mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize inmediato ejecutado")),o._wheelForwardHandler||(o._wheelForwardHandler=function(e){try{e.preventDefault(),e.stopPropagation()}catch(e){}const o=e.deltaY||0;window.scrollBy(0,o)}),o.addEventListener("wheel",o._wheelForwardHandler,{passive:!1,capture:!0}),addKeyboardScrollSupport(),console.log("üìè Forzando resize del mapa para pantalla completa...");try{mapboxMap.scrollZoom.disable()}catch(e){}setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize 1 del mapa completado (100ms)"))},100),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize 2 del mapa completado (300ms)"))},300),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize 3 del mapa completado (600ms)"))},600);const n=async()=>{console.log("üé® Estilo del mapa cargado, a√±adiendo capas...");["densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb","supermanzanas-iniciales","crecimiento-urbano"].forEach(e=>{mapboxMap.getLayer(e)&&(mapboxMap.removeLayer(e),console.log(`üóëÔ∏è Capa ${e} eliminada`))});["densidad-poblacional-src","densidad-poblacional-distritos-src","tasa-cambio-poblacional-src","cambio-poblacional-ageb-src","supermanzanas-iniciales-src","crecimiento-urbano-src"].forEach(e=>{mapboxMap.getSource(e)&&(mapboxMap.removeSource(e),console.log(`üóëÔ∏è Fuente ${e} eliminada`))});const o=(()=>{try{const e=mapboxMap.getStyle();if(!e||!e.layers)return null;const o=e.layers.find(e=>"symbol"===e.type);return o?o.id:null}catch{return null}})();if(e.layers&&e.layers.length>0){console.log(`üìä A√±adiendo ${e.layers.length} capas...`);for(const t of e.layers)try{const e=t.id+"-src";let a={...t.source};if("geojson"===a.type&&"string"==typeof a.data){if(a.data.toLowerCase().endsWith(".gpkg")){console.warn(`‚õî Formato GPKG no soportado para ${t.id}. Omite esta capa hasta convertir a GeoJSON.`);continue}console.log(`‚¨áÔ∏è Cargando GeoJSON para ${t.id} desde ${a.data} ...`);const e=await loadGeoJSONWithReprojection(a.data);a={...a,data:e}}mapboxMap.addSource(e,a);const n={...t.paint},l={id:t.id,type:t.type,source:e,paint:n};o?mapboxMap.addLayer(l,o):mapboxMap.addLayer(l),t.popup&&(mapboxMap.on("click",t.id,e=>{const o=e.features[0].properties,a=t.popup(o);(new mapboxgl.Popup).setLngLat(e.lngLat).setHTML(a).addTo(mapboxMap)}),mapboxMap.on("mouseenter",t.id,()=>{mapboxMap.getCanvas().style.cursor="pointer"}),mapboxMap.on("mouseleave",t.id,()=>{mapboxMap.getCanvas().style.cursor=""})),console.log(`‚úÖ Capa ${t.id} a√±adida correctamente`)}catch(e){console.error(`‚ùå Error a√±adiendo capa ${t.id}:`,e)}}else console.log("‚ÑπÔ∏è No hay capas para a√±adir");console.log("üìè Resize final del mapa tras cargar capas..."),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize final completado"))},500)};console.log("üó∫Ô∏è Aplicando configuraci√≥n del mapa...");const l=e.style||currentBaseStyle;l!==currentBaseStyle?(mapboxMap.once("style.load",n),mapboxMap.setStyle(l),currentBaseStyle=l):mapboxMap.isStyleLoaded&&mapboxMap.isStyleLoaded()?n():mapboxMap.once("style.load",n),mapboxMap.flyTo({center:e.center,zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,duration:2e3,essential:!0}),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize post-flyTo completado (1000ms)"))},1e3),setTimeout(()=>{mapboxMap&&(mapboxMap.resize(),console.log("‚úÖ Resize post-flyTo completado (2500ms)"))},2500),console.log("=== showMapOverlay COMPLETADO ===")}function hideMapOverlay(){console.log("=== hideMapOverlay INICIANDO ===");const e=document.getElementById("map");if(e){e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.classList.remove("active");e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove()),e._wheelForwardHandler&&e.removeEventListener("wheel",e._wheelForwardHandler,{capture:!0}),console.log("‚úÖ Contenedor del mapa ocultado")}else console.error("‚ùå No se encontr√≥ el contenedor #map para ocultar");try{const e=document.getElementById("map-legend");e&&(e.style.display="none",console.log("üîç DEBUG: Leyenda forzadamente ocultada en hideMapOverlay original"));const o=document.getElementById("map-lustro-control");o&&(o.style.display="none",console.log("üîç DEBUG: Panel de lustros forzadamente ocultado en hideMapOverlay original"))}catch(e){console.warn("Error en limpieza de leyendas:",e)}}async function updateMapForStep(e){console.log(`=== updateMapForStep(${e}) INICIANDO ===`);try{const e=document.getElementById("map-legend");e&&(e.style.display="none");const o=document.getElementById("map-lustro-control");o&&(o.style.display="none"),console.log("üîç DEBUG: Limpieza preventiva de leyendas realizada")}catch{}const o=String(e);console.log("üìã Verificando configuraci√≥n..."),console.log("Steps visibles:",mapStepsConfig.visibleSteps),console.log("¬øStep est√° en visibleSteps?",mapStepsConfig.visibleSteps.includes(Number(e))),console.log("¬øExiste configuraci√≥n para step?",!!mapStepsConfig.stepConfigs[o]),mapStepsConfig.visibleSteps.includes(Number(e))&&mapStepsConfig.stepConfigs[o]?(console.log(`‚úÖ Step ${e} debe mostrar mapa, llamando showMapOverlay...`),await ensureMapboxReady(),window.mapboxHelper&&"function"==typeof window.mapboxHelper.showMapOverlay?window.mapboxHelper.showMapOverlay(mapStepsConfig.stepConfigs[o]):showMapOverlay(mapStepsConfig.stepConfigs[o])):(console.log(`‚ùå Step ${e} NO debe mostrar mapa, llamando hideMapOverlay...`),window.mapboxHelper&&"function"==typeof window.mapboxHelper.hideMapOverlay?window.mapboxHelper.hideMapOverlay():hideMapOverlay()),console.log(`=== updateMapForStep(${e}) COMPLETADO ===`)}function createScrollZones(e){e.querySelectorAll(".map-scroll-zone").forEach(e=>e.remove());const o=document.createElement("div");o.className="map-scroll-zone top",o.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(o);const t=document.createElement("div");t.className="map-scroll-zone bottom",t.addEventListener("wheel",handleScrollZoneWheel,{passive:!1}),e.appendChild(t)}function handleScrollZoneWheel(e){e.preventDefault(),e.stopPropagation();const o=e.deltaY;window.scrollBy(0,o)}function addKeyboardScrollSupport(){document.addEventListener("keydown",function(e){const o=document.getElementById("map");o&&"none"!==o.style.display&&("ArrowDown"===e.key||"PageDown"===e.key?(e.preventDefault(),window.scrollBy(0,100)):"ArrowUp"===e.key||"PageUp"===e.key?(e.preventDefault(),window.scrollBy(0,-100)):"Home"===e.key?(e.preventDefault(),window.scrollTo(0,0)):"End"===e.key&&(e.preventDefault(),window.scrollTo(0,document.body.scrollHeight)))})}let mapInitPromise=null;async function ensureMapboxReady(){return!!mapboxMap||(mapInitPromise||(mapInitPromise=new Promise(e=>{if("undefined"!=typeof mapboxgl){console.log("‚úÖ Mapbox GL ya est√° cargado, inicializando mapa..."),initializeMapbox();const o=()=>{document.removeEventListener("mapbox-ready",o),e(!0)};return void document.addEventListener("mapbox-ready",o)}console.log("‚è≥ Cargando librer√≠a de Mapbox bajo demanda...");const o=document.createElement("script");o.src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js",o.async=!0,o.onload=()=>{console.log("‚úÖ Mapbox GL cargado, inicializando mapa..."),initializeMapbox();const o=()=>{document.removeEventListener("mapbox-ready",o),e(!0)};document.addEventListener("mapbox-ready",o)},o.onerror=()=>{console.error("‚ùå No se pudo cargar Mapbox GL"),e(!1)},document.head.appendChild(o)})),mapInitPromise)}function ensureLustroPanel(){if(document.getElementById("map-lustro-control"))return;const e=document.createElement("div");e.id="map-lustro-control",e.style.position="fixed",e.style.zIndex="2000",e.style.background="rgba(255,255,255,0.96)",e.style.color="#222",e.style.borderRadius="8px",e.style.boxShadow="0 6px 18px rgba(0,0,0,0.18)",e.style.padding="10px 12px",e.style.minWidth="220px",e.style.pointerEvents="auto",e.style.display="none";const o=document.createElement("div");o.className="lustro-title",o.textContent="Expansi√≥n urbana por periodo",o.style.fontWeight="700",o.style.fontSize="13px",o.style.marginBottom="8px",e.appendChild(o);const t=document.createElement("div");t.className="lustro-list",t.style.display="grid",t.style.gridTemplateColumns="repeat(2, minmax(100px, 1fr))",t.style.gap="6px 12px",LUSTROS.forEach(e=>{const o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.gap="6px";const a=document.createElement("input");a.type="checkbox",a.value=String(e),a.checked=!0,a.addEventListener("change",()=>{a.checked?selectedLustros.add(Number(a.value)):selectedLustros.delete(Number(a.value)),applyLustroFilterWhenReady()});const n=document.createElement("span");n.style.width="14px",n.style.height="10px",n.style.borderRadius="2px",n.style.border="1px solid rgba(0,0,0,0.2)",n.style.display="inline-block",n.style.background=LUSTRO_COLORS[e];const l=document.createElement("span");l.textContent=String(e),o.appendChild(a),o.appendChild(n),o.appendChild(l),t.appendChild(o)}),e.appendChild(t),document.body.appendChild(e)}function toggleLustroPanel(e){console.log("üîç DEBUG: toggleLustroPanel llamado con show =",e),ensureLustroPanel();const o=document.getElementById("map-lustro-control");console.log("üîç DEBUG: Panel encontrado:",!!o),o&&(o.style.display=e?"block":"none",console.log("üîç DEBUG: Panel display establecido a:",o.style.display),e?(positionLustroPanel(),window.addEventListener("resize",positionLustroPanel)):window.removeEventListener("resize",positionLustroPanel))}function positionLustroPanel(){const e=document.getElementById("map-lustro-control");if(!e||"none"===e.style.display)return;document.getElementById("map-legend");const o=e.style.visibility,t=e.style.display;"none"===t&&(e.style.visibility="hidden",e.style.display="block");const a=e.getBoundingClientRect(),n=(a.width,a.height,Math.max(document.documentElement.clientWidth,window.innerWidth||0)),l=(Math.max(document.documentElement.clientHeight,window.innerHeight||0),n<=640);e.style.right="14px",e.style.left="",e.style.top="",e.style.bottom="14px",e.style.minWidth=l?"190px":"240px",e.style.padding=l?"6px 8px":"10px 12px",e.style.maxHeight=l?"40vh":"60vh",e.style.overflowY="auto";const s=e.querySelector(".lustro-title");s&&(s.style.fontSize=l?"12px":"13px",s.style.marginBottom=l?"6px":"8px");const i=e.querySelector(".lustro-list");i&&(i.style.gridTemplateColumns=l?"repeat(2, minmax(90px, 1fr))":"repeat(1, minmax(140px, 1fr))",i.style.gap=l?"4px 8px":"6px 12px",Array.from(i.children).forEach(e=>{if(!(e instanceof HTMLElement))return;e.style.gap=l?"4px":"6px";const o=e.querySelector('input[type="checkbox"]');o&&(o.style.transform=l?"scale(0.9)":"scale(1)");const t=e.querySelector("span");t&&(t.style.width=l?"12px":"14px",t.style.height=l?"8px":"10px");const a=e.querySelector("span + span");a&&(a.style.fontSize=l?"12px":"13px")})),"none"===t&&(e.style.display="none",e.style.visibility=o||"visible")}function applyLustroFilter(){if(!mapboxMap)return;const e="crecimiento-urbano";if(!mapboxMap.getLayer||!mapboxMap.getLayer(e))return;const o=Array.from(selectedLustros);if(0===o.length){try{mapboxMap.setLayoutProperty(e,"visibility","none")}catch{}const o=document.getElementById("map-legend");o&&(o.style.display="none");try{mapboxMap.setFilter(e,null)}catch{}return}try{mapboxMap.setLayoutProperty(e,"visibility","visible")}catch{}const t=["match",["to-number",["get","LUSTRO"]]];o.forEach(e=>{t.push(e,!0)}),t.push(!1),mapboxMap.setFilter(e,t);try{console.debug("Filtro aplicado a crecimiento-urbano:",JSON.stringify(t))}catch{}}function applyLustroFilterWhenReady(e=0){if(!mapboxMap)return;if(mapboxMap.getLayer&&mapboxMap.getLayer("crecimiento-urbano"))applyLustroFilter();else if(!(e>10)){setTimeout(()=>applyLustroFilterWhenReady(e+1),150);try{mapboxMap.once&&mapboxMap.once("idle",()=>applyLustroFilter())}catch{}}}window.mapboxHelper={updateMapForStep:updateMapForStep,showMapOverlay:showMapOverlay,hideMapOverlay:hideMapOverlay},function(){const e=()=>document.getElementById("map-legend"),o=()=>e()?e().querySelector(".legend-items"):null;function t(o){console.log("üîç DEBUG: showLegend llamado con t√≠tulo:",o);const t=e();if(t){if(o){const e=t.querySelector(".legend-title");e&&(e.textContent=o)}t.style.display="block",console.log("üîç DEBUG: Leyenda mostrada, display =",t.style.display)}else console.log("üîç DEBUG: No se encontr√≥ elemento de leyenda")}function a(){console.log("üîç DEBUG: hideLegend llamado");const o=e();o&&(o.style.display="none",console.log("üîç DEBUG: Leyenda ocultada"))}function n(e,t){const a=o();if(!a)return;const n=document.createElement("div");n.className="legend-item";const l=document.createElement("span");l.className="legend-swatch",l.style.background=e;const s=document.createElement("span");s.className="legend-label",s.textContent=t,n.appendChild(l),n.appendChild(s),a.appendChild(n)}function l(e,l={}){!function(){const e=o();e&&(e.innerHTML="")}();const i=l.title||"Leyenda",r=l.allowedValues?new Set(l.allowedValues):null,p=e&&e["fill-color"];if(!p)return a();if(Array.isArray(p)&&"step"===p[0]){const e=p,o=e[2],a=[];for(let o=3;o<e.length;o+=2){const t=e[o],n=e[o+1];"number"==typeof t&&"string"==typeof n&&a.push({stop:t,color:n})}if(t(i),0===a.length)return void n(o,"Valor bajo");n(o,`< ${s(a[0].stop)}`);for(let e=0;e<a.length;e++){const o=a[e].stop,t=e+1<a.length?a[e+1].stop:null;n(a[e].color,null==t?`‚â• ${s(o)}`:`${s(o)} ‚Äì ${s(t)}`)}return}if(Array.isArray(p)&&"match"===p[0]){const e=p,o=[];for(let t=2;t<e.length-1;t+=2){const a=e[t],n=e[t+1];if("number"!=typeof a&&"string"!=typeof a||"string"!=typeof n)break;r&&!r.has(a)||o.push({value:a,color:n})}if(o.length>0)return t(i),void o.forEach(e=>n(e.color,String(e.value)))}if("string"==typeof p)return t(i),void n(p,"√Årea destacada");a()}function s(e){try{return Number(e).toLocaleString("es-MX")}catch{return String(e)}}const i=showMapOverlay,r=hideMapOverlay,p={"crecimiento-urbano":"Expansi√≥n urbana por periodo","tasa-cambio-poblacional":"Tasa de cambio poblacional (2010‚Äì2020)","cambio-poblacional-ageb":"Tasa de cambio poblacional (2010‚Äì2020)","densidad-poblacional":"Densidad poblacional (hab/ha)","densidad-poblacional-distritos":"Densidad poblacional (hab/ha)"};window.mapboxHelper.showMapOverlay=function(e){console.log("üîç DEBUG: showMapOverlay llamado con config:",e);try{const e=document.getElementById("map-legend");if(e){const o=e.querySelector(".legend-items");o&&(o.innerHTML=""),e.style.display="none"}const o=document.getElementById("map-lustro-control");o&&(o.style.display="none")}catch{}i(e);try{const o=(e.layers||[]).some(e=>"crecimiento-urbano"===e.id);let t=null;for(const[o,a]of Object.entries(mapStepsConfig.stepConfigs))if(a===e){t=parseInt(o);break}const n=o&&4===t;if(console.log("üîç DEBUG: hasCrecimiento:",o),console.log("üîç DEBUG: targetStepId para panel:",t),console.log("üîç DEBUG: shouldShowLustroPanel:",n),toggleLustroPanel(n),n)console.log("üîç DEBUG: Aplicando filtro de lustros"),applyLustroFilterWhenReady(),a();else{const o=["densidad-poblacional","densidad-poblacional-distritos","tasa-cambio-poblacional","cambio-poblacional-ageb"],t=e.layers||[];let n=null;for(const e of o){const o=t.find(o=>o.id===e);if(o){n=o;break}}if(n||(n=t.find(e=>"fill"===e.type&&e.paint&&e.paint["fill-color"])),n&&n.paint){const e=p[n.id]||"Leyenda";l(n.paint,{title:e})}else a()}}catch(e){console.warn("No se pudo construir la leyenda:",e),a()}},window.mapboxHelper.hideMapOverlay=function(){console.log("üîç DEBUG: hideMapOverlay ejecutado - FORZANDO OCULTADO TOTAL"),r();try{const e=document.getElementById("map-legend");e&&(e.style.display="none",console.log("üîç DEBUG: Leyenda forzadamente ocultada"));const o=document.getElementById("map-lustro-control");o&&(o.style.display="none",console.log("üîç DEBUG: Panel de lustros forzadamente ocultado"))}catch(e){console.warn("Error ocultando leyendas:",e)}a(),toggleLustroPanel(!1)},window.mapboxLegend={buildFromPaint:(e,o)=>{try{l(e,o||{})}catch{}},hide:()=>{try{a()}catch{}},show:e=>{try{t(e)}catch{}}}}(),window.debugMapa=function(e=19){console.log("=== FUNCI√ìN DEBUG MAPA ==="),console.log("Testing step:",e);const o=document.getElementById("map");console.log("Contenedor #map:",o),console.log("mapboxMap:",mapboxMap),console.log("mapStepsConfig:",mapStepsConfig);const t=document.getElementById("map-legend");console.log("Elemento leyenda:",t);const a=document.getElementById("map-lustro-control");console.log("Panel lustros:",a);const n=document.querySelector(".step.is-active");console.log("Step actual en DOM:",n),n&&console.log("Data-step del elemento actual:",n.getAttribute("data-step")),o&&(console.log("Estilos actuales del contenedor:"),console.log("- display:",window.getComputedStyle(o).display),console.log("- opacity:",window.getComputedStyle(o).opacity),console.log("- visibility:",window.getComputedStyle(o).visibility),console.log("- z-index:",window.getComputedStyle(o).zIndex)),window.mapboxHelper&&(console.log("Llamando updateMapForStep..."),window.mapboxHelper.updateMapForStep(e))};